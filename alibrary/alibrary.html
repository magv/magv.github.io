<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <title>Amplitude library (alibrary.m)</title>
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
 </head>
 <body>
</pre>
<h1 id="AmplitudeLibraryAlibraryM">Amplitude library (<code>alibrary.m</code>)</h1>
<p>Tired of relying on large monolitic programs to generate
your Feynman amplitudes? What you need is a library: <em>alibrary</em>.</p>
<p>This file deals with Feynman diagrams and all the related
things. Generic Mathematica utils go into <a href="utils.html">utils.m</a>.
Tests go into <a href="atestsuite.html">atestsuite.m</a>.</p>
<h2 id="Contents">Contents</h2>
<p><nav>
<ul><li>
 <a href="#DiagramGeneration">Diagram generation</a>
<ul><li>
 <a href="#DiagramId">DiagramId</a>
</li><li>
 <a href="#DiagramClosedLoops">DiagramClosedLoops</a>
</li><li>
 <a href="#Diagrams">Diagrams</a>
</li></ul>
</li><li>
 <a href="#DiagramsToGraphs">Diagrams to graphs</a>
<ul><li>
 <a href="#DiagramGraphEdges">DiagramGraphEdges</a>
</li><li>
 <a href="#DiagramGraph">DiagramGraph</a>
</li><li>
 <a href="#DiagramXGraph">DiagramXGraph</a>
</li><li>
 <a href="#DiagramToGraphviz">DiagramToGraphviz</a>
</li><li>
 <a href="#FieldGraphvizColor">FieldGraphvizColor</a>
</li><li>
 <a href="#DiagramViz">DiagramViz</a>
</li><li>
 <a href="#GraphLayoutVertexCoordinates">GraphLayoutVertexCoordinates</a>
</li><li>
 <a href="#NormalizeCoordinates">NormalizeCoordinates</a>
</li></ul>
</li><li>
 <a href="#TikzInterfaceForDiagrams">TikZ interface for diagrams</a>
<ul><li>
 <a href="#DiagramToTikZ">DiagramToTikZ</a>
</li><li>
 <a href="#FieldTikZStyle">FieldTikZStyle</a>
</li><li>
 <a href="#MkTikZGraph">MkTikZGraph</a>
</li><li>
 <a href="#MkIntegralTikZ">MkIntegralTikZ</a>
</li></ul>
</li><li>
 <a href="#IbpBases">IBP Bases</a>
<ul><li>
 <a href="#ExpandScalarProducts">ExpandScalarProducts</a>
</li><li>
 <a href="#BToDen">BToDen</a>
</li><li>
 <a href="#ToB">ToB</a>
</li><li>
 <a href="#IBPRelations">IBPRelations</a>
</li><li>
 <a href="#VariableDimensions">VariableDimensions</a>
</li><li>
 <a href="#NormalizeDens">NormalizeDens</a>
</li><li>
 <a href="#CompleteIBPBasis">CompleteIBPBasis</a>
</li><li>
 <a href="#IBPBasisMapInvariants">IBPBasisMapInvariants</a>
</li><li>
 <a href="#InvariantMapUnderMomentaPermutation">InvariantMapUnderMomentaPermutation</a>
</li><li>
 <a href="#IBPBasisMassDimensions">IBPBasisMassDimensions</a>
</li><li>
 <a href="#IBPBasisCross">IBPBasisCross</a>
</li><li>
 <a href="#IBPBasisSameQ">IBPBasisSameQ</a>
</li></ul>
</li><li>
 <a href="#FeynsonInterfaceForIntegralSymmetries">Feynson interface for integral symmetries</a>
<ul><li>
 <a href="#ZeroSectors">ZeroSectors</a>
</li><li>
 <a href="#ZeroSectorPattern">ZeroSectorPattern</a>
</li><li>
 <a href="#SymmetryMaps">SymmetryMaps</a>
</li><li>
 <a href="#IntegralFamilyMappingRules">IntegralFamilyMappingRules</a>
</li><li>
 <a href="#IntegralEqualitySets">IntegralEqualitySets</a>
</li><li>
 <a href="#UniqueIntegralIndices">UniqueIntegralIndices</a>
</li><li>
 <a href="#IntegralUnion">IntegralUnion</a>
</li><li>
 <a href="#IntegralMapOntoSectors">IntegralMapOntoSectors</a>
</li><li>
 <a href="#IntegralMapOntoFamily">IntegralMapOntoFamily</a>
</li></ul>
</li><li>
 <a href="#FormInterfaceForIntegrandTransformation">FORM interface for integrand transformation</a>
<ul><li>
 <a href="#RunThroughForm">RunThroughForm</a>
</li><li>
 <a href="#FormCallToB">FormCallToB</a>
</li></ul>
</li><li>
 <a href="#KiraInterfaceForIbpReduction">Kira interface for IBP reduction</a>
<ul><li>
 <a href="#KiraBasisName">KiraBasisName</a>
</li><li>
 <a href="#MkKiraKinematicsYaml">MkKiraKinematicsYaml</a>
</li><li>
 <a href="#MkKiraIntegralFamiliesYaml">MkKiraIntegralFamiliesYaml</a>
</li><li>
 <a href="#MkKiraJobsYaml">MkKiraJobsYaml</a>
</li><li>
 <a href="#MkKiraFinishUDSYaml">MkKiraFinishUDSYaml</a>
</li><li>
 <a href="#MkKiraIntegrals">MkKiraIntegrals</a>
</li><li>
 <a href="#MkKiraIntegralList">MkKiraIntegralList</a>
</li><li>
 <a href="#IndicesToSectorId">IndicesToSectorId</a>
</li><li>
 <a href="#BToSector">BToSector</a>
</li><li>
 <a href="#BToSectorPattern">BToSectorPattern</a>
</li><li>
 <a href="#TopSectors">TopSectors</a>
</li><li>
 <a href="#TopSectorMap">TopSectorMap</a>
</li><li>
 <a href="#SectorUnion">SectorUnion</a>
</li><li>
 <a href="#MkKiraEquations">MkKiraEquations</a>
</li><li>
 <a href="#MkKiraConfig">MkKiraConfig</a>
</li><li>
 <a href="#MkKiraConfigUDS">MkKiraConfigUDS</a>
</li><li>
 <a href="#MkKiraConfigByBasis">MkKiraConfigByBasis</a>
</li><li>
 <a href="#KiraApplyResults">KiraApplyResults</a>
</li><li>
 <a href="#KiraApplyResultsInBulk">KiraApplyResultsInBulk</a>
</li><li>
 <a href="#LoadKiraMap">LoadKiraMap</a>
</li><li>
 <a href="#LoadKiraMasters">LoadKiraMasters</a>
</li><li>
 <a href="#KiraIBP">KiraIBP</a>
</li><li>
 <a href="#MkKiraMastersConfig">MkKiraMastersConfig</a>
</li><li>
 <a href="#KiraMasters">KiraMasters</a>
</li></ul>
</li><li>
 <a href="#FireAmpLiteredInterfaceForIbpReduction">FIRE &amp; LiteRed interface for IBP reduction</a>
<ul><li>
 <a href="#PrepareFireStart">PrepareFireStart</a>
</li><li>
 <a href="#LoadFireMasters">LoadFireMasters</a>
</li><li>
 <a href="#LoadFireTables">LoadFireTables</a>
</li></ul>
</li><li>
 <a href="#PysecdecInterfaceForNumericalEvaluationOfIntegrals">pySecDec interface for numerical evaluation of integrals</a>
<ul><li>
 <a href="#SecDecIntegralName">SecDecIntegralName</a>
</li><li>
 <a href="#ToSympy">ToSympy</a>
</li><li>
 <a href="#SecDecPrepare">SecDecPrepare</a>
</li><li>
 <a href="#SecDecPrepareSum">SecDecPrepareSum</a>
</li><li>
 <a href="#SecDecIntegrateSum">SecDecIntegrateSum</a>
</li><li>
 <a href="#SecDecLeadingOrders">SecDecLeadingOrders</a>
</li><li>
 <a href="#MkSecDecCoefficientFile">MkSecDecCoefficientFile</a>
</li><li>
 <a href="#MkSecDecCoefficientDir">MkSecDecCoefficientDir</a>
</li><li>
 <a href="#SecDecCompile">SecDecCompile</a>
</li><li>
 <a href="#SecDecIntegrate">SecDecIntegrate</a>
</li></ul>
</li><li>
 <a href="#DimensionalRecurrence">Dimensional recurrence</a>
<ul><li>
 <a href="#RaisingDRR">RaisingDRR</a>
</li><li>
 <a href="#LoweringDRR">LoweringDRR</a>
</li></ul>
</li><li>
 <a href="#IntegralDifferentiation">Integral differentiation</a>
<ul><li>
 <a href="#BasisExternalInvariantSymbols">BasisExternalInvariantSymbols</a>
</li><li>
 <a href="#BasisExternalScalarProducts">BasisExternalScalarProducts</a>
</li><li>
 <a href="#GramMatrix">GramMatrix</a>
</li><li>
 <a href="#BasisGramMatrix">BasisGramMatrix</a>
</li><li>
 <a href="#BasisInvGramMatrix">BasisInvGramMatrix</a>
</li><li>
 <a href="#BasisInvGramMatrixMap">BasisInvGramMatrixMap</a>
</li><li>
 <a href="#BDiff">BDiff</a>
</li></ul>
</li><li>
 <a href="#Amplitudes">Amplitudes</a>
<ul><li>
 <a href="#Amplitude">Amplitude</a>
</li><li>
 <a href="#CutAmplitudeGlue">CutAmplitudeGlue</a>
</li><li>
 <a href="#DiagramFinalStateSum">DiagramFinalStateSum</a>
</li></ul>
</li></ul>
</nav>
</p>
<hr />
<p>First, load the other libraries, <a href="utils.html">utils.m</a> and <a href="library.html">library.m</a>.</p>
<pre><a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/$InputFileName.html" rel="nofollow">$InputFileName</a>, <span class="tnt">s_String</span> /; <a class="tnb" href="https://reference.wolfram.com/language/ref/StringEndsQ.html" rel="nofollow">StringEndsQ</a>[<span class="tnv">s</span>, <span class="ts">"alibrary.m"</span>]],
  <span class="tnv">$Apath</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/FileNameDrop.html" rel="nofollow">FileNameDrop</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/$InputFileName.html" rel="nofollow">$InputFileName</a>] /. <span class="ts">""</span> -&gt; <span class="ts">"."</span>;
  ,
  <span class="tnv">$Apath</span> = <span class="ts">"."</span>;
]

<a class="tnb" href="https://reference.wolfram.com/language/ref/Get.html" rel="nofollow">Get</a>[<span class="tnv">$Apath</span> &lt;&gt; <span class="ts">"/utils.m"</span>];
<a class="tnb" href="https://reference.wolfram.com/language/ref/Get.html" rel="nofollow">Get</a>[<span class="tnv">$Apath</span> &lt;&gt; <span class="ts">"/library.m"</span>];</pre>
<h2 id="DiagramGeneration">Diagram generation</h2>
<p>We use diagrams generated by QGraf and expect them to come
in the following format (defined in <code>qgraf-stylefile</code>):</p>
<pre class="doc"><span class="tnv">Diagram</span>[<span class="tnv">id</span>, <span class="tnv">sym</span>-<span class="tnv">factor</span>, {<span class="tnv">in</span>-<span class="tnv">field</span> ...}, {<span class="tnv">out</span>-<span class="tnv">field</span> ...}, {<span class="tnv">propagator</span> ...}, {<span class="tnv">vertex</span> ...}]
</pre>

<p>where</p>
<ul>
<li>id is an arbitrary identified of the diagram;</li>
<li>sym-factor is the symmetry factor and the sign of the diagram;</li>
<li>in- and out-fields: F[&quot;field&quot;, field-idx, vertex-idx, momentum];</li>
<li>propagators:   P[&quot;field&quot;, from-field-idx, to-field-idx, from-vertex-idx, to-vertex-idx, momentum]</li>
<li>vertices:      V[vertex-idx, &quot;fields&quot;, field-idx-1, momentum-1, field-idx-2, momentum-2, ...]</li>
</ul>
<p>All the information here is directly as QGraf provides it,
just packaged into a Mathematica expression.</p>
<p>To generate diagrams conveniently, use <a href="#Diagrams">Diagrams</a>.</p>
<h3 id="DiagramId"><code>DiagramId[]</code></h3>
<p>Because <code>Diagram[]</code> objects are not <code>Association</code>s, here are
some functions that help access their parts by names, instead
of numbers. (In many places we will access these parts by
numbers still; arguably those places should be changed to use
these functions).</p>
<pre><a class="tnv" href="#DiagramId">DiagramId</a>[<span class="tnv">Diagram</span>[<span class="tnt">id_</span>, <span class="tnt">factor_</span>, <span class="tnt">ifld_</span>, <span class="tnt">ofld_</span>, <span class="tnt">props_</span>, <span class="tnt">verts_</span>]] := <span class="tnv">id</span>

<span class="tnv">DiagramSymmetryFactor</span>[<span class="tnv">Diagram</span>[_, <span class="tnt">factor_</span>, _, _, _, _]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Abs.html" rel="nofollow">Abs</a>[<span class="tnv">factor</span>]

<span class="tnv">DiagramIncomingFields</span>[<span class="tnv">Diagram</span>[_, _, <span class="tnt">ifld_List</span>, _, _, _]] := <span class="tnv">ifld</span>

<span class="tnv">DiagramOutgoingFields</span>[<span class="tnv">Diagram</span>[_, _, _, <span class="tnt">ofld_List</span>, _, _]] := <span class="tnv">ofld</span>

<span class="tnv">DiagramPropagators</span>[<span class="tnv">Diagram</span>[_, _, _, _, <span class="tnt">props_List</span>, _]] := <span class="tnv">props</span>

<span class="tnv">DiagramVertices</span>[<span class="tnv">Diagram</span>[_, _, _, _, _, <span class="tnt">verts_List</span>]] := <span class="tnv">verts</span></pre>
<h3 id="DiagramClosedLoops"><code>DiagramClosedLoops[]</code></h3>
<p>Return the number of closed loops comprised only of fields
that match the given (string) pattern. Only really works
for fields that always come in a pair in each vertex (e.g.
fermions).</p>
<pre><a class="tnv" href="#DiagramClosedLoops">DiagramClosedLoops</a>[<span class="tnt">fieldpat_</span>] := <span class="tnv">DiagramFieldLoops</span>[<span class="tnv">#</span>, <span class="tnv">fieldpat</span>]&amp;
<a class="tnv" href="#DiagramClosedLoops">DiagramClosedLoops</a>[<span class="tnv">Diagram</span>[_, _, <span class="tnt">i_List</span>, <span class="tnt">o_List</span>, <span class="tnt">p_List</span>, _], <span class="tnt">fieldpat_</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">edges</span>, <span class="tnvc">SS</span>, <span class="tnvc">II</span>, <span class="tnvc">EE</span>},
  <span class="tnvc">edges</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
    <span class="tnv">i</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[ <span class="tnv">F</span>[<span class="tnv">fieldpat</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, _] :&gt; <span class="tnvc">SS</span>[<span class="tnv">fi</span>] &lt;-&gt; <span class="tnvc">II</span>[<span class="tnv">vi</span>] ],
    <span class="tnv">o</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[ <span class="tnv">F</span>[<span class="tnv">fieldpat</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, _] :&gt; <span class="tnvc">II</span>[<span class="tnv">vi</span>] &lt;-&gt; <span class="tnvc">EE</span>[<span class="tnv">fi</span>] ],
    <span class="tnv">p</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[ <span class="tnv">P</span>[<span class="tnv">fieldpat</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, _] :&gt; <span class="tnvc">II</span>[<span class="tnv">vi1</span>] &lt;-&gt; <span class="tnvc">II</span>[<span class="tnv">vi2</span>] ]
  ];
  <span class="tnvc">edges</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ConnectedComponents.html" rel="nofollow">ConnectedComponents</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/FreeQ.html" rel="nofollow">FreeQ</a>[<span class="tnt">_SS</span>|<span class="tnt">_EE</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>
]</pre>
<h3 id="Diagrams"><code>Diagrams[]</code></h3>
<p>Return a list of diagrams produced by QGraf with the given
incoming and outgoing fields and the given number of loops.</p>
<p>The QGraf binary, QGraf model file, QGraf options, and the
massless particle pattern are specified via the global
variables <code>$QGraf</code>, <code>$QGrafModel</code>, <code>$QGrafOptions</code>, and
<code>$MasslessFieldPattern</code>. These can be overriden via <code>QGraf</code>,
<code>QGrafModel</code>, <code>QGrafOptions</code>, and <code>MasslessFieldPattern</code>
options, but the idea is that a model file has already provided
the global variables instead.</p>
<pre><a class="tnv" href="#Diagrams">Diagrams</a>[<span class="tnt">fieldsi_List</span>, <span class="tnt">fieldso_List</span>, <span class="tnt">loops_Integer</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">model</span>, <span class="tnvc">options</span>, <span class="tnvc">nomasspat</span>, <span class="tnvc">tmpdir</span>, <span class="tnvc">tmpoutput</span>, <span class="tnvc">momi</span>, <span class="tnvc">momo</span>, <span class="tnvc">i</span>, <span class="tnvc">result</span>},
  <span class="tnvc">model</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">QGrafModel</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a> -&gt; <span class="tnv">$QGrafModel</span>];
  <span class="tnvc">options</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">QGrafOptions</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a> -&gt; <span class="tnv">$QGrafOptions</span>];
  <span class="tnv">qgraf</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">QGraf</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a> -&gt; <span class="tnv">$QGraf</span>];
  <span class="tnvc">nomasspat</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">MasslessFieldPattern</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a> -&gt; <span class="tnv">$MasslessFieldPattern</span>];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">model</span>, <span class="tnt">_String</span>]];
  <span class="tnvc">tmpdir</span> = <a class="tnv" href="utils.html#MkTemp">MkTemp</a>[<span class="ts">"qgraf"</span>, <span class="ts">""</span>];
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnvc">tmpdir</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/CopyFile.html" rel="nofollow">CopyFile</a>[<span class="tnv">$Apath</span> &lt;&gt; <span class="ts">"/qgraf-stylefile"</span>, <span class="tnvc">tmpdir</span> &lt;&gt; <span class="ts">"/stylefile"</span>];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">tmpdir</span> &lt;&gt; <span class="ts">"/modelfile"</span>, <span class="tnvc">model</span>];
  <span class="tnvc">momi</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">fieldsi</span>] == <span class="tl">1</span>, {<span class="ts">"q"</span>}, <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="ts">"q"</span> &lt;&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnvc">i</span>], {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">fieldsi</span>]}]];
  <span class="tnvc">momo</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">fieldso</span>] == <span class="tl">1</span>, {<span class="ts">"q"</span>}, <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="ts">"p"</span> &lt;&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnvc">i</span>], {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">fieldso</span>]}]];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">tmpdir</span> &lt;&gt; <span class="ts">"/qgraf.dat"</span>,
    <span class="ts">"output='output.m';\n"</span>,
    <span class="ts">"style='stylefile';\n"</span>,
    <span class="ts">"model='modelfile';\n"</span>,
    <span class="ts">"in="</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[{<span class="tnv">#1</span>, <span class="ts">"["</span>, <span class="tnv">#2</span>, <span class="ts">"]"</span>}&amp;, {<span class="tnv">fieldsi</span>, <span class="tnvc">momi</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;, <span class="ts">";\n"</span>,
    <span class="ts">"out="</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[{<span class="tnv">#1</span>, <span class="ts">"["</span>, <span class="tnv">#2</span>, <span class="ts">"]"</span>}&amp;, {<span class="tnv">fieldso</span>, <span class="tnvc">momo</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;, <span class="ts">";\n"</span>,
    <span class="ts">"loops="</span>, <span class="tnv">loops</span>, <span class="ts">";\n"</span>,
    <span class="ts">"loop_momentum=l;\n"</span>,
    <span class="ts">"options="</span>, <span class="tnvc">options</span>, <span class="ts">";\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">fieldsi</span>] &gt; <span class="tl">1</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
        <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">fieldsi</span>[[<span class="tnvc">i</span>]], <span class="tnvc">nomasspat</span>], {<span class="ts">"false=plink["</span>, <span class="tl">1</span>-<span class="tl">2</span>*<span class="tnvc">i</span>, <span class="ts">"];\n"</span>}, <span class="ts">""</span>],
        {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">fieldsi</span>]}],
      <span class="ts">""</span>],
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">fieldso</span>] &gt; <span class="tl">1</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
        <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">fieldso</span>[[<span class="tnvc">i</span>]], <span class="tnvc">nomasspat</span>], {<span class="ts">"false=plink["</span>, -<span class="tl">2</span>*<span class="tnvc">i</span>, <span class="ts">"];\n"</span>}, <span class="ts">""</span>],
        {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">fieldso</span>]}],
      <span class="ts">""</span>]
  ];
  <a class="tnv" href="utils.html#SafeRun">SafeRun</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"cd '"</span>, <span class="tnvc">tmpdir</span>, <span class="ts">"' &amp;&amp; '"</span>, <span class="tnv">qgraf</span>, <span class="ts">"'"</span>]];
  <span class="tnvc">result</span> = <a class="tnv" href="utils.html#SafeGet">SafeGet</a>[<span class="tnvc">tmpdir</span> &lt;&gt; <span class="ts">"/output.m"</span>];
  <a class="tnv" href="utils.html#EnsureNoDirectory">EnsureNoDirectory</a>[<span class="tnvc">tmpdir</span>];
  <span class="tnvc">result</span>
]
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#Diagrams">Diagrams</a>] = {<span class="tnv">QGraf</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>, <span class="tnv">QGrafModel</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>, <span class="tnv">QGrafOptions</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>, <span class="tnv">MasslessFieldPattern</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>};</pre>
<p>By default look for QGraf in PATH.</p>
<pre><a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">$QGraf</span>, <span class="tnt">_String</span>]], <span class="tnv">$QGraf</span> = <span class="ts">"qgraf"</span>; ];</pre>
<h2 id="DiagramsToGraphs">Diagrams to graphs</h2>
<h3 id="DiagramGraphEdges"><code>DiagramGraphEdges[]</code></h3>
<p>Convert a diagram to a list of undirected edges.</p>
<pre><a class="tnv" href="#DiagramGraphEdges">DiagramGraphEdges</a>[<span class="tnv">Diagram</span>[_, _, <span class="tnt">i_List</span>, <span class="tnt">o_List</span>, <span class="tnt">p_List</span>, _]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
  <span class="tnv">p</span> /. <span class="tnv">P</span>[<span class="tnt">f_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">Internal</span>[<span class="tnv">vi1</span>] &lt;-&gt; <span class="tnv">Internal</span>[<span class="tnv">vi2</span>],
  <span class="tnv">i</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">Incoming</span>[<span class="tnv">fi</span>] &lt;-&gt; <span class="tnv">Internal</span>[<span class="tnv">vi</span>],
  <span class="tnv">o</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">Internal</span>[<span class="tnv">vi</span>] &lt;-&gt; <span class="tnv">Outgoing</span>[<span class="tnv">fi</span>]
]</pre>
<h3 id="DiagramGraph"><code>DiagramGraph[]</code></h3>
<p>Convert a diagram to an undirected <code>Graph</code> object.</p>
<pre><a class="tnv" href="#DiagramGraph">DiagramGraph</a>[<span class="tnt">d_Diagram</span>] := <a class="tnv" href="#DiagramGraphEdges">DiagramGraphEdges</a>[<span class="tnv">d</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Graph.html" rel="nofollow">Graph</a>
<a class="tnv" href="#DiagramGraph">DiagramGraph</a>[<span class="tnv">CutDiagram</span>[<span class="tnt">d1_Diagram</span>, <span class="tnt">d2_Diagram</span>]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">e1</span>, <span class="tnvc">e2</span>, <span class="tnvc">x</span>},
  <span class="tnvc">e1</span> = <a class="tnv" href="#DiagramGraphEdges">DiagramGraphEdges</a>[<span class="tnv">d1</span>];
  <span class="tnvc">e2</span> = <a class="tnv" href="#DiagramGraphEdges">DiagramGraphEdges</a>[<span class="tnv">d2</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
    <span class="tnvc">e1</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[_ &lt;-&gt; <span class="tnt">_Outgoing</span>],
    <span class="tnvc">e2</span> /.
      <span class="tnv">Incoming</span> -&gt; <span class="tnv">Incoming2</span> /.
      <span class="tnv">Internal</span> -&gt; <span class="tnv">Internal2</span> /.
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnvc">e1</span>, (<span class="tnt">i_</span> &lt;-&gt; <span class="tnt">e_Outgoing</span>) :&gt; ((<span class="tnt">x_</span> &lt;-&gt; <span class="tnv">e</span>) :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Style.html" rel="nofollow">Style</a>[<span class="tnvc">x</span> &lt;-&gt; <span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Dashed.html" rel="nofollow">Dashed</a>])]
  ]
]</pre>
<h3 id="DiagramXGraph"><code>DiagramXGraph[]</code></h3>
<p>Convert a diagram to an [[XGraph]] object, with informational
labels on each edge.</p>
<pre><a class="tnv" href="#DiagramXGraph">DiagramXGraph</a>[<span class="tnv">Diagram</span>[_, _, <span class="tnt">i_List</span>, <span class="tnt">o_List</span>, <span class="tnt">p_List</span>, _]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
   <span class="tnv">i</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">IN</span>[<span class="tnv">fi</span>] -&gt; <span class="tnv">vi</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span>, <span class="ts">")"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>]],
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Gray.html" rel="nofollow">Gray</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Thin.html" rel="nofollow">Thin</a>},
   <span class="tnv">o</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">vi</span> -&gt; <span class="tnv">OO</span>[<span class="tnv">fi</span>],
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span>, <span class="ts">")"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>]],
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Gray.html" rel="nofollow">Gray</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Thin.html" rel="nofollow">Thin</a>},
   <span class="tnv">p</span> /. <span class="tnv">P</span>[<span class="tnt">f_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">vi1</span> -&gt; <span class="tnv">vi2</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span>, <span class="ts">")"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>]],
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Switch.html" rel="nofollow">Switch</a>[<span class="tnv">f</span>, <span class="tnv">q</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Thickness.html" rel="nofollow">Thickness</a>[<span class="tl">0.01</span>], _, {}]}
   ] // <span class="tnv">XGraph</span></pre>
<h3 id="DiagramToGraphviz"><code>DiagramToGraphviz[]</code></h3>
<p>Convert a diagram to a source code for a Graphviz <code>digraph</code> object.</p>
<pre><a class="tnv" href="#DiagramToGraphviz">DiagramToGraphviz</a>[<span class="tnv">Diagram</span>[<span class="tnt">id_</span>, _, <span class="tnt">i_List</span>, <span class="tnt">o_List</span>, <span class="tnt">p_List</span>, _]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{},
  <a class="tnv" href="utils.html#MkString">MkString</a>[
   <span class="ts">"digraph {\n"</span>,
   <span class="ts">" fontsize=12; margin=0;\n"</span>,
   <span class="ts">" node [shape=circle width=0.1 color=black];\n"</span>,
   <span class="ts">" edge [fontsize=8; colorscheme=paired12];\n"</span>,
   <span class="tnv">i</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">fi</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">" "</span>, <span class="tnv">#</span>, <span class="ts">" [width=0.05 color=gray];\n"</span>} &amp;],
   <span class="tnv">o</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">fi</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">" "</span>, <span class="tnv">#</span>, <span class="ts">" [width=0.05 color=gray];\n"</span>} &amp;],
   <span class="tnv">i</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
     <span class="ts">" "</span>, <span class="tnv">fi</span>, <span class="ts">" -&gt; "</span>, <span class="tnv">vi</span>,
     <span class="ts">" [label=\""</span>, <span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>], <span class="ts">")\",color="</span>, <a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnv">f</span>] - <span class="tl">1</span>, <span class="ts">"];\n"</span>},
   <span class="tnv">p</span> /. <span class="tnv">P</span>[<span class="tnt">f_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; {
     <span class="ts">" "</span>, <span class="tnv">vi1</span>, <span class="ts">" -&gt; "</span>, <span class="tnv">vi2</span>,
     <span class="ts">" [label=\""</span>, <span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>], <span class="ts">")\",color="</span>, <a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnv">f</span>], <span class="ts">",style=bold];\n"</span>},
   <span class="tnv">o</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
     <span class="ts">" "</span>, <span class="tnv">vi</span>, <span class="ts">" -&gt; "</span>, <span class="tnv">fi</span>,
     <span class="ts">" [label=\""</span>, <span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>], <span class="ts">")\",color="</span>, <a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnv">f</span>] - <span class="tl">1</span>, <span class="ts">"];\n"</span>},
   <span class="ts">"}\n"</span>
   ]
]
<a class="tnv" href="#DiagramToGraphviz">DiagramToGraphviz</a>[<span class="tnv">CutDiagram</span>[
  <span class="tnv">Diagram</span>[<span class="tnt">id1_</span>, _, <span class="tnt">i1_List</span>, <span class="tnt">o1_List</span>, <span class="tnt">p1_List</span>, <span class="tnt">v1_List</span>], <span class="tnv">Diagram</span>[<span class="tnt">id2_</span>, _, <span class="tnt">i2_List</span>, <span class="tnt">o2_List</span>, <span class="tnt">p2_List</span>, <span class="tnt">v2_List</span>]
]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{},
  <a class="tnv" href="utils.html#MkString">MkString</a>[
   <span class="ts">"digraph {\n"</span>,
   <span class="ts">" fontsize=12; margin=0; label_scheme=2;\n"</span>,
   <span class="ts">" node [shape=circle width=0.1 color=black];\n"</span>,
   <span class="ts">" edge [fontsize=8; colorscheme=paired12];\n"</span>,
   <span class="tnv">i1</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">fi</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">" "</span>, <span class="tnv">#</span>, <span class="ts">"01 [fontsize=10 width=0.05 color=gray label=\""</span>, <span class="tnv">#</span>, <span class="ts">"\"];\n"</span>} &amp;],
   <span class="tnv">i2</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">fi</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">" "</span>, <span class="tnv">#</span>, <span class="ts">"02 [fontsize=10 width=0.05 color=gray label=\""</span>, <span class="tnv">#</span>, <span class="ts">"'\"];\n"</span>} &amp;],
   <span class="tnv">v1</span> /. <span class="tnv">V</span>[<span class="tnt">id_</span>, ___] :&gt; <span class="tnv">id</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">" "</span>, <span class="tnv">#</span>, <span class="ts">"01 [label=\""</span>, <span class="tnv">#</span>, <span class="ts">"\"];\n"</span>} &amp;],
   <span class="tnv">v2</span> /. <span class="tnv">V</span>[<span class="tnt">id_</span>, ___] :&gt; <span class="tnv">id</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">" "</span>, <span class="tnv">#</span>, <span class="ts">"02 [label=\""</span>, <span class="tnv">#</span>, <span class="ts">"'\"];\n"</span>} &amp;],
   <span class="tnv">o1</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">fi</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">" \"|edgelabel|"</span>, -<span class="tnv">#</span>, <span class="ts">"00\" [fontsize=10 width=0.05 shape=square color=gray label=\""</span>, <span class="tnv">#</span>, <span class="ts">"\"];\n"</span>} &amp;],
   <span class="tnv">i1</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
     <span class="ts">" "</span>, <span class="tnv">fi</span>, <span class="ts">"01 -&gt; "</span>, <span class="tnv">vi</span>, <span class="ts">"01"</span>,
     <span class="ts">"[label=\""</span>, <span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>], <span class="ts">")\",color="</span>, <a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnv">f</span>] - <span class="tl">1</span>, <span class="ts">"];\n"</span>
   },
   <span class="tnv">i2</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
     <span class="ts">" "</span>, <span class="tnv">fi</span>, <span class="ts">"02 -&gt; "</span>, <span class="tnv">vi</span>, <span class="ts">"02"</span>,
     <span class="ts">"[label=\""</span>, <span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>], <span class="ts">")\",color="</span>, <a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnv">f</span>] - <span class="tl">1</span>, <span class="ts">"];\n"</span>
   },
   <span class="tnv">p1</span> /. <span class="tnv">P</span>[<span class="tnt">f_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; {
     <span class="ts">" "</span>, <span class="tnv">vi1</span>, <span class="ts">"01 -&gt; "</span>, <span class="tnv">vi2</span>, <span class="ts">"01"</span>,
     <span class="ts">" [label=\""</span>, <span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>], <span class="ts">")\",color="</span>, <a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnv">f</span>], <span class="ts">",style=bold];\n"</span>
   },
   <span class="tnv">p2</span> /. <span class="tnv">P</span>[<span class="tnt">f_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; {
     <span class="ts">" "</span>, <span class="tnv">vi1</span>, <span class="ts">"02 -&gt; "</span>, <span class="tnv">vi2</span>, <span class="ts">"02"</span>,
     <span class="ts">" [label=\""</span>, <span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>], <span class="ts">")\",color="</span>, <a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnv">f</span>], <span class="ts">",style=bold];\n"</span>
   },
   <span class="tnv">o1</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
     <span class="ts">" "</span>, <span class="tnv">vi</span>, <span class="ts">"01 -&gt; \"|edgelabel|"</span>, -<span class="tnv">fi</span>, <span class="ts">"00\""</span>,
     <span class="ts">" [label=\""</span>, <span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>], <span class="ts">")\",color="</span>, <a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnv">f</span>] - <span class="tl">1</span>, <span class="ts">"];\n"</span>
   },
   <span class="tnv">o2</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
     <span class="ts">" "</span>, <span class="tnv">vi</span>, <span class="ts">"02 -&gt; \"|edgelabel|"</span>, -<span class="tnv">fi</span>, <span class="ts">"00\""</span>,
     <span class="ts">" [label=\""</span>, <span class="tnv">f</span>, <span class="ts">"("</span>, <span class="tnv">mom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>], <span class="ts">")\",color="</span>, <a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnv">f</span>] - <span class="tl">1</span>, <span class="ts">"];\n"</span>
   },
   <span class="ts">"}\n"</span>
   ]
]</pre>
<h3 id="FieldGraphvizColor"><code>FieldGraphvizColor[]</code></h3>
<p>Default Graphviz style for all fields. Styles for specific
fields should be defined by the model files.</p>
<pre><a class="tnv" href="#FieldGraphvizColor">FieldGraphvizColor</a>[<span class="tnt">field_</span>] = <span class="tl">12</span>;</pre>
<h3 id="DiagramViz"><code>DiagramViz[]</code></h3>
<p>Use Graphviz to convert a diagram into a <code>Graphics</code> object.
Useful for visualization.</p>
<pre><a class="tnv" href="#DiagramViz">DiagramViz</a>[<span class="tnv">d</span>:(<span class="tnt">_Diagram</span>|<span class="tnt">_CutDiagram</span>)] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">tmp</span>, <span class="tnvc">pdf</span>, <span class="tnvc">result</span>},
  <span class="tnvc">tmp</span> = <a class="tnv" href="utils.html#MkTemp">MkTemp</a>[<span class="ts">"diavis"</span>, <span class="ts">".gv"</span>];
  <span class="tnvc">pdf</span> = <span class="tnvc">tmp</span> &lt;&gt; <span class="ts">".pdf"</span>;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Export.html" rel="nofollow">Export</a>[<span class="tnvc">tmp</span>, <a class="tnv" href="#DiagramToGraphviz">DiagramToGraphviz</a>[<span class="tnv">d</span>], <span class="ts">"String"</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Run.html" rel="nofollow">Run</a>[<span class="ts">"neato -Tpdf -o"</span>, <span class="tnvc">pdf</span>, <span class="tnvc">tmp</span>];
  <span class="tnvc">result</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Import.html" rel="nofollow">Import</a>[<span class="tnvc">pdf</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteFile.html" rel="nofollow">DeleteFile</a>[{<span class="tnvc">tmp</span>, <span class="tnvc">pdf</span>}];
  <span class="tnvc">result</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>
]</pre>
<h3 id="GraphLayoutVertexCoordinates"><code>GraphLayoutVertexCoordinates[]</code></h3>
<p>Take a graph defined by edges (pairs of nodes) and produce
coordinates for all vertices by calling Graphviz (sfpd).</p>
<p>Example:</p>
<pre class="doc"><span class="tnb">In</span>[]:= <a class="tnv" href="#GraphLayoutVertexCoordinates">GraphLayoutVertexCoordinates</a>[{{<span class="tl">1</span>,<span class="tl">2</span>},{<span class="tl">1</span>,<span class="tl">3</span>},{<span class="tl">2</span>,<span class="tl">3</span>}}]
<span class="tnb">Out</span>[]= {<span class="tl">1</span> -&gt; {<span class="tl">272.32</span>, <span class="tl">243.6</span>},
        <span class="tl">2</span> -&gt; {<span class="tl">27</span>, <span class="tl">214.2</span>},
        <span class="tl">3</span> -&gt; {<span class="tl">175.3</span>, <span class="tl">18</span>}}
</pre>

<pre><a class="tnv" href="#GraphLayoutVertexCoordinates">GraphLayoutVertexCoordinates</a>[<span class="tnv">edges</span>:{{_,_} ...}] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">tmp</span>, <span class="tnvc">out</span>, <span class="tnvc">result</span>, <span class="tnvc">VertexToName</span>, <span class="tnvc">NameToVertex</span>, <span class="tnvc">nameidx</span>},
  <span class="tnvc">tmp</span> = <a class="tnv" href="utils.html#MkTemp">MkTemp</a>[<span class="ts">"graph"</span>, <span class="ts">".gv"</span>];
  <span class="tnvc">out</span> = <span class="tnvc">tmp</span> &lt;&gt; <span class="ts">".json"</span>;
  <span class="tnvc">nameidx</span> = <span class="tl">0</span>;
  <span class="tnvc">VertexToName</span>[<span class="tnt">v_</span>] := <span class="tnvc">VertexToName</span>[<span class="tnv">v</span>] = (
    <span class="tnvc">NameToVertex</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnvc">nameidx</span>]] = <span class="tnv">v</span>;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnvc">nameidx</span>++]
  );
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">tmp</span>,
    <span class="ts">"graph {\n"</span>,
    <span class="tnv">edges</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
      {<span class="tnt">a_</span>, <span class="tnt">b_</span>} :&gt; {<span class="ts">" "</span>, <span class="tnvc">VertexToName</span>[<span class="tnv">a</span>], <span class="ts">" -- "</span>, <span class="tnvc">VertexToName</span>[<span class="tnv">b</span>], <span class="ts">";\n"</span>}
    ],
    <span class="ts">"}\n"</span>
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Run.html" rel="nofollow">Run</a>[<span class="ts">"cat "</span> &lt;&gt; <span class="tnvc">tmp</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Run.html" rel="nofollow">Run</a>[<span class="ts">"sfdp -Tjson -o"</span>, <span class="tnvc">out</span>, <span class="tnvc">tmp</span>];
  <span class="tnvc">result</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Import.html" rel="nofollow">Import</a>[<span class="tnvc">out</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteFile.html" rel="nofollow">DeleteFile</a>[{<span class="tnvc">tmp</span>, <span class="tnvc">out</span>}];
  <span class="ts">"objects"</span> /. <span class="tnvc">result</span> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[
      <span class="tnvc">NameToVertex</span>[<span class="ts">"name"</span> /. <span class="tnv">#</span>] -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"{"</span>, <span class="ts">"pos"</span> /. <span class="tnv">#</span>, <span class="ts">"}"</span>]]&amp;
    ]
]</pre>
<h3 id="NormalizeCoordinates"><code>NormalizeCoordinates[]</code></h3>
<p>Scale and rotate the coordinates (in the format returned
by <a href="#GraphLayoutVertexCoordinates">GraphLayoutVertexCoordinates</a>) so that the <code>left</code>
vertices end up on the left, the <code>right</code> on the right, and
the distance between them is <code>scale</code>.</p>
<pre><a class="tnv" href="#NormalizeCoordinates">NormalizeCoordinates</a>[<span class="tnt">coordmap_</span>, <span class="tnt">left_List</span>, <span class="tnt">right_List</span>, <span class="tnt">scale_</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">l</span>, <span class="tnvc">r</span>, <span class="tnvc">angle</span>, <span class="tnvc">rotationmx</span>, <span class="tnvc">coordmap3</span>, <span class="tnvc">scalefactor</span>},
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/AllTrue.html" rel="nofollow">AllTrue</a>[<span class="tnv">left</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/KeyExistsQ.html" rel="nofollow">KeyExistsQ</a>[<span class="tnv">coordmap</span>, <span class="tnv">#</span>]&amp;]];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/AllTrue.html" rel="nofollow">AllTrue</a>[<span class="tnv">right</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/KeyExistsQ.html" rel="nofollow">KeyExistsQ</a>[<span class="tnv">coordmap</span>, <span class="tnv">#</span>]&amp;]];
  <span class="tnvc">l</span> = <span class="tnv">left</span> /. <span class="tnv">coordmap</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Mean.html" rel="nofollow">Mean</a>;
  <span class="tnvc">r</span> = <span class="tnv">right</span> /. <span class="tnv">coordmap</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Mean.html" rel="nofollow">Mean</a>;
  <span class="tnvc">angle</span> = <span class="tnvc">r</span> - <span class="tnvc">l</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ArcTan.html" rel="nofollow">ArcTan</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a>;
  <span class="tnvc">rotationmx</span> = {{<a class="tnb" href="https://reference.wolfram.com/language/ref/Cos.html" rel="nofollow">Cos</a>[<span class="tnvc">angle</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Sin.html" rel="nofollow">Sin</a>[<span class="tnvc">angle</span>]}, {-<a class="tnb" href="https://reference.wolfram.com/language/ref/Sin.html" rel="nofollow">Sin</a>[<span class="tnvc">angle</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Cos.html" rel="nofollow">Cos</a>[<span class="tnvc">angle</span>]}};
  <span class="tnv">coordmap2</span> = <span class="tnv">coordmap</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnvc">rotationmx</span>.(<span class="tnv">#</span> - <span class="tnvc">l</span>)&amp;];
  <span class="tnvc">l</span> = <span class="tnv">left</span> /. <span class="tnv">coordmap2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Min.html" rel="nofollow">Min</a>;
  <span class="tnvc">r</span> = <span class="tnv">right</span> /. <span class="tnv">coordmap2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>;
  <span class="tnvc">scalefactor</span> = <span class="tnv">scale</span>/{<span class="tnvc">r</span>-<span class="tnvc">l</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnv">coordmap2</span>[[;;,<span class="tl">2</span>]]] - <a class="tnb" href="https://reference.wolfram.com/language/ref/Min.html" rel="nofollow">Min</a>[<span class="tnv">coordmap2</span>[[;;,<span class="tl">2</span>]]]} // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a>;
  <span class="tnv">coordmap2</span> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnvc">scalefactor</span> (<span class="tnv">#</span> - {(<span class="tnvc">l</span>+<span class="tnvc">r</span>)/<span class="tl">2</span>, <span class="tl">0</span>})&amp;] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>
]</pre>
<h2 id="TikzInterfaceForDiagrams">TikZ interface for diagrams</h2>
<h3 id="DiagramToTikZ"><code>DiagramToTikZ[]</code></h3>
<p>Convert a diagram into TikZ, somewhat badly. It is expected
that the user will manually edit the TikZ source afterwards
using e.g. <a href="https://tikzit.github.io/">TikZiT</a>.</p>
<pre><a class="tnv" href="#DiagramToTikZ">DiagramToTikZ</a>[<span class="tnv">Diagram</span>[<span class="tnt">id_</span>, _, <span class="tnt">i_List</span>, <span class="tnt">o_List</span>, <span class="tnt">p_List</span>, <span class="tnt">v_List</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">pstyles</span>, <span class="tnvc">ni</span>, <span class="tnvc">no</span>, <span class="tnvc">coords</span>, <span class="tnvc">scale</span>, <span class="tnvc">external</span>},
  <span class="tnvc">pstyles</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">PropagatorStyles</span>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#</span> =!= <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>, <span class="tnv">#</span>, <span class="tnv">p</span> /. <span class="tnv">P</span>[<span class="tnt">f_</span>, ___] :&gt; <a class="tnv" href="#FieldTikZStyle">FieldTikZStyle</a>[<span class="tnv">f</span>]]&amp;;
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">p</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">pstyles</span>]];
  <span class="tnvc">ni</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">i</span>];
  <span class="tnvc">no</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">o</span>];
  <span class="tnvc">scale</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">ni</span>,<span class="tnvc">no</span>,<span class="tl">4</span>];
  <span class="tnvc">scale</span> = {<span class="tl">2.0</span>,<span class="tl">1.5</span>};
  <span class="tnvc">external</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
      <span class="tnv">i</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<span class="tnv">fi</span>, <span class="tnvc">scale</span> {-<span class="tl">1</span>/<span class="tl">2</span> - <span class="tl">1</span>/<span class="tl">2</span>/<span class="tnvc">scale</span>[[<span class="tl">1</span>]], <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">ni</span>&lt;=<span class="tl">1</span>,<span class="tl">0</span>,(<span class="tnv">fi</span>+<span class="tl">1</span>)/<span class="tl">2</span>/(<span class="tnvc">ni</span>-<span class="tl">1</span>)+<span class="tl">1</span>/<span class="tl">2</span>]} // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a>],
      <span class="tnv">o</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<span class="tnv">fi</span>, <span class="tnvc">scale</span> {+<span class="tl">1</span>/<span class="tl">2</span> + <span class="tl">1</span>/<span class="tl">2</span>/<span class="tnvc">scale</span>[[<span class="tl">1</span>]], <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">no</span>&lt;=<span class="tl">1</span>,<span class="tl">0</span>,(<span class="tnv">fi</span>+<span class="tl">2</span>)/<span class="tl">2</span>/(<span class="tnvc">no</span>-<span class="tl">1</span>)+<span class="tl">1</span>/<span class="tl">2</span>]} // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a>]
  ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>;
  <span class="tnvc">coords</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Graph.html" rel="nofollow">Graph</a>[
      <span class="tnv">v</span> /. <span class="tnv">V</span>[<span class="tnt">vi_</span>, __] :&gt; <span class="tnv">vi</span>,
      <span class="tnv">p</span> /. <span class="tnv">P</span>[<span class="tnt">f_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">vi1</span> &lt;-&gt; <span class="tnv">vi2</span>
    ] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/GraphEmbedding.html" rel="nofollow">GraphEmbedding</a>[<span class="tnv">#</span>, <span class="ts">"SpringEmbedding"</span>]&amp; //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>, {<span class="tnv">v</span> /. <span class="tnv">V</span>[<span class="tnt">vi_</span>, __] :&gt; <span class="tnv">vi</span>, <span class="tnv">#</span>}]&amp; //
    <a class="tnv" href="#NormalizeCoordinates">NormalizeCoordinates</a>[<span class="tnv">#</span>,
      <span class="tnv">i</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">vi</span>,
      <span class="tnv">o</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <span class="tnv">vi</span>,
      <span class="tnvc">scale</span>]&amp; //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>@@(<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">i</span>, <span class="tnv">o</span>] /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/EuclideanDistance.html" rel="nofollow">EuclideanDistance</a>[<span class="tnv">#</span>[<span class="tnv">vi</span>]*{<span class="tl">1</span>,+<span class="tl">1</span>}, <span class="tnvc">external</span>[<span class="tnv">fi</span>]]^<span class="tl">2</span>) &gt;
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>@@(<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">i</span>, <span class="tnv">o</span>] /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/EuclideanDistance.html" rel="nofollow">EuclideanDistance</a>[<span class="tnv">#</span>[<span class="tnv">vi</span>]*{<span class="tl">1</span>,-<span class="tl">1</span>}, <span class="tnvc">external</span>[<span class="tnv">fi</span>]]^<span class="tl">2</span>),
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span>*{<span class="tl">1</span>,+<span class="tl">1</span>}&amp;, <span class="tnv">#</span>],
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span>*{<span class="tl">1</span>,-<span class="tl">1</span>}&amp;, <span class="tnv">#</span>]
    ]&amp; //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnvc">external</span>, <span class="tnv">#</span>]&amp;;
  <a class="tnv" href="utils.html#MkString">MkString</a>[
    <span class="ts">"\\begin{tikzpicture}\n"</span>,
    <span class="ts">"\t\\begin{pgfonlayer}{nodelayer}\n"</span>,
    <span class="tnv">i</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
      <span class="ts">"\t\t\\node [style=none] ("</span>, <span class="tnv">fi</span>, <span class="ts">") at ("</span>,
        <span class="tnvc">coords</span>[<span class="tnv">fi</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Round.html" rel="nofollow">Round</a>[<span class="tnv">#</span>, <span class="tl">0.25</span>]&amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#FormatFixed">FormatFixed</a>[<span class="tl">2</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">","</span>]&amp;,
      <span class="ts">") {};\n"</span>
    },
    <span class="tnv">o</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
      <span class="ts">"\t\t\\node [style=none] ("</span>, <span class="tnv">fi</span>, <span class="ts">") at ("</span>,
        <span class="tnvc">coords</span>[<span class="tnv">fi</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Round.html" rel="nofollow">Round</a>[<span class="tnv">#</span>, <span class="tl">0.25</span>]&amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#FormatFixed">FormatFixed</a>[<span class="tl">2</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">","</span>]&amp;,
      <span class="ts">") {};\n"</span>
    },
    <span class="tnv">v</span> /. <span class="tnv">V</span>[<span class="tnt">vi_</span>, __] :&gt; {
      <span class="ts">"\t\t\\node [style=dot] ("</span>, <span class="tnv">vi</span>, <span class="ts">") at ("</span>, 
        <span class="tnvc">coords</span>[<span class="tnv">vi</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Round.html" rel="nofollow">Round</a>[<span class="tnv">#</span>, <span class="tl">0.25</span>]&amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#FormatFixed">FormatFixed</a>[<span class="tl">2</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">","</span>]&amp;,
      <span class="ts">") {};\n"</span>
    },
    <span class="ts">"\t\\end{pgfonlayer}\n"</span>,
    <span class="ts">"\t\\begin{pgfonlayer}{edgelayer}\n"</span>,
    <span class="tnv">i</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
      <span class="ts">"\t\t\\draw [style=incoming "</span>, <a class="tnv" href="#FieldTikZStyle">FieldTikZStyle</a>[<span class="tnv">f</span>], <span class="ts">"] ("</span>, <span class="tnv">fi</span>, <span class="ts">") to ("</span>, <span class="tnv">vi</span>, <span class="ts">");\n"</span>
    },
    <span class="tnv">o</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {
      <span class="ts">"\t\t\\draw [style=outgoing "</span>, <a class="tnv" href="#FieldTikZStyle">FieldTikZStyle</a>[<span class="tnv">f</span>], <span class="ts">"] ("</span>, <span class="tnv">vi</span>, <span class="ts">") to ("</span>, <span class="tnv">fi</span>, <span class="ts">");\n"</span>
    },
    {<span class="tnv">p</span>, <span class="tnvc">pstyles</span>} // <a class="tnb" href="https://reference.wolfram.com/language/ref/Transpose.html" rel="nofollow">Transpose</a> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
      {<span class="tnv">P</span>[<span class="tnt">f_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>], <span class="tnt">s_</span>} :&gt;
        {<span class="ts">"\t\t\\draw [style="</span>, <span class="tnv">s</span>, <span class="ts">"] ("</span>, <span class="tnv">vi1</span>, <span class="ts">") to ("</span>, <span class="tnv">vi2</span>, <span class="ts">");\n"</span>}
    ],
    <span class="ts">"\t\\end{pgfonlayer}\n"</span>,
    <span class="ts">"\\end{tikzpicture}\n"</span>
  ]
]
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#DiagramToTikZ">DiagramToTikZ</a>] = {<span class="tnv">PropagatorStyles</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>};</pre>
<h3 id="FieldTikZStyle"><code>FieldTikZStyle[]</code></h3>
<p>Default TikZ style for all fields. Styles for specific fields
should be defined by the model files.</p>
<pre><a class="tnv" href="#FieldTikZStyle">FieldTikZStyle</a>[<span class="tnt">field_</span>] = <span class="ts">"edge"</span>;</pre>
<h3 id="MkTikZGraph"><code>MkTikZGraph[]</code></h3>
<p>Create a TikZ graph file from the given edges and labels.</p>
<pre><a class="tnv" href="#MkTikZGraph">MkTikZGraph</a>[<span class="tnt">filename_String</span>, <span class="tnt">dx_</span>, <span class="tnt">dy_</span>, <span class="tnt">vleft_</span>, <span class="tnt">vright_</span>, <span class="tnv">edges</span>:{{_, _, _} ...}, <span class="tnv">labels</span>:{{_, _, _, _}...}] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">vertexcoords</span>, <span class="tnvc">outer</span>, <span class="tnvc">inner</span>, <span class="tnvc">sx</span>, <span class="tnvc">sy</span>, <span class="tnvc">x1</span>, <span class="tnvc">y1</span>, <span class="tnvc">x2</span>, <span class="tnvc">y2</span>, <span class="tnvc">x</span>, <span class="tnvc">y</span>, <span class="tnvc">bends</span>, <span class="tnvc">b</span>, <span class="tnvc">e</span>, <span class="tnvc">i</span>},
  <span class="tnvc">vertexcoords</span> = <span class="tnv">edges</span>[[;;,;;<span class="tl">2</span>]] // <a class="tnv" href="#GraphLayoutVertexCoordinates">GraphLayoutVertexCoordinates</a>//<a class="tnb" href="https://reference.wolfram.com/language/ref/MapAt.html" rel="nofollow">MapAt</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>, <span class="tnv">#</span>, {;;,<span class="tl">1</span>}]&amp;;
  <span class="tc">(* Shorten outer legs by a half. *)</span>
  <span class="tnvc">outer</span> = <span class="tnv">edges</span>[[;;,;;<span class="tl">2</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">edges</span>, {<span class="tnv">#</span>, _, _}|{_, <span class="tnv">#</span>, _}] === <span class="tl">1</span>&amp;];
  <span class="tnvc">inner</span> = <span class="tnvc">outer</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnv">edges</span>, {<span class="tnv">#</span>, <span class="tnt">v_</span>, _}|{<span class="tnt">v_</span>, <span class="tnv">#</span>, _} :&gt; <span class="tnv">v</span>]&amp; /* <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>];
  <span class="tnvc">vertexcoords</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<span class="tnv">#1</span>-&gt;(<span class="tnv">#2</span>+<span class="tnv">#3</span>)/<span class="tl">2</span>&amp;, {<span class="tnvc">outer</span>, <span class="tnvc">outer</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">vertexcoords</span>]], <span class="tnvc">inner</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">vertexcoords</span>]]}],
    <span class="tnvc">vertexcoords</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnvc">outer</span>, _]]
  ];
  <span class="tc">(* Scale the diagram to desired size *)</span>
  <span class="tnvc">sx</span> = <span class="tnvc">vertexcoords</span> // <span class="tnv">#</span>[[;;,<span class="tl">2</span>,<span class="tl">1</span>]]&amp; // <span class="tnv">dx</span>/(<span class="tl">1</span> + <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnv">#</span>] - <a class="tnb" href="https://reference.wolfram.com/language/ref/Min.html" rel="nofollow">Min</a>[<span class="tnv">#</span>])&amp;;
  <span class="tnvc">sy</span> = <span class="tnvc">vertexcoords</span> // <span class="tnv">#</span>[[;;,<span class="tl">2</span>,<span class="tl">2</span>]]&amp; // <span class="tnv">dy</span>/(<span class="tl">1</span> + <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnv">#</span>] - <a class="tnb" href="https://reference.wolfram.com/language/ref/Min.html" rel="nofollow">Min</a>[<span class="tnv">#</span>])&amp;;
  {<span class="tnvc">x1</span>, <span class="tnvc">y1</span>} = <span class="tnv">vleft</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">vertexcoords</span>];
  {<span class="tnvc">x2</span>, <span class="tnvc">y2</span>} = <span class="tnv">vright</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">vertexcoords</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">x2</span> &lt; <span class="tnvc">x1</span>, <span class="tnvc">sx</span> = -<span class="tnvc">sx</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">y2</span> &lt; <span class="tnvc">y1</span>, <span class="tnvc">sy</span> = -<span class="tnvc">sy</span>];
  <span class="tnvc">vertexcoords</span> = <span class="tnvc">vertexcoords</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<span class="tnt">v_</span>, {<span class="tnt">x_</span>, <span class="tnt">y_</span>}] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<span class="tnv">v</span>, {(<span class="tnvc">x</span> - <span class="tnvc">x1</span>)*<span class="tnvc">sx</span>, (<span class="tnvc">y</span> - <span class="tnvc">y1</span>)*<span class="tnvc">sy</span> }]];
  <span class="tnvc">bends</span> = &lt;|
    <span class="tl">1</span> -&gt; {<span class="ts">""</span>},
    <span class="tl">2</span> -&gt; {<span class="ts">", bend right"</span>, <span class="ts">", bend left"</span>},
    <span class="tl">3</span> -&gt; {<span class="ts">", bend right=45"</span>, <span class="ts">""</span>, <span class="ts">", bend left=45"</span>},
    <span class="tl">4</span> -&gt; {<span class="ts">", bend right=75, looseness=1.25"</span>, <span class="ts">", bend right"</span>, <span class="ts">", bend left"</span>, <span class="ts">", bend left=75, looseness=1.25"</span>},
    <span class="tl">5</span> -&gt; {<span class="ts">", bend right=75, looseness=1.25"</span>, <span class="ts">", bend right=45"</span>, <span class="ts">""</span>, <span class="ts">", bend left=45"</span>, <span class="ts">", bend left=75, looseness=1.25"</span>}
  |&gt;;
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnv">filename</span>,
    <span class="ts">"\\begin{tikzpicture}\n"</span>,
    <span class="ts">"\t\\begin{pgfonlayer}{nodelayer}\n"</span>,
    <span class="tnvc">vertexcoords</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[(<span class="tnt">v_</span> -&gt; {<span class="tnt">x_</span>, <span class="tnt">y_</span>}) :&gt;
      {<span class="ts">"\t\t\\node [style="</span>, <span class="tnv">v</span> /. { <a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnvc">outer</span> -&gt; <span class="ts">"none"</span>, _ -&gt; <span class="ts">"dot"</span>}, <span class="ts">"] ("</span>, <span class="tnv">v</span>, <span class="ts">") at ("</span>,
        <span class="tnvc">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Round.html" rel="nofollow">Round</a>[<span class="tnv">#</span>, <span class="tl">0.25</span>]&amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/NumberForm.html" rel="nofollow">NumberForm</a>[<span class="tnv">#</span>, {<a class="tnb" href="https://reference.wolfram.com/language/ref/Infinity.html" rel="nofollow">Infinity</a>,<span class="tl">3</span>}]&amp;, <span class="ts">", "</span>,
        <span class="tnvc">y</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Round.html" rel="nofollow">Round</a>[<span class="tnv">#</span>, <span class="tl">0.25</span>]&amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/NumberForm.html" rel="nofollow">NumberForm</a>[<span class="tnv">#</span>, {<a class="tnb" href="https://reference.wolfram.com/language/ref/Infinity.html" rel="nofollow">Infinity</a>,<span class="tl">3</span>}]&amp;, <span class="ts">") {};\n"</span>}
    ],
    <span class="tnv">labels</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{<span class="tnt">v1_</span>, <span class="tnt">v2_</span>, <span class="tnt">style_</span>, <span class="tnt">text_</span>} :&gt; (
      {<span class="tnvc">x</span>, <span class="tnvc">y</span>} = ((<span class="tnv">v1</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">vertexcoords</span>]) + (<span class="tnv">v2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">vertexcoords</span>]))/<span class="tl">2</span>;
      {<span class="ts">"\t\t\\node [style="</span>, <span class="tnv">style</span>, <span class="ts">"] ("</span>, <span class="tnv">v1</span>, <span class="ts">":"</span>, <span class="tnv">v2</span>, <span class="ts">") at ("</span>,
        <span class="tnvc">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Round.html" rel="nofollow">Round</a>[<span class="tnv">#</span>, <span class="tl">0.125</span>]&amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/NumberForm.html" rel="nofollow">NumberForm</a>[<span class="tnv">#</span>, {<a class="tnb" href="https://reference.wolfram.com/language/ref/Infinity.html" rel="nofollow">Infinity</a>,<span class="tl">3</span>}]&amp;, <span class="ts">", "</span>,
        <span class="tnvc">y</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Round.html" rel="nofollow">Round</a>[<span class="tnv">#</span>, <span class="tl">0.125</span>]&amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/NumberForm.html" rel="nofollow">NumberForm</a>[<span class="tnv">#</span>, {<a class="tnb" href="https://reference.wolfram.com/language/ref/Infinity.html" rel="nofollow">Infinity</a>,<span class="tl">3</span>}]&amp;, <span class="ts">") {"</span>, <span class="tnv">text</span>, <span class="ts">"};\n"</span>}
    )],
    <span class="ts">"	\\end{pgfonlayer}\n"</span>,
    <span class="ts">"	\\begin{pgfonlayer}{edgelayer}\n"</span>,
    <span class="tnv">edges</span> //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">#</span>[[;;<span class="tl">2</span>]]]&amp;] //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Values.html" rel="nofollow">Values</a> //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Function.html" rel="nofollow">Function</a>[{<span class="tnv">edgs</span>},
        <span class="tnvc">b</span> = <span class="tnvc">bends</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">edgs</span>]];
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
          <span class="tnvc">e</span> = <span class="tnv">edgs</span>[[<span class="tnvc">i</span>]];
          {<span class="ts">"\t\t\\draw [style="</span>, <span class="tnvc">e</span>[[<span class="tl">3</span>]], <span class="tnvc">b</span>[[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnvc">e</span>[[;;<span class="tl">2</span>]]]===<span class="tnvc">e</span>[[;;<span class="tl">2</span>]], <span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">edgs</span>]+<span class="tl">1</span>-<span class="tnvc">i</span>]]], <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">e</span>[[<span class="tl">1</span>]] === <span class="tnvc">e</span>[[<span class="tl">2</span>]], <span class="ts">", loop"</span>, <span class="ts">""</span>], <span class="ts">"] ("</span>, <span class="tnvc">e</span>[[<span class="tl">1</span>]], <span class="ts">") to ("</span>, <span class="tnvc">e</span>[[<span class="tl">2</span>]], <span class="ts">");\n"</span>},
          {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">edgs</span>]}
        ]
      ]],
    <span class="ts">"	\\end{pgfonlayer}\n"</span>,
    <span class="ts">"\\end{tikzpicture}\n"</span>
  ];
];</pre>
<h3 id="MkIntegralTikZ"><code>MkIntegralTikZ[]</code></h3>
<p>Create a TikZ file for an integral with given indices. The
indices should come in the same order as the propagators of
the diagram. Only non-negative indices work at the moment.</p>
<pre><a class="tnv" href="#MkIntegralTikZ">MkIntegralTikZ</a>[<span class="tnt">filename_String</span>, <span class="tnv">Diagram</span>[_, _, <span class="tnt">ifld_List</span>, <span class="tnt">ofld_List</span>, <span class="tnt">props_List</span>, <span class="tnt">verts_List</span>], <span class="tnt">indices_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">toremove</span>, <span class="tnvc">shrinkgr</span>, <span class="tnvc">vimap</span>},
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">props</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">indices</span>]];
  <span class="tnvc">toremove</span> = <span class="tnv">indices</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/PositionIndex.html" rel="nofollow">PositionIndex</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Lookup.html" rel="nofollow">Lookup</a>[<span class="tnv">#</span>, <span class="tl">0</span>, {}]&amp;;
  <span class="tnvc">vimap</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Graph.html" rel="nofollow">Graph</a>[<span class="tnv">verts</span>[[;;,<span class="tl">1</span>]], <span class="tnv">props</span>[[<span class="tnvc">toremove</span>, <span class="tl">4</span>;;<span class="tl">5</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/UndirectedEdge.html" rel="nofollow">UndirectedEdge</a>]]] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ConnectedComponents.html" rel="nofollow">ConnectedComponents</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">#</span>] &gt; <span class="tl">1</span>&amp;] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnv">#</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>[<span class="tnv">#</span>]&amp;];
  <span class="tnv">field2style</span> = {<span class="ts">"t"</span> -&gt; <span class="ts">"top"</span>, _ -&gt; <span class="ts">"edge"</span>};
  <span class="tnv">ifield2style</span> = {<span class="ts">"t"</span>|<span class="ts">"T"</span> -&gt; <span class="ts">"incoming top"</span>, _ -&gt; <span class="ts">"incoming"</span>};
  <span class="tnv">ofield2style</span> = {<span class="ts">"t"</span>|<span class="ts">"T"</span> -&gt; <span class="ts">"outgoing top"</span>, <span class="ts">"H"</span> -&gt; <span class="ts">"outgoing higgs"</span>, _ -&gt; <span class="ts">"outgoing"</span>};
  <a class="tnv" href="#MkTikZGraph">MkTikZGraph</a>[<span class="tnv">filename</span>, <span class="tl">3.0</span>, <span class="tl">2.0</span>, -<span class="tl">1</span>, -<span class="tl">2</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
      <span class="tnv">ifld</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">fi</span>, <span class="tnv">vi</span> /. <span class="tnvc">vimap</span>, <span class="tnv">f</span> /. <span class="tnv">ifield2style</span>},
      <span class="tnv">ofld</span> /. <span class="tnv">F</span>[<span class="tnt">f_</span>, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">vi</span> /. <span class="tnvc">vimap</span>, <span class="tnv">fi</span>, <span class="tnv">f</span> /. <span class="tnv">ofield2style</span>},
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Transpose.html" rel="nofollow">Transpose</a>[{<span class="tnv">props</span>, <span class="tnv">indices</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[{
        {<span class="tnt">_P</span>, <span class="tl">0</span>} :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>,
        {<span class="tnv">P</span>[<span class="tnt">f_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>], <span class="tl">1</span>} :&gt; {<span class="tnv">vi1</span> /. <span class="tnvc">vimap</span>, <span class="tnv">vi2</span> /. <span class="tnvc">vimap</span>, <span class="tnv">f</span> /. <span class="tnv">field2style</span>},
        {<span class="tnv">P</span>[<span class="tnt">f_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>], <span class="tnt">idx_</span>} :&gt; {<span class="tnv">vi1</span> /. <span class="tnvc">vimap</span>, <span class="tnv">vi2</span> /. <span class="tnvc">vimap</span>, (<span class="tnv">f</span> /. <span class="tnv">field2style</span>) &lt;&gt; <span class="ts">",style=edge dot"</span> &lt;&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnv">idx</span>-<span class="tl">1</span>]}
      }]]
    ],
    {}
  ];
]</pre>
<h2 id="IbpBases">IBP Bases</h2>
<h3 id="ExpandScalarProducts"><code>ExpandScalarProducts[]</code></h3>
<p>Expand <code>sp[..., ...]</code> and take out constant factors, so
that only <code>sp</code> between momenta are left. To know which symbols
are momenta, this function takes a list of symbols, or a pattern.</p>
<pre><a class="tnv" href="#ExpandScalarProducts">ExpandScalarProducts</a>[<span class="tnt">momnames_List</span>] := <a class="tnv" href="#ExpandScalarProducts">ExpandScalarProducts</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnv">momnames</span>]
<a class="tnv" href="#ExpandScalarProducts">ExpandScalarProducts</a>[<span class="tnt">mompattern_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">sp</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] :&gt; (
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>[<span class="tnv">a</span>*<span class="tnv">b</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[{
    (<span class="tnv">l</span>:<span class="tnv">mompattern</span>) (<span class="tnv">k</span>:<span class="tnv">mompattern</span>) :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnv">l</span>, <span class="tnv">k</span>]],
    (<span class="tnv">l</span>:<span class="tnv">mompattern</span>)^<span class="tl">2</span> :&gt; <span class="tnv">sp</span>[<span class="tnv">l</span>, <span class="tnv">l</span>]
  }]
)]</pre>
<h3 id="BToDen"><code>BToDen[]</code></h3>
<p>Convert B notation back to a product of <code>den</code>.</p>
<pre><a class="tnv" href="#BToDen">BToDen</a>[<span class="tnt">ex_</span>, <span class="tnt">bases_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid2basis</span>},
  <span class="tnvc">bid2basis</span> = <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>[<span class="ts">"id"</span>]&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#Only">Only</a>];
  <span class="tnv">ex</span> /.
    <span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>] :&gt; (<span class="tnvc">bid2basis</span>[<span class="tnv">bid</span>][<span class="ts">"denominators"</span>]^{<span class="tnv">idx</span>} // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>]) /.
    <span class="tnv">den</span>[<span class="tnt">p_</span>]^<span class="tnt">n_</span>?<a class="tnb" href="https://reference.wolfram.com/language/ref/Negative.html" rel="nofollow">Negative</a> :&gt; <span class="tnv">sp</span>[<span class="tnv">p</span>, <span class="tnv">p</span>]^(-<span class="tnv">n</span>) /.
    <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>]^<span class="tnt">n_</span>?<a class="tnb" href="https://reference.wolfram.com/language/ref/Negative.html" rel="nofollow">Negative</a> :&gt; (<span class="tnv">sp</span>[<span class="tnv">p</span>, <span class="tnv">p</span>] - <span class="tnv">m</span>)^(-<span class="tnv">n</span>) /.
    <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, <span class="tnv">irr</span>]^<span class="tnt">n_</span>?<a class="tnb" href="https://reference.wolfram.com/language/ref/Negative.html" rel="nofollow">Negative</a> :&gt; (<span class="tnv">sp</span>[<span class="tnv">p</span>, <span class="tnv">p</span>] - <span class="tnv">m</span>)^(-<span class="tnv">n</span>)
]
<a class="tnv" href="#BToDen">BToDen</a>[<span class="tnt">bases_List</span>] := <a class="tnv" href="#BToDen">BToDen</a>[<span class="tnv">#</span>, <span class="tnv">bases</span>] &amp;</pre>
<h3 id="ToB"><code>ToB[]</code></h3>
<p>Convert an expression with <code>sp</code> and <code>den</code> to <code>B</code> notation in
a given basis. This is the slow version of it; the faster one
uses FORM: see <a href="#RunThroughForm">RunThroughForm</a> and <a href="#FormCallToB">FormCallToB</a>.</p>
<pre><a class="tnv" href="#ToB">ToB</a>[<span class="tnt">basis_Association</span>] := <a class="tnv" href="#ToB">ToB</a>[<span class="tnv">#</span>, <span class="tnv">basis</span>]&amp;
<a class="tnv" href="#ToB">ToB</a>[<span class="tnt">ex_</span>, <span class="tnt">basis_Association</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">indices</span>},
  <span class="tnv">ex</span> //
    <a class="tnv" href="#ExpandScalarProducts">ExpandScalarProducts</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">basis</span>[<span class="ts">"externalmom"</span>], <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>]]] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">basis</span>[<span class="ts">"nummap"</span>]] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">basis</span>[<span class="ts">"denmap"</span>]] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">basis</span>[<span class="ts">"sprules"</span>]] //
    <span class="tc">(*Together //*)</span>
    <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_DEN</span>, <span class="tnv">#</span>&amp;, (
      <span class="tnvc">indices</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="tl">0</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>[<span class="ts">"denominators"</span>]]];
      <span class="tnv">#</span> /. <span class="tnv">DEN</span>[<span class="tnt">i_</span>]^<span class="tnt">n_</span>. :&gt; (<span class="tnvc">indices</span>[[<span class="tnv">i</span>]] += <span class="tnv">n</span>; <span class="tl">1</span>) // <span class="tnv">#</span>* <span class="tnv">B</span>[<span class="tnv">basis</span>[<span class="ts">"id"</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a> @@ <span class="tnvc">indices</span>] &amp;
    ) &amp;]&amp;
]</pre>
<h3 id="IBPRelations"><code>IBPRelations[]</code></h3>
<p>List IBP relations for a basis, return a list of equations
with terms of the form <code>B[id, n[1], n[2], ...]</code> and coefficients
that depend on <code>n[i]</code>.</p>
<pre><a class="tnv" href="#IBPRelations">IBPRelations</a>[<span class="tnt">basis_Association</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">dens</span>, <span class="tnvc">i</span>, <span class="tnvc">l</span>, <span class="tnvc">v</span>},
  <span class="tnvc">dens</span> = <span class="tnv">basis</span>[<span class="ts">"denominators"</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Product.html" rel="nofollow">Product</a>[<span class="tnv">DEN</span>[<span class="tnvc">i</span>]^(<span class="tnv">n</span>[<span class="tnvc">i</span>]), {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]}]*(
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Sum.html" rel="nofollow">Sum</a>[-<span class="tl">2</span> <span class="tnv">n</span>[<span class="tnvc">i</span>] <a class="tnb" href="https://reference.wolfram.com/language/ref/D.html" rel="nofollow">D</a>[<span class="tnvc">dens</span>[[<span class="tnvc">i</span>, <span class="tl">1</span>]], <span class="tnvc">l</span>] <span class="tnv">sp</span>[<span class="tnvc">v</span>, <span class="tnvc">dens</span>[[<span class="tnvc">i</span>, <span class="tl">1</span>]]] <span class="tnv">DEN</span>[<span class="tnvc">i</span>], {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]}] +
        <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">v</span> === <span class="tnvc">l</span>, <span class="tnv">d</span>, <span class="tl">0</span>]
      )
    ,
    {<span class="tnvc">l</span>, <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>]},
    {<span class="tnvc">v</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">basis</span>[<span class="ts">"externalmom"</span>], <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>]]}
  ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#ToB">ToB</a>[<span class="tnv">basis</span>]] // <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_B</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Together.html" rel="nofollow">Together</a>]&amp;
]</pre>
<h3 id="VariableDimensions"><code>VariableDimensions[]</code></h3>
<p>Figure out the dimensionality of variables in an expression
(or a list of expressions) of a given dimensionality.</p>
<p>E.g.:</p>
<pre class="doc"><span class="tnb">In</span>[<span class="tl">1</span>]:= <a class="tnv" href="#VariableDimensions">VariableDimensions</a>[<span class="tnv">m</span> + <span class="tnv">m</span>^<span class="tl">2</span>/<span class="tnv">q</span>, <span class="tl">1</span>]
<span class="tnb">Out</span>[<span class="tl">1</span>]= {<span class="tnv">m</span> -&gt; <span class="tl">1</span>, <span class="tnv">q</span> -&gt; <span class="tl">1</span>}
</pre>

<pre><a class="tnv" href="#VariableDimensions">VariableDimensions</a>[{}, _] := {}
<a class="tnv" href="#VariableDimensions">VariableDimensions</a>[<span class="tnt">expression_</span>, <span class="tnt">dimension_</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">DimOf</span>, <span class="tnvc">DimOfSymbol</span>, <span class="tnvc">ex</span>, <span class="tnvc">eqns</span>, <span class="tnvc">solution</span>},
  <span class="tnvc">DimOf</span>[<span class="tnt">ex_List</span>] := (
    <span class="tnvc">ex</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sow.html" rel="nofollow">Sow</a>[<span class="tnvc">DimOf</span>[<span class="tnv">#</span>] == <span class="tnvc">DimOf</span>[<span class="tnvc">ex</span>[[<span class="tl">1</span>]]]]&amp;];
    <span class="tnvc">DimOf</span>[<span class="tnvc">ex</span>[[<span class="tl">1</span>]]]
  );
  <span class="tnvc">DimOf</span>[<span class="tnt">ex_Plus</span>] := (
    <span class="tnvc">ex</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sow.html" rel="nofollow">Sow</a>[<span class="tnvc">DimOf</span>[<span class="tnv">#</span>] == <span class="tnvc">DimOf</span>[<span class="tnvc">ex</span>[[<span class="tl">1</span>]]]]&amp;];
    <span class="tnvc">DimOf</span>[<span class="tnvc">ex</span>[[<span class="tl">1</span>]]]
  );
  <span class="tnvc">DimOf</span>[<span class="tnt">ex_Times</span>] := <span class="tnvc">ex</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnvc">DimOf</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>];
  <span class="tnvc">DimOf</span>[<span class="tnt">ex_</span>^<span class="tnt">n_</span>] := <span class="tnvc">DimOf</span>[<span class="tnvc">ex</span>]*<span class="tnv">n</span>;
  <span class="tnvc">DimOf</span>[<span class="tnt">ex_</span>?<a class="tnb" href="https://reference.wolfram.com/language/ref/NumberQ.html" rel="nofollow">NumberQ</a>] := <span class="tl">0</span>;
  <span class="tnvc">DimOf</span>[<span class="tnt">ex_Symbol</span>] := <span class="tnvc">DimOfSymbol</span>[<span class="tnvc">ex</span>];
  <span class="tnvc">DimOf</span>[<span class="tnt">ex_</span>] := <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Don't know the dimension of: "</span>, <span class="tnvc">ex</span>];
  <span class="tnvc">eqns</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Reap.html" rel="nofollow">Reap</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sow.html" rel="nofollow">Sow</a>[<span class="tnvc">DimOf</span>[<span class="tnv">expression</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tl">0</span>]] == <span class="tnv">dimension</span>];][[<span class="tl">2</span>,<span class="tl">1</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/And.html" rel="nofollow">And</a>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">eqns</span> === <a class="tnb" href="https://reference.wolfram.com/language/ref/False.html" rel="nofollow">False</a>, <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"The dimension of "</span>, <span class="tnv">expression</span>, <span class="ts">" can't be "</span>, <span class="tnv">dimension</span>]];
  <span class="tnvc">solution</span> = <span class="tnvc">eqns</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Solve.html" rel="nofollow">Solve</a>[<span class="tnv">#</span>, <span class="tnv">#</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_DimOfSymbol</span>]]&amp;;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">solution</span> === {}, <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Inconsistent dimension in "</span>, <span class="tnv">expression</span>]];
  <span class="tnvc">solution</span>[[<span class="tl">1</span>]] /. <span class="tnvc">DimOfSymbol</span>[<span class="tnt">ex_</span>] :&gt; <span class="tnvc">ex</span>
]</pre>
<h3 id="NormalizeDens"><code>NormalizeDens[]</code></h3>
<p>Normalize the <code>den[]</code> expressions by dropping the leading
signs of the momenta.</p>
<pre><a class="tnv" href="#NormalizeDens">NormalizeDens</a>[<span class="tnt">ex_</span>] := <span class="tnv">ex</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">x___</span>] :&gt; <span class="tnv">den</span>[<a class="tnv" href="utils.html#DropLeadingSign">DropLeadingSign</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>[<span class="tnv">p</span>]], <span class="tnv">x</span>] /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tl">0</span>] :&gt; <span class="tnv">den</span>[<span class="tnv">p</span>]</pre>
<h3 id="CompleteIBPBasis"><code>CompleteIBPBasis[]</code></h3>
<p>Complete a list of denominators to a full IBP basis, and
return an IBP basis object with all the information. This
object is used throughout this library, and this is the main
way to create it.</p>
<p>You are advised to <a href="#NormalizeDens">NormalizeDens</a> the denominators and
sort them before calling this function.</p>
<p>Example:</p>
<pre class="doc"><span class="tnb">In</span>[]:= <a class="tnv" href="#CompleteIBPBasis">CompleteIBPBasis</a>[<span class="tl">1</span>, {<span class="tnv">den</span>[<span class="tnv">l1</span>], <span class="tnv">den</span>[<span class="tnv">q</span>-<span class="tnv">l1</span>]}, {<span class="tnv">l1</span>, <span class="tnv">l2</span>}, {<span class="tnv">q</span>}, {<span class="tnv">sp</span>[<span class="tnv">q</span>,<span class="tnv">q</span>]-&gt;<span class="tnv">qq</span>}]
<span class="tnb">Out</span>[]=
&lt;|
 <span class="ts">"</span><span class="ts">id</span><span class="ts">"</span> -&gt; <span class="tl">1</span>,
 <span class="ts">"</span><span class="ts">loopmom</span><span class="ts">"</span> -&gt; {<span class="tnv">l1</span>, <span class="tnv">l2</span>},
 <span class="ts">"</span><span class="ts">externalmom</span><span class="ts">"</span> -&gt; {<span class="tnv">q</span>},
 <span class="ts">"</span><span class="ts">sprules</span><span class="ts">"</span> -&gt; {<span class="tnv">sp</span>[<span class="tnv">q</span>,<span class="tnv">q</span>] -&gt; <span class="tnv">qq</span>},
 <span class="ts">"</span><span class="ts">invariants</span><span class="ts">"</span> -&gt; {<span class="tnv">qq</span>},
 <span class="ts">"</span><span class="ts">denominators</span><span class="ts">"</span> -&gt; { <span class="tnv">den</span>[<span class="tnv">l1</span>], <span class="tnv">den</span>[<span class="tnv">l1</span>-<span class="tnv">q</span>], <span class="tnv">den</span>[<span class="tnv">l2</span>,<span class="tl">0</span>,<span class="tnv">irr</span>], <span class="tnv">den</span>[<span class="tnv">l1</span>+<span class="tnv">l2</span>,<span class="tl">0</span>,<span class="tnv">irr</span>], <span class="tnv">den</span>[<span class="tnv">l2</span>+<span class="tnv">q</span>,<span class="tl">0</span>,<span class="tnv">irr</span>] },
 <span class="ts">"</span><span class="ts">denmap</span><span class="ts">"</span> -&gt; &lt;| <span class="tnv">den</span>[<span class="tnv">l1</span>] -&gt; <span class="tnv">DEN</span>[<span class="tl">1</span>], ... |&gt;,
 <span class="ts">"</span><span class="ts">nummap</span><span class="ts">"</span> -&gt; &lt;| <span class="tnv">sp</span>[<span class="tnv">l1</span>,<span class="tnv">l1</span>] -&gt; <span class="tl">1</span>/<span class="tnv">DEN</span>[<span class="tl">1</span>], ... |&gt;
|&gt;
</pre>

<pre><a class="tnv" href="#CompleteIBPBasis">CompleteIBPBasis</a>[<span class="tnt">bid_</span>, <span class="tnt">denominators_List</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">extmom_List</span>, <span class="tnt">sprules_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">L</span>, <span class="tnvc">M</span>, <span class="tnvc">p</span>, <span class="tnvc">k</span>, <span class="tnvc">nums</span>, <span class="tnvc">vars</span>, <span class="tnvc">c</span>, <span class="tnvc">mx</span>, <span class="tnvc">candidatemoms</span>, <span class="tnvc">denadd</span>, <span class="tnvc">numadd</span>, <span class="tnvc">cadd</span>, <span class="tnvc">mxadd</span>, <span class="tnvc">dens</span>, <span class="tnvc">Complete</span>, <span class="tnvc">rels</span>},
  <span class="tnvc">L</span> = <span class="tnv">loopmom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#DropLeadingSign">DropLeadingSign</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>];
  <span class="tnvc">M</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">loopmom</span>, <span class="tnv">extmom</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#DropLeadingSign">DropLeadingSign</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>];
  <span class="tnvc">dens</span> = <span class="tnv">denominators</span> // <a class="tnv" href="#NormalizeDens">NormalizeDens</a>;
  <span class="tnvc">nums</span> = <span class="tnvc">dens</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tnvc">p</span>^<span class="tl">2</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m2_</span>, ___] :&gt; <span class="tnvc">p</span>^<span class="tl">2</span> - <span class="tnv">m2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>;
  <span class="tnvc">nums</span> = <span class="tnvc">nums</span> /. (<span class="tnv">l</span>:<span class="tnvc">M</span>) (<span class="tnvc">k</span>:<span class="tnvc">M</span>) :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnv">l</span>, <span class="tnvc">k</span>]] /. (<span class="tnv">l</span>:<span class="tnvc">M</span>)^<span class="tl">2</span> :&gt; <span class="tnv">sp</span>[<span class="tnv">l</span>, <span class="tnv">l</span>] /. <span class="tnv">sprules</span>;
  <span class="tnvc">vars</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Tuples.html" rel="nofollow">Tuples</a>[{<span class="tnv">loopmom</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">loopmom</span>, <span class="tnv">extmom</span>]}] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#DropLeadingSign">DropLeadingSign</a> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<span class="tnv">sp</span>]] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">nums</span> =!= {},
    {<span class="tnvc">c</span>, <span class="tnvc">mx</span>} = <a class="tnb" href="https://reference.wolfram.com/language/ref/CoefficientArrays.html" rel="nofollow">CoefficientArrays</a>[<span class="tnvc">nums</span>, <span class="tnvc">vars</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>;
    <span class="tc">(* nums == c + mx.vars *)</span>
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatrixRank.html" rel="nofollow">MatrixRank</a>[<span class="tnvc">mx</span>] =!= <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">mx</span>],
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"nums="</span>,<span class="tnvc">nums</span>];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"vars="</span>,<span class="tnvc">vars</span>];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="tnvc">c</span>];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="tnvc">mx</span>];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatrixRank.html" rel="nofollow">MatrixRank</a>[<span class="tnvc">mx</span>]];
      <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"CompleteIBPBasis: denominators "</span>, <span class="tnv">denominators</span>, <span class="ts">" are already linearly dependent"</span>]
    ];
    ,
    {<span class="tnvc">c</span>, <span class="tnvc">mx</span>} = {{}, {}};
  ];
  <span class="tnvc">candidatemoms</span> =
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Subsets.html" rel="nofollow">Subsets</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">loopmom</span>, <span class="tnv">extmom</span>], {<span class="tl">1</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Infinity.html" rel="nofollow">Infinity</a>}] //
    <span class="tc">(* Higher counts almost always give more IBP terms; the
     * minimal amount is sufficient in our case (but not in
     * general). *)</span>
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">#</span>] &lt; <span class="tl">3</span>&amp;] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">#</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnv">#</span>, {<span class="tnt">a_</span>, <span class="tnt">b_</span>} :&gt; {<span class="tnv">a</span>, -<span class="tnv">b</span>}]]&amp; //
    <span class="tc">(*
    Join[#, Cases[#, {a_, b_, c_} :&gt; {a, -b, c}]]&amp; //
    Join[#, Cases[#, {a_, b_, c_} :&gt; {a, b, -c}]]&amp; //
    Join[#, Cases[#, {a_, b_, c_} :&gt; {a, -b, -c}]]&amp; //
    *)</span>
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>] /* <a class="tnv" href="utils.html#DropLeadingSign">DropLeadingSign</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<span class="tnvc">L</span>]];
  <span class="tnvc">Complete</span>[<span class="tnt">dens_</span>, <span class="tnt">mx_</span>, <span class="tnt">c_</span>, <span class="tnt">mini_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">i</span>},
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">mx</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">vars</span>],
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Sow.html" rel="nofollow">Sow</a>[
        &lt;|
          <span class="ts">"id"</span> -&gt; <span class="tnv">bid</span>,
          <span class="ts">"loopmom"</span> -&gt; (<span class="tnv">loopmom</span> // <a class="tnv" href="utils.html#DropLeadingSign">DropLeadingSign</a>),
          <span class="ts">"externalmom"</span> -&gt; (<span class="tnv">extmom</span> // <a class="tnv" href="utils.html#DropLeadingSign">DropLeadingSign</a>),
          <span class="ts">"sprules"</span> -&gt; <span class="tnv">sprules</span>,
          <span class="ts">"denominators"</span> -&gt; <span class="tnv">dens</span>,
          <span class="ts">"denmap"</span> -&gt; (
            <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[<span class="tnv">#1</span> -&gt; <span class="tnv">DEN</span> @@ <span class="tnv">#2</span> &amp;, <span class="tnv">dens</span>] //
            <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tnv">den</span>[_, _, <span class="tnv">irr</span>] -&gt; _] //
            <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[(<span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">x___</span>] -&gt; <span class="tnt">y_</span>) :&gt; {<span class="tnv">den</span>[<span class="tnv">p</span>, <span class="tnv">x</span>] -&gt; <span class="tnv">y</span>, <span class="tnv">den</span>[-<span class="tnv">p</span>, <span class="tnv">x</span>] -&gt; <span class="tnv">y</span>}] //
            <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> //
            <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>
          ),
          <span class="ts">"nummap"</span> -&gt; (
            <a class="tnb" href="https://reference.wolfram.com/language/ref/Inverse.html" rel="nofollow">Inverse</a>[<span class="tnv">mx</span>].(<a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tl">1</span>/<span class="tnv">DEN</span>[<span class="tnv">#</span>] &amp;, <a class="tnb" href="https://reference.wolfram.com/language/ref/Range.html" rel="nofollow">Range</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">mx</span>]]] - <span class="tnv">c</span>) //
            <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_DEN</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Factor.html" rel="nofollow">Factor</a>]&amp; //
            <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>, {<span class="tnv">vars</span>, <span class="tnv">#</span>}]&amp; //
            <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">#</span>, <span class="tnv">#</span> /. <span class="tnv">sp</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] :&gt; <span class="tnv">sp</span>[<span class="tnv">b</span>, <span class="tnv">a</span>]]&amp; //
            <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>
          ),
          <span class="ts">"invariants"</span> -&gt; ({<span class="tnv">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnv">den</span>[_, <span class="tnt">m_</span>, ___] :&gt; <span class="tnv">m</span>], <span class="tnv">sprules</span>[[;;,<span class="tl">2</span>]]} // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_Symbol</span>])
        |&gt;
      ]
      ,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/For.html" rel="nofollow">For</a>[<span class="tnvc">i</span> = <span class="tnv">mini</span>, <span class="tnvc">i</span> &lt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">candidatemoms</span>], <span class="tnvc">i</span>++,
        <span class="tnv">numadd</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>[<span class="tnv">candidatemoms</span>[[<span class="tnvc">i</span>]]^<span class="tl">2</span>];
        <span class="tnv">numadd</span> = <span class="tnv">numadd</span> /. (<span class="tnv">l</span>:<span class="tnv">M</span>) (<span class="tnv">k</span>:<span class="tnv">M</span>) :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnv">l</span>, <span class="tnv">k</span>]] /. (<span class="tnv">l</span>:<span class="tnv">M</span>)^<span class="tl">2</span> :&gt; <span class="tnv">sp</span>[<span class="tnv">l</span>, <span class="tnv">l</span>] /. <span class="tnv">sprules</span>;
        {<span class="tnv">cadd</span>, <span class="tnv">mxadd</span>} = <a class="tnb" href="https://reference.wolfram.com/language/ref/CoefficientArrays.html" rel="nofollow">CoefficientArrays</a>[<span class="tnv">numadd</span>, <span class="tnv">vars</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>;
        <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatrixRank.html" rel="nofollow">MatrixRank</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnv">mx</span>, <span class="tnv">mxadd</span>]] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">mx</span>] + <span class="tl">1</span>,
          <span class="tnv">Complete</span>[
            <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnv">dens</span>, <span class="tnv">den</span>[<span class="tnv">candidatemoms</span>[[<span class="tnvc">i</span>]], <span class="tl">0</span>, <span class="tnv">irr</span>]],
            <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnv">mx</span>, <span class="tnv">mxadd</span>],
            <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnv">c</span>, <span class="tnv">cadd</span>],
            <span class="tnvc">i</span>+<span class="tl">1</span>]
        ]
      ]
    ]
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Reap.html" rel="nofollow">Reap</a>[<span class="tnvc">Complete</span>[<span class="tnvc">dens</span>, <span class="tnvc">mx</span>, <span class="tnvc">c</span>, <span class="tl">1</span>]][[<span class="tl">2</span>]] // <a class="tnv" href="utils.html#Only">Only</a> //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/MinimalBy.html" rel="nofollow">MinimalBy</a>[(
    <span class="tnvc">rels</span> = <a class="tnv" href="#IBPRelations">IBPRelations</a>[<span class="tnv">#</span>] // <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_B</span>, <span class="tnv">CO</span>]&amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#Terms">Terms</a> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>];
    {<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>@@<span class="tnvc">rels</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>@@(<span class="tnvc">rels</span>*<span class="tnvc">rels</span>), <span class="tnv">#</span>[<span class="ts">"denominators"</span>][[;;,<span class="tl">1</span>]]//<a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#Terms">Terms</a>/*<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>]//<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>]}
  )&amp;]//<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>
]</pre>
<h3 id="IBPBasisMapInvariants"><code>IBPBasisMapInvariants[]</code></h3>
<p>Apply a replacement map to the invariants of a basis.</p>
<pre><a class="tnv" href="#IBPBasisMapInvariants">IBPBasisMapInvariants</a>[<span class="tnt">basis_Association</span>, <span class="tnt">invmap_</span>] :=
  <span class="tnv">basis</span> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="ts">"denominators"</span> -&gt; (<span class="tnv">basis</span>[<span class="ts">"denominators"</span>] /. <span class="tnv">invmap</span>)] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="ts">"sprules"</span> -&gt; (<span class="tnv">basis</span>[<span class="ts">"sprules"</span>] /. <span class="tnv">invmap</span>)] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="ts">"invariants"</span> -&gt; (<span class="tnv">basis</span>[<span class="ts">"invariants"</span>] /. <span class="tnv">invmap</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_Symbol</span>])]
<a class="tnv" href="#IBPBasisMapInvariants">IBPBasisMapInvariants</a>[<span class="tnt">bases_List</span>, <span class="tnt">invmap_</span>] := <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#IBPBasisMapInvariants">IBPBasisMapInvariants</a>[<span class="tnv">#</span>, <span class="tnv">invmap</span>]&amp;]</pre>
<h3 id="InvariantMapUnderMomentaPermutation"><code>InvariantMapUnderMomentaPermutation[]</code></h3>
<p>Return a list of substitutions of the invariants of a basis
corresponding to an external momenta permutation.</p>
<pre><a class="tnv" href="#InvariantMapUnderMomentaPermutation">InvariantMapUnderMomentaPermutation</a>[<span class="tnt">basis_Association</span>, <span class="tnt">momperm_</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">extmom</span>, <span class="tnvc">sprules</span>, <span class="tnvc">i</span>, <span class="tnvc">j</span>, <span class="tnvc">sps</span>, <span class="tnvc">v1</span>, <span class="tnvc">v2</span>, <span class="tnvc">vars</span>, <span class="tnvc">OLD</span>, <span class="tnvc">NEW</span>, <span class="tnvc">x</span>},
  <span class="tnvc">extmom</span> = <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>];
  <span class="tnvc">sprules</span> = <span class="tnv">basis</span>[<span class="ts">"sprules"</span>];
  <span class="tnvc">sps</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnvc">extmom</span>[[<span class="tnvc">i</span>]], <span class="tnvc">extmom</span>[[<span class="tnvc">j</span>]]]]
    ,
    {<span class="tnvc">i</span>, <span class="tl">1</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">extmom</span>]},
    {<span class="tnvc">j</span>, <span class="tl">1</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">extmom</span>]}
  ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>;
  <span class="tnvc">vars</span> = <span class="tnv">basis</span>[<span class="ts">"invariants"</span>];
  <span class="tnvc">v1</span> = <span class="tnvc">sps</span> /. <span class="tnvc">sprules</span> /. <span class="tnvc">x</span>:(<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>@@<span class="tnvc">vars</span>) :&gt; <span class="tnvc">OLD</span>[<span class="tnvc">x</span>];
  <span class="tnvc">v2</span> = <span class="tnvc">sps</span> /. <span class="tnv">momperm</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnvc">sprules</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnvc">x</span>:(<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>@@<span class="tnvc">vars</span>) :&gt; <span class="tnvc">NEW</span>[<span class="tnvc">x</span>]];
  <span class="tnvc">v1</span> - <span class="tnvc">v2</span> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span>==<span class="tl">0</span>&amp;] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Solve.html" rel="nofollow">Solve</a>[<span class="tnv">#</span>, <span class="tnvc">vars</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnvc">OLD</span>]]&amp; //
    <a class="tnv" href="utils.html#Only">Only</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[(<span class="tnvc">NEW</span>|<span class="tnvc">OLD</span>)[<span class="tnt">x_</span>] :&gt; <span class="tnvc">x</span>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tnt">x_</span> -&gt; <span class="tnt">x_</span>]
]</pre>
<h3 id="IBPBasisMassDimensions"><code>IBPBasisMassDimensions[]</code></h3>
<p>Return a map from the invariants of a basis to their mass
dimensions.</p>
<pre><a class="tnv" href="#IBPBasisMassDimensions">IBPBasisMassDimensions</a>[<span class="tnt">basis_Association</span>] := <a class="tnv" href="#IBPBasisMassDimensions">IBPBasisMassDimensions</a>[{<span class="tnv">basis</span>}]
<a class="tnv" href="#IBPBasisMassDimensions">IBPBasisMassDimensions</a>[<span class="tnt">bases_List</span>] :=
  {
    <span class="tnv">bases</span>[[;;, <span class="ts">"sprules"</span>, ;;, <span class="tl">2</span>]],
    <span class="tnv">bases</span>[[;;, <span class="ts">"denominators"</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnv">den</span>[_, <span class="tnt">m_</span>, ___] :&gt; <span class="tnv">m</span>]]
  } //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tl">0</span>] //
  <a class="tnv" href="#VariableDimensions">VariableDimensions</a>[<span class="tnv">#</span>, <span class="tl">2</span>]&amp;</pre>
<h3 id="IBPBasisCross"><code>IBPBasisCross[]</code></h3>
<p>Return a copy of the basis, but with external momenta swapped
inside the denominator list. No change otherwise, i.e. the
external scalar product rules remain the same.</p>
<pre><a class="tnv" href="#IBPBasisCross">IBPBasisCross</a>[<span class="tnt">bid_</span>, <span class="tnt">basis_Association</span>, <span class="tnt">externalmommap_</span>] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[
    <a class="tnv" href="#CompleteIBPBasis">CompleteIBPBasis</a>[<span class="tnv">bid</span>, <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] /. <span class="tnv">externalmommap</span>, <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>], <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>], <span class="tnv">basis</span>[<span class="ts">"sprules"</span>]],
    <span class="ts">"invariants"</span> -&gt; <span class="tnv">basis</span>[<span class="ts">"invariants"</span>]
  ]</pre>
<h3 id="IBPBasisSameQ"><code>IBPBasisSameQ[]</code></h3>
<p>Check if two bases are identical, up to the order of keys.</p>
<pre><a class="tnv" href="#IBPBasisSameQ">IBPBasisSameQ</a>[<span class="tnt">b1_</span>, <span class="tnt">b2_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>[<span class="tnv">b1</span>]] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>[<span class="tnv">b2</span>]]</pre>
<h2 id="FeynsonInterfaceForIntegralSymmetries">Feynson interface for integral symmetries</h2>
<p>By default look for Feynson in PATH.</p>
<pre><a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">$Feynson</span>, <span class="tnt">_String</span>]], <span class="tnv">$Feynson</span> = <span class="ts">"feynson -q -j4"</span>; ];</pre>
<h3 id="ZeroSectors"><code>ZeroSectors[]</code></h3>
<p>Calculate the zero sectors of a given basis. Return a list,
each element being <code>B[basis-id, (1|0), ...]</code>, listing the topmost
zero sectors.</p>
<pre><a class="tnv" href="#ZeroSectors">ZeroSectors</a>[<span class="tnt">basis_Association</span>] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/RunThrough.html" rel="nofollow">RunThrough</a>[<span class="tnv">$Feynson</span> &lt;&gt; <span class="ts">" zero-sectors -sj3 -"</span>, {
      <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] /. {
        <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>,
        <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span>,
        <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, <span class="tnv">irr</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span>,
        <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, <span class="tnv">cut</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span>-<span class="tnv">CUT</span>
      },
      <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] /. <span class="tnv">den</span>[_, _, <span class="tnv">cut</span>] -&gt; <span class="tl">1</span> /. <span class="tnv">den</span>[___] -&gt; <span class="tl">0</span>,
      <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>],
      <span class="tnv">basis</span>[<span class="ts">"sprules"</span>] /. <a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>-&gt;<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a> /. <span class="tnv">sp</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>
    }] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">B</span>[<span class="tnv">basis</span>[<span class="ts">"id"</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>@@<span class="tnv">SectorIdToIndices</span>[<span class="tnv">#</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>[<span class="ts">"denominators"</span>]]]]&amp;]
<a class="tnv" href="#ZeroSectors">ZeroSectors</a>[<span class="tnt">bases_List</span>] := <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#ZeroSectors">ZeroSectors</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>]</pre>
<h3 id="ZeroSectorPattern"><code>ZeroSectorPattern[]</code></h3>
<p>Return a pattern that matches zero intergals (in the <code>B</code>
notation) of a given basis.</p>
<pre><a class="tnv" href="#ZeroSectorPattern">ZeroSectorPattern</a>[<span class="tnt">basis_Association</span>] := <a class="tnv" href="#ZeroSectors">ZeroSectors</a>[<span class="tnv">basis</span>] //
  <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>] :&gt; <span class="tnv">B</span>[<span class="tnv">bid</span>, {<span class="tnv">idx</span>} /. <span class="tl">1</span> -&gt; _ /. <span class="tl">0</span> -&gt; _?<a class="tnb" href="https://reference.wolfram.com/language/ref/NonPositive.html" rel="nofollow">NonPositive</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>]]] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>]
<a class="tnv" href="#ZeroSectorPattern">ZeroSectorPattern</a>[<span class="tnt">bases_List</span>] := <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#ZeroSectorPattern">ZeroSectorPattern</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>]</pre>
<h3 id="SymmetryMaps"><code>SymmetryMaps[]</code></h3>
<p>Return a list of momenta maps, such that applying them to
the list of feynman integral families makes symmetries and
subtopology relations explicit. So, families that are symmetric
will have identical sets of denominators after the maps are
applied. Families that are symmetric to a subtopology of a
bigger family will have a subsets of the denominators.</p>
<p>The families are defined by their set of den[]s.</p>
<p>The latter families are guaranteed to be mapped to the former ones.</p>
<p>You can use <a href="library.html#UniqueSupertopologyMapping">UniqueSupertopologyMapping</a> to figure out the
topmost supertopologies after this.</p>
<pre><a class="tnv" href="#SymmetryMaps">SymmetryMaps</a>[<span class="tnt">families_List</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">sprules_</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">densets</span>, <span class="tnvc">uniqdensets</span>, <span class="tnvc">densetindices</span>, <span class="tnvc">uniqdensetmaps</span>},
  <span class="tnvc">densets</span> = <span class="tnv">families</span> // <a class="tnv" href="#NormalizeDens">NormalizeDens</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[
    <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_den</span>] /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>@@<span class="tnv">loopmom</span>]]
  ];
  <span class="tnvc">densets</span> = <span class="tnvc">densets</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, <span class="tnv">cut</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span>-<span class="tnv">CUT</span>;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/RunThrough.html" rel="nofollow">RunThrough</a>[<span class="tnv">$Feynson</span> &lt;&gt; <span class="ts">" symmetrize -"</span>, {<span class="tnvc">densets</span>, <span class="tnv">loopmom</span>, <span class="tnv">sprules</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>]]}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>]]]
];
<a class="tnv" href="#SymmetryMaps">SymmetryMaps</a>[<span class="tnt">families_List</span>, <span class="tnt">loopmom_List</span>] := <a class="tnv" href="#SymmetryMaps">SymmetryMaps</a>[<span class="tnv">families</span>, <span class="tnv">loopmom</span>, {}]</pre>
<h3 id="IntegralFamilyMappingRules"><code>IntegralFamilyMappingRules[]</code></h3>
<p>Determine if the latter families of integrals can be expressed
in terms of the earlier ones. For each family (defined by a list
of <code>den[]</code> expression) return either <code>{}</code> if it is unique, or
<code>{fam, {n1, n2, ...}}</code>, meaning that any integral in the
given family with indices <code>{i_1,i_2,...}</code> is equal to an
integral in the family number <code>fam</code> with indices <code>{i_n1,i_n2,...}</code>.</p>
<pre><a class="tnv" href="#IntegralFamilyMappingRules">IntegralFamilyMappingRules</a>[<span class="tnt">densets_List</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">sprules_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{},
  <a class="tnb" href="https://reference.wolfram.com/language/ref/RunThrough.html" rel="nofollow">RunThrough</a>[<span class="tnv">$Feynson</span> &lt;&gt; <span class="ts">" -d mapping-rules -"</span>, {
    <span class="tnv">densets</span> /.
      <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span> /.
      <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span> /.
      <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, <span class="tnv">irr</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span> /.
      <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, <span class="tnv">cut</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span>-<span class="tnv">CUT</span>,
    <span class="tnv">loopmom</span>, <span class="tnv">sprules</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>]]
  }]
]</pre>
<h3 id="IntegralEqualitySets"><code>IntegralEqualitySets[]</code></h3>
<p>Take a list of integrals (in the <code>B</code> notation) and a list of bases,
determine which integrals are equal, and return a list of index sets,
with each integral in a set being equal to each other.</p>
<pre><a class="tnv" href="#IntegralEqualitySets">IntegralEqualitySets</a>[<span class="tnt">integrals_List</span>, <span class="tnt">bases_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid2basis</span>, <span class="tnvc">densets</span>},
  <span class="tnvc">bid2basis</span> = <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>[<span class="ts">"id"</span>]&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#Only">Only</a>];
  <span class="tnvc">densets</span> = <span class="tnv">integrals</span> //
    <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
      <span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Which.html" rel="nofollow">Which</a>[
        <span class="tnv">#2</span> === <span class="tl">0</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>,
        <span class="tnv">#2</span> === <span class="tl">1</span>, <span class="tnv">#1</span>,
        <span class="tnv">#2</span> &gt; <span class="tl">0</span>, <span class="tnv">#1</span> - <a class="tnv" href="utils.html#MkExpression">MkExpression</a>[<span class="ts">"POW"</span>, <span class="tnv">#2</span>],
        <span class="tnv">#2</span> &lt; <span class="tl">0</span>, <span class="tnv">#1</span> - <a class="tnv" href="utils.html#MkExpression">MkExpression</a>[<span class="ts">"POWm"</span>, -<span class="tnv">#2</span>],
        <a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>, <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Unrecognized index:"</span>, <span class="tnv">#2</span>]
      ]&amp;, {<span class="tnvc">bid2basis</span>[<span class="tnv">bid</span>][<span class="ts">"denominators"</span>], {<span class="tnv">idx</span>}}]
    ];
  <span class="tnvc">densets</span> = <span class="tnvc">densets</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, <span class="tnv">cut</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span>-<span class="tnv">CUT</span>;
  <a class="tnv" href="#IntegralFamilyMappingRules">IntegralFamilyMappingRules</a>[
    <span class="tnvc">densets</span>,
    <span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"loopmom"</span>]],
    <span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"sprules"</span>]] /. <span class="tnv">sp</span>[<span class="tnt">p1_</span>,<span class="tnt">p2_</span>] :&gt; <span class="tnv">p1</span>*<span class="tnv">p2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>]]
  ] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnv">#1</span>, {} -&gt; {<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>[<span class="tnv">#2</span>], <span class="tnvc">densets</span>[[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>[<span class="tnv">#2</span>]]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Range.html" rel="nofollow">Range</a>}]&amp;]//
    <a class="tnb" href="https://reference.wolfram.com/language/ref/MapAt.html" rel="nofollow">MapAt</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Except.html" rel="nofollow">Except</a>[<span class="tl">0</span>] -&gt; <span class="tl">1</span>], <span class="tnv">#</span>, {;;, <span class="tl">2</span>, ;;}]&amp; //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/PositionIndex.html" rel="nofollow">PositionIndex</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Values.html" rel="nofollow">Values</a>
]</pre>
<h3 id="UniqueIntegralIndices"><code>UniqueIntegralIndices[]</code></h3>
<p>Take a list of integrals (in the <code>B</code> notation) and a list of bases,
and return the indices of unique integrals, discarding the
symmetric duplicates.</p>
<pre><a class="tnv" href="#UniqueIntegralIndices">UniqueIntegralIndices</a>[<span class="tnt">integrals_List</span>, <span class="tnt">bases_List</span>] :=
  <a class="tnv" href="#IntegralEqualitySets">IntegralEqualitySets</a>[<span class="tnv">integrals</span>, <span class="tnv">bases</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>]</pre>
<h3 id="IntegralUnion"><code>IntegralUnion[]</code></h3>
<p>Take a list of integrals (in the <code>B</code> notation) and a list of bases,
and return a list of integrals with all symmetric duplicates
removed.</p>
<pre><a class="tnv" href="#IntegralUnion">IntegralUnion</a>[<span class="tnt">integrals_List</span>, <span class="tnt">bases_List</span>] :=
  <span class="tnv">integrals</span>[[<a class="tnv" href="#UniqueIntegralIndices">UniqueIntegralIndices</a>[<span class="tnv">integrals</span>, <span class="tnv">bases</span>]]]</pre>
<h3 id="IntegralMapOntoSectors"><code>IntegralMapOntoSectors[]</code></h3>
<p>Try to map the given integrals onto their symmetric equivalents
in the given sectors. Return a map from the given integrals
to integrals in the specified sectors.</p>
<p>Negative indices are not supported here.</p>
<pre><a class="tnv" href="#IntegralMapOntoSectors">IntegralMapOntoSectors</a>[<span class="tnt">sectors_List</span>, <span class="tnt">integrals_List</span>, <span class="tnt">bases_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid2basis</span>, <span class="tnvc">fullfamidx</span>, <span class="tnvc">n</span>, <span class="tnvc">shortfams</span>, <span class="tnvc">intdensets</span>, <span class="tnvc">intidx</span>, <span class="tnvc">idx</span>, <span class="tnvc">bid</span>},
  <span class="tnvc">bid2basis</span> = <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>[<span class="ts">"id"</span>]&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#Only">Only</a>];
  <span class="tnvc">fullfamidx</span> = <span class="tnv">sectors</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
    <span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>] :&gt; (<span class="tnvc">n</span>=<span class="tl">0</span>; {<span class="tnvc">idx</span>} // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#</span>===<span class="tl">0</span>,<span class="tl">0</span>,<span class="tnvc">n</span>+=<span class="tl">1</span>;<span class="tnvc">n</span>]&amp;])
  ];
  <span class="tnvc">shortfams</span> = <span class="tnv">sectors</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
    <span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>] :&gt; (<a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#1</span>===<span class="tl">0</span>,<a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>,<span class="tnv">#2</span>]&amp;, {{<span class="tnvc">idx</span>}, <span class="tnvc">bid2basis</span>[<span class="tnvc">bid</span>][<span class="ts">"denominators"</span>]}])
  ];
  {<span class="tnvc">intdensets</span>, <span class="tnvc">intidx</span>} = <span class="tnv">integrals</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
      <span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>] :&gt; {
        <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#</span>===<span class="tl">0</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>, <span class="tnv">#2</span>]&amp;, {{<span class="tnvc">idx</span>}, <span class="tnvc">bid2basis</span>[<span class="tnvc">bid</span>][<span class="ts">"denominators"</span>]}],
        {<span class="tnvc">idx</span>} // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tl">0</span>]
      }
    ] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Transpose.html" rel="nofollow">Transpose</a>;
  <a class="tnv" href="#IntegralFamilyMappingRules">IntegralFamilyMappingRules</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnvc">shortfams</span>, <span class="tnvc">intdensets</span>] /.
      <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span> /.
      <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span> /.
      <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, <span class="tnv">irr</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span> /.
      <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, <span class="tnv">cut</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span>-<span class="tnv">CUT</span>,
    <span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"loopmom"</span>]],
    <span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"sprules"</span>]] /. <span class="tnv">sp</span>[<span class="tnt">p1_</span>,<span class="tnt">p2_</span>] :&gt; <span class="tnv">p1</span>*<span class="tnv">p2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>]]
  ][[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">sectors</span>]+<span class="tl">1</span>;;]] //
    <a class="tnv" href="utils.html#MapIndexed1">MapIndexed1</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Function.html" rel="nofollow">Function</a>[{<span class="tnv">rule</span>, <span class="tnv">i</span>},
      <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/And.html" rel="nofollow">And</a>[<span class="tnv">rule</span> =!= {}, <span class="tnv">rule</span>[[<span class="tl">1</span>]] &lt;= <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">sectors</span>]],
        <span class="tnvc">idx</span> = <span class="tnv">rule</span>[[<span class="tl">2</span>]];
        <span class="tnvc">bid</span> = <span class="tnv">sectors</span>[[<span class="tnv">rule</span>[[<span class="tl">1</span>]], <span class="tl">1</span>]];
        <span class="tnv">integrals</span>[[<span class="tnv">i</span>]] -&gt; <span class="tnv">B</span>[<span class="tnvc">bid</span>, <span class="tnvc">intidx</span>[[<span class="tnv">i</span>]] //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Prepend.html" rel="nofollow">Prepend</a>[<span class="tl">0</span>] //
          <span class="tnv">#</span>[[<span class="tnvc">idx</span> + <span class="tl">1</span>]]&amp; //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Prepend.html" rel="nofollow">Prepend</a>[<span class="tl">0</span>] //
          <span class="tnv">#</span>[[<span class="tnvc">fullfamidx</span>[[<span class="tnv">rule</span>[[<span class="tl">1</span>]]]] + <span class="tl">1</span>]]&amp; //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>]
        ]
        ,
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>
      ]
    ]]
]

<span class="tnv">IntegralMapOntoSector</span>[<span class="tnt">sector_B</span>, <span class="tnt">integrals_List</span>, <span class="tnt">bases_List</span>] :=
  <a class="tnv" href="#IntegralMapOntoSectors">IntegralMapOntoSectors</a>[{<span class="tnv">sector</span>}, <span class="tnv">integrals</span>, <span class="tnv">bases</span>]</pre>
<h3 id="IntegralMapOntoFamily"><code>IntegralMapOntoFamily[]</code></h3>
<p>Try to map the given integrals onto a given basis using
symmetries. Return a map from the given integrals to integrals
of the given basis.</p>
<p>Negative indices are not supported here.</p>
<pre><a class="tnv" href="#IntegralMapOntoFamily">IntegralMapOntoFamily</a>[<span class="tnt">basis_Association</span>, <span class="tnt">integrals_List</span>, <span class="tnt">bases_List</span>] :=
  <a class="tnv" href="#IntegralMapOntoSectors">IntegralMapOntoSectors</a>[
    {<span class="tnv">B</span>[<span class="tnv">basis</span>[<span class="ts">"id"</span>], <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{<span class="tnv">den</span>[__,<span class="tnv">irr</span>]-&gt;<span class="tl">0</span>, <span class="tnt">_den</span>-&gt;<span class="tl">1</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>]]},
    <span class="tnv">integrals</span>,
    <span class="tnv">bases</span>]</pre>
<h2 id="FormInterfaceForIntegrandTransformation">FORM interface for integrand transformation</h2>
<pre><a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">$FORM</span>, <span class="tnt">_String</span>]], <span class="tnv">$FORM</span> = <span class="ts">"tform -w4"</span>; ];</pre>
<h3 id="RunThroughForm"><code>RunThroughForm[]</code></h3>
<p>Run expressions through FORM (using <code>library.frm</code>), running
the specified code fragment on it. (The code is constructed
with <a href="utils.html#MkString">MkString</a>).</p>
<pre><a class="tnv" href="#RunThroughForm">RunThroughForm</a>[{}, _] := {}
<a class="tnv" href="#RunThroughForm">RunThroughForm</a>[<span class="tnt">exprs_List</span>, <span class="tnt">code_</span>] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">tmpsrc</span>, <span class="tnvc">tmpdst</span>, <span class="tnvc">tmplog</span>, <span class="tnvc">result</span>, <span class="tnvc">toform</span>, <span class="tnvc">fromform</span>, <span class="tnvc">i</span>, <span class="tnvc">expridxs</span>},
  <span class="tnvc">tmpsrc</span> = <a class="tnv" href="utils.html#MkTemp">MkTemp</a>[<span class="ts">"amp"</span>, <span class="ts">".frm"</span>];
  <span class="tnvc">tmpdst</span> = <span class="tnvc">tmpsrc</span> &lt;&gt; <span class="ts">".m"</span>;
  <span class="tnvc">tmplog</span> = <span class="tnvc">tmpsrc</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">".frm"</span> ~~ <a class="tnb" href="https://reference.wolfram.com/language/ref/EndOfString.html" rel="nofollow">EndOfString</a> -&gt; <span class="ts">".log"</span>];
  {<span class="tnvc">toform</span>, <span class="tnvc">fromform</span>} = <span class="tnv">AmpFormIndexMaps</span>[<span class="tnv">exprs</span>];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">tmpsrc</span>,
    <span class="ts">"#include "</span>, <span class="tnv">$Apath</span>, <span class="ts">"/library.frm\n"</span>,
    <span class="tc">(* This whole dance is needed to distribute expressions
     * across workers; tform would keep everything in a single
     * process if we where to just do assign our expression to
     * EXPR directly.
     *)</span>
    <span class="ts">"Table EXTBL(1:"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">exprs</span>], <span class="ts">");\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      {<span class="ts">"Fill EXTBL("</span>, <span class="tnvc">i</span>, <span class="ts">") = ("</span>,
        <span class="tc">(* Replacing delta() with d_() doesn't work because
         * d_()^2 is broken. Instead use (d_()), which works.
         * See: github.com/vermaseren/form/issues/341.
         *)</span>
        <span class="tnv">exprs</span>[[<span class="tnvc">i</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnvc">toform</span>] // <span class="tnv">AmpToForm</span> // <span class="tc">(*StringReplace["delta("-&gt;"d_("]*)</span>
          <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">"delta("</span> ~~ <span class="tnv">a</span>:(<a class="tnb" href="https://reference.wolfram.com/language/ref/Except.html" rel="nofollow">Except</a>[<span class="ts">")"</span>] ...) ~~ <span class="ts">")"</span> -&gt; <span class="ts">"(d_("</span> ~~ <span class="tnv">a</span> ~~ <span class="ts">"))"</span>],
        <span class="ts">");\n"</span>}
      ,
      {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">exprs</span>]}
    ],
    <span class="tc">(*"L EXPR = &lt;EX(1)&gt;+...+&lt;EX(", Length[exprs], ")&gt;;\n",*)</span>
    <span class="ts">"L EXPR = sum_(xidx,1,"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">exprs</span>], <span class="ts">",EX(xidx));\n"</span>,
    <span class="ts">".sort:init;\n"</span>,
    <span class="tc">(* Now that EX(n) are in different workers, we can insert
     * their values, and start the computations.
     *)</span>
    <span class="ts">"id EX(x?) = EX(x)*EXTBL(x);\n"</span>,
    <span class="tc">(*"cleartable EXTBL;\n"*)</span>
    <span class="ts">"#call input\n"</span>,
    <span class="tnv">code</span>,
    <span class="ts">"#call output("</span>, <span class="tnvc">tmpdst</span>, <span class="ts">")\n"</span>,
    <span class="ts">".end\n"</span>
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"RunThroughForm: calling "</span>, <span class="tnv">$FORM</span>, <span class="ts">" "</span>, <span class="tnvc">tmpsrc</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Run.html" rel="nofollow">Run</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[
    <span class="ts">"env "</span>,
      <span class="ts">"FORMTMP=\"${FORMTMP:-$TMP}\" "</span>,
      <span class="ts">"FORMTMPSORT=\"${FORMTMPSORT:-$TMP}\" "</span>,
      <span class="ts">"FORMPATH='"</span>, <span class="tnv">$Apath</span>, <span class="ts">"' "</span>,
    <span class="tnv">$FORM</span>, <span class="ts">" -q -Z -M -l '"</span>, <span class="tnvc">tmpsrc</span>, <span class="ts">"'"</span>]];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"RunThroughForm: reading result ("</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/FileByteCount.html" rel="nofollow">FileByteCount</a>[<span class="tnvc">tmpdst</span>]//<a class="tnv" href="utils.html#FormatBytes">FormatBytes</a>, <span class="ts">")"</span>];
  <span class="tnvc">result</span> = <a class="tnv" href="utils.html#SafeGet">SafeGet</a>[<span class="tnvc">tmpdst</span>]//<a class="tnv" href="utils.html#TM">TM</a>;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteFile.html" rel="nofollow">DeleteFile</a>[{<span class="tnvc">tmpsrc</span>, <span class="tnvc">tmpdst</span>, <span class="tnvc">tmplog</span>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"RunThroughForm: transforming it back"</span>];
  <span class="tnvc">result</span> /. <span class="tnvc">fromform</span> // <span class="tnv">AmpFromForm</span> // <a class="tnv" href="utils.html#Terms">Terms</a> //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnv">EX</span>[<span class="tnt">i_</span>]*<span class="tnt">ex_</span>. :&gt; {<span class="tnvc">i</span>, <span class="tnv">ex</span>}]] //
     <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a> -&gt; (<span class="tnv">#</span>[[<span class="tl">2</span>]] &amp;)] &amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>]] //
   <a class="tnb" href="https://reference.wolfram.com/language/ref/Lookup.html" rel="nofollow">Lookup</a>[<span class="tnv">#</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Range.html" rel="nofollow">Range</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">exprs</span>]], <span class="tl">0</span>] &amp;
  ]
<a class="tnv" href="#RunThroughForm">RunThroughForm</a>[<span class="tnt">code_</span>] := <a class="tnv" href="#RunThroughForm">RunThroughForm</a>[<span class="tnv">#</span>, <span class="tnv">code</span>]&amp;
<a class="tnv" href="#RunThroughForm">RunThroughForm</a>[<span class="tnt">exprs_</span>, <span class="tnt">code_</span>] := <a class="tnv" href="#RunThroughForm">RunThroughForm</a>[{<span class="tnv">exprs</span>}, <span class="tnv">code</span>] // <a class="tnv" href="utils.html#Only">Only</a>

<span class="tnv">FormCall</span>[<span class="tnt">procname_String</span>] := {<span class="ts">"#call "</span>, <span class="tnv">procname</span>, <span class="ts">"\n"</span>}
<span class="tnv">FormCall</span>[<span class="tnt">procnames__</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">FormCall</span>, {<span class="tnv">procnames</span>}]

<span class="tnv">FormCallZeroSectors</span>[<span class="tnt">zerobs_List</span>] := <span class="tnv">zerobs</span> //
  <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>] :&gt; {
    <span class="ts">"id B("</span>, <span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">#1</span>, {
      <span class="tl">0</span> -&gt; {<span class="ts">", x"</span>, <span class="tnv">#2</span>, <span class="ts">"?neg0_"</span>},
      <span class="tl">1</span> -&gt; {<span class="ts">", x"</span>, <span class="tnv">#2</span>, <span class="ts">"?"</span>}
    }]&amp;, {<span class="tnv">idx</span>}], <span class="ts">") = 0;\n"</span>
  }]

<span class="tnv">FormCallReplace</span>[<span class="tnt">rules__</span>] := {<span class="tnv">rules</span>} // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
  (<span class="tnv">sp</span>[<span class="tnt">p_</span>] -&gt; <span class="tnt">v_</span>) :&gt; {
    <span class="ts">"id sp("</span>, <span class="tnv">p</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">") = "</span>, <span class="tnv">v</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"id dot("</span>, <span class="tnv">p</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">","</span>, <span class="tnv">p</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">") = "</span>, <span class="tnv">v</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>
  },
  (<span class="tnv">sp</span>[<span class="tnt">p1_</span>,<span class="tnt">p2_</span>] -&gt; <span class="tnt">v_</span>) :&gt; {
    <span class="ts">"id sp("</span>, <span class="tnv">p1</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">","</span>, <span class="tnv">p2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">") = "</span>, <span class="tnv">v</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"id sp("</span>, <span class="tnv">p2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">","</span>, <span class="tnv">p1</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">") = "</span>, <span class="tnv">v</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"id dot("</span>, <span class="tnv">p1</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">","</span>, <span class="tnv">p2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">") = "</span>, <span class="tnv">v</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>
  }
]</pre>
<h3 id="FormCallToB"><code>FormCallToB[]</code></h3>
<p>FORM function to convert the current expression into B notation.
To be used with <a href="#RunThroughForm">RunThroughForm</a>.</p>
<pre><a class="tnv" href="#FormCallToB">FormCallToB</a>[<span class="tnt">bases_List</span>] := <a class="tnv" href="utils.html#MkString">MkString</a>[
    <span class="ts">"#procedure toBID\n"</span>,
    <span class="ts">"* Assume BID^n factor are already supplied.\n"</span>,
    <span class="ts">"#endprocedure\n"</span>,
    <span class="ts">"#procedure toDEN\n"</span>,
    <span class="ts">"  "</span>,
    <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Function.html" rel="nofollow">Function</a>[{<span class="tnv">basis</span>},
      {
        <span class="ts">"if (match(only, BID^"</span>, <span class="tnv">basis</span>[<span class="ts">"id"</span>], <span class="ts">"));\n"</span>,
        <span class="tnv">basis</span>[<span class="ts">"denmap"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{
            <span class="ts">"    id "</span>, <span class="tnv">#</span>[[<span class="tl">1</span>]]//<span class="tnv">AmpToForm</span>, <span class="ts">" = "</span>,
            <span class="tnv">#</span>[[<span class="tl">2</span>]] /. <span class="tnv">basis</span>[<span class="ts">"sprules"</span>] /. <span class="tnv">DEN</span>[<span class="tnt">n_</span>] :&gt; <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"DEN"</span>, <span class="tnv">n</span>] // <span class="tnv">AmpToForm</span>,
            <span class="ts">";\n"</span>
          }&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>,
        <span class="tnv">basis</span>[<span class="ts">"nummap"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{
            <span class="ts">"    id "</span>, <span class="tnv">#</span>[[<span class="tl">1</span>]] /. <span class="tnv">sp</span>-&gt;(<a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a>/*<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>) //<span class="tnv">AmpToForm</span>, <span class="ts">" = "</span>,
            <span class="tnv">#</span>[[<span class="tl">2</span>]] /. <span class="tnv">basis</span>[<span class="ts">"sprules"</span>] /. <span class="tnv">DEN</span>[<span class="tnt">n_</span>] :&gt; <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"DEN"</span>, <span class="tnv">n</span>] // <span class="tnv">AmpToForm</span>,
            <span class="ts">";\n"</span>
          }&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>,
        <span class="tnv">basis</span>[<span class="ts">"sprules"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{
            <span class="ts">"    id "</span>, <span class="tnv">#</span>[[<span class="tl">1</span>]] /. <span class="tnv">sp</span>-&gt;(<a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a>/*<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>) // <span class="tnv">AmpToForm</span>, <span class="ts">" = "</span>,
            <span class="tnv">#</span>[[<span class="tl">2</span>]] /. <span class="tnv">DEN</span>[<span class="tnt">n_</span>] :&gt; <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"DEN"</span>, <span class="tnv">n</span>] // <span class="tnv">AmpToForm</span>,
            <span class="ts">";\n"</span>
          }&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>
      }
    ]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"  else"</span>]&amp;,
    <span class="ts">"  else;\n"</span>,
    <span class="ts">"    exit \"ERROR: toDEN: got a term without a proper BID^n factor.\";\n"</span>,
    <span class="ts">"  endif;\n"</span>,
    <span class="ts">"#endprocedure\n"</span>,
    <span class="ts">"#call toB("</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"denominators"</span>]]], <span class="ts">", toBID, toDEN)\n"</span>
  ]</pre>
<h2 id="KiraInterfaceForIbpReduction">Kira interface for IBP reduction</h2>
<h3 id="KiraBasisName"><code>KiraBasisName[]</code></h3>
<p>Kira sorts bases by name instead of adhering to the order
of definition. We shall make sure that both the numerical
and the lexicographic orders match, which will prevent Kira
from messing it up.</p>
<pre><a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnt">bid_Integer</span>] := <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"b"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/IntegerDigits.html" rel="nofollow">IntegerDigits</a>[<span class="tnv">bid</span>, <span class="tl">10</span>, <span class="tl">5</span>]]
<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnt">name_String</span>] := <span class="tnv">name</span>
<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnv">DimShift</span>[<span class="tnt">name_</span>, <span class="tnt">n_</span>]] := <a class="tnv" href="utils.html#MkString">MkString</a>[<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnv">name</span>], <span class="ts">"_dimshift"</span>, <span class="tnv">n</span>]</pre>
<h3 id="MkKiraKinematicsYaml"><code>MkKiraKinematicsYaml[]</code></h3>
<p>Create Kira’s <code>kinematics.yaml</code> config file.</p>
<pre><a class="tnv" href="#MkKiraKinematicsYaml">MkKiraKinematicsYaml</a>[<span class="tnt">filename_</span>, <span class="tnt">extmom_List</span>, <span class="tnt">sprules_List</span>, <span class="tnt">variabledimensions_List</span>, <span class="tnt">one_</span>] :=
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">filename</span>,
    <span class="ts">"kinematics:\n"</span>,
    <span class="ts">" incoming_momenta: ["</span>, <span class="tnv">extmom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;, <span class="ts">"]\n"</span>,
    <span class="ts">" kinematic_invariants:\n"</span>,
    <span class="tnv">variabledimensions</span> //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[(<span class="tnt">var_</span> -&gt; <span class="tnt">dim_</span>) :&gt; {<span class="ts">"  - ["</span>, <span class="tnv">var</span> , <span class="ts">", "</span>, <span class="tnv">dim</span>, <span class="ts">"]\n"</span>}],
    <span class="ts">" scalarproduct_rules:\n"</span>,
    <span class="tnv">sprules</span> //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">sp</span> -&gt; (<span class="tnv">sp</span> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>)] //
      <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
      (<span class="tnv">sp</span>[<span class="tnt">p_</span>] -&gt; <span class="tnt">v_</span>) :&gt; {<span class="ts">"  - [["</span>, <span class="tnv">p</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">","</span>, <span class="tnv">p</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"], "</span>, <span class="tnv">v</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"]\n"</span>},
      (<span class="tnv">sp</span>[<span class="tnt">p1_</span>, <span class="tnt">p2_</span>] -&gt; <span class="tnt">v_</span>) :&gt; {<span class="ts">"  - [["</span>, <span class="tnv">p1</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">","</span>, <span class="tnv">p2</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"], "</span>, <span class="tnv">v</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"]\n"</span>}
    ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">one</span> =!= <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>,
      {<span class="ts">" symbol_to_replace_by_one: "</span>, <span class="tnv">one</span>, <span class="ts">"\n"</span>}
      ,
      {<span class="ts">"# symbol_to_replace_by_one: "</span>, <span class="tnv">variabledimensions</span>[[<span class="tl">1</span>,<span class="tl">1</span>]], <span class="ts">"\n"</span>}
    ]
  ];</pre>
<h3 id="MkKiraIntegralFamiliesYaml"><code>MkKiraIntegralFamiliesYaml[]</code></h3>
<p>Create Kira’s <code>integralfamilies.yaml</code> config file.</p>
<pre><a class="tnv" href="#MkKiraIntegralFamiliesYaml">MkKiraIntegralFamiliesYaml</a>[<span class="tnt">filename_</span>, <span class="tnt">bases_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">loopmom</span>, <span class="tnvc">extmom</span>, <span class="tnvc">dens</span>, <span class="tnvc">basis</span>},
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">filename</span>,
    <span class="ts">"integralfamilies:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      <span class="tnvc">loopmom</span> = <span class="tnvc">basis</span>[<span class="ts">"loopmom"</span>];
      <span class="tnvc">extmom</span> = <span class="tnvc">basis</span>[<span class="ts">"externalmom"</span>];
      <span class="tnvc">dens</span> = <span class="tnvc">basis</span>[<span class="ts">"denominators"</span>];
      {
        <span class="ts">"  - name: \""</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">basis</span>[<span class="ts">"id"</span>]], <span class="ts">"\"\n"</span>,
        <span class="ts">"    loop_momenta: ["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnvc">loopmom</span>, <span class="ts">", "</span>], <span class="ts">"]\n"</span>,
        <span class="ts">"    top_level_sectors: [b"</span>, <span class="tnvc">dens</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">den</span>[_, _, <span class="tnv">irr</span>] -&gt; <span class="tl">0</span>, <span class="tnt">_den</span> -&gt; <span class="tl">1</span>], <span class="ts">"]\n"</span>,
        <span class="ts">"    propagators:\n"</span>,
        <span class="tnvc">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[{
          <span class="tnv">den</span>[<span class="tnt">p_</span>] | <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tl">0</span>, ___] :&gt; {<span class="ts">"      - [\""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>[<span class="tnv">p</span>], <span class="ts">"\", 0]\n"</span>},
          <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, ___] :&gt; {<span class="ts">"      - [\""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>[<span class="tnv">p</span>], <span class="ts">"\", \""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>[<span class="tnv">m</span> /. <span class="tnv">sp</span>[<span class="tnv">q</span>] -&gt; <span class="tnv">qq</span>], <span class="ts">"\"]\n"</span>},
          <span class="tnt">d_</span> :&gt; <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"MkKiraConfig: bad denominator form: "</span>, <span class="tnv">d</span>]
        }]],
        <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<span class="tnvc">dens</span>, <span class="tnv">cut</span>],
          {<span class="ts">"    cut_propagators: ["</span>,
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Range.html" rel="nofollow">Range</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">dens</span>[[<span class="tnv">#</span>]], <span class="tnv">den</span>[_, _, <span class="tnv">cut</span>]]&amp;], <span class="ts">", "</span>],
          <span class="ts">"]\n"</span>
          }
          ,
          {}
        ]
      }
      ,
      {<span class="tnvc">basis</span>, <span class="tnv">bases</span>}]
  ];
]</pre>
<h3 id="MkKiraJobsYaml"><code>MkKiraJobsYaml[]</code></h3>
<p>Create Kira’s jobs file.</p>
<pre><a class="tnv" href="#MkKiraJobsYaml">MkKiraJobsYaml</a>[<span class="tnt">filename_</span>, <span class="tnt">bids_List</span>, <span class="tnt">topsectors_</span>, <span class="tnt">mode_</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid</span>, <span class="tnvc">sector</span>, <span class="tnvc">r</span>, <span class="tnvc">s</span>}, 
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">filename</span>,
    <span class="ts">"jobs:\n"</span>,
    <span class="ts">" - reduce_sectors:\n"</span>,
    <span class="ts">"    reduce:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
        <span class="tnvc">r</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">sector</span>[<span class="ts">"r"</span>], <span class="tl">1</span> + <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>@@<span class="tnvc">sector</span>[<span class="ts">"idx"</span>]];
        <span class="tnvc">s</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">sector</span>[<span class="ts">"s"</span>], <span class="tl">1</span>];
        {<span class="ts">"     - {topologies: ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">"], sectors: [b"</span>, <span class="tnvc">sector</span>[<span class="ts">"idx"</span>], <span class="ts">"], r: "</span>, <span class="tnvc">r</span>, <span class="ts">", s: "</span>, <span class="tnvc">s</span>, <span class="ts">"}\n"</span>}
        ,
        {<span class="tnvc">bid</span>, <span class="tnv">bids</span>},
        {<span class="tnvc">sector</span>, <span class="tnv">topsectors</span>[<span class="tnvc">bid</span>]}],
    <span class="ts">"    select_integrals:\n"</span>,
    <span class="ts">"     select_mandatory_list:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
        {<span class="ts">"      - ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">", \""</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">".integrals\"]\n"</span>}
        ,
        {<span class="tnvc">bid</span>, <span class="tnv">bids</span>}],
    <span class="ts">"#     select_mandatory_recursively:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
        {
        <span class="ts">"#      - {topologies: ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>],
            <span class="ts">"], sectors: [b"</span>, <span class="tnvc">sector</span>[<span class="ts">"idx"</span>],
            <span class="ts">"], r: "</span>, <span class="tnvc">sector</span>[<span class="ts">"r"</span>],
            <span class="ts">", s: "</span>, <span class="tnvc">sector</span>[<span class="ts">"s"</span>],
            <span class="ts">", d: "</span>, <span class="tnvc">sector</span>[<span class="ts">"d"</span>], <span class="ts">"}\n"</span>},
        {<span class="tnvc">bid</span>, <span class="tnv">bids</span>},
        {<span class="tnvc">sector</span>, <span class="tnv">topsectors</span>[<span class="tnvc">bid</span>]}],
    <span class="ts">"    integral_ordering: 8\n"</span>,
    <span class="ts">"    preferred_masters: \"preferred-masters\"\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Switch.html" rel="nofollow">Switch</a>[<span class="tnv">mode</span>,
      <span class="ts">"reduce"</span>, {
        <span class="ts">"    run_symmetries: true\n"</span>,
        <span class="ts">"    run_initiate: true\n"</span>,
        <span class="ts">"#    run_triangular: true\n"</span>,
        <span class="ts">"#    run_back_substitution: true\n"</span>,
        <span class="ts">"    run_firefly: true\n"</span>,
        <span class="ts">" - kira2math:\n"</span>,
        <span class="ts">"    target:\n"</span>,
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
          {<span class="ts">"     - ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">", \""</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">".integrals\"]\n"</span>},
          {<span class="tnvc">bid</span>, <span class="tnv">bids</span>}],
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
            {<span class="ts">"#     - {topologies: ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">"], sectors: [b"</span>, <span class="tnvc">sector</span>[<span class="ts">"idx"</span>], <span class="ts">"], r: "</span>, <span class="tnvc">sector</span>[<span class="ts">"r"</span>], <span class="ts">", s: "</span>, <span class="tnvc">sector</span>[<span class="ts">"s"</span>], <span class="ts">", d: "</span>, <span class="tnvc">sector</span>[<span class="ts">"d"</span>], <span class="ts">"}\n"</span>},
            {<span class="tnvc">bid</span>, <span class="tnv">bids</span>},
            {<span class="tnvc">sector</span>, <span class="tnv">topsectors</span>[<span class="tnvc">bid</span>]}],
        <span class="ts">"    reconstruct_mass: false\n"</span>
      },
      <span class="ts">"prepare"</span>, {
        <span class="ts">"    run_symmetries: true\n"</span>,
        <span class="ts">"    run_initiate: true\n"</span>,
        <span class="ts">"    run_triangular: false\n"</span>,
        <span class="ts">"    run_back_substitution: false\n"</span>,
        <span class="ts">"    run_firefly: false\n"</span>
      },
      <span class="ts">"prepare-input"</span>, {
        <span class="ts">"    run_symmetries: true\n"</span>,
        <span class="ts">"    run_initiate: input\n"</span>,
        <span class="ts">"    run_triangular: false\n"</span>,
        <span class="ts">"    run_back_substitution: false\n"</span>,
        <span class="ts">"    run_firefly: false\n"</span>
      }
    ]
  ];
]</pre>
<h3 id="MkKiraFinishUDSYaml"><code>MkKiraFinishUDSYaml[]</code></h3>
<p>Create Kira’s jobs file for UD system reduction.</p>
<pre><a class="tnv" href="#MkKiraFinishUDSYaml">MkKiraFinishUDSYaml</a>[<span class="tnt">filename_</span>, <span class="tnt">bids_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid</span>, <span class="tnvc">sector</span>, <span class="tnvc">r</span>, <span class="tnvc">s</span>}, 
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">filename</span>,
    <span class="ts">"jobs:\n"</span>,
    <span class="ts">" - reduce_user_defined_system:\n"</span>,
    <span class="ts">"    input_system:\n"</span>,
    <span class="ts">"      files:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<span class="ts">"       - \"input_kira/"</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">"\"\n"</span>}, {<span class="tnvc">bid</span>, <span class="tnv">bids</span>}],
    <span class="ts">"      config: false\n"</span>,
    <span class="ts">"      otf: true\n"</span>,
    <span class="ts">"    select_integrals:\n"</span>,
    <span class="ts">"     select_mandatory_list:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<span class="ts">"      - ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">", \""</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">".integrals\"]\n"</span>}, {<span class="tnvc">bid</span>, <span class="tnv">bids</span>}],
    <span class="ts">"    integral_ordering: 8\n"</span>,
    <span class="ts">"    preferred_masters: \"preferred-masters\"\n"</span>,
    <span class="ts">"    run_symmetries: false\n"</span>,
    <span class="ts">"    run_initiate: false\n"</span>,
    <span class="ts">"    run_triangular: false\n"</span>,
    <span class="ts">"    run_back_substitution: false\n"</span>,
    <span class="ts">"    run_firefly: true\n"</span>,
    <span class="ts">" - kira2math:\n"</span>,
    <span class="ts">"    target:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      {<span class="ts">"     - ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">", \""</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">".integrals\"]\n"</span>},
      {<span class="tnvc">bid</span>, <span class="tnv">bids</span>}],
    <span class="ts">"    reconstruct_mass: false\n"</span>
  ];
]</pre>
<h3 id="MkKiraIntegrals"><code>MkKiraIntegrals[]</code></h3>
<p>Create Kira’s integral list files, one per basis.</p>
<pre><a class="tnv" href="#MkKiraIntegrals">MkKiraIntegrals</a>[<span class="tnt">dirname_</span>, <span class="tnt">blist_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid</span>, <span class="tnvc">idxlist</span>},
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
    <span class="tnvc">idxlist</span> = <span class="tnv">blist</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnvc">bid</span>, <span class="tnt">idx__</span>] :&gt; {<span class="tnv">idx</span>}];
    <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/"</span> &lt;&gt; <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>] &lt;&gt; <span class="ts">".integrals"</span>,
      <span class="tnvc">idxlist</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">"["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">","</span>], <span class="ts">"]\n"</span>}&amp;]
    ];
    ,
    {<span class="tnvc">bid</span>, <span class="tnv">blist</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, ___] :&gt; <span class="tnvc">bid</span>]}];
]</pre>
<h3 id="MkKiraIntegralList"><code>MkKiraIntegralList[]</code></h3>
<p>Create Kira’s integral list file.</p>
<pre><a class="tnv" href="#MkKiraIntegralList">MkKiraIntegralList</a>[<span class="tnt">filename_</span>, <span class="tnt">blist_</span>] :=
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">filename</span>,
    <span class="tnv">blist</span> //
      <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>] :&gt; {<span class="tnv">bid</span>, {<span class="tnv">idx</span>}}] //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[{<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnv">#1</span>], <span class="ts">"["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#2</span>, <span class="ts">","</span>], <span class="ts">"]\n"</span>}&amp;]]
  ]</pre>
<h3 id="IndicesToSectorId"><code>IndicesToSectorId[]</code></h3>
<p>R = denominator power sum
Dots = denominator dot count
T = denominator count
S = numerator power sum</p>
<pre><a class="tnv" href="#IndicesToSectorId">IndicesToSectorId</a>[<span class="tnt">idx_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a> @@ <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">idx</span>[[<span class="tnv">i</span>]] &gt; <span class="tl">0</span>, <span class="tl">2</span>^(<span class="tnv">i</span>-<span class="tl">1</span>), <span class="tl">0</span>], {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">idx</span>]}]
<span class="tnv">SectorIdToIndices</span>[<span class="tnt">sector_Integer</span>, <span class="tnt">ndens_Integer</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/IntegerDigits.html" rel="nofollow">IntegerDigits</a>[<span class="tnv">sector</span>, <span class="tl">2</span>, <span class="tnv">ndens</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Reverse.html" rel="nofollow">Reverse</a>
<span class="tnv">IndicesToR</span>[<span class="tnt">idx_List</span>] := <span class="tnv">idx</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnt">n_</span> /; <span class="tnv">n</span> &gt; <span class="tl">0</span> :&gt; <span class="tnv">n</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>]
<span class="tnv">IndicesToDots</span>[<span class="tnt">idx_List</span>] := <span class="tnv">idx</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnt">n_</span> /; <span class="tnv">n</span>&gt;<span class="tl">1</span> :&gt; <span class="tnv">n</span>-<span class="tl">1</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>]
<span class="tnv">IndicesToT</span>[<span class="tnt">idx_List</span>] := <span class="tnv">idx</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnt">n_</span> /; <span class="tnv">n</span> &gt; <span class="tl">0</span>]
<span class="tnv">IndicesToS</span>[<span class="tnt">idx_List</span>] := <span class="tnv">idx</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnt">n_</span> /; <span class="tnv">n</span> &lt; <span class="tl">0</span> :&gt; -<span class="tnv">n</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>]

<span class="tnv">BToR</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>]] := <span class="tnv">IndicesToR</span>[{<span class="tnv">idx</span>}]
<span class="tnv">BToR</span>[<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, _]] := <span class="tnv">BToR</span>[<span class="tnv">b</span>]
<span class="tnv">BToDots</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>]] := <span class="tnv">IndicesToDots</span>[{<span class="tnv">idx</span>}]
<span class="tnv">BToDots</span>[<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, _]] := <span class="tnv">BToDots</span>[<span class="tnv">b</span>]
<span class="tnv">BToT</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>]] := <span class="tnv">IndicesToT</span>[{<span class="tnv">idx</span>}]
<span class="tnv">BToT</span>[<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, _]] := <span class="tnv">BToT</span>[<span class="tnv">b</span>]
<span class="tnv">BToS</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>]] := <span class="tnv">IndicesToS</span>[{<span class="tnv">idx</span>}]
<span class="tnv">BToS</span>[<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, _]] := <span class="tnv">BToS</span>[<span class="tnv">b</span>]
<span class="tnv">BToBID</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>]] := <span class="tnv">bid</span>
<span class="tnv">BToBID</span>[<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, _]] := <span class="tnv">BToBID</span>[<span class="tnv">b</span>]
<span class="tnv">BToIndices</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>]] := {<span class="tnv">idx</span>}
<span class="tnv">BToIndices</span>[<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, <span class="tnt">n_</span>]] := <span class="tnv">BToIndices</span>[<span class="tnv">b</span>]
<span class="tnv">BToDimension</span>[<span class="tnt">_B</span>] := <span class="tl">4</span>
<span class="tnv">BToDimension</span>[<span class="tnv">DimShift</span>[<span class="tnt">_B</span>, <span class="tnt">n_</span>]] := <span class="tl">4</span>+<span class="tnv">n</span></pre>
<h3 id="BToSector"><code>BToSector[]</code></h3>
<p>Convert an integral in B notation into the corner integral of
the corresponding sector (i.e. normalize all indices to 1 or 0.</p>
<pre><a class="tnv" href="#BToSector">BToSector</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>]] :=
  <span class="tnv">B</span>[<span class="tnv">bid</span>, {<span class="tnv">idx</span>} // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{ <span class="tnt">n_</span> /; <span class="tnv">n</span> &lt;= <span class="tl">0</span> -&gt; <span class="tl">0</span>, _ -&gt; <span class="tl">1</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>]]

<a class="tnv" href="#BToSector">BToSector</a>[<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, _]] := <a class="tnv" href="#BToSector">BToSector</a>[<span class="tnv">b</span>]</pre>
<h3 id="BToSectorPattern"><code>BToSectorPattern[]</code></h3>
<p>Convert an integral in B notation into a pattern matching the
corresponding sector.</p>
<pre><a class="tnv" href="#BToSectorPattern">BToSectorPattern</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>]] :=
  <span class="tnv">B</span>[<span class="tnv">bid</span>, {<span class="tnv">idx</span>} // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{ <span class="tnt">n_</span> /; <span class="tnv">n</span> &lt;= <span class="tl">0</span> -&gt; _?<a class="tnb" href="https://reference.wolfram.com/language/ref/NonPositive.html" rel="nofollow">NonPositive</a>, _ -&gt; _?<a class="tnb" href="https://reference.wolfram.com/language/ref/Positive.html" rel="nofollow">Positive</a>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>]]

<a class="tnv" href="#BToSectorPattern">BToSectorPattern</a>[<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, _]] := <a class="tnv" href="#BToSectorPattern">BToSectorPattern</a>[<span class="tnv">b</span>]

<a class="tnv" href="#BToSectorPattern">BToSectorPattern</a>[<span class="tnt">bs_List</span>] := <span class="tnv">bs</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#BToSectorPattern">BToSectorPattern</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>]</pre>
<h3 id="TopSectors"><code>TopSectors[]</code></h3>
<p>Figure out a list of topmost sectors containing all the
supplied integrals. Each returned sector is an <code>Association</code>
with keys <code>id</code>, <code>idx</code>, <code>r</code>, <code>s</code>, and <code>d</code>. The integrals are
specified by the lists of their indices.</p>
<pre><a class="tnv" href="#TopSectors">TopSectors</a>[<span class="tnt">idxlist_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">sector2i</span>, <span class="tnvc">sector2r</span>, <span class="tnvc">sector2s</span>, <span class="tnvc">sector2d</span>, <span class="tnvc">o2sectors</span>, <span class="tnvc">int</span>, <span class="tnvc">sector</span>, <span class="tnvc">r</span>, <span class="tnvc">s</span>, <span class="tnvc">d</span>, <span class="tnvc">o</span>, <span class="tnvc">sectors</span>, <span class="tnvc">done</span>, <span class="tnvc">i</span>, <span class="tnvc">ss</span>},
  <span class="tnvc">sector2i</span> = &lt;||&gt;;
  <span class="tnvc">sector2r</span> = &lt;||&gt;;
  <span class="tnvc">sector2s</span> = &lt;||&gt;;
  <span class="tnvc">sector2d</span> = &lt;||&gt;;
  <span class="tnvc">o2sectors</span> = &lt;||&gt;;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
      <span class="tnvc">sector</span> = <a class="tnv" href="#IndicesToSectorId">IndicesToSectorId</a>[<span class="tnvc">int</span>];
      <span class="tnvc">sector2i</span>[<span class="tnvc">sector</span>] = <span class="tnv">SectorIdToIndices</span>[<span class="tnvc">sector</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">int</span>]];
      <span class="tnvc">r</span> = <span class="tnv">IndicesToR</span>[<span class="tnvc">int</span>];
      <span class="tnvc">s</span> = <span class="tnv">IndicesToS</span>[<span class="tnvc">int</span>];
      <span class="tnvc">d</span> = <span class="tnv">IndicesToDots</span>[<span class="tnvc">int</span>];
      <span class="tnvc">o</span> = {<span class="tnvc">s</span>, <span class="tnvc">r</span>};
      <span class="tnvc">o2sectors</span>[<span class="tnvc">o</span>] = {<span class="tnvc">o2sectors</span>[<span class="tnvc">o</span>] /. <span class="tnt">_Missing</span> -&gt; {}, <span class="tnvc">sector</span>};
      <span class="tnvc">sector2r</span>[<span class="tnvc">sector</span>] = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">r</span>, <span class="tnvc">sector2r</span>[<span class="tnvc">sector</span>] /. <span class="tnt">_Missing</span> -&gt; <span class="tl">0</span>];
      <span class="tnvc">sector2d</span>[<span class="tnvc">sector</span>] = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">d</span>, <span class="tnvc">sector2d</span>[<span class="tnvc">sector</span>] /. <span class="tnt">_Missing</span> -&gt; <span class="tl">0</span>];
      <span class="tc">(* Note: s=0 makes Kira produce false masters. It’s not
       * clear if we should only fix s=0 case, or if we need
       * to add +1 to all s. Currently we’re doing the former
       * inside [[MkKiraJobsYaml]].
       *)</span>
      <span class="tnvc">sector2s</span>[<span class="tnvc">sector</span>] = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">s</span>, <span class="tnvc">sector2s</span>[<span class="tnvc">sector</span>] /. <span class="tnt">_Missing</span> -&gt; <span class="tl">0</span>];
      ,
      {<span class="tnvc">int</span>, <span class="tnv">idxlist</span>}
  ];
  <span class="tnvc">sectors</span> = {};
  <span class="tnvc">done</span> = {};
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
          <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MemberQ.html" rel="nofollow">MemberQ</a>[<span class="tnvc">done</span>, <span class="tnvc">sector</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Continue.html" rel="nofollow">Continue</a>[]];
          <span class="tnvc">i</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/FirstPosition.html" rel="nofollow">FirstPosition</a>[<span class="tnvc">done</span>, <span class="tnt">ss_</span> /; (<a class="tnb" href="https://reference.wolfram.com/language/ref/BitAnd.html" rel="nofollow">BitAnd</a>[<span class="tnvc">ss</span>, <span class="tnvc">sector</span>] === <span class="tnvc">sector</span>)];
          <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">i</span>, <span class="tnt">_Missing</span>],
              <a class="tnb" href="https://reference.wolfram.com/language/ref/AppendTo.html" rel="nofollow">AppendTo</a>[<span class="tnvc">done</span>, <span class="tnvc">sector</span>];
              <a class="tnb" href="https://reference.wolfram.com/language/ref/AppendTo.html" rel="nofollow">AppendTo</a>[<span class="tnvc">sectors</span>, <span class="tnvc">sector</span>];
              ,
              <span class="tnvc">i</span> = <span class="tnvc">i</span>[[<span class="tl">1</span>]];
              <span class="tnvc">sector2r</span>[<span class="tnvc">done</span>[[<span class="tnvc">i</span>]]] = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">sector2r</span>[<span class="tnvc">sector</span>], <span class="tnvc">sector2r</span>[<span class="tnvc">done</span>[[<span class="tnvc">i</span>]]]];
              <span class="tnvc">sector2d</span>[<span class="tnvc">done</span>[[<span class="tnvc">i</span>]]] = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">sector2d</span>[<span class="tnvc">sector</span>], <span class="tnvc">sector2d</span>[<span class="tnvc">done</span>[[<span class="tnvc">i</span>]]]];
              <span class="tnvc">sector2s</span>[<span class="tnvc">done</span>[[<span class="tnvc">i</span>]]] = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">sector2s</span>[<span class="tnvc">sector</span>], <span class="tnvc">sector2s</span>[<span class="tnvc">done</span>[[<span class="tnvc">i</span>]]]];
              ];
          ,
          {<span class="tnvc">sector</span>, <span class="tnvc">o2sectors</span>[<span class="tnvc">o</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Reverse.html" rel="nofollow">Reverse</a>}
      ];
      ,
      {<span class="tnvc">o</span>, <span class="tnvc">o2sectors</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Keys.html" rel="nofollow">Keys</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Reverse.html" rel="nofollow">Reverse</a>}
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    &lt;|<span class="ts">"id"</span> -&gt; <span class="tnvc">sector</span>, <span class="ts">"idx"</span> -&gt; <span class="tnvc">sector2i</span>[<span class="tnvc">sector</span>], <span class="ts">"r"</span> -&gt; <span class="tnvc">sector2r</span>[<span class="tnvc">sector</span>], <span class="ts">"s"</span> -&gt; <span class="tnvc">sector2s</span>[<span class="tnvc">sector</span>], <span class="ts">"d"</span> -&gt; <span class="tnvc">sector2d</span>[<span class="tnvc">sector</span>]|&gt;
    ,
    {<span class="tnvc">sector</span>, <span class="tnvc">sectors</span>}] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>
]</pre>
<h3 id="TopSectorMap"><code>TopSectorMap[]</code></h3>
<p>Return an association from basis ids to top sector lists as
given by <a href="#TopSectors">TopSectors</a>.</p>
<pre><a class="tnv" href="#TopSectorMap">TopSectorMap</a>[<span class="tnt">blist_</span>] :=
  <span class="tnv">blist</span> //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, ___] :&gt; <span class="tnv">bid</span>]] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[(<span class="tnv">#</span>[[;;,<span class="tl">2</span>;;]])&amp; /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>]] /* <a class="tnv" href="#TopSectors">TopSectors</a>]</pre>
<h3 id="SectorUnion"><code>SectorUnion[]</code></h3>
<p>Return a list of sectors that represent a union of the given
ones. In other words, drop the subsectors.</p>
<pre><a class="tnv" href="#SectorUnion">SectorUnion</a>[<span class="tnt">sectors_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{},
  <span class="tnv">sectors</span> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // 
    <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>[[<span class="tl">1</span>]]&amp;] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> //
    <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
      (<span class="tnt">bid_</span> -&gt; <span class="tnt">seclist_</span>) :&gt; (
        <span class="tnv">seclist</span>[[;;, <span class="tl">2</span>;;]] //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>]] //
          <a class="tnv" href="#TopSectors">TopSectors</a> //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span>[<span class="ts">"idx"</span>]&amp;] //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">B</span>[<span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a> @@ <span class="tnv">#</span>]&amp;]
      )
    ] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>]
]</pre>
<h3 id="MkKiraEquations"><code>MkKiraEquations[]</code></h3>
<p>Create a list of preferred masters in Kira syntax.
The masters themselves can be both single integrals
in the <code>B</code> notation, or linear combinations of them.</p>
<pre><a class="tnv" href="#MkKiraEquations">MkKiraEquations</a>[<span class="tnt">filename_String</span>, <span class="tnv">masters</span>:{(<span class="tnt">_B</span>|<span class="tnt">_DimShift</span>|<span class="tnt">_amplitude</span>) ...}] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">COEF</span>},
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">filename</span>,
    <span class="tnv">masters</span> //
      <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{
        <span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>] :&gt;
          {<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[{<span class="tnv">idx</span>}, <span class="ts">","</span>], <span class="ts">"]\n"</span>},
        <span class="tnv">DimShift</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>], <span class="tnt">n_</span>] :&gt;
          {<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"_dimshift"</span>, <span class="tnv">n</span>, <span class="ts">"["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[{<span class="tnv">idx</span>}, <span class="ts">","</span>], <span class="ts">"]\n"</span>},
        <span class="tnv">amplitude</span>[<span class="tnt">idx___</span>] :&gt;
          {<span class="ts">"amplitude["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[{<span class="tnv">idx</span>}, <span class="ts">","</span>], <span class="ts">"]\n"</span>}
      }]
  ]
]

<a class="tnv" href="#MkKiraEquations">MkKiraEquations</a>[<span class="tnt">filename_String</span>, <span class="tnt">expressions_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">COEF</span>},
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">filename</span>,
    <span class="tnv">expressions</span> //
      <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_B</span>|<span class="tnt">_DimShift</span>|<span class="tnt">_amplitude</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Factor.html" rel="nofollow">Factor</a> /* <span class="tnvc">COEF</span>]&amp; //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[
        <a class="tnv" href="utils.html#Terms">Terms</a> /*
        <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{
            <span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>]*<span class="tnvc">COEF</span>[<span class="tnt">co_</span>] :&gt;
              {<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[{<span class="tnv">idx</span>}, <span class="ts">","</span>], <span class="ts">"]*("</span>, <span class="tnv">co</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span>-&gt;<span class="ts">""</span>], <span class="ts">")\n"</span>},
            <span class="tnv">DimShift</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx___</span>], <span class="tnt">n_</span>]*<span class="tnvc">COEF</span>[<span class="tnt">co_</span>] :&gt;
              {<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"_dimshift"</span>, <span class="tnv">n</span>, <span class="ts">"["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[{<span class="tnv">idx</span>}, <span class="ts">","</span>], <span class="ts">"]*("</span>, <span class="tnv">co</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span>-&gt;<span class="ts">""</span>], <span class="ts">")\n"</span>},
            <span class="tnv">amplitude</span>[<span class="tnt">idx___</span>]*<span class="tnvc">COEF</span>[<span class="tnt">co_</span>] :&gt;
              {<span class="ts">"amplitude["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[{<span class="tnv">idx</span>}, <span class="ts">","</span>], <span class="ts">"]*("</span>, <span class="tnv">co</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span>-&gt;<span class="ts">""</span>], <span class="ts">")\n"</span>}
          }]
      ] //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"\n"</span>]&amp;
  ]
]</pre>
<h3 id="MkKiraConfig"><code>MkKiraConfig[]</code></h3>
<p>Create Kira’s configuration directory for reduction of
the given integrals under the given bases.</p>
<pre><a class="tnv" href="#MkKiraConfig">MkKiraConfig</a>[<span class="tnt">dirname_</span>, <span class="tnt">bases_List</span>, <span class="tnt">blist_</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid</span>, <span class="tnvc">bids</span>, <span class="tnvc">bid2topsector</span>, <span class="tnvc">idxlist</span>, <span class="tnvc">massdims</span>},
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">dirname</span>];
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/config"</span>];
  <span class="tnvc">bids</span> = <span class="tnv">blist</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, ___] :&gt; <span class="tnvc">bid</span>];
  <span class="tnv">bid2topsectors</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <span class="tnvc">bid</span> -&gt; (<span class="tnv">blist</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnvc">bid</span>, <span class="tnt">idx__</span>] :&gt; {<span class="tnv">idx</span>}] // <a class="tnv" href="#TopSectors">TopSectors</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>)
    ,
    {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>;
  <span class="tnvc">massdims</span> = <a class="tnv" href="#IBPBasisMassDimensions">IBPBasisMassDimensions</a>[<span class="tnv">bases</span>];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnvc">massdims</span>[[;;,<span class="tl">1</span>]]] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"invariants"</span>]]]];
  <span class="tnvc">massdims</span> = <span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"invariants"</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[(<span class="tnv">#</span> -&gt; (<span class="tnv">#</span> /. <span class="tnvc">massdims</span>))&amp;];
  <a class="tnv" href="#MkKiraKinematicsYaml">MkKiraKinematicsYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/config/kinematics.yaml"</span>,
    <span class="tnv">bases</span>[[<span class="tl">1</span>,<span class="ts">"externalmom"</span>]], <span class="tnv">bases</span>[[<span class="tl">1</span>,<span class="ts">"sprules"</span>]], <span class="tnvc">massdims</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">ReplaceByOne</span>]];
  <a class="tnv" href="#MkKiraIntegralFamiliesYaml">MkKiraIntegralFamiliesYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/config/integralfamilies.yaml"</span>,<span class="tc">(* bases];*)</span>
    <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MemberQ.html" rel="nofollow">MemberQ</a>[<span class="tnvc">bids</span>, <span class="tnv">#</span>[<span class="ts">"id"</span>]]&amp;]];
  <a class="tnv" href="#MkKiraJobsYaml">MkKiraJobsYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/reduce.yaml"</span>, <span class="tnvc">bids</span>, <span class="tnv">bid2topsectors</span>, <span class="ts">"reduce"</span>];
  <a class="tnv" href="#MkKiraJobsYaml">MkKiraJobsYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/prepare.yaml"</span>, <span class="tnvc">bids</span>, <span class="tnv">bid2topsectors</span>, <span class="ts">"prepare"</span>];
  <a class="tnv" href="#MkKiraJobsYaml">MkKiraJobsYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/prepare-uds.yaml"</span>, <span class="tnvc">bids</span>, <span class="tnv">bid2topsectors</span>, <span class="ts">"prepare-input"</span>];
  <a class="tnv" href="#MkKiraFinishUDSYaml">MkKiraFinishUDSYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/finish-uds.yaml"</span>, <span class="tnvc">bids</span>]
  <a class="tnv" href="#MkKiraIntegrals">MkKiraIntegrals</a>[<span class="tnv">dirname</span>, <span class="tnv">blist</span>];
  <a class="tnv" href="#MkKiraEquations">MkKiraEquations</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/preferred-masters"</span>, 
    <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">PreferredMasters</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<span class="tnv">B</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnvc">bids</span>, ___]]]];
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/Makefile"</span>,
    <span class="ts">"THREADS?= 1\n"</span>,
    <span class="ts">"RUN ?=\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"reduce.done: "</span>,
      <span class="ts">"reduce.yaml "</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">".integrals "</span>}, {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}],
      <span class="ts">"config/integralfamilies.yaml "</span>,
      <span class="ts">"config/kinematics.yaml "</span>,
      <span class="ts">"preferred-masters\n"</span>,
    <span class="ts">"\t${RUN} tempwrap "</span>,
      <span class="ts">"./ -i 'b*integrals' -i 'pref*' -i '*yaml' "</span>,
      <span class="ts">"./ -o 'results/b*' -o '*.log' "</span>,
      <span class="ts">"-- $${KIRA:-kira} reduce.yaml --parallel=${THREADS} --bunch_size=8\n"</span>,
    <span class="ts">"\tdate &gt;$@\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"prepare-uds.done: "</span>,
      <span class="ts">"prepare-uds.yaml "</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">".integrals "</span>}, {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}],
      <span class="ts">"config/integralfamilies.yaml "</span>,
      <span class="ts">"config/kinematics.yaml\n"</span>,
    <span class="ts">"\trm -rf input_kira/\n"</span>,
    <span class="ts">"\t${RUN} tempwrap "</span>,
      <span class="ts">"./ -i 'b*integrals' -i 'pref*' -i '*yaml' "</span>,
      <span class="ts">"./ -o 'input_kira/*' -o '*.log' "</span>,
      <span class="ts">"-- $${KIRA:-kira} prepare-uds.yaml --parallel=${THREADS} --bunch_size=8 &gt;$@.log 2&gt;&amp;1\n"</span>,
    <span class="ts">"\tdate &gt;$@\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"finish-uds.done: "</span>,
      <span class="ts">"sed-arguments "</span>,
      <span class="ts">"prepare-uds.done "</span>,
      <span class="ts">"finish-uds.yaml "</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">".integrals "</span>}, {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}],
      <span class="ts">"\n"</span>,
    <span class="ts">"\t${RUN} tempwrap "</span>,
      <span class="ts">"./ -i 'b*integrals' -i 'input_kira/*' -i 'pref*' -i 'finish-uds.yaml' "</span>,
      <span class="ts">"./ -o 'results/b*' -o '*.log' "</span>,
      <span class="ts">"$$(cat sed-arguments) "</span>,
      <span class="ts">"-- $${KIRA:-kira} finish-uds.yaml --parallel=${THREADS} --bunch_size=8 &gt;$@.log 2&gt;&amp;1\n"</span>,
    <span class="ts">"\tdate &gt;$@\n"</span>
  ];
]
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#MkKiraConfig">MkKiraConfig</a>] = {<span class="tnv">PreferredMasters</span> -&gt; {}, <span class="tnv">ReplaceByOne</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>};

<span class="tnv">KiraAmplitudeTag</span>[<span class="tnt">n_</span>, <span class="tnt">nprops_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/IntegerDigits.html" rel="nofollow">IntegerDigits</a>[<span class="tnv">n</span>, <span class="tl">2</span>, <span class="tnv">nprops</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Reverse.html" rel="nofollow">Reverse</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<span class="tnv">amplitude</span>]</pre>
<h3 id="MkKiraConfigUDS"><code>MkKiraConfigUDS[]</code></h3>
<p>Create Kira’s configuration directory for reduction of
the given integrals under the given bases.</p>
<pre><a class="tnv" href="#MkKiraConfigUDS">MkKiraConfigUDS</a>[<span class="tnt">dirname_</span>, <span class="tnt">bases_List</span>, <span class="tnt">blist_</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid</span>, <span class="tnvc">bids</span>, <span class="tnvc">bid2topsector</span>, <span class="tnvc">idxlist</span>, <span class="tnvc">massdims</span>, <span class="tnvc">sector</span>, <span class="tnvc">nprops</span>, <span class="tnvc">r</span>, <span class="tnvc">s</span>},
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">dirname</span>];
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/config"</span>];
  <span class="tnvc">bids</span> = <span class="tnv">blist</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, ___] :&gt; <span class="tnvc">bid</span>];
  <span class="tnv">bid2topsectors</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <span class="tnvc">idxlist</span> = <span class="tnv">blist</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnvc">bid</span>, <span class="tnt">idx__</span>] :&gt; {<span class="tnv">idx</span>}];
    <span class="tnvc">bid</span> -&gt; (<span class="tnvc">idxlist</span> // <a class="tnv" href="#TopSectors">TopSectors</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>)
    ,
    {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>;
  <span class="tnvc">massdims</span> = <a class="tnv" href="#IBPBasisMassDimensions">IBPBasisMassDimensions</a>[<span class="tnv">bases</span>];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnvc">massdims</span>[[;;,<span class="tl">1</span>]]] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"invariants"</span>]]]];
  <span class="tnvc">massdims</span> = <span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"invariants"</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[(<span class="tnv">#</span> -&gt; (<span class="tnv">#</span> /. <span class="tnvc">massdims</span>))&amp;];
  <a class="tnv" href="#MkKiraKinematicsYaml">MkKiraKinematicsYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/config/kinematics.yaml"</span>,
    <span class="tnv">bases</span>[[<span class="tl">1</span>,<span class="ts">"externalmom"</span>]], <span class="tnv">bases</span>[[<span class="tl">1</span>,<span class="ts">"sprules"</span>]], <span class="tnvc">massdims</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">ReplaceByOne</span>]];
  <a class="tnv" href="#MkKiraIntegralFamiliesYaml">MkKiraIntegralFamiliesYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/config/integralfamilies.yaml"</span>,<span class="tc">(* bases];*)</span>
    <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MemberQ.html" rel="nofollow">MemberQ</a>[<span class="tnvc">bids</span>, <span class="tnv">#</span>[<span class="ts">"id"</span>]]&amp;]];</pre>
<p>jobs:</p>
<ul>
<li>reduce_sectors:
reduce:
<ul>
<li>{r: 7, s: 2}
weight_notation: false
generate_input: { level: 0}</li>
</ul>
</li>
</ul>
<pre>  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/prepare.yaml"</span>,
    <span class="ts">"jobs:\n"</span>,
    <span class="ts">" - reduce_sectors:\n"</span>,
    <span class="ts">"    reduce:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
        <span class="tnvc">r</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">sector</span>[<span class="ts">"r"</span>], <span class="tl">1</span> + <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>@@<span class="tnvc">sector</span>[<span class="ts">"idx"</span>]];
        <span class="tnvc">s</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnvc">sector</span>[<span class="ts">"s"</span>], <span class="tl">1</span>];
        {<span class="ts">"     - {topologies: ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">"], sectors: [b"</span>, <span class="tnvc">sector</span>[<span class="ts">"idx"</span>], <span class="ts">"], r: "</span>, <span class="tnvc">r</span>, <span class="ts">", s: "</span>, <span class="tnvc">s</span>, <span class="ts">"}\n"</span>}
        ,
        {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>},
        {<span class="tnvc">sector</span>, <span class="tnv">bid2topsectors</span>[<span class="tnvc">bid</span>]}],
    <span class="ts">"    generate_input: {level: 0}\n"</span>,
    <span class="ts">"    weight_notation: false\n"</span>
  ];
  <span class="tnvc">nprops</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">bases</span>[[<span class="tl">1</span>,<span class="ts">"denominators"</span>]]];
  <a class="tnv" href="#MkKiraEquations">MkKiraEquations</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/expressions"</span>,
    <span class="tnv">blist</span> // <a class="tnv" href="utils.html#MapIndexed1">MapIndexed1</a>[<span class="tnv">#1</span>-<span class="tnv">KiraAmplitudeTag</span>[<span class="tnv">#2</span>, <span class="tnvc">nprops</span>]&amp;]];
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/weights"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<span class="tnv">KiraAmplitudeTag</span>[<span class="tnv">i</span>, <span class="tnvc">nprops</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span>-&gt;<span class="ts">""</span>], <span class="ts">"\n"</span>}, {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">blist</span>]}]];
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/solve.yaml"</span>,
    <span class="ts">"jobs:\n"</span>,
    <span class="ts">" - reduce_user_defined_system:\n"</span>,
    <span class="ts">"    input_system:\n"</span>,
    <span class="ts">"     config: false\n"</span>,
    <span class="ts">"     otf: true\n"</span>,
    <span class="ts">"     files:\n"</span>,
    <span class="ts">"      - \"expressions\"\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      {<span class="ts">"      - \"input_kira/"</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">"\"\n"</span>},
      {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}],
    <span class="ts">"    select_integrals:\n"</span>,
    <span class="ts">"     select_mandatory_list:\n"</span>,
    <span class="ts">"      - [\"weights\"]\n"</span>,
    <span class="ts">"#    iterative_reduction: masterwise\n"</span>,
    <span class="ts">"    preferred_masters: \"preferred-masters\"\n"</span>,
    <span class="ts">"    run_initiate: true\n"</span>,
    <span class="ts">"#    run_triangular: true\n"</span>,
    <span class="ts">"#    run_back_substitution: true\n"</span>,
    <span class="ts">"    run_firefly: true\n"</span>,
    <span class="ts">" - kira2math:\n"</span>,
    <span class="ts">"    target:\n"</span>,
    <span class="ts">"      - [\"weights\"]\n"</span>
  ];
  <a class="tnv" href="#MkKiraEquations">MkKiraEquations</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/preferred-masters"</span>, 
    <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">PreferredMasters</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<span class="tnv">B</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnvc">bids</span>, ___]]]];
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/Makefile"</span>,
    <span class="ts">"THREADS?= 1\n"</span>,
    <span class="ts">"RUN ?=\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"prepare.done: "</span>,
      <span class="ts">"prepare.yaml "</span>,
      <span class="ts">"preferred-masters "</span>,
      <span class="ts">"config/integralfamilies.yaml "</span>,
      <span class="ts">"config/kinematics.yaml\n"</span>,
    <span class="ts">"\trm -rf input_kira/ results/\n"</span>,
    <span class="ts">"\t${RUN} tempwrap "</span>,
      <span class="ts">"./ -i '*yaml' -i 'pref*' "</span>,
      <span class="ts">"./ -o 'input_kira/*' -o '*.log' -o '*id2int' "</span>,
      <span class="ts">"-- $${KIRA:-kira} prepare.yaml --parallel=${THREADS} --bunch_size=8\n"</span>,
    <span class="ts">"\tdate &gt;$@\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"solve.done: "</span>,
      <span class="ts">"sed-arguments "</span>,
      <span class="ts">"prepare.done "</span>,
      <span class="ts">"solve.yaml "</span>,
      <span class="ts">"weights "</span>,
      <span class="ts">"\n"</span>,
    <span class="ts">"\t${RUN} tempwrap "</span>,
      <span class="ts">"./ -i '*yaml' -i expressions -i weights -i 'pref*' -i 'input_kira/*' "</span>,
      <span class="ts">"./ -o 'results/*' -o '*.log' "</span>,
      <span class="ts">"$$(cat sed-arguments) "</span>,
      <span class="ts">"-- $${KIRA:-kira} solve.yaml --parallel=${THREADS} --bunch_size=8\n"</span>,
    <span class="ts">"\tdate &gt;$@\n"</span>
  ];
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/sed-arguments"</span>, <span class="ts">""</span>];
]
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#MkKiraConfigUDS">MkKiraConfigUDS</a>] = {<span class="tnv">PreferredMasters</span> -&gt; {}, <span class="tnv">ReplaceByOne</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>};</pre>
<h3 id="MkKiraConfigByBasis"><code>MkKiraConfigByBasis[]</code></h3>
<p>Populate a directory with Kira subdirectories for each basis, and
write a Makefile that runs Kira for each of them. With this done,
just running <code>make</code> should already reduce each basis (separately).</p>
<p>The intended usage however is to parallelize the computations
on a cluster. To this end, first define <code>THREADS</code> environment
variable, that specifies how many threads should each Kira
use, and the <code>RUN</code> environment variable, that specifies the
command prefix for running jobs on the cluster (for example,
<code>srun -c16 --mem=50G --tmp=10G</code>); then run <code>make -j99</code>.</p>
<p>The idea behind <code>THREADS</code> and <code>RUN</code> variables is the same as
with <a href="#SecDecPrepare">SecDecPrepare</a>.</p>
<p>Note that unlike the direct usage, to discover symmetries
between master integrals in different bases, a separate combined
IBP run is needed -- this time covering only the master integrals.</p>
<pre><a class="tnv" href="#MkKiraConfigByBasis">MkKiraConfigByBasis</a>[<span class="tnt">dirname_</span>, <span class="tnt">bases_List</span>, <span class="tnt">blist_</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid</span>, <span class="tnvc">bids</span>, <span class="tnvc">bid2basis</span>, <span class="tnvc">name</span>},
  <span class="tnvc">bids</span> = <span class="tnv">blist</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, ___] :&gt; <span class="tnvc">bid</span>];
  <span class="tnvc">bid2basis</span> = <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>[<span class="ts">"id"</span>]&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#Only">Only</a>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
    <a class="tnv" href="#MkKiraConfig">MkKiraConfig</a>[
      <span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/"</span> &lt;&gt; <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>],
      {<span class="tnvc">bid2basis</span>[<span class="tnvc">bid</span>]},
      <span class="tnv">blist</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnvc">bid</span>,___]],
      <span class="tnv">PreferredMasters</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">PreferredMasters</span>],
      <span class="tnv">ReplaceByOne</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">ReplaceByOne</span>]
    ];
    ,
    {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}];
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/Makefile"</span>,
    <span class="ts">"THREADS?= 1\n"</span>,
    <span class="ts">"RUN ?=\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      <span class="tnvc">name</span> = <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>];
      {
        <span class="ts">"\n"</span>,
        <span class="ts">"reduce: "</span>, <span class="tnvc">name</span>, <span class="ts">"/reduce.done\n"</span>,
        <span class="ts">"\n"</span>,
        <span class="tnvc">name</span>, <span class="ts">"/reduce.done: "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/reduce.yaml "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/config/integralfamilies.yaml "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/config/kinematics.yaml "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/preferred-masters "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/"</span>, <span class="tnvc">name</span>, <span class="ts">".integrals\n"</span>,
        <span class="ts">"\t${RUN} tempwrap "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/ -i 'b*integrals' -i 'pref*' -i '*yaml' "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/ -o 'results/b*' -o '*.log' "</span>,
          <span class="ts">"-- $${KIRA:-kira} reduce.yaml --parallel=${THREADS} --bunch_size=8 &gt;$@.log 2&gt;&amp;1\n"</span>,
        <span class="ts">"\tdate &gt;$@\n"</span>,
        <span class="ts">"\n"</span>,
        <span class="ts">"prepare-uds: "</span>, <span class="tnvc">name</span>, <span class="ts">"/prepare-uds.done\n"</span>,
        <span class="ts">"\n"</span>,
        <span class="tnvc">name</span>, <span class="ts">"/prepare-uds.done: "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/prepare-uds.yaml "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/config/integralfamilies.yaml "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/config/kinematics.yaml "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/preferred-masters "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/"</span>, <span class="tnvc">name</span>, <span class="ts">".integrals\n"</span>,
        <span class="ts">"\trm -rf input_kira/\n"</span>,
        <span class="ts">"\t${RUN} tempwrap "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/ -i 'b*integrals' -i 'pref*' -i '*yaml' "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/ -o 'input_kira/*' -o '*.log' "</span>,
          <span class="ts">"-- $${KIRA:-kira} prepare-uds.yaml --parallel=${THREADS} --bunch_size=8 &gt;$@.log 2&gt;&amp;1\n"</span>,
        <span class="ts">"\tdate &gt;$@\n"</span>,
        <span class="ts">"\n"</span>,
        <span class="ts">"finish-uds: "</span>, <span class="tnvc">name</span>, <span class="ts">"/finish-uds.done\n"</span>,
        <span class="ts">"\n"</span>,
        <span class="tnvc">name</span>, <span class="ts">"/finish-uds.done: "</span>,
          <span class="ts">"sed-arguments "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/prepare-uds.done "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/finish-uds.yaml "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/preferred-masters "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/"</span>, <span class="tnvc">name</span>, <span class="ts">".integrals\n"</span>,
        <span class="ts">"\t${RUN} tempwrap "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/ -i 'b*integrals' -i 'input_kira/*' -i 'pref*' -i 'finish-uds.yaml' "</span>,
          <span class="tnvc">name</span>, <span class="ts">"/ -o 'results/b*' -o '*.log' "</span>,
          <span class="ts">"$$(cat sed-arguments) "</span>,
          <span class="ts">"-- $${KIRA:-kira} finish-uds.yaml --parallel=${THREADS} --bunch_size=8 &gt;$@.log 2&gt;&amp;1\n"</span>,
        <span class="ts">"\tdate &gt;$@\n"</span>
      },
      {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}]
  ];
]
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#MkKiraConfigByBasis">MkKiraConfigByBasis</a>] = {<span class="tnv">PreferredMasters</span> -&gt; {}, <span class="tnv">ReplaceByOne</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>};</pre>
<h3 id="KiraApplyResults"><code>KiraApplyResults[]</code></h3>
<p>Read the IBP tables from a Kira directory, apply them to a
given expression.</p>
<pre><a class="tnv" href="#KiraApplyResults">KiraApplyResults</a>[<span class="tnt">ex_</span>, <span class="tnt">confdir_String</span>, <span class="tnt">bases_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">exx</span>, <span class="tnvc">idx</span>, <span class="tnvc">bids</span>, <span class="tnvc">bid</span>, <span class="tnvc">ibpmapfiles</span>, <span class="tnvc">bvar</span>, <span class="tnvc">table</span>, <span class="tnvc">bmap</span>},
  <span class="tnvc">exx</span> = <span class="tnv">ex</span>;
  <span class="tnvc">bids</span> = <span class="tnvc">exx</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, __] :&gt; <span class="tnvc">bid</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
    <span class="tnvc">ibpmapfiles</span> = <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnv">confdir</span>, <span class="ts">"/results/"</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">"/kira_"</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">".integrals.m"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/FileNames.html" rel="nofollow">FileNames</a>;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">ibpmapfiles</span> === {}, <a class="tnb" href="https://reference.wolfram.com/language/ref/Continue.html" rel="nofollow">Continue</a>[]];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"* Loading IBP tables for basis "</span>, <span class="tnvc">bid</span>];
    <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">ibpmapfiles</span>] === <span class="tl">1</span>];
    <span class="tnvc">table</span> = <a class="tnv" href="#LoadKiraMap">LoadKiraMap</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>[<span class="tnvc">ibpmapfiles</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a> // <a class="tnv" href="utils.html#TM">TM</a>;
    <span class="tc">(*BMapLoadFromKira[bmap, First[ibpmapfiles]];
    (*table = RunThrough["sed 's/b0*\\([0-9]*\\)\\[/B[\\1,/g' '" &lt;&gt; First[ibpmapfiles] &lt;&gt; "'", ""] // TM;
    BMapLoad[bmap, table] // TM;*)
    Print["Masters: "];
    BMapMasters[bmap] // Map[Print["- ", #]&amp;];
    *)</span>
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"* Applying the IBP tables for basis "</span>, <span class="tnvc">bid</span>, <span class="ts">"; expression size "</span>, <span class="tnvc">exx</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/ByteCount.html" rel="nofollow">ByteCount</a>//<a class="tnv" href="utils.html#FormatBytes">FormatBytes</a>];
    <span class="tc">(*
    table = {};
    exx = exx // BMapApply[bmap] // TM;
    BMapClear[bmap];
    *)</span>
    <span class="tnvc">exx</span> = <span class="tnvc">exx</span> /. <span class="tnvc">table</span> // <a class="tnv" href="utils.html#TM">TM</a>;
    <span class="tnvc">table</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>;
    ,
    {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}
  ];
  <span class="tnvc">exx</span>
]
<a class="tnv" href="#KiraApplyResults">KiraApplyResults</a>[<span class="tnt">confdir_String</span>, <span class="tnt">bases_List</span>] := <a class="tnv" href="#KiraApplyResults">KiraApplyResults</a>[<span class="tnv">#</span>, <span class="tnv">confdir</span>, <span class="tnv">bases</span>]&amp;</pre>
<h3 id="KiraApplyResultsInBulk"><code>KiraApplyResultsInBulk[]</code></h3>
<p>Read the IBP tables from a Kira directory, apply them to a
given expression.</p>
<pre><a class="tnv" href="#KiraApplyResultsInBulk">KiraApplyResultsInBulk</a>[<span class="tnt">ex_</span>, <span class="tnt">confdir_String</span>, <span class="tnt">bases_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">exx</span>, <span class="tnvc">idx</span>, <span class="tnvc">bids</span>, <span class="tnvc">bid</span>, <span class="tnvc">ibpmapfiles</span>, <span class="tnvc">bvar</span>, <span class="tnvc">table</span>, <span class="tnvc">bmap</span>},
  <span class="tnvc">exx</span> = <span class="tnv">ex</span>;
  <span class="tnvc">bids</span> = <span class="tnvc">exx</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, __] :&gt; <span class="tnvc">bid</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
    <span class="tnvc">ibpmapfiles</span> = <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnv">confdir</span>, <span class="ts">"/results/"</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">"/kira_"</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid</span>], <span class="ts">".integrals.m"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/FileNames.html" rel="nofollow">FileNames</a>;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">ibpmapfiles</span> === {}, <a class="tnb" href="https://reference.wolfram.com/language/ref/Continue.html" rel="nofollow">Continue</a>[]];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"* Loading IBP tables for basis "</span>, <span class="tnvc">bid</span>];
    <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">ibpmapfiles</span>] === <span class="tl">1</span>];
    <span class="tnvc">table</span> = <a class="tnv" href="#LoadKiraMap">LoadKiraMap</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>[<span class="tnvc">ibpmapfiles</span>]] // <a class="tnv" href="utils.html#TM">TM</a>;
    <a class="tnv" href="utils.html#BMapLoad">BMapLoad</a>[<span class="tnvc">bmap</span>, <span class="tnvc">table</span>] // <a class="tnv" href="utils.html#TM">TM</a>;
    <span class="tnvc">table</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>;
    ,
    {<span class="tnvc">bid</span>, <span class="tnvc">bids</span>}
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"* Applying the IBP tables"</span>];
  <span class="tnvc">exx</span> = <span class="tnv">ex</span> // <a class="tnv" href="utils.html#BMapApply">BMapApply</a>[<span class="tnvc">bmap</span>];
  <a class="tnv" href="utils.html#BMapClear">BMapClear</a>[<span class="tnvc">bmap</span>];
  <span class="tnvc">exx</span>
]
<a class="tnv" href="#KiraApplyResultsInBulk">KiraApplyResultsInBulk</a>[<span class="tnt">confdir_String</span>, <span class="tnt">bases_List</span>] := <a class="tnv" href="#KiraApplyResultsInBulk">KiraApplyResultsInBulk</a>[<span class="tnv">#</span>, <span class="tnv">confdir</span>, <span class="tnv">bases</span>]&amp;</pre>
<h3 id="LoadKiraMap"><code>LoadKiraMap[]</code></h3>
<p>Load an IBP map from a Kira output file.</p>
<pre><a class="tnv" href="#LoadKiraMap">LoadKiraMap</a>[<span class="tnt">filename_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">table</span>},
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/FileExistsQ.html" rel="nofollow">FileExistsQ</a>[<span class="tnv">filename</span>]];
  <span class="tnvc">table</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/RunThrough.html" rel="nofollow">RunThrough</a>[<span class="ts">"sed -E -e 's/b0*([0-9]+)_dimshift([0-9]+)\\[/B[DimShift[\\1,\\2],/g' -e 's/b0*([0-9]*)\\[/B[\\1,/g' '"</span> &lt;&gt; <span class="tnv">filename</span> &lt;&gt; <span class="ts">"'"</span>, <span class="ts">""</span>];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">table</span>, <span class="tnt">_List</span>]];
  <span class="tnvc">table</span> /. <span class="tnv">B</span>[<span class="tnv">DimShift</span>[<span class="tnt">bid_</span>, <span class="tnt">n_</span>], <span class="tnt">idx___</span>] :&gt; <span class="tnv">DimShift</span>[<span class="tnv">B</span>[<span class="tnv">bid</span>, <span class="tnv">idx</span>], <span class="tnv">n</span>]
]
<a class="tnv" href="#LoadKiraMap">LoadKiraMap</a>[<span class="tnt">filenames_List</span>] := <span class="tnv">filenames</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#LoadKiraMap">LoadKiraMap</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>]</pre>
<h3 id="LoadKiraMasters"><code>LoadKiraMasters[]</code></h3>
<p>Extract the list of master integrals from Kira results.</p>
<pre><a class="tnv" href="#LoadKiraMasters">LoadKiraMasters</a>[<span class="tnt">confdir_String</span>] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/FileNames.html" rel="nofollow">FileNames</a>[<span class="tnv">confdir</span> &lt;&gt; <span class="ts">"/results/b*/masters"</span>] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ReadString.html" rel="nofollow">ReadString</a> /*
    (<a class="tnb" href="https://reference.wolfram.com/language/ref/StringSplit.html" rel="nofollow">StringSplit</a>[<span class="tnv">#</span>, <span class="ts">"\n"</span>]&amp;) /*
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[
      <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">"["</span> -&gt; <span class="ts">","</span>] /*
      <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">"]"</span> ~~ ___ -&gt; <span class="ts">"]"</span>] /*
      <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">"b"</span> ~~ <span class="tnv">x</span>:(<a class="tnb" href="https://reference.wolfram.com/language/ref/DigitCharacter.html" rel="nofollow">DigitCharacter</a> ...) ~~ <span class="ts">"_dimshift"</span> ~~ <span class="tnv">n</span>:(<a class="tnb" href="https://reference.wolfram.com/language/ref/DigitCharacter.html" rel="nofollow">DigitCharacter</a> ...) :&gt;
        <span class="ts">"B[DimShift["</span> &lt;&gt; <span class="tnv">x</span> &lt;&gt; <span class="ts">","</span> &lt;&gt; <span class="tnv">n</span> &lt;&gt;<span class="ts">"]"</span>] /*
      <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">"b"</span> -&gt; <span class="ts">"B["</span>] /*
      <a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a> /*
      <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">B</span>[<span class="tnv">DimShift</span>[<span class="tnt">bid_</span>, <span class="tnt">n_</span>], <span class="tnt">idx___</span>] :&gt; <span class="tnv">DimShift</span>[<span class="tnv">B</span>[<span class="tnv">bid</span>, <span class="tnv">idx</span>], <span class="tnv">n</span>]]
    ]
  ] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a></pre>
<h3 id="KiraIBP"><code>KiraIBP[]</code></h3>
<p>Perform full IBP reduction of an expression using Kira,
replacing all the <code>B[...]</code> with linear combinations of master
integrals.</p>
<p>Note that usually it’s not the best idea to run Kira from
Mathematica. It is possible though.</p>
<pre><a class="tnv" href="#KiraIBP">KiraIBP</a>[<span class="tnt">ex_</span>, <span class="tnt">bases_List</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">blist</span>, <span class="tnvc">confdir</span>, <span class="tnvc">result</span>},
  <span class="tnvc">confdir</span> = <a class="tnv" href="utils.html#MkTempDirectory">MkTempDirectory</a>[<span class="ts">"kira"</span>, <span class="ts">""</span>];
  <a class="tnv" href="#MkKiraConfig">MkKiraConfig</a>[<span class="tnvc">confdir</span>, <span class="tnv">bases</span>, <span class="tnv">ex</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_B</span>],
    <span class="tnv">PreferredMasters</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">PreferredMasters</span>],
    <span class="tnv">ReplaceByOne</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">ReplaceByOne</span>]];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Run.html" rel="nofollow">Run</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"make -C '"</span>, <span class="tnvc">confdir</span>, <span class="ts">"'"</span>]] // <a class="tnv" href="utils.html#TM">TM</a> // <span class="tnv">#</span> =!= <span class="tl">0</span>&amp;,
    <a class="tnv" href="utils.html#EnsureNoDirectory">EnsureNoDirectory</a>[<span class="tnvc">confdir</span>];
    <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Failed to run kira in "</span> &lt;&gt; <span class="tnvc">confdir</span>];
  ];
  <span class="tnvc">result</span> = <a class="tnv" href="#KiraApplyResults">KiraApplyResults</a>[<span class="tnv">ex</span>, <span class="tnvc">confdir</span>, <span class="tnv">bases</span>];
  <a class="tnv" href="utils.html#EnsureNoDirectory">EnsureNoDirectory</a>[<span class="tnvc">confdir</span>];
  <span class="tnvc">result</span>
]
<a class="tnv" href="#KiraIBP">KiraIBP</a>[<span class="tnt">bases_List</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] := <a class="tnv" href="#KiraIBP">KiraIBP</a>[<span class="tnv">#</span>, <span class="tnv">bases</span>, 
    <span class="tnv">PreferredMasters</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">PreferredMasters</span>],
    <span class="tnv">ReplaceByOne</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">ReplaceByOne</span>]]&amp;;
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#KiraIBP">KiraIBP</a>] = {<span class="tnv">PreferredMasters</span> -&gt; {}, <span class="tnv">ReplaceByOne</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>};</pre>
<h3 id="MkKiraMastersConfig"><code>MkKiraMastersConfig[]</code></h3>
<p>Create the Kira configuration directory for <a href="#KiraMasters">KiraMasters</a>.</p>
<pre><a class="tnv" href="#MkKiraMastersConfig">MkKiraMastersConfig</a>[<span class="tnt">dirname_String</span>, <span class="tnt">bases_List</span>, <span class="tnt">maxdots_Integer</span>, <span class="tnt">maxnums_Integer</span>, <span class="tnt">intordering_Integer</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">idx</span>},
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">dirname</span>];
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/config"</span>];
  <a class="tnv" href="#MkKiraKinematicsYaml">MkKiraKinematicsYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/config/kinematics.yaml"</span>,
    <span class="tnv">bases</span>[[<span class="tl">1</span>,<span class="ts">"externalmom"</span>]],
    <span class="tnv">bases</span>[[<span class="tl">1</span>,<span class="ts">"sprules"</span>]],
    <a class="tnv" href="#IBPBasisMassDimensions">IBPBasisMassDimensions</a>[<span class="tnv">bases</span>],
    <span class="tnv">bases</span>[[<span class="tl">1</span>, <span class="ts">"invariants"</span>, <span class="tl">1</span>]]];
  <a class="tnv" href="#MkKiraIntegralFamiliesYaml">MkKiraIntegralFamiliesYaml</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/config/integralfamilies.yaml"</span>, <span class="tnv">bases</span>];
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">dirname</span> &lt;&gt; <span class="ts">"/domasters.yaml"</span>,
    <span class="ts">"jobs:\n"</span>,
    <span class="ts">" - reduce_sectors:\n"</span>,
    <span class="ts">"    reduce:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      <span class="tnvc">idx</span> = <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">den</span>[_,_,<span class="tnv">irr</span>] -&gt; <span class="tl">0</span>, _ -&gt; <span class="tl">1</span>];
      {<span class="ts">"     - {topologies: ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnv">basis</span>[<span class="ts">"id"</span>]], <span class="ts">"], sectors: [b"</span>,
        <span class="tnvc">idx</span>, <span class="ts">"], r: "</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnvc">idx</span>,<span class="tl">1</span>] + <span class="tnv">maxdots</span>, <span class="ts">", s: "</span>, <span class="tnv">maxnums</span>, <span class="ts">"}\n"</span>}
      ,
      {<span class="tnv">basis</span>, <span class="tnv">bases</span>}],
    <span class="ts">"    select_integrals:\n"</span>,
    <span class="ts">"     select_mandatory_recursively:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      <span class="tnvc">idx</span> = <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">den</span>[_,_,<span class="tnv">irr</span>] -&gt; <span class="tl">0</span>, _ -&gt; <span class="tl">1</span>];
      {<span class="ts">"      - {topologies: ["</span>, <a class="tnv" href="#KiraBasisName">KiraBasisName</a>[<span class="tnv">basis</span>[<span class="ts">"id"</span>]], <span class="ts">"], sectors: [b"</span>,
        <span class="tnvc">idx</span>, <span class="ts">"], r: "</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnvc">idx</span>,<span class="tl">1</span>] + <span class="tnv">maxdots</span>, <span class="ts">", s: "</span>, <span class="tnv">maxnums</span>, <span class="ts">", d: "</span>, <span class="tnv">maxdots</span>, <span class="ts">"}\n"</span>}
      ,
      {<span class="tnv">basis</span>, <span class="tnv">bases</span>}],
    <span class="ts">"    integral_ordering: "</span>, <span class="tnv">intordering</span>, <span class="ts">"\n"</span>,
    <span class="ts">"    run_symmetries: true\n"</span>,
    <span class="ts">"    run_initiate: true\n"</span>,
    <span class="ts">"    run_triangular: false\n"</span>,
    <span class="ts">"    run_back_substitution: false\n"</span>,
    <span class="ts">"    run_firefly: false\n"</span>
  ];
]</pre>
<h3 id="KiraMasters"><code>KiraMasters[]</code></h3>
<p>Run Kira to determine a set of master integrals in a given
basis. The masters are selected according to Kira's integral
ordering setting (an integer from 1 to 8; see Kira's documentation
for what these mean).</p>
<pre><a class="tnv" href="#KiraMasters">KiraMasters</a>[<span class="tnt">bases_List</span>, <span class="tnt">maxdots_Integer</span>, <span class="tnt">maxnums_Integer</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">dirname</span>, <span class="tnvc">result</span>},
  <span class="tnvc">dirname</span> = <a class="tnv" href="utils.html#MkTemp">MkTemp</a>[<span class="ts">"kira"</span>, <span class="ts">".masters"</span>];
  <a class="tnv" href="#MkKiraMastersConfig">MkKiraMastersConfig</a>[<span class="tnvc">dirname</span>, <span class="tnv">bases</span>, <span class="tnv">maxdots</span>, <span class="tnv">maxnums</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">KiraIntegralOrdering</span>]];
  <a class="tnv" href="utils.html#SafeRun">SafeRun</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"cd '"</span>, <span class="tnvc">dirname</span>, <span class="ts">"' &amp;&amp; "</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">Kira</span>], <span class="ts">" domasters.yaml"</span>]];
  <span class="tnvc">result</span> = <a class="tnv" href="#LoadKiraMasters">LoadKiraMasters</a>[<span class="tnvc">dirname</span>];
  <a class="tnv" href="utils.html#EnsureNoDirectory">EnsureNoDirectory</a>[<span class="tnvc">dirname</span>];
  <span class="tnvc">result</span>
]
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#KiraMasters">KiraMasters</a>] = {<span class="tnv">Kira</span> -&gt; <span class="ts">"kira"</span>, <span class="tnv">KiraIntegralOrdering</span> -&gt; <span class="tl">8</span>};</pre>
<h2 id="FireAmpLiteredInterfaceForIbpReduction">FIRE &amp; LiteRed interface for IBP reduction</h2>
<pre><span class="tnv">TrailingIrr</span>[<span class="tnt">denominators_</span>] := <span class="tnv">denominators</span> /. {___, <span class="tnv">trail</span>:<a class="tnb" href="https://reference.wolfram.com/language/ref/Longest.html" rel="nofollow">Longest</a>[<span class="tnv">den</span>[_, _, <span class="tnv">irr</span>] ...]} :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[{<span class="tnv">trail</span>}]
<span class="tnv">LeadingIrr</span>[<span class="tnt">denominators_</span>] := <span class="tnv">denominators</span> /. {<span class="tnv">lead</span>:<a class="tnb" href="https://reference.wolfram.com/language/ref/Longest.html" rel="nofollow">Longest</a>[<span class="tnv">den</span>[_, _, <span class="tnv">irr</span>] ...], ___} :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[{<span class="tnv">lead</span>}]</pre>
<h3 id="PrepareFireStart"><code>PrepareFireStart[]</code></h3>
<p>Use FIRE and LiteRed to prepare the basis definition and
symmetry files that FIRE will need for the reduction.</p>
<pre><a class="tnv" href="#PrepareFireStart">PrepareFireStart</a>[<span class="tnt">basis_Association</span>, <span class="tnt">confdir_String</span>] := <a class="tnv" href="#PrepareFireStart">PrepareFireStart</a>[<span class="tnv">basis</span>, <span class="tnv">confdir</span>, {}]
<a class="tnv" href="#PrepareFireStart">PrepareFireStart</a>[<span class="tnt">basis_Association</span>, <span class="tnt">confdir_String</span>, <span class="tnt">invariantrules_</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">tmpdir</span>, <span class="tnvc">props</span>},
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"* Preparing FIRE basis "</span>, <span class="tnv">basis</span>[<span class="ts">"id"</span>]];
  <span class="tnv">FIREPATH</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Environment.html" rel="nofollow">Environment</a>[<span class="ts">"FIREPATH"</span>];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/FileExistsQ.html" rel="nofollow">FileExistsQ</a>[<span class="tnv">FIREPATH</span> &lt;&gt; <span class="ts">"/FIRE6.m"</span>]];
  <span class="tnvc">props</span> = <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">invariantrules</span>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[{<span class="tnv">sp</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>, <span class="tnv">sp</span>[<span class="tnt">p_</span>,<span class="tnt">q_</span>] :&gt; <span class="tnv">p</span>*<span class="tnv">q</span>}] //
    <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>, <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, ___] :&gt; <span class="tnv">p</span>^<span class="tl">2</span>-<span class="tnv">m</span>];
  <span class="tnvc">tmpdir</span> = <a class="tnv" href="utils.html#MkTemp">MkTemp</a>[<span class="ts">"fire"</span>, <span class="ts">""</span>];
  <a class="tnv" href="utils.html#EnsureCleanDirectory">EnsureCleanDirectory</a>[<span class="tnvc">tmpdir</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"Directory: "</span>, <span class="tnvc">tmpdir</span>];
  <a class="tnv" href="utils.html#RunMathProgram">RunMathProgram</a>[
    <span class="ts">"Off[FrontEndObject::notavail];\n"</span>,
    <span class="ts">"SetDirectory[\""</span>, <span class="tnv">FIREPATH</span>, <span class="ts">"\"];\n"</span>,
    <span class="ts">"Get[\"FIRE6.m\"];\n"</span>,
    <span class="ts">"Internal = "</span>, <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>]//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"External = "</span>, <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>]//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"Propagators = "</span>, <span class="tnvc">props</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"Replacements = "</span>, <span class="tnv">basis</span>[<span class="ts">"sprules"</span>] /. <span class="tnv">sp</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span> /. <span class="tnv">sp</span>[<span class="tnt">p_</span>,<span class="tnt">q_</span>] :&gt; <span class="tnv">p</span>*<span class="tnv">q</span> /. <span class="tnv">invariantrules</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"RESTRICTIONS = "</span>,
      <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[
        <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">#1</span>, <span class="tnv">den</span>[_, _, <span class="tnv">cut</span>]],
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#2</span> === {<span class="tnv">idx</span>}, -<span class="tl">1</span>, <span class="tl">0</span>], {<span class="tnv">idx</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>[<span class="ts">"denominators"</span>]]}],
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>
        ]&amp;
      ]//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>,
    <span class="ts">";\n"</span>,
    <span class="ts">"Print[\"Internal: \", Internal];\n"</span>,
    <span class="ts">"Print[\"External: \", External];\n"</span>,
    <span class="ts">"Print[\"Propagators: \", Propagators//InputForm];\n"</span>,
    <span class="ts">"Print[\"Replacements: \", Replacements//InputForm];\n"</span>,
    <span class="ts">"Print[\"RESTRICTIONS: \", RESTRICTIONS];\n"</span>,
    <span class="ts">"Print[\"* PrepareIBP[]\"];\n"</span>,
    <span class="ts">"PrepareIBP[];\n"</span>,
    <span class="ts">"Print[\"* Prepare[]\"];\n"</span>,
    <span class="ts">"Prepare[AutoDetectRestrictions-&gt;False];\n"</span>,
    <span class="ts">"Print[\"* SaveStart[]\"];\n"</span>,
    <span class="ts">"SaveStart[\""</span>, <span class="tnvc">tmpdir</span>, <span class="ts">"/start\"];\n"</span>,
    <span class="ts">"Print[\"* Done with SaveStart[]\"];\n"</span>
  ];
  <a class="tnv" href="utils.html#RunMathProgram">RunMathProgram</a>[
    <span class="ts">"Off[FrontEndObject::notavail];\n"</span>,
    <span class="ts">"Off[DiskSave::dir];\n"</span>,
    <span class="ts">"Off[DiskSave::overwrite];\n"</span>,
    <span class="ts">"SetDirectory[\""</span>, <span class="tnv">FIREPATH</span>, <span class="ts">"/extra/LiteRed/Setup\"];\n"</span>,
    <span class="ts">"Get[\"LiteRed.m\"];\n"</span>,
    <span class="ts">"SetDirectory[\""</span>, <span class="tnv">FIREPATH</span>, <span class="ts">"\"];\n"</span>,
    <span class="ts">"Get[\"FIRE6.m\"];\n"</span>,
    <span class="ts">"Internal = "</span>, <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>]//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"External = "</span>, <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>]//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"Propagators = "</span>, <span class="tnvc">props</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"Replacements = "</span>, <span class="tnv">basis</span>[<span class="ts">"sprules"</span>] /. <span class="tnv">sp</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span> /. <span class="tnv">sp</span>[<span class="tnt">p_</span>,<span class="tnt">q_</span>] :&gt; <span class="tnv">p</span>*<span class="tnv">q</span> /. <span class="tnv">invariantrules</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">";\n"</span>,
    <span class="ts">"RESTRICTIONS = "</span>,
      <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[
        <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">#1</span>, <span class="tnv">den</span>[_, _, <span class="tnv">cut</span>]],
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#2</span> === {<span class="tnv">idx</span>}, -<span class="tl">1</span>, <span class="tl">0</span>], {<span class="tnv">idx</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>[<span class="ts">"denominators"</span>]]}],
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>
        ]&amp;
      ]//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>,
    <span class="ts">";\n"</span>,
    <span class="ts">"CreateNewBasis[basisx, Directory-&gt;(\""</span>, <span class="tnvc">tmpdir</span>, <span class="ts">"/litered\")];\n"</span>,
    <span class="ts">"GenerateIBP[basisx];\n"</span>,
    <span class="ts">"Print[\"* AnalyzeSectors[]\"];\n"</span>,
    <span class="ts">"AnalyzeSectors[basisx,\n"</span>,
    <span class="ts">"  "</span>, <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">den</span>[_, _, <span class="tnv">irr</span>] -&gt; <span class="tl">0</span>, <span class="tnv">den</span>[___] -&gt; _] // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">",\n"</span>,
    <span class="ts">"  CutDs -&gt; ("</span>, <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">den</span>[_, _, <span class="tnv">cut</span>] -&gt; <span class="tl">1</span>, <span class="tnv">den</span>[___] -&gt; <span class="tl">0</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">")];\n"</span>,
    <span class="ts">"Print[\"* FindSymmetries[]\"];\n"</span>,
    <span class="ts">"FindSymmetries[basisx];\n"</span>,
    <span class="ts">"Print[\"* DiskSave[]\"];\n"</span>,
    <span class="ts">"DiskSave[basisx];\n"</span>,
    <span class="ts">"Print[\"* Done with DiskSave[]\"];\n"</span>
  ];
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">confdir</span>];
  <a class="tnv" href="utils.html#RunMathProgram">RunMathProgram</a>[
    <span class="ts">"Off[FrontEndObject::notavail];\n"</span>,
    <span class="ts">"SetDirectory[\""</span>, <span class="tnv">FIREPATH</span>, <span class="ts">"\"];\n"</span>,
    <span class="ts">"Get[\"FIRE6.m\"];\n"</span>,
    <span class="ts">"LoadStart[\""</span>, <span class="tnvc">tmpdir</span>, <span class="ts">"/start\"];\n"</span>,
    <span class="ts">"TransformRules[\""</span>, <span class="tnvc">tmpdir</span>, <span class="ts">"/litered\", \""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/ExpandFileName.html" rel="nofollow">ExpandFileName</a>[<span class="tnv">confdir</span>], <span class="ts">"/b"</span>, <span class="tnv">basis</span>[<span class="ts">"id"</span>], <span class="ts">".lbases\", "</span>, <span class="tnv">basis</span>[<span class="ts">"id"</span>], <span class="ts">"];\n"</span>,
    <span class="ts">"SaveSBases[\""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/ExpandFileName.html" rel="nofollow">ExpandFileName</a>[<span class="tnv">confdir</span>], <span class="ts">"/b"</span>, <span class="tnv">basis</span>[<span class="ts">"id"</span>], <span class="ts">"\"];\n"</span>,
    <span class="ts">"Print[\"* Done with SaveSBases[]\"];\n"</span>
  ];
  <a class="tnv" href="utils.html#EnsureNoDirectory">EnsureNoDirectory</a>[<span class="tnvc">tmpdir</span>];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnv">confdir</span> &lt;&gt; <span class="ts">"/b"</span> &lt;&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnv">basis</span>[<span class="ts">"id"</span>]] &lt;&gt; <span class="ts">".pos"</span>,
    <span class="ts">"|"</span>, <span class="tnv">LeadingIrr</span>[<span class="tnv">basis</span>[<span class="ts">"denominators"</span>]] + <span class="tl">1</span>, <span class="ts">","</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>[<span class="ts">"denominators"</span>]] - <span class="tnv">TrailingIrr</span>[<span class="tnv">basis</span>[<span class="ts">"denominators"</span>]], <span class="ts">"|"</span>
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"* Done with everything"</span>];
]</pre>
<h3 id="LoadFireMasters"><code>LoadFireMasters[]</code></h3>
<p>Get the list of master integrals from a FIRE .tables file.</p>
<pre><a class="tnv" href="#LoadFireMasters">LoadFireMasters</a>[<span class="tnt">filename_String</span>] := <span class="tnv">filename</span> // <a class="tnv" href="utils.html#SafeGet">SafeGet</a> // <span class="tnv">#</span>[[<span class="tl">2</span>, ;;, <span class="tl">2</span>]]&amp; // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{<span class="tnt">bid_</span>, <span class="tnt">idx_List</span>} :&gt; <span class="tnv">B</span>[<span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a> @@ <span class="tnv">idx</span>]]</pre>
<h3 id="LoadFireTables"><code>LoadFireTables[]</code></h3>
<p>Load IBP tables from FIRE .tables file.</p>
<pre><a class="tnv" href="#LoadFireTables">LoadFireTables</a>[<span class="tnt">filename_</span>, <span class="tnt">coeff_</span>: <a class="tnb" href="https://reference.wolfram.com/language/ref/Identity.html" rel="nofollow">Identity</a>, <span class="tnt">JoinTerms_</span>: <a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">temp</span>, <span class="tnvc">GGG</span>, <span class="tnvc">data</span>},
    <span class="tnvc">data</span> = <a class="tnv" href="utils.html#SafeGet">SafeGet</a>[<span class="tnv">filename</span>];
    <span class="tnvc">temp</span> = {<span class="tnvc">GGG</span>[<span class="tnv">##</span>[[<span class="tl">1</span>]]], {<span class="tnvc">GGG</span>[<span class="tnv">##</span>[[<span class="tl">1</span>]]], <span class="tnv">##</span>[[<span class="tl">2</span>]]} &amp; /@ <span class="tnv">##</span>[[<span class="tl">2</span>]]} &amp; /@ <span class="tnvc">data</span>[[<span class="tl">1</span>]];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Set.html" rel="nofollow">Set</a>[<span class="tnvc">GGG</span>[<span class="tnv">##</span>[[<span class="tl">1</span>]]], <span class="tnv">G</span>[<span class="tnv">##</span>[[<span class="tl">2</span>, <span class="tl">1</span>]], <span class="tnv">##</span>[[<span class="tl">2</span>, <span class="tl">2</span>]]]] &amp; /@ <span class="tnvc">data</span>[[<span class="tl">2</span>]];
    <span class="tnvc">temp</span> = <span class="tnvc">temp</span>;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Clear.html" rel="nofollow">Clear</a>[<span class="tnvc">GGG</span>];
    <span class="tnvc">temp</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tnvc">temp</span>, {<span class="tnt">a_</span>, {{<span class="tnt">a_</span>, <span class="ts">"1"</span>}}}];
    <span class="tnvc">temp</span> = {<span class="tnv">##</span>[[<span class="tl">1</span>]], {<span class="tnv">##</span>[[<span class="tl">1</span>]], <a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>[<span class="tnv">##</span>[[<span class="tl">2</span>]]]} &amp; /@ <span class="tnv">##</span>[[<span class="tl">2</span>]]} &amp; /@ <span class="tnvc">temp</span>;
    <span class="tnvc">temp</span> = {<span class="tnv">##</span>[[<span class="tl">1</span>]], {<span class="tnv">##</span>[[<span class="tl">1</span>]], <span class="tnv">coeff</span>[<span class="tnv">##</span>[[<span class="tl">2</span>]]]} &amp; /@ <span class="tnv">##</span>[[<span class="tl">2</span>]]} &amp; /@ <span class="tnvc">temp</span>;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">JoinTerms</span>,
        <span class="tnvc">temp</span> = {<span class="tnv">##</span>[[<span class="tl">1</span>]], <a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a> @@@ <span class="tnv">##</span>[[<span class="tl">2</span>]]} &amp; /@ <span class="tnvc">temp</span>;
        <span class="tnvc">temp</span> = {<span class="tnv">##</span>[[<span class="tl">1</span>]], <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a> @@ <span class="tnv">##</span>[[<span class="tl">2</span>]]} &amp; /@ <span class="tnvc">temp</span>;
    ];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a> @@@ <span class="tnvc">temp</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">G</span>[<span class="tnt">bid_</span>, <span class="tnt">idx_List</span>] :&gt; <span class="tnv">B</span>[<span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a> @@ <span class="tnv">idx</span>]]
 ]</pre>
<h2 id="PysecdecInterfaceForNumericalEvaluationOfIntegrals">pySecDec interface for numerical evaluation of integrals</h2>
<h3 id="SecDecIntegralName"><code>SecDecIntegralName[]</code></h3>
<p>Convert an integral name (<code>B</code> notation) into a filename.</p>
<pre><a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnt">integral_B</span>] := <span class="tnv">integral</span> //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">" "</span> -&gt; <span class="ts">""</span>] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">","</span> -&gt; <span class="ts">"_"</span>] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">"["</span> -&gt; <span class="ts">""</span>] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">"]"</span> -&gt; <span class="ts">""</span>] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="ts">"-"</span> -&gt; <span class="ts">"m"</span>]
<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">DimShift</span>[<span class="tnt">integral_B</span>, <span class="tnt">n_</span>]] :=
  <a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">integral</span>] &lt;&gt; <span class="ts">"_dshift"</span> &lt;&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Negative.html" rel="nofollow">Negative</a>[<span class="tnv">n</span>], <span class="ts">"m"</span>, <span class="ts">""</span>] &lt;&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Abs.html" rel="nofollow">Abs</a>[<span class="tnv">n</span>]]</pre>
<h3 id="ToSympy"><code>ToSympy[]</code></h3>
<p>Convert an expression into a string in Sympy format.</p>
<p>This might need additional work to correctly convert more
forms.</p>
<pre><a class="tnv" href="#ToSympy">ToSympy</a>[<span class="tnt">ex_</span>] := <span class="tnv">ex</span> /. <a class="tnb" href="https://reference.wolfram.com/language/ref/Pi.html" rel="nofollow">Pi</a> -&gt; <span class="tnv">pi</span> //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a> //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a> //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="tnv">#</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/WordBoundary.html" rel="nofollow">WordBoundary</a> ~~ <span class="ts">"Sqrt["</span> -&gt; <span class="ts">"sqrt["</span>]&amp; //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="tnv">#</span>, <span class="ts">"["</span> -&gt; <span class="ts">"("</span>]&amp; //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="tnv">#</span>, <span class="ts">"]"</span> -&gt; <span class="ts">")"</span>]&amp; //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="tnv">#</span>, <span class="ts">"*^"</span> -&gt; <span class="ts">"e"</span>]&amp;</pre>
<h3 id="SecDecPrepare"><code>SecDecPrepare[]</code></h3>
<p>Prepare pySecDec files in a given directory for the given
list of integrals. These can then be compiled manually by
running <code>make compile</code>.</p>
<p>Each integral in the list can be:</p>
<ul>
<li><code>B[...] * prefactor</code>;</li>
<li><code>DimShift[B[...], n] * prefactor</code>;</li>
<li>{integral, epsilon-order}.</li>
</ul>
<p>One can alternatively use <a href="#SecDecCompile">SecDecCompile</a> to both prepare
and compile.</p>
<p>Note that the loop integration in the integrals is assumed to
come with physical normalization, i.e. <img alt="1/(2\pi)^d" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2249.529pt%22%20height%3D%2215.318pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2049.529%2015.318%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22g%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.2812-9.4062-2.9844%200.90625v0.57812l2.1562-0.39062v7.4062l-0.15625%200.23438-1.5938%200.078125v0.59375h4.6094v-0.57812l-1.4844-0.0625-0.15625-0.21875v-8.5469z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22f%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-1.0938c3.0469-2.4219%204.7188-3.9688%204.7188-5.7031%200-1.5625-1.0938-2.6094-2.875-2.6094-1.7031%200-2.9062%200.98438-2.9062%201.9375%200%200.46875%200.28125%200.78125%200.76562%200.78125%200.21875%200%200.42188-0.078125%200.60938-0.20312v-1.4844c0.42188-0.23438%200.8125-0.32812%201.2344-0.32812%201.1406%200%201.8281%200.78125%201.8281%202.0781%200%201.8125-1.7188%203.3125-4.7344%205.75v0.875h6.375v-2.25h-0.625l-0.25%201.1562z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.1719-10.516h-0.875l-4.5312%2013.109h0.875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.0469-5.6406h0.46875c-0.10938%200.76562-0.21875%201.5312-0.35938%202.2969-0.1875%200.85938-0.59375%201.7188-1.2188%202.4531-0.14062%200.14062-0.1875%200.3125-0.1875%200.48438%200%200.28125%200.20312%200.53125%200.54688%200.53125%200.32812%200%200.60938-0.29688%200.70312-0.64062%200.23438-0.9375%200.46875-1.8906%200.6875-2.8281l0.53125-2.2969h2.2344l-0.35938%202.2969c-0.10938%200.625-0.1875%201.2812-0.1875%201.8438%200%200.92188%200.23438%201.625%201.1094%201.625%200.75%200%201.4062-0.70312%201.5625-1.5l-0.53125-0.14062c-0.078125%200.34375-0.45312%200.59375-0.8125%200.59375-0.59375%200-0.78125-0.45312-0.78125-1.0625%200-0.40625%200.078125-0.90625%200.1875-1.3594l0.51562-2.2969h1.6719l0.20312-1.0469h-5.7812c-0.875%200-1.5938%201.3281-2.1875%202.4062-0.03125%200.0625-0.046875%200.09375-0.046875%200.14062%200%200.125%200.09375%200.20312%200.21875%200.20312%200.09375%200%200.1875-0.046875%200.25-0.17188%200.42188-0.6875%200.82812-1.5312%201.5625-1.5312z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.5469-7.0312-1.4688%200.26562v0.26562l0.84375%200.10938-0.34375%201.9062c-0.25-0.10938-0.5-0.15625-0.75-0.15625-0.79688%200-1.6406%200.46875-2.1562%201.2812-0.3125%200.48438-0.46875%201.0781-0.46875%201.7344%200%201.0938%200.48438%201.7188%201.25%201.7188%200.5%200%201.0312-0.29688%201.4844-0.89062v0.1875c0%200.46875%200.20312%200.67188%200.64062%200.67188%200.25%200%200.65625-0.078125%201.1719-0.26562v-0.29688c-0.28125%200.0625-0.5%200.10938-0.625%200.10938-0.28125%200-0.42188-0.14062-0.42188-0.40625%200-0.125%200.03125-0.29688%200.0625-0.51562l1.0312-5.7188zm-1.5469%202.7812%200.45312%200.54688-0.4375%202.4375c-0.42188%200.53125-0.85938%200.8125-1.2188%200.8125-0.5%200-0.82812-0.42188-0.82812-1.1875%200-1.5938%200.9375-2.6406%201.7969-2.6406%200.0625%200%200.14062%200.03125%200.23438%200.03125z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22j%22%3E%3Cpath%20d%3D%22m8%202h6v13.316h-6z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22i%22%3E%3Cpath%20d%3D%22m15%202h5v13.316h-5z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22h%22%3E%3Cpath%20d%3D%22m38%202h5v13.316h-5z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%3E%3Cuse%20x%3D%220.1%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23g%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23j%29%22%3E%3Cg%3E%3Cuse%20x%3D%227.757%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23i%29%22%3E%3Cg%3E%3Cuse%20x%3D%2214.726%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23c%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2220.138%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23f%22/%3E%3Cuse%20x%3D%2227.796%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23d%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23h%29%22%3E%3Cg%3E%3Cuse%20x%3D%2237.561%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23b%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2243.212%22%20y%3D%227.12%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/svg%3E"/> per loop,
which is different from the default pySecDec normalization
(<img alt="1/(i\pi^{d/2})" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2257.015pt%22%20height%3D%2215.633pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2057.015%2015.633%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22i%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.2812-9.4062-2.9844%200.90625v0.57812l2.1562-0.39062v7.4062l-0.15625%200.23438-1.5938%200.078125v0.59375h4.6094v-0.57812l-1.4844-0.0625-0.15625-0.21875v-8.5469z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22h%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.1719-10.516h-0.875l-4.5312%2013.109h0.875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22g%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.0469-5.6406h0.46875c-0.10938%200.76562-0.21875%201.5312-0.35938%202.2969-0.1875%200.85938-0.59375%201.7188-1.2188%202.4531-0.14062%200.14062-0.1875%200.3125-0.1875%200.48438%200%200.28125%200.20312%200.53125%200.54688%200.53125%200.32812%200%200.60938-0.29688%200.70312-0.64062%200.23438-0.9375%200.46875-1.8906%200.6875-2.8281l0.53125-2.2969h2.2344l-0.35938%202.2969c-0.10938%200.625-0.1875%201.2812-0.1875%201.8438%200%200.92188%200.23438%201.625%201.1094%201.625%200.75%200%201.4062-0.70312%201.5625-1.5l-0.53125-0.14062c-0.078125%200.34375-0.45312%200.59375-0.8125%200.59375-0.59375%200-0.78125-0.45312-0.78125-1.0625%200-0.40625%200.078125-0.90625%200.1875-1.3594l0.51562-2.2969h1.6719l0.20312-1.0469h-5.7812c-0.875%200-1.5938%201.3281-2.1875%202.4062-0.03125%200.0625-0.046875%200.09375-0.046875%200.14062%200%200.125%200.09375%200.20312%200.21875%200.20312%200.09375%200%200.1875-0.046875%200.25-0.17188%200.42188-0.6875%200.82812-1.5312%201.5625-1.5312z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22f%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m2.7656-9.6875c-0.40625%200-0.73438%200.32812-0.73438%200.73438%200%200.4375%200.32812%200.75%200.73438%200.75s0.75-0.32812%200.75-0.75c0-0.39062-0.34375-0.73438-0.75-0.73438zm-0.28125%203.0469-2.0312%200.45312v0.34375l1.1094%200.21875-0.8125%204.0938c-0.046875%200.3125-0.078125%200.54688-0.078125%200.71875%200%200.60938%200.29688%200.90625%200.89062%200.90625%200.51562%200%201.1719-0.15625%201.9375-0.48438v-0.42188c-0.4375%200.14062-0.76562%200.20312-1.0156%200.20312-0.4375%200-0.67188-0.17188-0.67188-0.53125%200-0.078125%200.015625-0.1875%200.046875-0.34375l0.98438-5.1562z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.5469-7.0312-1.4688%200.26562v0.26562l0.84375%200.10938-0.34375%201.9062c-0.25-0.10938-0.5-0.15625-0.75-0.15625-0.79688%200-1.6406%200.46875-2.1562%201.2812-0.3125%200.48438-0.46875%201.0781-0.46875%201.7344%200%201.0938%200.48438%201.7188%201.25%201.7188%200.5%200%201.0312-0.29688%201.4844-0.89062v0.1875c0%200.46875%200.20312%200.67188%200.64062%200.67188%200.25%200%200.65625-0.078125%201.1719-0.26562v-0.29688c-0.28125%200.0625-0.5%200.10938-0.625%200.10938-0.28125%200-0.42188-0.14062-0.42188-0.40625%200-0.125%200.03125-0.29688%200.0625-0.51562l1.0312-5.7188zm-1.5469%202.7812%200.45312%200.54688-0.4375%202.4375c-0.42188%200.53125-0.85938%200.8125-1.2188%200.8125-0.5%200-0.82812-0.42188-0.82812-1.1875%200-1.5938%200.9375-2.6406%201.7969-2.6406%200.0625%200%200.14062%200.03125%200.23438%200.03125z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.2812-7.3125h-0.59375l-3.1562%209.1094h0.60938z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.3438-0.75c2.125-1.6875%203.2812-2.7656%203.2812-3.9688%200-1.0781-0.76562-1.8125-2-1.8125-1.1875%200-2.0156%200.67188-2.0156%201.3438%200%200.32812%200.1875%200.54688%200.53125%200.54688%200.15625%200%200.29688-0.046875%200.42188-0.15625v-1.0156c0.29688-0.15625%200.5625-0.23438%200.85938-0.23438%200.79688%200%201.2656%200.53125%201.2656%201.4531%200%201.25-1.1875%202.2969-3.2812%203.9844v0.60938h4.4219v-1.5625h-0.42188l-0.17188%200.8125z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22l%22%3E%3Cpath%20d%3D%22m8%202h6v13.633h-6z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22k%22%3E%3Cpath%20d%3D%22m15%202h5v13.633h-5z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22j%22%3E%3Cpath%20d%3D%22m52%202h5v13.633h-5z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%3E%3Cuse%20x%3D%220.1%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23i%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23l%29%22%3E%3Cg%3E%3Cuse%20x%3D%227.757%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23h%22/%3E%3C/g%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23k%29%22%3E%3Cg%3E%3Cuse%20x%3D%2214.726%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23f%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2220.483%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23d%22/%3E%3Cuse%20x%3D%2225.124%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23g%22/%3E%3Cuse%20x%3D%2235.128%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23c%22/%3E%3Cuse%20x%3D%2240.847%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23b%22/%3E%3Cuse%20x%3D%2245.687%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23j%29%22%3E%3Cg%3E%3Cuse%20x%3D%2251.503%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"/> per loop).</p>
<p>The resulting directory consists of a <code>Makefile</code> and a set
of python scripts. While compilation can be performed by just
<code>make compile</code>, there are two provisions to parallelize the
compilation: the <code>THREADS</code> environment variable which sets
how many threads should comilation of a single integral use,
and the <code>RUN</code> variable that is inserted as a prefix before
the slow generation and compilation commands. The intent is
for you to be able to set <code>RUN</code> to the command that executes
its arguments on a cluster (e.g. <code>srun -c 10 --mem=10G</code>),
and <code>THREADS</code> to the number of processes to use on the remote
machine (e.g. <code>10</code>). With these two set, <code>make -j99 compile</code>
will parallelize the compilation across 99 cluster machines.</p>
<p>Of course, <code>make -j99 compile</code> will also work well on a local
machine, if it has 99 processors and lots of free memory.</p>
<pre><a class="tnv" href="#SecDecPrepare">SecDecPrepare</a>[<span class="tnt">basedir_String</span>, <span class="tnt">bases_List</span>, <span class="tnt">integrals_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">name</span>, <span class="tnvc">basisid</span>, <span class="tnvc">bid2basis</span>, <span class="tnvc">indices</span>, <span class="tnvc">basis</span>, <span class="tnvc">integral</span>, <span class="tnvc">p</span>, <span class="tnvc">m</span>, <span class="tnvc">dim</span>, <span class="tnvc">order</span>, <span class="tnvc">prefactor</span>},
  <span class="tnvc">bid2basis</span> = <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>[<span class="ts">"id"</span>]&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#Only">Only</a>];
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">basedir</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
    {<span class="tnvc">name</span>, <span class="tnvc">integral</span>, <span class="tnvc">dim</span>, <span class="tnvc">order</span>, <span class="tnvc">prefactor</span>} = <span class="tnvc">integral</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[{
        <span class="tnt">pre_</span>. * <span class="tnt">b_B</span> :&gt; {<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">b</span>], <span class="tnv">b</span>, <span class="tl">4</span>, <span class="tl">0</span>, <span class="tnv">pre</span>},
        <span class="tnt">pre_</span>. * <span class="tnv">int</span>:<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, <span class="tnt">n_</span>] :&gt; {<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">int</span>], <span class="tnv">b</span>, <span class="tl">4</span> + <span class="tnv">n</span>, <span class="tl">0</span>, <span class="tnv">pre</span>},
        {<span class="tnt">pre_</span>. * <span class="tnt">b_B</span>, <span class="tnt">ord_</span>} :&gt; {<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">b</span>], <span class="tnv">b</span>, <span class="tl">4</span>, <span class="tnv">ord</span>, <span class="tnv">pre</span>},
        {<span class="tnt">pre_</span>. * <span class="tnv">int</span>:<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, <span class="tnt">n_</span>], <span class="tnt">ord_</span>} :&gt; {<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">int</span>], <span class="tnv">b</span>, <span class="tl">4</span>+<span class="tnv">n</span>, <span class="tnv">ord</span>, <span class="tnv">pre</span>}
    }];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"* Making "</span>, <span class="tnv">basedir</span>, <span class="ts">"/"</span>, <span class="tnvc">name</span>, <span class="ts">".*"</span>];
    <span class="tnvc">basisid</span> = <span class="tnvc">integral</span>[[<span class="tl">1</span>]];
    <span class="tnvc">indices</span> = <span class="tnvc">integral</span>[[<span class="tl">2</span>;;]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>];
    <span class="tnvc">basis</span> = <span class="tnvc">bid2basis</span>[<span class="tnvc">basisid</span>];
    <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">basedir</span> &lt;&gt; <span class="ts">"/"</span> &lt;&gt; <span class="tnvc">name</span> &lt;&gt; <span class="ts">".compile.py"</span>,
      <span class="ts">"#!/usr/bin/env python3\n"</span>,
      <span class="ts">"import os\n"</span>,
      <span class="ts">"import subprocess\n"</span>,
      <span class="ts">"import tempfile\n"</span>,
      <span class="ts">"import pySecDec as psd\n"</span>,
      <span class="ts">"loopint = psd.loop_integral.LoopIntegralFromPropagators(\n"</span>,
      <span class="ts">"  loop_momenta = ['"</span>, <span class="tnvc">basis</span>[<span class="ts">"loopmom"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"','"</span>]&amp;, <span class="ts">"'],\n"</span>,
      <span class="ts">"  external_momenta = ['"</span>, <span class="tnvc">basis</span>[<span class="ts">"externalmom"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"','"</span>]&amp;, <span class="ts">"'],\n"</span>,
      <span class="ts">"  regulator = 'eps',\n"</span>,
      <span class="ts">"  propagators = [\n"</span>,
      <span class="tnvc">basis</span>[<span class="ts">"denominators"</span>] /. {
        <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; {<span class="ts">"    '("</span>, <span class="tnvc">p</span>//<a class="tnv" href="#ToSympy">ToSympy</a>, <span class="ts">")^2'"</span>},
        <span class="tnv">den</span>[<span class="tnt">p_</span>,<span class="tnt">m_</span>,___] :&gt; {<span class="ts">"    '("</span>, <span class="tnvc">p</span>//<a class="tnv" href="#ToSympy">ToSympy</a>, <span class="ts">")^2-"</span>, <span class="tnvc">m</span>//<a class="tnv" href="#ToSympy">ToSympy</a>, <span class="ts">"'"</span>}
      } // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">",\n"</span>]&amp;,
      <span class="ts">"\n"</span>,
      <span class="ts">"  ],\n"</span>,
      <span class="ts">"  powerlist = ["</span>, <span class="tnvc">indices</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">","</span>]&amp;, <span class="ts">"],\n"</span>,
      <span class="ts">"  dimensionality='"</span>, <span class="tnvc">dim</span>, <span class="ts">"-2*eps',\n"</span>,
      <span class="ts">"  replacement_rules = [\n  "</span>,
      <span class="tnvc">basis</span>[<span class="ts">"sprules"</span>] //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">sp</span> -&gt; (<span class="tnv">sp</span> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>)] //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> //
        <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
          (<span class="tnv">sp</span>[<span class="tnt">p1_</span>, <span class="tnt">p2_</span>] -&gt; <span class="tnt">v_</span>) :&gt; {<span class="ts">"   ('"</span>, <span class="tnv">p1</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"*"</span>, <span class="tnv">p2</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"', '"</span>, <span class="tnv">v</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"')"</span>}
        ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">",\n  "</span>]&amp;,
      <span class="ts">"\n  ]\n"</span>,
      <span class="ts">")\n"</span>,
      <span class="ts">"if __name__ == '__main__':\n"</span>,
      <span class="ts">"    subprocess.check_call(['rm', '-rf', '"</span>, <span class="tnvc">name</span>, <span class="ts">"', '"</span>, <span class="tnvc">name</span>, <span class="ts">"_data'])\n"</span>,
      <span class="ts">"    threads = int(os.environ.get('THREADS', '1'))\n"</span>,
      <span class="ts">"    cwd = os.getcwd()\n"</span>,
      <span class="ts">"    with tempfile.TemporaryDirectory(prefix='psd') as tmp:\n"</span>,
      <span class="ts">"        os.chdir(tmp)\n"</span>,
      <span class="ts">"        psd.loop_integral.loop_package(\n"</span>,
      <span class="ts">"            name = '"</span>, <span class="tnvc">name</span>, <span class="ts">"',\n"</span>,
      <span class="ts">"            loop_integral = loopint,\n"</span>,
      <span class="ts">"            real_parameters = ["</span>,
        <span class="tnvc">basis</span>[<span class="ts">"invariants"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">"'"</span>, <span class="tnv">#</span>, <span class="ts">"'"</span>}&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;,
      <span class="ts">"],\n"</span>,
      <span class="ts">"            additional_prefactor = '"</span>,
        <span class="tc">(* Convert from pySecDec to the physical normalization. *)</span>
        (<a class="tnb" href="https://reference.wolfram.com/language/ref/I.html" rel="nofollow">I</a>*<a class="tnb" href="https://reference.wolfram.com/language/ref/Pi.html" rel="nofollow">Pi</a>^(<span class="tnvc">dim</span>/<span class="tl">2</span>-<span class="tnv">eps</span>)/(<span class="tl">2</span>*<a class="tnb" href="https://reference.wolfram.com/language/ref/Pi.html" rel="nofollow">Pi</a>)^(<span class="tnvc">dim</span>-<span class="tl">2</span>*<span class="tnv">eps</span>))^<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">basis</span>[<span class="ts">"loopmom"</span>]] * <span class="tnvc">prefactor</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Factor.html" rel="nofollow">Factor</a> // <a class="tnv" href="#ToSympy">ToSympy</a>,
      <span class="ts">"',\n"</span>,
      <span class="ts">"            decomposition_method = '"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnvc">indices</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Except.html" rel="nofollow">Except</a>[<span class="tl">0</span>]] &gt; <span class="tl">2</span>, <span class="ts">"geometric_ku"</span>, <span class="ts">"iterative"</span>],<span class="ts">"',\n"</span>,
      <span class="ts">"            use_dreadnaut = True,\n"</span>,
      <span class="ts">"            requested_order = "</span>, <span class="tnvc">order</span>, <span class="ts">",\n"</span>,
      <span class="ts">"            processes = threads,\n"</span>,
      <span class="ts">"            form_optimization_level = 4,\n"</span>,
      <span class="ts">"            form_work_space = '100M',\n"</span>,
      <span class="ts">"            form_threads = 1,\n"</span>,
      <span class="ts">"            contour_deformation = True\n"</span>,
      <span class="ts">"        )\n"</span>,
      <span class="ts">"        subprocess.check_call(['make', '-C', '"</span>, <span class="tnvc">name</span>, <span class="ts">"', '-j', str(threads), '"</span>, <span class="tnvc">name</span>, <span class="ts">"_pylink.so'])\n"</span>,
      <span class="ts">"        subprocess.check_call(['mv', '"</span>, <span class="tnvc">name</span>, <span class="ts">"/"</span>, <span class="tnvc">name</span>, <span class="ts">"_pylink.so', cwd])\n"</span>,
      <span class="ts">"        subprocess.check_call(['mv', '"</span>, <span class="tnvc">name</span>, <span class="ts">"/"</span>, <span class="tnvc">name</span>, <span class="ts">"_data', cwd])\n"</span>,
      <span class="ts">"        subprocess.check_call(['rm', '-rf', '"</span>, <span class="tnvc">name</span>, <span class="ts">"'])\n"</span>
    ];
    <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">basedir</span> &lt;&gt; <span class="ts">"/"</span> &lt;&gt; <span class="tnvc">name</span> &lt;&gt; <span class="ts">".integrate.py"</span>,
      <span class="ts">"#!/usr/bin/env python3\n"</span>,
      <span class="ts">"import os\n"</span>,
      <span class="ts">"import sys\n"</span>,
      <span class="ts">"import pySecDec as psd\n"</span>,
      <span class="ts">"if __name__ == '__main__':\n"</span>,
      <span class="ts">"    argmap = dict(arg.split('=') for arg in sys.argv[1:])\n"</span>,
      <span class="ts">"    parameters = ["</span>,
        <span class="tnvc">basis</span>[<span class="ts">"invariants"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">"float(argmap['"</span>, <span class="tnv">#</span>, <span class="ts">"'])"</span>}&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;,
      <span class="ts">"]\n"</span>,
      <span class="ts">"    threads = int(os.environ.get('THREADS', '1'))\n"</span>,
      <span class="ts">"    libfile = './"</span>, <span class="tnvc">name</span>, <span class="ts">"_pylink.so'\n"</span>,
      <span class="ts">"    lib = psd.integral_interface.IntegralLibrary(libfile)\n"</span>,
      <span class="ts">"    lib.use_Qmc(transform='korobov3', cputhreads=threads, verbosity=1)\n"</span>,
      <span class="ts">"    int_wo_prefactor, prefactor, int_with_prefactor = lib(real_parameters=parameters, verbose=True, epsrel=1e-6, epsabs=1e-18, wall_clock_limit=2*60*60)\n"</span>,
      <span class="ts">"    print(int_with_prefactor, file=sys.stderr)\n"</span>,
      <span class="ts">"    result = '{%s,\\n%s}' % psd.integral_interface.series_to_mathematica(int_with_prefactor)\n"</span>,
      <span class="ts">"    print(result)\n"</span>
    ];
    ,
    {<span class="tnvc">integral</span>, <span class="tnv">integrals</span>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"* Making "</span>, <span class="tnv">basedir</span>, <span class="ts">"/Makefile"</span>];
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">basedir</span> &lt;&gt; <span class="ts">"/Makefile"</span>,
    <span class="ts">"THREADS ?= 1\n"</span>,
    <span class="ts">"RUN ?=\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      <span class="tnvc">name</span> = <span class="tnvc">integral</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[{
        <span class="tnt">pre_</span>. * <span class="tnt">b_B</span> :&gt; <a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">b</span>],
        <span class="tnt">pre_</span>. * <span class="tnv">int</span>:<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, <span class="tnt">n_</span>] :&gt; <a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">int</span>],
        {<span class="tnt">pre_</span>. * <span class="tnt">b_B</span>, <span class="tnt">ord_</span>} :&gt; <a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">b</span>],
        {<span class="tnt">pre_</span>. * <span class="tnv">int</span>:<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, <span class="tnt">n_</span>], <span class="tnt">ord_</span>} :&gt; <a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">int</span>]
      }];
      {
        <span class="ts">"\n"</span>,
        <span class="ts">"compile: "</span>, <span class="tnvc">name</span> , <span class="ts">"_pylink.so\n"</span>,
        <span class="ts">"integrate: "</span>, <span class="tnvc">name</span> , <span class="ts">"_value.m\n"</span>,
        <span class="ts">"\n"</span>,
        <span class="tnvc">name</span>, <span class="ts">"_pylink.so: "</span>, <span class="tnvc">name</span>, <span class="ts">".compile.py\n"</span>,
        <span class="ts">"\t${RUN} python3 "</span>, <span class="tnvc">name</span>, <span class="ts">".compile.py\n"</span>,
        <span class="ts">"\n"</span>,
        <span class="tc">(* This part is tricky: because `$RUN` might send the
        * command to a cluster, and there is some delay in the
        * propagation of data across the network filesystem,
        * we can not allow `*.integrate.py` scripts to directly
        * read `invariants.txt` or write to `*_value.m` files. So
        * we supply the parameters as command line arguments,
        * and expect the results on stdout. Also to make sure
        * that if the script fails, `*_value.m` file is removed
        * (or at least marked as outdated), so it would be rebuilt
        * the next time `make` is executed.
        *)</span>
        <span class="tnvc">name</span>, <span class="ts">"_value.m: "</span>, <span class="tnvc">name</span>, <span class="ts">"_pylink.so "</span>, <span class="tnvc">name</span>, <span class="ts">".integrate.py invariants.txt\n"</span>,
        <span class="ts">"\ttouch -t 199001010000 $@\n"</span>,
        <span class="ts">"\t${RUN} python3 "</span>, <span class="tnvc">name</span>, <span class="ts">".integrate.py $$(cat invariants.txt) &gt;$@ 2&gt;$@.log || rm -f $@\n"</span>
      }
      ,
      {<span class="tnvc">integral</span>, <span class="tnv">integrals</span>}]
  ];
]

<span class="tnv">ToPythonString</span>[<span class="tnt">text_String</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/StringJoin.html" rel="nofollow">StringJoin</a>[
  <span class="ts">"\""</span>,
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[<span class="tnv">text</span>, {
    <span class="ts">"\n"</span> -&gt; <span class="ts">"\\n"</span>,
    <span class="ts">"\r"</span> -&gt; <span class="ts">"\\r"</span>,
    <span class="ts">"\t"</span> -&gt; <span class="ts">"\\t"</span>,
    <span class="ts">"\\" -&gt; "</span>\\\\<span class="ts">",
    "</span>\<span class="ts">""</span> -&gt; <span class="ts">"\\\""</span>
  }],
  <span class="ts">"\""</span>]</pre>
<h3 id="SecDecPrepareSum"><code>SecDecPrepareSum[]</code></h3>
<p>Prepare pySecDec files in a given directory for the given
weighted sums of integrals (in <code>B[...]</code> or <code>DimShift[B[...],...]</code>
syntax). The sums must be specified as <code>Association</code> maps from
string (sum names) into expressions.</p>
<p>The resulting directory consists of a single Python script
<code>compile.py</code>. When executed, this script will compile a
pySecDec <em>disteval</em> integration library, and put it into the
<code>disteval</code> subfolder, with <code>disteval/sum.json</code> being the main
entry point for the evaluation.</p>
<p>By default <code>compile.py</code> will use all the locally available CPUs;
this can be overridden by setting the <code>THREADS</code> environment
variable.</p>
<p>After the compilation one can use the <em>disteval</em> CLI, or
[SecDecIntegrateSum] to use the integration library to evaluate
the specified sums.</p>
<p>Note that the loop integration in the integrals is assumed to
come with physical normalization, i.e. <img alt="1/(2\pi)^d" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2249.529pt%22%20height%3D%2215.318pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2049.529%2015.318%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22g%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.2812-9.4062-2.9844%200.90625v0.57812l2.1562-0.39062v7.4062l-0.15625%200.23438-1.5938%200.078125v0.59375h4.6094v-0.57812l-1.4844-0.0625-0.15625-0.21875v-8.5469z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22f%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-1.0938c3.0469-2.4219%204.7188-3.9688%204.7188-5.7031%200-1.5625-1.0938-2.6094-2.875-2.6094-1.7031%200-2.9062%200.98438-2.9062%201.9375%200%200.46875%200.28125%200.78125%200.76562%200.78125%200.21875%200%200.42188-0.078125%200.60938-0.20312v-1.4844c0.42188-0.23438%200.8125-0.32812%201.2344-0.32812%201.1406%200%201.8281%200.78125%201.8281%202.0781%200%201.8125-1.7188%203.3125-4.7344%205.75v0.875h6.375v-2.25h-0.625l-0.25%201.1562z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.1719-10.516h-0.875l-4.5312%2013.109h0.875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.0469-5.6406h0.46875c-0.10938%200.76562-0.21875%201.5312-0.35938%202.2969-0.1875%200.85938-0.59375%201.7188-1.2188%202.4531-0.14062%200.14062-0.1875%200.3125-0.1875%200.48438%200%200.28125%200.20312%200.53125%200.54688%200.53125%200.32812%200%200.60938-0.29688%200.70312-0.64062%200.23438-0.9375%200.46875-1.8906%200.6875-2.8281l0.53125-2.2969h2.2344l-0.35938%202.2969c-0.10938%200.625-0.1875%201.2812-0.1875%201.8438%200%200.92188%200.23438%201.625%201.1094%201.625%200.75%200%201.4062-0.70312%201.5625-1.5l-0.53125-0.14062c-0.078125%200.34375-0.45312%200.59375-0.8125%200.59375-0.59375%200-0.78125-0.45312-0.78125-1.0625%200-0.40625%200.078125-0.90625%200.1875-1.3594l0.51562-2.2969h1.6719l0.20312-1.0469h-5.7812c-0.875%200-1.5938%201.3281-2.1875%202.4062-0.03125%200.0625-0.046875%200.09375-0.046875%200.14062%200%200.125%200.09375%200.20312%200.21875%200.20312%200.09375%200%200.1875-0.046875%200.25-0.17188%200.42188-0.6875%200.82812-1.5312%201.5625-1.5312z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.5469-7.0312-1.4688%200.26562v0.26562l0.84375%200.10938-0.34375%201.9062c-0.25-0.10938-0.5-0.15625-0.75-0.15625-0.79688%200-1.6406%200.46875-2.1562%201.2812-0.3125%200.48438-0.46875%201.0781-0.46875%201.7344%200%201.0938%200.48438%201.7188%201.25%201.7188%200.5%200%201.0312-0.29688%201.4844-0.89062v0.1875c0%200.46875%200.20312%200.67188%200.64062%200.67188%200.25%200%200.65625-0.078125%201.1719-0.26562v-0.29688c-0.28125%200.0625-0.5%200.10938-0.625%200.10938-0.28125%200-0.42188-0.14062-0.42188-0.40625%200-0.125%200.03125-0.29688%200.0625-0.51562l1.0312-5.7188zm-1.5469%202.7812%200.45312%200.54688-0.4375%202.4375c-0.42188%200.53125-0.85938%200.8125-1.2188%200.8125-0.5%200-0.82812-0.42188-0.82812-1.1875%200-1.5938%200.9375-2.6406%201.7969-2.6406%200.0625%200%200.14062%200.03125%200.23438%200.03125z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22j%22%3E%3Cpath%20d%3D%22m8%202h6v13.316h-6z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22i%22%3E%3Cpath%20d%3D%22m15%202h5v13.316h-5z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22h%22%3E%3Cpath%20d%3D%22m38%202h5v13.316h-5z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%3E%3Cuse%20x%3D%220.1%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23g%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23j%29%22%3E%3Cg%3E%3Cuse%20x%3D%227.757%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23i%29%22%3E%3Cg%3E%3Cuse%20x%3D%2214.726%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23c%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2220.138%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23f%22/%3E%3Cuse%20x%3D%2227.796%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23d%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23h%29%22%3E%3Cg%3E%3Cuse%20x%3D%2237.561%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23b%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2243.212%22%20y%3D%227.12%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/svg%3E"/> per loop,
which is different from the default pySecDec normalization
(<img alt="1/(i\pi^{d/2})" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2257.015pt%22%20height%3D%2215.633pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2057.015%2015.633%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22i%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.2812-9.4062-2.9844%200.90625v0.57812l2.1562-0.39062v7.4062l-0.15625%200.23438-1.5938%200.078125v0.59375h4.6094v-0.57812l-1.4844-0.0625-0.15625-0.21875v-8.5469z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22h%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.1719-10.516h-0.875l-4.5312%2013.109h0.875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22g%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.0469-5.6406h0.46875c-0.10938%200.76562-0.21875%201.5312-0.35938%202.2969-0.1875%200.85938-0.59375%201.7188-1.2188%202.4531-0.14062%200.14062-0.1875%200.3125-0.1875%200.48438%200%200.28125%200.20312%200.53125%200.54688%200.53125%200.32812%200%200.60938-0.29688%200.70312-0.64062%200.23438-0.9375%200.46875-1.8906%200.6875-2.8281l0.53125-2.2969h2.2344l-0.35938%202.2969c-0.10938%200.625-0.1875%201.2812-0.1875%201.8438%200%200.92188%200.23438%201.625%201.1094%201.625%200.75%200%201.4062-0.70312%201.5625-1.5l-0.53125-0.14062c-0.078125%200.34375-0.45312%200.59375-0.8125%200.59375-0.59375%200-0.78125-0.45312-0.78125-1.0625%200-0.40625%200.078125-0.90625%200.1875-1.3594l0.51562-2.2969h1.6719l0.20312-1.0469h-5.7812c-0.875%200-1.5938%201.3281-2.1875%202.4062-0.03125%200.0625-0.046875%200.09375-0.046875%200.14062%200%200.125%200.09375%200.20312%200.21875%200.20312%200.09375%200%200.1875-0.046875%200.25-0.17188%200.42188-0.6875%200.82812-1.5312%201.5625-1.5312z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22f%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m2.7656-9.6875c-0.40625%200-0.73438%200.32812-0.73438%200.73438%200%200.4375%200.32812%200.75%200.73438%200.75s0.75-0.32812%200.75-0.75c0-0.39062-0.34375-0.73438-0.75-0.73438zm-0.28125%203.0469-2.0312%200.45312v0.34375l1.1094%200.21875-0.8125%204.0938c-0.046875%200.3125-0.078125%200.54688-0.078125%200.71875%200%200.60938%200.29688%200.90625%200.89062%200.90625%200.51562%200%201.1719-0.15625%201.9375-0.48438v-0.42188c-0.4375%200.14062-0.76562%200.20312-1.0156%200.20312-0.4375%200-0.67188-0.17188-0.67188-0.53125%200-0.078125%200.015625-0.1875%200.046875-0.34375l0.98438-5.1562z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.5469-7.0312-1.4688%200.26562v0.26562l0.84375%200.10938-0.34375%201.9062c-0.25-0.10938-0.5-0.15625-0.75-0.15625-0.79688%200-1.6406%200.46875-2.1562%201.2812-0.3125%200.48438-0.46875%201.0781-0.46875%201.7344%200%201.0938%200.48438%201.7188%201.25%201.7188%200.5%200%201.0312-0.29688%201.4844-0.89062v0.1875c0%200.46875%200.20312%200.67188%200.64062%200.67188%200.25%200%200.65625-0.078125%201.1719-0.26562v-0.29688c-0.28125%200.0625-0.5%200.10938-0.625%200.10938-0.28125%200-0.42188-0.14062-0.42188-0.40625%200-0.125%200.03125-0.29688%200.0625-0.51562l1.0312-5.7188zm-1.5469%202.7812%200.45312%200.54688-0.4375%202.4375c-0.42188%200.53125-0.85938%200.8125-1.2188%200.8125-0.5%200-0.82812-0.42188-0.82812-1.1875%200-1.5938%200.9375-2.6406%201.7969-2.6406%200.0625%200%200.14062%200.03125%200.23438%200.03125z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.2812-7.3125h-0.59375l-3.1562%209.1094h0.60938z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.3438-0.75c2.125-1.6875%203.2812-2.7656%203.2812-3.9688%200-1.0781-0.76562-1.8125-2-1.8125-1.1875%200-2.0156%200.67188-2.0156%201.3438%200%200.32812%200.1875%200.54688%200.53125%200.54688%200.15625%200%200.29688-0.046875%200.42188-0.15625v-1.0156c0.29688-0.15625%200.5625-0.23438%200.85938-0.23438%200.79688%200%201.2656%200.53125%201.2656%201.4531%200%201.25-1.1875%202.2969-3.2812%203.9844v0.60938h4.4219v-1.5625h-0.42188l-0.17188%200.8125z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22l%22%3E%3Cpath%20d%3D%22m8%202h6v13.633h-6z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22k%22%3E%3Cpath%20d%3D%22m15%202h5v13.633h-5z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22j%22%3E%3Cpath%20d%3D%22m52%202h5v13.633h-5z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%3E%3Cuse%20x%3D%220.1%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23i%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23l%29%22%3E%3Cg%3E%3Cuse%20x%3D%227.757%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23h%22/%3E%3C/g%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23k%29%22%3E%3Cg%3E%3Cuse%20x%3D%2214.726%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23f%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2220.483%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23d%22/%3E%3Cuse%20x%3D%2225.124%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23g%22/%3E%3Cuse%20x%3D%2235.128%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23c%22/%3E%3Cuse%20x%3D%2240.847%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23b%22/%3E%3Cuse%20x%3D%2245.687%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23j%29%22%3E%3Cg%3E%3Cuse%20x%3D%2251.503%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"/> per loop). Additional prefactors can be
passed via the <code>IntegralPrefactors</code> option as an <code>Association</code>
mapping from integrals to prefactors.</p>
<p>There is a provision for automatically detecting Euclidean
integrals, and compiling them without contour deformaion, thus
making the evaluation faster: the <code>InvariantSignMap</code> option.
If certain parameters of the integrals are known to always
be positive (or negative), add an entry to InvariantSignMap
mapping the parameter to <code>+1</code> or <code>-1</code>. This information will
then be used to disable contour deformation for integrals
with <img alt="F" style="vertical-align:-0.1pt" src="data:image/svg+xml,%3Csvg%20width%3D%229.358pt%22%20height%3D%229.482pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%209.358%209.482%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.1875-9.2344v0.51562l0.875%200.09375%200.14062%200.1875-1.4688%207.6562-0.21875%200.1875-0.875%200.078125v0.51562h3.4531v-0.54688l-0.95312-0.078125-0.20312-0.20312%200.67188-3.5156h1.9531l0.15625%200.21875-0.046875%200.98438h0.59375l0.57812-3.0312h-0.59375l-0.32812%201-0.23438%200.20312h-1.9531l0.6875-3.6406h2.7812l0.14062%200.21875v1.3125h0.65625l0.4375-2.1562z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22b%22%3E%3Cpath%20d%3D%22m0%200h9v9.4805h-9z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%20clip-path%3D%22url%28%23b%29%22%3E%3Cg%3E%3Cuse%20x%3D%220.788%22%20y%3D%229.382%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"/> polynomials that are always positive.</p>
<pre><a class="tnv" href="#SecDecPrepareSum">SecDecPrepareSum</a>[<span class="tnt">basedir_String</span>, <span class="tnt">bases_List</span>, <span class="tnt">sums_Association</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">sum2int2co</span>, <span class="tnvc">integrals</span>, <span class="tnvc">int2idx</span>, <span class="tnvc">name</span>, <span class="tnvc">basisid</span>, <span class="tnvc">bid2basis</span>, <span class="tnvc">indices</span>, <span class="tnvc">basis</span>, <span class="tnvc">integral</span>, <span class="tnvc">p</span>, <span class="tnvc">m</span>, <span class="tnvc">dim</span>, <span class="tnvc">order</span>, <span class="tnvc">prefactor</span>, <span class="tnvc">cache</span>, <span class="tnvc">intfunnames</span>, <span class="tnvc">sumnames</span>},
  <span class="tnvc">sum2int2co</span> = <span class="tnv">sums</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#BracketAssociation">BracketAssociation</a>[<span class="tnt">_DimShift</span>|<span class="tnt">_B</span>]];
  <span class="tnvc">integrals</span> = <span class="tnvc">sum2int2co</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Keys.html" rel="nofollow">Keys</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Values.html" rel="nofollow">Values</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>;
  <span class="tnvc">int2idx</span> = <span class="tnvc">integrals</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/PositionIndex.html" rel="nofollow">PositionIndex</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">sums</span>] &gt; <span class="tl">0</span>];
  <span class="tnvc">bid2basis</span> = <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>[<span class="ts">"id"</span>]&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#Only">Only</a>];
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">basedir</span>];
  <span class="tnvc">cache</span> = &lt;||&gt;;
  <span class="tnvc">intfunnames</span> = <span class="tnvc">integrals</span> // <a class="tnv" href="utils.html#MapIndexed1">MapIndexed1</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"int_"</span>, <span class="tnv">#2</span>-<span class="tl">1</span>, <span class="ts">"_"</span>, <a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">#1</span>]]&amp;];
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">basedir</span> &lt;&gt; <span class="ts">"/compile.py"</span>,
    <span class="ts">"#!/usr/bin/env python3\n"</span>,
    <span class="ts">"import multiprocessing\n"</span>,
    <span class="ts">"import os\n"</span>,
    <span class="ts">"import subprocess\n"</span>,
    <span class="ts">"import sys\n"</span>,
    <span class="ts">"import tempfile\n"</span>,
    <span class="ts">"import sympy as sp\n"</span>,
    <span class="ts">"import pySecDec as psd\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"signmap = {\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<span class="ts">"  sp.Symbol('x"</span>, <span class="tnv">i</span>-<span class="tl">1</span>, <span class="ts">"'): 1,\n"</span>}, {<span class="tnv">i</span>, <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span>[<span class="ts">"denominators"</span>]&amp; /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>}],
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">InvariantSignMap</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>,
      <span class="ts">""</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">InvariantSignMap</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[(<span class="tnt">k_</span> -&gt; <span class="tnt">v_</span>) :&gt; {<span class="ts">"  sp.Symbol('"</span>, <span class="tnv">k</span>, <span class="ts">"'): "</span>, <span class="tnv">v</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">",\n"</span>}]
    ],
    <span class="ts">"}\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"def needs_cdeform(name, Fpoly):\n"</span>,
    <span class="ts">"  poly = sp.sympify(str(Fpoly))\n"</span>,
    <span class="ts">"  terms = sp.Add.make_args(poly.expand())\n"</span>,
    <span class="ts">"  res = not all((t.subs(signmap) &gt; 0) == True for t in terms)\n"</span>,
    <span class="ts">"  print(f'Needs-Contour-Deformation({name}, {poly}) = {res}')\n"</span>,
    <span class="ts">"  return res\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"def call(f):\n"</span>,
    <span class="ts">"  return f()\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      {
      <span class="ts">"\n"</span>,
      <span class="ts">"b"</span>, <span class="tnvc">basis</span>[<span class="ts">"id"</span>], <span class="ts">"_propagators = [\n"</span>,
      <span class="tnvc">basis</span>[<span class="ts">"denominators"</span>] /. {
        <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; {<span class="ts">"  '("</span>, <span class="tnvc">p</span>//<a class="tnv" href="#ToSympy">ToSympy</a>, <span class="ts">")^2'"</span>},
        <span class="tnv">den</span>[<span class="tnt">p_</span>,<span class="tnt">m_</span>,___] :&gt; {<span class="ts">"  '("</span>, <span class="tnvc">p</span>//<a class="tnv" href="#ToSympy">ToSympy</a>, <span class="ts">")^2-"</span>, <span class="tnvc">m</span>//<a class="tnv" href="#ToSympy">ToSympy</a>, <span class="ts">"'"</span>}
      } // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">",\n"</span>]&amp;,
      <span class="ts">"\n]\n"</span>,
      <span class="ts">"\n"</span>,
      <span class="ts">"b"</span>, <span class="tnvc">basis</span>[<span class="ts">"id"</span>], <span class="ts">"_replacement_rules = "</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/KeyExistsQ.html" rel="nofollow">KeyExistsQ</a>[<span class="tnvc">cache</span>, <span class="tnvc">basis</span>[<span class="ts">"sprules"</span>]],
        {<span class="tnvc">cache</span>[<span class="tnvc">basis</span>[<span class="ts">"sprules"</span>]], <span class="ts">"\n"</span>}
        ,
        <span class="tnvc">cache</span>[<span class="tnvc">basis</span>[<span class="ts">"sprules"</span>]] = <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"b"</span>, <span class="tnvc">basis</span>[<span class="ts">"id"</span>], <span class="ts">"_replacement_rules"</span>];
        {
        <span class="ts">"[\n"</span>,
        <span class="tnvc">basis</span>[<span class="ts">"sprules"</span>] //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">sp</span> -&gt; (<span class="tnv">sp</span> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>)] //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> //
          <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
            (<span class="tnv">sp</span>[<span class="tnt">p1_</span>, <span class="tnt">p2_</span>] -&gt; <span class="tnt">v_</span>) :&gt; {<span class="ts">"  ('"</span>, <span class="tnv">p1</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"*"</span>, <span class="tnv">p2</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"', '"</span>, <span class="tnv">v</span>//<a class="tnv" href="#ToSympy">ToSympy</a>, <span class="ts">"')"</span>}
          ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">",\n"</span>]&amp;,
        <span class="ts">"\n]\n"</span>
        }
      ]
      }
      ,
      {<span class="tnvc">basis</span>, <span class="tnv">bases</span>}],
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      <span class="tnvc">integral</span> = <span class="tnvc">integrals</span>[[<span class="tnv">idx</span>]];
      <span class="tnvc">prefactor</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Lookup.html" rel="nofollow">Lookup</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">IntegralPrefactors</span>], <span class="tnvc">integral</span>, <span class="tl">1</span>];
      <span class="tnvc">indices</span> = <span class="tnv">BToIndices</span>[<span class="tnvc">integral</span>];
      <span class="tnvc">basis</span> = <span class="tnvc">bid2basis</span>[<span class="tnv">BToBID</span>[<span class="tnvc">integral</span>]];
      <span class="tnvc">dim</span> = <span class="tnv">BToDimension</span>[<span class="tnvc">integral</span>];
      {
      <span class="ts">"\n"</span>,
      <span class="ts">"def "</span>, <span class="tnvc">intfunnames</span>[[<span class="tnv">idx</span>]], <span class="ts">"():\n"</span>,
      <span class="ts">"  li = psd.loop_integral.LoopIntegralFromPropagators(\n"</span>,
      <span class="ts">"    loop_momenta = ['"</span>, <span class="tnvc">basis</span>[<span class="ts">"loopmom"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"','"</span>]&amp;, <span class="ts">"'],\n"</span>,
      <span class="ts">"    external_momenta = ['"</span>, <span class="tnvc">basis</span>[<span class="ts">"externalmom"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"','"</span>]&amp;, <span class="ts">"'],\n"</span>,
      <span class="ts">"    propagators = b"</span>, <span class="tnvc">basis</span>[<span class="ts">"id"</span>], <span class="ts">"_propagators,\n"</span>,
      <span class="ts">"    powerlist = ["</span>, <span class="tnvc">indices</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">","</span>]&amp;, <span class="ts">"],\n"</span>,
      <span class="ts">"    replacement_rules = b"</span>, <span class="tnvc">basis</span>[<span class="ts">"id"</span>], <span class="ts">"_replacement_rules,\n"</span>,
      <span class="ts">"    dimensionality = '"</span>, <span class="tnvc">dim</span>, <span class="ts">"-2*eps',\n"</span>,
      <span class="ts">"    regulators = ['eps']\n"</span>,
      <span class="ts">"  )\n"</span>,
      <span class="ts">"  return psd.LoopPackage(\n"</span>,
      <span class="ts">"    name = '"</span>, <a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnvc">integral</span>], <span class="ts">"',\n"</span>,
      <span class="ts">"    loop_integral = li,\n"</span>,
      <span class="ts">"    real_parameters = ["</span>,
        <span class="tnvc">basis</span>[<span class="ts">"invariants"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">"'"</span>, <span class="tnv">#</span>, <span class="ts">"'"</span>}&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;,
      <span class="ts">"],\n"</span>,
      <span class="ts">"    additional_prefactor = '"</span>,
        <span class="tc">(* Convert from pySecDec to the physical normalization. *)</span>
        (<a class="tnb" href="https://reference.wolfram.com/language/ref/I.html" rel="nofollow">I</a>*<a class="tnb" href="https://reference.wolfram.com/language/ref/Pi.html" rel="nofollow">Pi</a>^(<span class="tnvc">dim</span>/<span class="tl">2</span>-<span class="tnv">eps</span>)/(<span class="tl">2</span>*<a class="tnb" href="https://reference.wolfram.com/language/ref/Pi.html" rel="nofollow">Pi</a>)^(<span class="tnvc">dim</span>-<span class="tl">2</span>*<span class="tnv">eps</span>))^<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">basis</span>[<span class="ts">"loopmom"</span>]] * <span class="tnvc">prefactor</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Factor.html" rel="nofollow">Factor</a> // <a class="tnv" href="#ToSympy">ToSympy</a>,
      <span class="ts">"',\n"</span>,
      <span class="ts">"    decomposition_method = '"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnvc">indices</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Except.html" rel="nofollow">Except</a>[<span class="tl">0</span>]] &gt; <span class="tl">2</span>, <span class="ts">"geometric_ku"</span>, <span class="ts">"iterative"</span>],<span class="ts">"',\n"</span>,
      <span class="ts">"    form_optimization_level = 4,\n"</span>,
      <span class="ts">"    form_work_space = '100M',\n"</span>,
      <span class="ts">"    form_threads = 1,\n"</span>,
      <span class="ts">"    contour_deformation = needs_cdeform('"</span>, <a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnvc">integral</span>], <span class="ts">"', li.F)\n"</span>,
      <span class="ts">"  )\n"</span>
      }
      ,
      {<span class="tnv">idx</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">integrals</span>]}
    ],
    <span class="ts">"\n"</span>,
    <span class="ts">"if __name__ == '__main__':\n"</span>,
    <span class="ts">"  # Always start in the directory this file resides in\n"</span>,
    <span class="ts">"  thisdir = os.path.dirname(sys.argv[0])\n"</span>,
    <span class="ts">"  if thisdir: os.chdir(os.path.dirname(sys.argv[0]))\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"  make_integrals = [\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<span class="ts">"    "</span>, <span class="tnvc">name</span>, <span class="ts">",\n"</span>}, {<span class="tnvc">name</span>, <span class="tnvc">intfunnames</span>}],
    <span class="ts">"  ]\n"</span>,
    <span class="ts">"\n"</span>,
    <span class="ts">"  coefficients = {\n"</span>,
    <span class="tnvc">sum2int2co</span> //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> //
      <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[(<span class="tnt">sumname_</span> -&gt; <span class="tnt">coefficients_</span>) :&gt; {
        <span class="ts">"    "</span>, <span class="tnv">sumname</span> // <span class="tnv">ToPythonString</span>, <span class="ts">": {\n"</span>,
        <span class="tnv">coefficients</span> //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> //
          <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[(<span class="tnt">int_</span> -&gt; <span class="tnt">coefficient_</span>) :&gt; {
            <span class="ts">"      "</span>, <span class="tnvc">int2idx</span>[<span class="tnv">int</span>]-<span class="tl">1</span>, <span class="ts">": "</span>, <span class="tnv">coefficient</span> // <a class="tnv" href="#ToSympy">ToSympy</a> // <span class="tnv">ToPythonString</span>, <span class="ts">",\n"</span>
          }],
        <span class="ts">"    },\n"</span>
      }],
    <span class="ts">"  }\n"</span>,
    <span class="ts">"  try:\n"</span>,
    <span class="ts">"    nthreads = int(os.environ['THREADS'])\n"</span>,
    <span class="ts">"  except KeyError:\n"</span>,
    <span class="ts">"    try:\n"</span>,
    <span class="ts">"      nthreads = len(os.sched_getaffinity(0))\n"</span>,
    <span class="ts">"    except AttributeError:\n"</span>,
    <span class="ts">"      nthreads = os.cpu_count()\n"</span>,
    <span class="ts">"  if nthreads &gt; 1:\n"</span>,
    <span class="ts">"    with multiprocessing.Pool(nthreads) as pool:\n"</span>,
    <span class="ts">"      integrals = pool.map(call, make_integrals)\n"</span>,
    <span class="ts">"  else:\n"</span>,
    <span class="ts">"    integrals = [f() for f in make_integrals]\n"</span>,
    <span class="ts">"  subprocess.check_call(['rm', '-rf', 'disteval'])\n"</span>,
    <span class="ts">"  cwd = os.getcwd()\n"</span>,
    <span class="ts">"  with tempfile.TemporaryDirectory(prefix='psd') as tmp:\n"</span>,
    <span class="ts">"    os.chdir(tmp)\n"</span>,
    <span class="ts">"    psd.sum_package('sum',\n"</span>,
    <span class="ts">"      integrals,\n"</span>,
    <span class="ts">"      coefficients = coefficients,\n"</span>,
    <span class="ts">"      regulators = ['eps'],\n"</span>,
    <span class="ts">"      requested_orders = ["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Order.html" rel="nofollow">Order</a>], <span class="ts">"],\n"</span>,
    <span class="ts">"      real_parameters = ["</span>,
      <span class="tnvc">basis</span>[<span class="ts">"invariants"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">"'"</span>, <span class="tnv">#</span>, <span class="ts">"'"</span>}&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;,
    <span class="ts">"],\n"</span>,
    <span class="ts">"      processes = nthreads,\n"</span>,
    <span class="ts">"    )\n"</span>,
    <span class="ts">"    subprocess.check_call(['make', '-C', 'sum', '-j', str(nthreads), 'disteval.done'])\n"</span>,
    <span class="ts">"    subprocess.check_call(['cp', '-a', 'sum/disteval', cwd])\n"</span>,
    <span class="ts">"    subprocess.check_call(['rm', '-rf', 'sum'])\n"</span>
  ];
]
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#SecDecPrepareSum">SecDecPrepareSum</a>] = {<a class="tnb" href="https://reference.wolfram.com/language/ref/Order.html" rel="nofollow">Order</a> -&gt; <span class="tl">0</span>, <span class="tnv">IntegralPrefactors</span> -&gt; &lt;||&gt;, <span class="tnv">InvariantSignMap</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>};</pre>
<h3 id="SecDecIntegrateSum"><code>SecDecIntegrateSum[]</code></h3>
<p>Evaluate the sums contained in a given pySecDec integration
library. The library is assume to have been prepared by
<a href="#SecDecPrepareSum">SecDecPrepareSum</a>, and compiled.</p>
<pre><a class="tnv" href="#SecDecIntegrateSum">SecDecIntegrateSum</a>[<span class="tnt">path_String</span>, <span class="tnt">invariantmap_List</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">tmp</span>, <span class="tnvc">result</span>, <span class="tnvc">regulators</span>},
  <span class="tnvc">tmp</span> = <a class="tnv" href="utils.html#MkTemp">MkTemp</a>[<span class="ts">"pysecdec"</span>, <span class="ts">".output.json"</span>];
  <a class="tnv" href="utils.html#SafeRun">SafeRun</a>[<span class="ts">"echo python3 -m pySecDec.disteval '"</span>, <span class="tnv">path</span>, <span class="ts">"' "</span>
    <span class="ts">"--epsrel="</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">EpsRel</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>, <span class="ts">" "</span>,
    <span class="ts">"--epsabs="</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">EpsAbs</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>, <span class="ts">" "</span>,
    <span class="ts">"--format=json "</span>,
    <span class="ts">"--lattice-candidates=11 "</span>,
    <span class="tnv">invariantmap</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[(<span class="tnt">k_</span> -&gt; <span class="tnt">v_</span>) :&gt; {<span class="tnv">k</span>, <span class="ts">"="</span>, <span class="tnv">v</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a>//<a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">" "</span>]&amp;, <span class="ts">" "</span>,
    <span class="ts">"&gt;'"</span>, <span class="tnvc">tmp</span>, <span class="ts">"' || rm -f '"</span>, <span class="tnvc">tmp</span>, <span class="ts">"'"</span>
  ];
  <a class="tnv" href="utils.html#SafeRun">SafeRun</a>[<span class="ts">"python3 -m pySecDec.disteval '"</span>, <span class="tnv">path</span>, <span class="ts">"' "</span>
    <span class="ts">"--epsrel="</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">EpsRel</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>, <span class="ts">" "</span>,
    <span class="ts">"--epsabs="</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">EpsAbs</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>, <span class="ts">" "</span>,
    <span class="ts">"--format=json "</span>,
    <span class="ts">"--lattice-candidates=11 "</span>,
    <span class="tnv">invariantmap</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[(<span class="tnt">k_</span> -&gt; <span class="tnt">v_</span>) :&gt; {<span class="tnv">k</span>, <span class="ts">"="</span>, <span class="tnv">v</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a>//<a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">" "</span>]&amp;, <span class="ts">" "</span>,
    <span class="ts">"&gt;'"</span>, <span class="tnvc">tmp</span>, <span class="ts">"' || rm -f '"</span>, <span class="tnvc">tmp</span>, <span class="ts">"'"</span>
  ];
  <span class="tnvc">result</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Import.html" rel="nofollow">Import</a>[<span class="tnvc">tmp</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">tmp</span> === <a class="tnb" href="https://reference.wolfram.com/language/ref/$Failed.html" rel="nofollow">$Failed</a>, <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Could not open "</span>, <span class="tnvc">tmp</span>, <span class="ts">"; pySecDec has failed"</span>]];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteFile.html" rel="nofollow">DeleteFile</a>[<span class="tnvc">tmp</span>];
  <span class="tnvc">result</span> = <span class="tnvc">result</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>;
  <span class="tnvc">regulators</span> = <span class="tnvc">result</span>[<span class="ts">"regulators"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>];
  &lt;|
    <span class="ts">"sums"</span> -&gt; (
      <span class="tnvc">result</span>[<span class="ts">"sums"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
        {<span class="tnt">regpow_List</span>, {<span class="tnt">re_</span>, <span class="tnt">im_</span>}, {<span class="tnt">dre_</span>, <span class="tnt">dim_</span>}} :&gt;
        {<span class="tnvc">regulators</span>^<span class="tnv">regpow</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Complex.html" rel="nofollow">Complex</a>[<span class="tnv">re</span>, <span class="tnv">im</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Complex.html" rel="nofollow">Complex</a>[<span class="tnv">dre</span>, <span class="tnv">dim</span>]}
      ]]
    ),
    <span class="ts">"integrals"</span> -&gt; (
      <span class="tnvc">result</span>[<span class="ts">"integrals"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
        {<span class="tnt">regpow_List</span>, {<span class="tnt">re_</span>, <span class="tnt">im_</span>}, {<span class="tnt">dre_</span>, <span class="tnt">dim_</span>}} :&gt;
        {<span class="tnvc">regulators</span>^<span class="tnv">regpow</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Complex.html" rel="nofollow">Complex</a>[<span class="tnv">re</span>, <span class="tnv">im</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Complex.html" rel="nofollow">Complex</a>[<span class="tnv">dre</span>, <span class="tnv">dim</span>]}
      ]]
    )
  |&gt;
]
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#SecDecIntegrateSum">SecDecIntegrateSum</a>] = {
    <span class="tnv">EpsRel</span> -&gt; <span class="tl">10.</span>^-<span class="tl">3</span>,
    <span class="tnv">EpsAbs</span> -&gt; <span class="tl">10.</span>^-<span class="tl">8</span>
};</pre>
<h3 id="SecDecLeadingOrders"><code>SecDecLeadingOrders[]</code></h3>
<p>Return the leading expansion orders in 'eps' of a list of
integrals computed via pySecDec.</p>
<pre><a class="tnv" href="#SecDecLeadingOrders">SecDecLeadingOrders</a>[<span class="tnt">base_List</span>, <span class="tnt">integrals_List</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionsPattern.html" rel="nofollow">OptionsPattern</a>[]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bid2basis</span>, <span class="tnvc">tmpscript</span>, <span class="tnvc">tmpresult</span>},
  <span class="tnvc">bid2basis</span> = <span class="tnv">bases</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>[<span class="ts">"id"</span>]&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#Only">Only</a>];
  <span class="tnvc">tmpscript</span> = <a class="tnv" href="utils.html#MkTemp">MkTemp</a>[<span class="ts">"psdlo"</span>, <span class="ts">".py"</span>];
  <span class="tnvc">tmpresult</span> = <span class="tnvc">tmpscript</span> &lt;&gt; <span class="ts">".m"</span>;
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnvc">tmpscript</span>,
    <span class="ts">"#!/usr/bin/env python3\n"</span>,
    <span class="ts">"import os\n"</span>,
    <span class="ts">"import subprocess\n"</span>,
    <span class="ts">"import tempfile\n"</span>,
    <span class="ts">"import json\n"</span>,
    <span class="ts">"import pySecDec as psd\n"</span>,
    <span class="ts">"if __name__ == '__main__':\n"</span>,
    <span class="ts">"    terms = []\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      {<span class="tnv">name</span>, <span class="tnv">integral</span>, <span class="tnv">dim</span>, <span class="tnv">order</span>, <span class="tnv">prefactor</span>} = <span class="tnv">integrals</span>[[<span class="tnv">i</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[{
          <span class="tnt">pre_</span>. * <span class="tnt">b_B</span> :&gt; {<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">b</span>], <span class="tnv">b</span>, <span class="tl">4</span>, <span class="tl">0</span>, <span class="tnv">pre</span>},
          <span class="tnt">pre_</span>. * <span class="tnv">int</span>:<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, <span class="tnt">n_</span>] :&gt; {<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">int</span>], <span class="tnv">b</span>, <span class="tl">4</span> + <span class="tnv">n</span>, <span class="tl">0</span>, <span class="tnv">pre</span>},
          {<span class="tnt">pre_</span>. * <span class="tnt">b_B</span>, <span class="tnt">ord_</span>} :&gt; {<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">b</span>], <span class="tnv">b</span>, <span class="tl">4</span>, <span class="tnv">ord</span>, <span class="tnv">pre</span>},
          {<span class="tnt">pre_</span>. * <span class="tnv">int</span>:<span class="tnv">DimShift</span>[<span class="tnt">b_B</span>, <span class="tnt">n_</span>], <span class="tnt">ord_</span>} :&gt; {<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">int</span>], <span class="tnv">b</span>, <span class="tl">4</span>+<span class="tnv">n</span>, <span class="tnv">ord</span>, <span class="tnv">pre</span>}
      }];
      <span class="tnv">basisid</span> = <span class="tnv">integral</span>[[<span class="tl">1</span>]];
      <span class="tnv">indices</span> = <span class="tnv">integral</span>[[<span class="tl">2</span>;;]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>];
      <span class="tnv">basis</span> = <span class="tnvc">bid2basis</span>[<span class="tnv">basisid</span>];
      {
      <span class="ts">"    loopint = psd.loop_integral.LoopIntegralFromPropagators(\n"</span>,
      <span class="ts">"      loop_momenta = ['"</span>, <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"','"</span>]&amp;, <span class="ts">"'],\n"</span>,
      <span class="ts">"      external_momenta = ['"</span>, <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"','"</span>]&amp;, <span class="ts">"'],\n"</span>,
      <span class="ts">"      regulator = 'eps',\n"</span>,
      <span class="ts">"      propagators = [\n"</span>,
      <span class="tnv">basis</span>[<span class="ts">"denominators"</span>] /. {
        <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; {<span class="ts">"        '("</span>, <span class="tnv">p</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>, <span class="ts">")^2'"</span>},
        <span class="tnv">den</span>[<span class="tnt">p_</span>,<span class="tnt">m_</span>,___] :&gt; {<span class="ts">"        '("</span>, <span class="tnv">p</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>, <span class="ts">")^2-"</span>, <span class="tnv">m</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>, <span class="ts">"'"</span>}
      } // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">",\n"</span>]&amp;,
      <span class="ts">"\n"</span>,
      <span class="ts">"      ],\n"</span>,
      <span class="ts">"      powerlist = ["</span>, <span class="tnv">indices</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">","</span>]&amp;, <span class="ts">"],\n"</span>,
      <span class="ts">"      dimensionality='"</span>, <span class="tnv">dim</span>, <span class="ts">"-2*eps',\n"</span>,
      <span class="ts">"      replacement_rules = [\n  "</span>,
      <span class="tnv">basis</span>[<span class="ts">"sprules"</span>] //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnv">sp</span> -&gt; (<span class="tnv">sp</span> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>)] //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> //
        <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
          (<span class="tnv">sp</span>[<span class="tnt">p1_</span>, <span class="tnt">p2_</span>] -&gt; <span class="tnt">v_</span>) :&gt; {<span class="ts">"      ('"</span>, <span class="tnv">p1</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"*"</span>, <span class="tnv">p2</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"', '"</span>, <span class="tnv">v</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"')"</span>}
        ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">",\n  "</span>]&amp;,
      <span class="ts">"\n      ]\n"</span>,
      <span class="ts">"    )\n"</span>,
      <span class="ts">"    terms.append(psd.LoopPackage(\n"</span>,
      <span class="ts">"      name = 'integral"</span>, <span class="tnv">i</span>, <span class="ts">"',\n"</span>,
      <span class="ts">"      loop_integral = loopint,\n"</span>,
      <span class="ts">"      real_parameters = ["</span>,
        <span class="tnv">basis</span>[<span class="ts">"invariants"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">"'"</span>, <span class="tnv">#</span>, <span class="ts">"'"</span>}&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;,
      <span class="ts">"],\n"</span>,
      <span class="ts">"      additional_prefactor = '"</span>,
        <span class="tc">(* Convert from pySecDec to the physical normalization. *)</span>
        (<a class="tnb" href="https://reference.wolfram.com/language/ref/I.html" rel="nofollow">I</a>*<a class="tnb" href="https://reference.wolfram.com/language/ref/Pi.html" rel="nofollow">Pi</a>^(<span class="tnv">dim</span>/<span class="tl">2</span>-<span class="tnv">eps</span>)/(<span class="tl">2</span>*<a class="tnb" href="https://reference.wolfram.com/language/ref/Pi.html" rel="nofollow">Pi</a>)^(<span class="tnv">dim</span>-<span class="tl">2</span>*<span class="tnv">eps</span>))^<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>[<span class="ts">"loopmom"</span>]] * <span class="tnv">prefactor</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Factor.html" rel="nofollow">Factor</a> // <a class="tnv" href="#ToSympy">ToSympy</a>,
      <span class="ts">"',\n"</span>,
      <span class="ts">"      decomposition_method = '"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">indices</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Except.html" rel="nofollow">Except</a>[<span class="tl">0</span>]] &gt; <span class="tl">2</span>, <span class="ts">"geometric_ku"</span>, <span class="ts">"iterative"</span>],<span class="ts">"',\n"</span>,
      <span class="ts">"      use_dreadnaut = True,\n"</span>,
      <span class="ts">"      requested_order = "</span>, <span class="tnv">order</span>, <span class="ts">",\n"</span>,
      <span class="ts">"      processes = 1,\n"</span>,
      <span class="ts">"      form_optimization_level = 4,\n"</span>,
      <span class="ts">"      form_work_space = '100M',\n"</span>,
      <span class="ts">"      form_threads = 1,\n"</span>,
      <span class="ts">"      contour_deformation = False\n"</span>,
      <span class="ts">"    ))\n"</span>
      }
      ,
      {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">integrals</span>]}],
    <span class="ts">"    with tempfile.TemporaryDirectory(prefix='psd') as tmp:\n"</span>,
    <span class="ts">"        os.chdir(tmp)\n"</span>,
    <span class="ts">"        psd.sum_package(\n"</span>,
    <span class="ts">"            'sum',\n"</span>,
    <span class="ts">"            terms,\n"</span>,
    <span class="ts">"            regulators=['eps'],\n"</span>,
    <span class="ts">"            requested_orders=["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">MaxOrder</span>], <span class="ts">"],\n"</span>,
    <span class="ts">"            real_parameters=["</span>,
      <span class="tnv">bases</span>[[;;,<span class="ts">"invariants"</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<span class="ts">"'"</span>, <span class="tnv">#</span>, <span class="ts">"'"</span>}&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;,
    <span class="ts">"],\n"</span>,
    <span class="ts">"            processes = "</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">Threads</span>], <span class="ts">"\n"</span>,
    <span class="ts">"        )\n"</span>,
    <span class="ts">"        orders = []\n"</span>,
    <span class="ts">"        for i in range("</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">integrals</span>], <span class="ts">"):\n"</span>,
    <span class="ts">"            with open(f'sum/integral{i+1}/disteval/integral{i+1}.json', 'r') as f:\n"</span>,
    <span class="ts">"                desk = json.load(f)\n"</span>,
    <span class="ts">"            if desk['orders']:\n"</span>,
    <span class="ts">"                orders.append(desk['lowest_orders'][0] + desk['prefactor_lowest_orders'][0])\n"</span>,
    <span class="ts">"            else:\n"</span>,
    <span class="ts">"                orders.append("</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OptionValue.html" rel="nofollow">OptionValue</a>[<span class="tnv">MaxOrder</span>], <span class="ts">")\n"</span>,
    <span class="ts">"        with open('"</span>, <span class="tnvc">tmpresult</span>, <span class="ts">"', 'w') as f:\n"</span>,
    <span class="ts">"            f.write('{' + ','.join(map(str, orders)) + '}')\n"</span>
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Run.html" rel="nofollow">Run</a>[<span class="ts">"python3 '"</span> &lt;&gt; <span class="tnvc">tmpscript</span> &lt;&gt; <span class="ts">"' &gt;/dev/null"</span>] =!= <span class="tl">0</span>,
    <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"pySecDec script failed\n"</span>];
  ];
  <span class="tnv">results</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Get.html" rel="nofollow">Get</a>[<span class="tnvc">tmpresult</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteFile.html" rel="nofollow">DeleteFile</a>[{<span class="tnvc">tmpscript</span>, <span class="tnvc">tmpresult</span>}];
  <span class="tnv">results</span>
]
<a class="tnb" href="https://reference.wolfram.com/language/ref/Options.html" rel="nofollow">Options</a>[<a class="tnv" href="#SecDecLeadingOrders">SecDecLeadingOrders</a>] = {<span class="tnv">Threads</span> -&gt; <span class="tl">2</span>, <span class="tnv">MaxOrder</span> -&gt; <span class="tl">1</span>};</pre>
<h3 id="MkSecDecCoefficientFile"><code>MkSecDecCoefficientFile[]</code></h3>
<p>Write a single coefficient file in pySecDec syntax. It is
expected that overall regulator factors are factorized.</p>
<pre><a class="tnv" href="#MkSecDecCoefficientFile">MkSecDecCoefficientFile</a>[<span class="tnt">filename_String</span>, <span class="tnt">value_</span>, <span class="tnt">regulators_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">regpattern</span>, <span class="tnvc">num</span>, <span class="tnvc">den</span>, <span class="tnvc">reg</span>},
  <span class="tnvc">regpattern</span> = <span class="tnv">regulators</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>];
  <span class="tnv">nums</span> = <span class="tnv">dens</span> = <span class="tnv">regs</span> = {};
  <span class="tnv">value</span> //
    <a class="tnv" href="utils.html#Factors">Factors</a> //
    <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{
      <span class="tnt">x_Integer</span> :&gt; (<span class="tnv">nums</span> = {<span class="tnv">nums</span>, <span class="tnv">x</span>}),
      <span class="tnt">x_Rational</span> :&gt; (<span class="tnv">nums</span> = {<span class="tnv">nums</span>, <span class="tnv">x</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/Numerator.html" rel="nofollow">Numerator</a>}; <span class="tnv">dens</span> = {<span class="tnv">dens</span>, <span class="tnv">x</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/Denominator.html" rel="nofollow">Denominator</a>}),
      <span class="tnv">x</span>:(<span class="tnvc">regpattern</span>^<span class="tnt">n_</span>.) :&gt; (<span class="tnv">regs</span> = {<span class="tnv">regs</span>, <span class="tnv">x</span>}),
      <span class="tnv">x</span>:(_^<span class="tnt">n_</span> /; <span class="tnv">n</span> &gt; <span class="tl">0</span>) :&gt; (<span class="tnv">nums</span> = {<span class="tnv">nums</span>, <span class="tnv">x</span>}),
      <span class="tnv">x</span>:(_^<span class="tnt">n_</span> /; <span class="tnv">n</span> &lt; <span class="tl">0</span>) :&gt; (<span class="tnv">dens</span> = {<span class="tnv">dens</span>, <span class="tl">1</span>/<span class="tnv">x</span>}),
      <span class="tnv">x</span>:(_) :&gt; (<span class="tnv">nums</span> = {<span class="tnv">nums</span>, <span class="tnv">x</span>})
    }];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">value</span> === <span class="tl">0</span>, <span class="tnv">regs</span> = <span class="tnv">regulators</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span>^<span class="tl">500000000</span>&amp;]];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnv">filename</span>,
    <span class="ts">"numerator = 1\n"</span>,
    <span class="tnv">nums</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{
      <span class="tnt">x_</span>^<span class="tnt">n_</span> :&gt; {<span class="ts">"*("</span>, <span class="tnv">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">")^("</span>, <span class="tnv">n</span>, <span class="ts">")\n"</span>},
      <span class="tnt">x_</span> :&gt; {<span class="ts">"*("</span>, <span class="tnv">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">")\n"</span>}
    }],
    <span class="ts">";\n"</span>,
    <span class="ts">"denominator = 1\n"</span>,
    <span class="tnv">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{
      <span class="tnt">x_</span>^<span class="tnt">n_</span> :&gt; {<span class="ts">"*("</span>, <span class="tnv">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">")^("</span>, <span class="tnv">n</span>, <span class="ts">")\n"</span>},
      <span class="tnt">x_</span> :&gt; {<span class="ts">"*("</span>, <span class="tnv">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">")\n"</span>}
    }],
    <span class="ts">";\n"</span>,
    <span class="ts">"regulator_factor = 1\n"</span>,
    <span class="tnv">regs</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{
      <span class="tnt">x_Symbol</span>^<span class="tnt">n_</span> :&gt; {<span class="ts">"*"</span>, <span class="tnv">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"^("</span>, <span class="tnv">n</span>, <span class="ts">")\n"</span>},
      <span class="tnt">x_Symbol</span> :&gt; {<span class="ts">"*"</span>, <span class="tnv">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"\n"</span>},
      <span class="tnt">x_</span>^<span class="tnt">n_</span> :&gt; {<span class="ts">"*("</span>, <span class="tnv">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">")^("</span>, <span class="tnv">n</span>, <span class="ts">")\n"</span>},
      <span class="tnt">x_</span> :&gt; {<span class="ts">"*("</span>, <span class="tnv">x</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">")\n"</span>}
    }],
    <span class="ts">";\n"</span>
  ];
];</pre>
<h3 id="MkSecDecCoefficientDir"><code>MkSecDecCoefficientDir[]</code></h3>
<p>Populate a directory with coefficient files in pySecDec
syntax.</p>
<pre><a class="tnv" href="#MkSecDecCoefficientDir">MkSecDecCoefficientDir</a>[<span class="tnt">coefdir_String</span>, <span class="tnt">integrals_List</span>, <span class="tnt">coefficients_List</span>, <span class="tnt">regulators_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">name</span>, <span class="tnvc">basisid</span>, <span class="tnvc">bid2basis</span>, <span class="tnvc">indices</span>, <span class="tnvc">basis</span>, <span class="tnvc">integral</span>, <span class="tnvc">coeff</span>, <span class="tnvc">p</span>, <span class="tnvc">m</span>, <span class="tnvc">dim</span>, <span class="tnvc">order</span>, <span class="tnvc">prefactor</span>, <span class="tnvc">c</span>},
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">coefficients</span>] &gt; <span class="tl">0</span>];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">coefficients</span>[[<span class="tl">1</span>]]] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">integrals</span>]];
  <a class="tnv" href="utils.html#EnsureDirectory">EnsureDirectory</a>[<span class="tnv">coefdir</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
    <span class="tnvc">integral</span> = <span class="tnv">integrals</span>[[<span class="tnv">idx</span>]];
    <span class="tnvc">name</span> = <a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnvc">integral</span>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
      <span class="tnvc">c</span> = <span class="tnv">coefficients</span>[[<span class="tnv">cidx</span>, <span class="tnv">idx</span>]];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">c</span> =!= <span class="tl">0</span>,
        <a class="tnv" href="#MkSecDecCoefficientFile">MkSecDecCoefficientFile</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnv">coefdir</span>, <span class="ts">"/"</span>, <span class="tnvc">name</span>, <span class="ts">"_coefficient"</span>, <span class="tnv">cidx</span>-<span class="tl">1</span>, <span class="ts">".txt"</span>], <span class="tnvc">c</span>, <span class="tnv">regulators</span>];
      ];
      ,
      {<span class="tnv">cidx</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">coefficients</span>]}];
    ,
    {<span class="tnv">idx</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">integrals</span>]}];
]</pre>
<h3 id="SecDecCompile"><code>SecDecCompile[]</code></h3>
<p>Compile integration libraries for a list of integrals belonging
to a given set of bases in a given directory.</p>
<p>Note that by design if this function is re-run with the same
(or slightly different) parameters, then no (or very little)
recompilation will take place.</p>
<pre><a class="tnv" href="#SecDecCompile">SecDecCompile</a>[<span class="tnt">basedir_String</span>, <span class="tnt">bases_List</span>, <span class="tnt">integrals_List</span>, <span class="tnt">jobs_</span>:<span class="tl">1</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{},
  <a class="tnv" href="#SecDecPrepare">SecDecPrepare</a>[<span class="tnv">basedir</span>, <span class="tnv">bases</span>, <span class="tnv">integrals</span>];
  <a class="tnv" href="utils.html#SafeRun">SafeRun</a>[<span class="ts">"make -j"</span>, <span class="tnv">jobs</span>, <span class="ts">" -C '"</span>, <span class="tnv">basedir</span>, <span class="ts">"' compile"</span>];
]

<span class="tnv">MkInvariantsTxt</span>[<span class="tnt">filename_</span>, <span class="tnt">invariantmap_</span>] :=
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">filename</span>,
    <span class="tnv">invariantmap</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[(<span class="tnt">k_</span> -&gt; <span class="tnt">v_</span>) :&gt; {<span class="tnv">k</span>, <span class="ts">"="</span>, <span class="tnv">v</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a>//<a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">" "</span>]&amp;
  ]

<span class="tnv">MkSedArguments</span>[<span class="tnt">filename_</span>, <span class="tnt">invmap_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{},
  <a class="tnv" href="utils.html#MaybeMkFile">MaybeMkFile</a>[<span class="tnv">filename</span>, <span class="tnv">invmap</span> //
    <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{
      (<span class="tnt">x_Symbol</span> -&gt; <span class="tnt">value_Integer</span> /; <span class="tnv">value</span> &gt;= <span class="tl">0</span>) :&gt; { <span class="ts">"-e s,"</span>, <span class="tnv">x</span>, <span class="ts">","</span>, <span class="tnv">value</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">",g"</span> },
      (<span class="tnt">x_Symbol</span> -&gt; <span class="tnt">value_</span>) :&gt; { <span class="ts">"-e s,"</span>, <span class="tnv">x</span>, <span class="ts">",("</span>, <span class="tnv">value</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>, <span class="ts">"),g"</span> }
    }] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">" "</span>]&amp;,
    <span class="ts">"\n"</span>
  ];
]</pre>
<h3 id="SecDecIntegrate"><code>SecDecIntegrate[]</code></h3>
<p>Integrate a set of integrals at a given phase-space point
given by a map of invariant values. The direcory should
have already been prepared with <a href="#SecDecPrepare">SecDecPrepare</a>, and
optionally compiled with <a href="#SecDecCompile">SecDecCompile</a>.</p>
<p>Here the same setup as with <a href="#SecDecPrepare">SecDecPrepare</a> is used:
you can set the <code>THREADS</code> and <code>RUN</code> environment variables to
parallelize the integration.</p>
<p>As with <a href="#SecDecCompile">SecDecCompile</a> this function can be re-run twice,
and the second time it will return immediately because all
the integration is already saved to disk. Only if the phase-space
point has changed will the new integration be performed.</p>
<pre><a class="tnv" href="#SecDecIntegrate">SecDecIntegrate</a>[<span class="tnt">basedir_String</span>, <span class="tnt">integrals_List</span>, <span class="tnt">invariantmap_List</span>, <span class="tnt">jobs_</span>:<span class="tl">1</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">invstring</span>,<span class="tnvc">filenames</span>},
  <span class="tnv">MkInvariantsTxt</span>[<span class="tnv">basedir</span> &lt;&gt; <span class="ts">"/invariants.txt"</span>, <span class="tnv">invariantmap</span>];
  <span class="tnvc">filenames</span> = <span class="tnv">integrals</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<a class="tnv" href="#SecDecIntegralName">SecDecIntegralName</a>[<span class="tnv">#</span>], <span class="ts">"_value.m"</span>]&amp;];
  <a class="tnv" href="utils.html#SafeRun">SafeRun</a>[<span class="ts">"make -j"</span>, <span class="tnv">jobs</span>, <span class="ts">" -C '"</span>, <span class="tnv">basedir</span>, <span class="ts">"' "</span>, <span class="tnvc">filenames</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">" "</span>]&amp;];
  <span class="tnvc">filenames</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#SafeGet">SafeGet</a>[<span class="tnv">basedir</span> &lt;&gt; <span class="ts">"/"</span> &lt;&gt; <span class="tnv">#</span>]&amp;]
]
<a class="tnv" href="#SecDecIntegrate">SecDecIntegrate</a>[<span class="tnt">basedir_String</span>, <span class="tnt">integral_</span>, <span class="tnt">variables_List</span>] :=
  <a class="tnv" href="#SecDecIntegrate">SecDecIntegrate</a>[<span class="tnv">basedir</span>, {<span class="tnv">integral</span>}, <span class="tnv">variables</span>] // <a class="tnv" href="utils.html#Only">Only</a></pre>
<h2 id="DimensionalRecurrence">Dimensional recurrence</h2>
<pre><span class="tnv">DenToNumerator</span>[<span class="tnv">den</span>[<span class="tnt">p_</span>]] := <span class="tnv">sp</span>[<span class="tnv">p</span>,<span class="tnv">p</span>]
<span class="tnv">DenToNumerator</span>[<span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, ___]] := <span class="tnv">sp</span>[<span class="tnv">p</span>,<span class="tnv">p</span>] - <span class="tnv">m</span>

<span class="tnv">ExpandSP</span>[<span class="tnv">sp</span>[<span class="tnt">p1_</span>]] := <span class="tnv">ExpandSP</span>[<span class="tnv">sp</span>[<span class="tnv">p1</span>,<span class="tnv">p1</span>]]
<span class="tnv">ExpandSP</span>[<span class="tnv">sp</span>[<span class="tnt">p1_</span>,<span class="tnt">p2_</span>]] := <span class="tnv">p1</span>*<span class="tnv">p2</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>//<a class="tnv" href="utils.html#Terms">Terms</a>//<a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
  <span class="tnt">a_Symbol</span>*<span class="tnt">b_Symbol</span>*<span class="tnt">c_</span>. :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnv">a</span>,<span class="tnv">b</span>]]*<span class="tnv">c</span>,
  <span class="tnt">a_Symbol</span>^<span class="tl">2</span>*<span class="tnt">c_</span>.:&gt; <span class="tnv">sp</span>[<span class="tnv">a</span>,<span class="tnv">a</span>]*<span class="tnv">c</span>
]//<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>]
<span class="tnv">ExpandSP</span>[<span class="tnt">ex_</span>] := <span class="tnv">ex</span> /. <span class="tnt">s_sp</span> :&gt; <span class="tnv">ExpandSP</span>[<span class="tnv">s</span>]</pre>
<h3 id="RaisingDRR"><code>RaisingDRR[]</code></h3>
<p>“Raising” dimensional recurrence: expresses a given integral
in <img alt="d-2" style="vertical-align:-0.2935272216796875pt" src="data:image/svg+xml,%3Csvg%20width%3D%2231.628pt%22%20height%3D%2210.501pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2031.628%2010.501%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.5312-10.125-2.0938%200.39062v0.39062l1.2031%200.14062-0.48438%202.75c-0.35938-0.17188-0.71875-0.23438-1.0938-0.23438-1.1406%200-2.3594%200.6875-3.0938%201.8594-0.45312%200.70312-0.67188%201.5469-0.67188%202.4844%200%201.5781%200.6875%202.4688%201.7969%202.4688%200.73438%200%201.4688-0.42188%202.1406-1.2812-0.015625%200.09375-0.015625%200.1875-0.015625%200.28125%200%200.67188%200.29688%200.96875%200.92188%200.96875%200.35938%200%200.9375-0.125%201.7031-0.39062v-0.42188c-0.42188%200.09375-0.71875%200.15625-0.89062%200.15625-0.42188%200-0.60938-0.1875-0.60938-0.57812%200-0.1875%200.03125-0.4375%200.078125-0.75l1.4688-8.2344zm-2.2188%204.0156%200.65625%200.78125-0.625%203.5c-0.60938%200.78125-1.25%201.1719-1.75%201.1719-0.71875%200-1.1875-0.60938-1.1875-1.7031%200-2.2969%201.3281-3.7969%202.5781-3.7969%200.09375%200%200.20312%200.03125%200.32812%200.046875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m0.32812-3.5469h9.3594v-0.82812h-9.3594z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-1.0938c3.0469-2.4219%204.7188-3.9688%204.7188-5.7031%200-1.5625-1.0938-2.6094-2.875-2.6094-1.7031%200-2.9062%200.98438-2.9062%201.9375%200%200.46875%200.28125%200.78125%200.76562%200.78125%200.21875%200%200.42188-0.078125%200.60938-0.20312v-1.4844c0.42188-0.23438%200.8125-0.32812%201.2344-0.32812%201.1406%200%201.8281%200.78125%201.8281%202.0781%200%201.8125-1.7188%203.3125-4.7344%205.75v0.875h6.375v-2.25h-0.625l-0.25%201.1562z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22e%22%3E%3Cpath%20d%3D%22m0%200h8v10.5h-8z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22d%22%3E%3Cpath%20d%3D%22m24%200h7v10.5h-7z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%20clip-path%3D%22url%28%23e%29%22%3E%3Cg%3E%3Cuse%20x%3D%220.444%22%20y%3D%2210.209%22%20xlink%3Ahref%3D%22%23c%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2211.241%22%20y%3D%2210.209%22%20xlink%3Ahref%3D%22%23b%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23d%29%22%3E%3Cg%3E%3Cuse%20x%3D%2223.871%22%20y%3D%2210.209%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"/> space-time dimensions as a linear combination of
integrals in d space-time dimensions.</p>
<p>Note that Minkowski metrics is assumed. Multiply by <img alt="(-1)^L" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2235.206pt%22%20height%3D%2214.744pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2035.206%2014.744%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m0.32812-3.5469h9.3594v-0.82812h-9.3594z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.2812-9.4062-2.9844%200.90625v0.57812l2.1562-0.39062v7.4062l-0.15625%200.23438-1.5938%200.078125v0.59375h4.6094v-0.57812l-1.4844-0.0625-0.15625-0.21875v-8.5469z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m0.79688-6.4219v0.375l0.625%200.046875%200.09375%200.14062-1.0156%205.3125-0.15625%200.14062-0.60938%200.046875v0.35938h4.2656l0.32812-1.7344h-0.45312l-0.375%201.1406-0.17188%200.15625h-2.0312l1.0625-5.4219%200.14062-0.14062%200.625-0.046875v-0.375z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22g%22%3E%3Cpath%20d%3D%22m0%201h5v13.742h-5z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22f%22%3E%3Cpath%20d%3D%22m24%201h4v13.742h-4z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%20clip-path%3D%22url%28%23g%29%22%3E%3Cg%3E%3Cuse%20x%3D%220.1%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%225.512%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23c%22/%3E%3Cuse%20x%3D%2215.58%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23b%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23f%29%22%3E%3Cg%3E%3Cuse%20x%3D%2223.237%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23d%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2229.367%22%20y%3D%226.546%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/svg%3E"/>
to get Euclidean.</p>
<p>Also be careful about the normalization: the integrals are
assumed to use loop integration measure of <img alt="d^d l/(i\pi^{d/2})" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2269.559pt%22%20height%3D%2215.633pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2069.559%2015.633%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22j%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.5312-10.125-2.0938%200.39062v0.39062l1.2031%200.14062-0.48438%202.75c-0.35938-0.17188-0.71875-0.23438-1.0938-0.23438-1.1406%200-2.3594%200.6875-3.0938%201.8594-0.45312%200.70312-0.67188%201.5469-0.67188%202.4844%200%201.5781%200.6875%202.4688%201.7969%202.4688%200.73438%200%201.4688-0.42188%202.1406-1.2812-0.015625%200.09375-0.015625%200.1875-0.015625%200.28125%200%200.67188%200.29688%200.96875%200.92188%200.96875%200.35938%200%200.9375-0.125%201.7031-0.39062v-0.42188c-0.42188%200.09375-0.71875%200.15625-0.89062%200.15625-0.42188%200-0.60938-0.1875-0.60938-0.57812%200-0.1875%200.03125-0.4375%200.078125-0.75l1.4688-8.2344zm-2.2188%204.0156%200.65625%200.78125-0.625%203.5c-0.60938%200.78125-1.25%201.1719-1.75%201.1719-0.71875%200-1.1875-0.60938-1.1875-1.7031%200-2.2969%201.3281-3.7969%202.5781-3.7969%200.09375%200%200.20312%200.03125%200.32812%200.046875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22i%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m2.9219-10.125-2.0938%200.40625v0.35938l1.2188%200.14062-1.3125%206.7344c-0.17188%200.85938-0.25%201.3906-0.25%201.5938%200%200.6875%200.32812%201.0156%201%201.0156%200.42188%200%201.0469-0.14062%201.8281-0.46875v-0.42188c-0.40625%200.125-0.73438%200.21875-0.96875%200.21875-0.5%200-0.76562-0.21875-0.76562-0.65625%200-0.1875%200.046875-0.5625%200.15625-1.1094l1.3906-6.9219c0.015625-0.078125%200.0625-0.39062%200.17188-0.89062z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22h%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m2.7656-9.6875c-0.40625%200-0.73438%200.32812-0.73438%200.73438%200%200.4375%200.32812%200.75%200.73438%200.75s0.75-0.32812%200.75-0.75c0-0.39062-0.34375-0.73438-0.75-0.73438zm-0.28125%203.0469-2.0312%200.45312v0.34375l1.1094%200.21875-0.8125%204.0938c-0.046875%200.3125-0.078125%200.54688-0.078125%200.71875%200%200.60938%200.29688%200.90625%200.89062%200.90625%200.51562%200%201.1719-0.15625%201.9375-0.48438v-0.42188c-0.4375%200.14062-0.76562%200.20312-1.0156%200.20312-0.4375%200-0.67188-0.17188-0.67188-0.53125%200-0.078125%200.015625-0.1875%200.046875-0.34375l0.98438-5.1562z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.5469-7.0312-1.4688%200.26562v0.26562l0.84375%200.10938-0.34375%201.9062c-0.25-0.10938-0.5-0.15625-0.75-0.15625-0.79688%200-1.6406%200.46875-2.1562%201.2812-0.3125%200.48438-0.46875%201.0781-0.46875%201.7344%200%201.0938%200.48438%201.7188%201.25%201.7188%200.5%200%201.0312-0.29688%201.4844-0.89062v0.1875c0%200.46875%200.20312%200.67188%200.64062%200.67188%200.25%200%200.65625-0.078125%201.1719-0.26562v-0.29688c-0.28125%200.0625-0.5%200.10938-0.625%200.10938-0.28125%200-0.42188-0.14062-0.42188-0.40625%200-0.125%200.03125-0.29688%200.0625-0.51562l1.0312-5.7188zm-1.5469%202.7812%200.45312%200.54688-0.4375%202.4375c-0.42188%200.53125-0.85938%200.8125-1.2188%200.8125-0.5%200-0.82812-0.42188-0.82812-1.1875%200-1.5938%200.9375-2.6406%201.7969-2.6406%200.0625%200%200.14062%200.03125%200.23438%200.03125z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22g%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.1719-10.516h-0.875l-4.5312%2013.109h0.875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22f%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.0469-5.6406h0.46875c-0.10938%200.76562-0.21875%201.5312-0.35938%202.2969-0.1875%200.85938-0.59375%201.7188-1.2188%202.4531-0.14062%200.14062-0.1875%200.3125-0.1875%200.48438%200%200.28125%200.20312%200.53125%200.54688%200.53125%200.32812%200%200.60938-0.29688%200.70312-0.64062%200.23438-0.9375%200.46875-1.8906%200.6875-2.8281l0.53125-2.2969h2.2344l-0.35938%202.2969c-0.10938%200.625-0.1875%201.2812-0.1875%201.8438%200%200.92188%200.23438%201.625%201.1094%201.625%200.75%200%201.4062-0.70312%201.5625-1.5l-0.53125-0.14062c-0.078125%200.34375-0.45312%200.59375-0.8125%200.59375-0.59375%200-0.78125-0.45312-0.78125-1.0625%200-0.40625%200.078125-0.90625%200.1875-1.3594l0.51562-2.2969h1.6719l0.20312-1.0469h-5.7812c-0.875%200-1.5938%201.3281-2.1875%202.4062-0.03125%200.0625-0.046875%200.09375-0.046875%200.14062%200%200.125%200.09375%200.20312%200.21875%200.20312%200.09375%200%200.1875-0.046875%200.25-0.17188%200.42188-0.6875%200.82812-1.5312%201.5625-1.5312z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.2812-7.3125h-0.59375l-3.1562%209.1094h0.60938z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.3438-0.75c2.125-1.6875%203.2812-2.7656%203.2812-3.9688%200-1.0781-0.76562-1.8125-2-1.8125-1.1875%200-2.0156%200.67188-2.0156%201.3438%200%200.32812%200.1875%200.54688%200.53125%200.54688%200.15625%200%200.29688-0.046875%200.42188-0.15625v-1.0156c0.29688-0.15625%200.5625-0.23438%200.85938-0.23438%200.79688%200%201.2656%200.53125%201.2656%201.4531%200%201.25-1.1875%202.2969-3.2812%203.9844v0.60938h4.4219v-1.5625h-0.42188l-0.17188%200.8125z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22m%22%3E%3Cpath%20d%3D%22m21%202h6v13.633h-6z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22l%22%3E%3Cpath%20d%3D%22m28%202h4v13.633h-4z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22k%22%3E%3Cpath%20d%3D%22m64%202h5v13.633h-5z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%3E%3Cuse%20x%3D%220.444%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23j%22/%3E%3Cuse%20x%3D%228.919%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23a%22/%3E%3Cuse%20x%3D%2215.481%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23i%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23m%29%22%3E%3Cg%3E%3Cuse%20x%3D%2220.301%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23g%22/%3E%3C/g%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23l%29%22%3E%3Cg%3E%3Cuse%20x%3D%2227.27%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2233.027%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23h%22/%3E%3Cuse%20x%3D%2237.668%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23f%22/%3E%3Cuse%20x%3D%2247.672%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23a%22/%3E%3Cuse%20x%3D%2253.391%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23c%22/%3E%3Cuse%20x%3D%2258.231%22%20y%3D%227.435%22%20xlink%3Ahref%3D%22%23b%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23k%29%22%3E%3Cg%3E%3Cuse%20x%3D%2264.047%22%20y%3D%2212.93%22%20xlink%3Ahref%3D%22%23d%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"/>,
which is not the physical <img alt="d^d l/(2\pi)^d" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2262.073pt%22%20height%3D%2215.318pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2062.073%2015.318%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22h%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.5312-10.125-2.0938%200.39062v0.39062l1.2031%200.14062-0.48438%202.75c-0.35938-0.17188-0.71875-0.23438-1.0938-0.23438-1.1406%200-2.3594%200.6875-3.0938%201.8594-0.45312%200.70312-0.67188%201.5469-0.67188%202.4844%200%201.5781%200.6875%202.4688%201.7969%202.4688%200.73438%200%201.4688-0.42188%202.1406-1.2812-0.015625%200.09375-0.015625%200.1875-0.015625%200.28125%200%200.67188%200.29688%200.96875%200.92188%200.96875%200.35938%200%200.9375-0.125%201.7031-0.39062v-0.42188c-0.42188%200.09375-0.71875%200.15625-0.89062%200.15625-0.42188%200-0.60938-0.1875-0.60938-0.57812%200-0.1875%200.03125-0.4375%200.078125-0.75l1.4688-8.2344zm-2.2188%204.0156%200.65625%200.78125-0.625%203.5c-0.60938%200.78125-1.25%201.1719-1.75%201.1719-0.71875%200-1.1875-0.60938-1.1875-1.7031%200-2.2969%201.3281-3.7969%202.5781-3.7969%200.09375%200%200.20312%200.03125%200.32812%200.046875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22g%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m2.9219-10.125-2.0938%200.40625v0.35938l1.2188%200.14062-1.3125%206.7344c-0.17188%200.85938-0.25%201.3906-0.25%201.5938%200%200.6875%200.32812%201.0156%201%201.0156%200.42188%200%201.0469-0.14062%201.8281-0.46875v-0.42188c-0.40625%200.125-0.73438%200.21875-0.96875%200.21875-0.5%200-0.76562-0.21875-0.76562-0.65625%200-0.1875%200.046875-0.5625%200.15625-1.1094l1.3906-6.9219c0.015625-0.078125%200.0625-0.39062%200.17188-0.89062z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.5469-7.0312-1.4688%200.26562v0.26562l0.84375%200.10938-0.34375%201.9062c-0.25-0.10938-0.5-0.15625-0.75-0.15625-0.79688%200-1.6406%200.46875-2.1562%201.2812-0.3125%200.48438-0.46875%201.0781-0.46875%201.7344%200%201.0938%200.48438%201.7188%201.25%201.7188%200.5%200%201.0312-0.29688%201.4844-0.89062v0.1875c0%200.46875%200.20312%200.67188%200.64062%200.67188%200.25%200%200.65625-0.078125%201.1719-0.26562v-0.29688c-0.28125%200.0625-0.5%200.10938-0.625%200.10938-0.28125%200-0.42188-0.14062-0.42188-0.40625%200-0.125%200.03125-0.29688%200.0625-0.51562l1.0312-5.7188zm-1.5469%202.7812%200.45312%200.54688-0.4375%202.4375c-0.42188%200.53125-0.85938%200.8125-1.2188%200.8125-0.5%200-0.82812-0.42188-0.82812-1.1875%200-1.5938%200.9375-2.6406%201.7969-2.6406%200.0625%200%200.14062%200.03125%200.23438%200.03125z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22f%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.1719-10.516h-0.875l-4.5312%2013.109h0.875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.0469-5.6406h0.46875c-0.10938%200.76562-0.21875%201.5312-0.35938%202.2969-0.1875%200.85938-0.59375%201.7188-1.2188%202.4531-0.14062%200.14062-0.1875%200.3125-0.1875%200.48438%200%200.28125%200.20312%200.53125%200.54688%200.53125%200.32812%200%200.60938-0.29688%200.70312-0.64062%200.23438-0.9375%200.46875-1.8906%200.6875-2.8281l0.53125-2.2969h2.2344l-0.35938%202.2969c-0.10938%200.625-0.1875%201.2812-0.1875%201.8438%200%200.92188%200.23438%201.625%201.1094%201.625%200.75%200%201.4062-0.70312%201.5625-1.5l-0.53125-0.14062c-0.078125%200.34375-0.45312%200.59375-0.8125%200.59375-0.59375%200-0.78125-0.45312-0.78125-1.0625%200-0.40625%200.078125-0.90625%200.1875-1.3594l0.51562-2.2969h1.6719l0.20312-1.0469h-5.7812c-0.875%200-1.5938%201.3281-2.1875%202.4062-0.03125%200.0625-0.046875%200.09375-0.046875%200.14062%200%200.125%200.09375%200.20312%200.21875%200.20312%200.09375%200%200.1875-0.046875%200.25-0.17188%200.42188-0.6875%200.82812-1.5312%201.5625-1.5312z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-1.0938c3.0469-2.4219%204.7188-3.9688%204.7188-5.7031%200-1.5625-1.0938-2.6094-2.875-2.6094-1.7031%200-2.9062%200.98438-2.9062%201.9375%200%200.46875%200.28125%200.78125%200.76562%200.78125%200.21875%200%200.42188-0.078125%200.60938-0.20312v-1.4844c0.42188-0.23438%200.8125-0.32812%201.2344-0.32812%201.1406%200%201.8281%200.78125%201.8281%202.0781%200%201.8125-1.7188%203.3125-4.7344%205.75v0.875h6.375v-2.25h-0.625l-0.25%201.1562z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22k%22%3E%3Cpath%20d%3D%22m21%202h6v13.316h-6z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22j%22%3E%3Cpath%20d%3D%22m28%202h4v13.316h-4z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22i%22%3E%3Cpath%20d%3D%22m50%202h5v13.316h-5z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%3E%3Cuse%20x%3D%220.444%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23h%22/%3E%3Cuse%20x%3D%228.919%22%20y%3D%227.12%22%20xlink%3Ahref%3D%22%23a%22/%3E%3Cuse%20x%3D%2215.481%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23g%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23k%29%22%3E%3Cg%3E%3Cuse%20x%3D%2220.301%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23f%22/%3E%3C/g%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23j%29%22%3E%3Cg%3E%3Cuse%20x%3D%2227.27%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23d%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2232.682%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23b%22/%3E%3Cuse%20x%3D%2240.34%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23i%29%22%3E%3Cg%3E%3Cuse%20x%3D%2250.105%22%20y%3D%2212.615%22%20xlink%3Ahref%3D%22%23c%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2255.756%22%20y%3D%227.12%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/svg%3E"/>. To obtain relations
between physically normalized integrals, multiply the result
of this function by <img alt="(4\pi)^L" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2234.903pt%22%20height%3D%2214.744pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2034.903%2014.744%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m5.0625-9.3125-4.6875%205.75v0.89062h4.4219v3.1875h1.0625v-3.1875h1.5625v-0.89062h-1.5625v-5.75zm-0.26562%201.5v4.25h-3.3906z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.0469-5.6406h0.46875c-0.10938%200.76562-0.21875%201.5312-0.35938%202.2969-0.1875%200.85938-0.59375%201.7188-1.2188%202.4531-0.14062%200.14062-0.1875%200.3125-0.1875%200.48438%200%200.28125%200.20312%200.53125%200.54688%200.53125%200.32812%200%200.60938-0.29688%200.70312-0.64062%200.23438-0.9375%200.46875-1.8906%200.6875-2.8281l0.53125-2.2969h2.2344l-0.35938%202.2969c-0.10938%200.625-0.1875%201.2812-0.1875%201.8438%200%200.92188%200.23438%201.625%201.1094%201.625%200.75%200%201.4062-0.70312%201.5625-1.5l-0.53125-0.14062c-0.078125%200.34375-0.45312%200.59375-0.8125%200.59375-0.59375%200-0.78125-0.45312-0.78125-1.0625%200-0.40625%200.078125-0.90625%200.1875-1.3594l0.51562-2.2969h1.6719l0.20312-1.0469h-5.7812c-0.875%200-1.5938%201.3281-2.1875%202.4062-0.03125%200.0625-0.046875%200.09375-0.046875%200.14062%200%200.125%200.09375%200.20312%200.21875%200.20312%200.09375%200%200.1875-0.046875%200.25-0.17188%200.42188-0.6875%200.82812-1.5312%201.5625-1.5312z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m0.79688-6.4219v0.375l0.625%200.046875%200.09375%200.14062-1.0156%205.3125-0.15625%200.14062-0.60938%200.046875v0.35938h4.2656l0.32812-1.7344h-0.45312l-0.375%201.1406-0.17188%200.15625h-2.0312l1.0625-5.4219%200.14062-0.14062%200.625-0.046875v-0.375z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22g%22%3E%3Cpath%20d%3D%22m0%201h5v13.742h-5z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22f%22%3E%3Cpath%20d%3D%22m23%201h5v13.742h-5z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%20clip-path%3D%22url%28%23g%29%22%3E%3Cg%3E%3Cuse%20x%3D%220.1%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%225.512%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23c%22/%3E%3Cuse%20x%3D%2213.17%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23b%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23f%29%22%3E%3Cg%3E%3Cuse%20x%3D%2222.934%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23d%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2229.064%22%20y%3D%226.546%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/svg%3E"/>.</p>
<p>Finally, you might want to cleanup the output of this function
using <a href="#ZeroSectors">ZeroSectors</a>, because some of the integrals will come
out to be scaleless.</p>
<pre><a class="tnv" href="#RaisingDRR">RaisingDRR</a>[<span class="tnt">ex_</span>, <span class="tnt">basis_Association</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">loopmom</span>, <span class="tnvc">i</span>, <span class="tnvc">j</span>, <span class="tnvc">k</span>, <span class="tnvc">mx</span>, <span class="tnvc">op</span>, <span class="tnvc">OP</span>, <span class="tnvc">bid</span>, <span class="tnvc">ii</span>, <span class="tnvc">n</span>, <span class="tnvc">idx</span>, <span class="tnvc">result</span>},
  <span class="tnvc">loopmom</span> = <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>];
  <span class="tnvc">mx</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">i</span>===<span class="tnvc">j</span>, <span class="tl">1</span>, <span class="tl">1</span>/<span class="tl">2</span>]
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Sum.html" rel="nofollow">Sum</a>[
      <span class="tnvc">OP</span>[<span class="tnvc">k</span>] <a class="tnb" href="https://reference.wolfram.com/language/ref/D.html" rel="nofollow">D</a>[
        <span class="tnv">basis</span>[<span class="ts">"denominators"</span>][[<span class="tnvc">k</span>]] // <span class="tnv">DenToNumerator</span> // <span class="tnv">ExpandSP</span>,
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnvc">loopmom</span>[[<span class="tnvc">i</span>]], <span class="tnvc">loopmom</span>[[<span class="tnvc">j</span>]]]]
      ],
      {<span class="tnvc">k</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>[<span class="ts">"denominators"</span>]]}]
    ,
    {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">loopmom</span>]},
    {<span class="tnvc">j</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">loopmom</span>]}];
  <span class="tnvc">op</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Det.html" rel="nofollow">Det</a>[<span class="tnvc">mx</span>] // <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_OP</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Factor.html" rel="nofollow">Factor</a>]&amp;;
  <span class="tnvc">bid</span> = <span class="tnv">basis</span>[<span class="ts">"id"</span>];
  <span class="tnvc">result</span> = <span class="tnvc">op</span> * <span class="tnv">ex</span> // <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_B</span>|<span class="tnt">_OP</span>, <span class="tnv">#</span>&amp;, <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceRepeated.html" rel="nofollow">ReplaceRepeated</a>[<span class="tnv">#</span>,
    <span class="tnvc">OP</span>[<span class="tnt">n_</span>]^<span class="tnt">k_</span>. <span class="tnv">B</span>[<span class="tnvc">bid</span>, <span class="tnt">idx__</span>] :&gt; (<span class="tnvc">ii</span> = {<span class="tnvc">idx</span>}; <span class="tnvc">ii</span>[[<span class="tnvc">n</span>]] += <span class="tnvc">k</span>; <a class="tnb" href="https://reference.wolfram.com/language/ref/Pochhammer.html" rel="nofollow">Pochhammer</a>[<span class="tnvc">ii</span>[[<span class="tnvc">n</span>]]-<span class="tnvc">k</span>,<span class="tnvc">k</span>] <span class="tnv">B</span>[<span class="tnvc">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>@@<span class="tnvc">ii</span>])
  ]&amp;]&amp;;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<span class="tnvc">result</span>, <span class="tnt">_OP</span>], <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Failed to replace all OPs"</span>]];
  (-<span class="tl">1</span>)^<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">loopmom</span>] <span class="tnvc">result</span>
]</pre>
<h3 id="LoweringDRR"><code>LoweringDRR[]</code></h3>
<p>“Lowering” dimensional recurrence: expresses a given integral
in <img alt="d+2" style="vertical-align:-0.369561767578125pt" src="data:image/svg+xml,%3Csvg%20width%3D%2231.628pt%22%20height%3D%2210.577pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2031.628%2010.577%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m6.5312-10.125-2.0938%200.39062v0.39062l1.2031%200.14062-0.48438%202.75c-0.35938-0.17188-0.71875-0.23438-1.0938-0.23438-1.1406%200-2.3594%200.6875-3.0938%201.8594-0.45312%200.70312-0.67188%201.5469-0.67188%202.4844%200%201.5781%200.6875%202.4688%201.7969%202.4688%200.73438%200%201.4688-0.42188%202.1406-1.2812-0.015625%200.09375-0.015625%200.1875-0.015625%200.28125%200%200.67188%200.29688%200.96875%200.92188%200.96875%200.35938%200%200.9375-0.125%201.7031-0.39062v-0.42188c-0.42188%200.09375-0.71875%200.15625-0.89062%200.15625-0.42188%200-0.60938-0.1875-0.60938-0.57812%200-0.1875%200.03125-0.4375%200.078125-0.75l1.4688-8.2344zm-2.2188%204.0156%200.65625%200.78125-0.625%203.5c-0.60938%200.78125-1.25%201.1719-1.75%201.1719-0.71875%200-1.1875-0.60938-1.1875-1.7031%200-2.2969%201.3281-3.7969%202.5781-3.7969%200.09375%200%200.20312%200.03125%200.32812%200.046875z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.5938-3.5469v3.8281h0.82812v-3.8281h3.8281v-0.82812h-3.8281v-3.8281h-0.82812v3.8281h-3.8281v0.82812z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-1.0938c3.0469-2.4219%204.7188-3.9688%204.7188-5.7031%200-1.5625-1.0938-2.6094-2.875-2.6094-1.7031%200-2.9062%200.98438-2.9062%201.9375%200%200.46875%200.28125%200.78125%200.76562%200.78125%200.21875%200%200.42188-0.078125%200.60938-0.20312v-1.4844c0.42188-0.23438%200.8125-0.32812%201.2344-0.32812%201.1406%200%201.8281%200.78125%201.8281%202.0781%200%201.8125-1.7188%203.3125-4.7344%205.75v0.875h6.375v-2.25h-0.625l-0.25%201.1562z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22f%22%3E%3Cpath%20d%3D%22m0%200h8v10.578h-8z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22e%22%3E%3Cpath%20d%3D%22m12%202h9v8.5781h-9z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22d%22%3E%3Cpath%20d%3D%22m24%200h7v10.578h-7z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%3E%3Cg%20clip-path%3D%22url%28%23f%29%22%3E%3Cg%3E%3Cuse%20x%3D%220.444%22%20y%3D%2210.209%22%20xlink%3Ahref%3D%22%23c%22/%3E%3C/g%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23e%29%22%3E%3Cg%3E%3Cuse%20x%3D%2211.241%22%20y%3D%2210.209%22%20xlink%3Ahref%3D%22%23b%22/%3E%3C/g%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23d%29%22%3E%3Cg%3E%3Cuse%20x%3D%2223.871%22%20y%3D%2210.209%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/svg%3E"/> space-time dimensions as a linear combination of
integrals in d space-time dimensions.</p>
<p>Note that Minkowski metrics is assumed. Multiply by <img alt="(-1)^L" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2235.206pt%22%20height%3D%2214.744pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2035.206%2014.744%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m0.32812-3.5469h9.3594v-0.82812h-9.3594z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m4.2812-9.4062-2.9844%200.90625v0.57812l2.1562-0.39062v7.4062l-0.15625%200.23438-1.5938%200.078125v0.59375h4.6094v-0.57812l-1.4844-0.0625-0.15625-0.21875v-8.5469z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m0.79688-6.4219v0.375l0.625%200.046875%200.09375%200.14062-1.0156%205.3125-0.15625%200.14062-0.60938%200.046875v0.35938h4.2656l0.32812-1.7344h-0.45312l-0.375%201.1406-0.17188%200.15625h-2.0312l1.0625-5.4219%200.14062-0.14062%200.625-0.046875v-0.375z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22g%22%3E%3Cpath%20d%3D%22m0%201h5v13.742h-5z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22f%22%3E%3Cpath%20d%3D%22m24%201h4v13.742h-4z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%20clip-path%3D%22url%28%23g%29%22%3E%3Cg%3E%3Cuse%20x%3D%220.1%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%225.512%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23c%22/%3E%3Cuse%20x%3D%2215.58%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23b%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23f%29%22%3E%3Cg%3E%3Cuse%20x%3D%2223.237%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23d%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2229.367%22%20y%3D%226.546%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/svg%3E"/>
to get Euclidean.</p>
<p>Same normalization issue as in <a href="#RaisingDRR">RaisingDRR</a>; divide by <img alt="(4\pi)^L" style="vertical-align:-2.7127471923828126pt" src="data:image/svg+xml,%3Csvg%20width%3D%2234.903pt%22%20height%3D%2214.744pt%22%20version%3D%221.1%22%20viewBox%3D%220%200%2034.903%2014.744%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%3E%3Cdefs%3E%3Csymbol%20id%3D%22e%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m1.9375-3.9688c0-3.7656%201.1094-5.6406%202.6875-5.9219v-0.625c-2.2812%200.28125-3.8594%202.3906-3.8594%206.5469s1.5781%206.2812%203.8594%206.5625v-0.64062c-1.5781-0.28125-2.6875-2.1406-2.6875-5.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22d%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.4531-3.9688c0%203.7812-1.0938%205.6406-2.6875%205.9219v0.64062c2.2969-0.28125%203.8594-2.4062%203.8594-6.5625s-1.5625-6.2656-3.8594-6.5469v0.625c1.5938%200.28125%202.6875%202.1562%202.6875%205.9219z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22c%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m5.0625-9.3125-4.6875%205.75v0.89062h4.4219v3.1875h1.0625v-3.1875h1.5625v-0.89062h-1.5625v-5.75zm-0.26562%201.5v4.25h-3.3906z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22b%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m3.0469-5.6406h0.46875c-0.10938%200.76562-0.21875%201.5312-0.35938%202.2969-0.1875%200.85938-0.59375%201.7188-1.2188%202.4531-0.14062%200.14062-0.1875%200.3125-0.1875%200.48438%200%200.28125%200.20312%200.53125%200.54688%200.53125%200.32812%200%200.60938-0.29688%200.70312-0.64062%200.23438-0.9375%200.46875-1.8906%200.6875-2.8281l0.53125-2.2969h2.2344l-0.35938%202.2969c-0.10938%200.625-0.1875%201.2812-0.1875%201.8438%200%200.92188%200.23438%201.625%201.1094%201.625%200.75%200%201.4062-0.70312%201.5625-1.5l-0.53125-0.14062c-0.078125%200.34375-0.45312%200.59375-0.8125%200.59375-0.59375%200-0.78125-0.45312-0.78125-1.0625%200-0.40625%200.078125-0.90625%200.1875-1.3594l0.51562-2.2969h1.6719l0.20312-1.0469h-5.7812c-0.875%200-1.5938%201.3281-2.1875%202.4062-0.03125%200.0625-0.046875%200.09375-0.046875%200.14062%200%200.125%200.09375%200.20312%200.21875%200.20312%200.09375%200%200.1875-0.046875%200.25-0.17188%200.42188-0.6875%200.82812-1.5312%201.5625-1.5312z%22/%3E%3C/symbol%3E%3Csymbol%20id%3D%22a%22%20overflow%3D%22visible%22%3E%3Cpath%20d%3D%22m0.79688-6.4219v0.375l0.625%200.046875%200.09375%200.14062-1.0156%205.3125-0.15625%200.14062-0.60938%200.046875v0.35938h4.2656l0.32812-1.7344h-0.45312l-0.375%201.1406-0.17188%200.15625h-2.0312l1.0625-5.4219%200.14062-0.14062%200.625-0.046875v-0.375z%22/%3E%3C/symbol%3E%3CclipPath%20id%3D%22g%22%3E%3Cpath%20d%3D%22m0%201h5v13.742h-5z%22/%3E%3C/clipPath%3E%3CclipPath%20id%3D%22f%22%3E%3Cpath%20d%3D%22m23%201h5v13.742h-5z%22/%3E%3C/clipPath%3E%3C/defs%3E%3Cg%20clip-path%3D%22url%28%23g%29%22%3E%3Cg%3E%3Cuse%20x%3D%220.1%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23e%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%225.512%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23c%22/%3E%3Cuse%20x%3D%2213.17%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23b%22/%3E%3C/g%3E%3Cg%20clip-path%3D%22url%28%23f%29%22%3E%3Cg%3E%3Cuse%20x%3D%2222.934%22%20y%3D%2212.041%22%20xlink%3Ahref%3D%22%23d%22/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3Cuse%20x%3D%2229.064%22%20y%3D%226.546%22%20xlink%3Ahref%3D%22%23a%22/%3E%3C/g%3E%3C/svg%3E"/>
to get the relation between physically normalized integrals.</p>
<pre><a class="tnv" href="#LoweringDRR">LoweringDRR</a>[<span class="tnt">ex_</span>, <span class="tnt">basis_Association</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">extmom</span>, <span class="tnvc">loopmom</span>, <span class="tnvc">op</span>, <span class="tnvc">OP</span>, <span class="tnvc">i</span>, <span class="tnvc">k</span>, <span class="tnvc">n</span>, <span class="tnvc">bid</span>, <span class="tnvc">ii</span>, <span class="tnvc">idx</span>, <span class="tnvc">result</span>},
  <span class="tnvc">extmom</span> = <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>];
  <span class="tnvc">loopmom</span> = <span class="tnv">basis</span>[<span class="ts">"loopmom"</span>];
  <span class="tnvc">op</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Det.html" rel="nofollow">Det</a>[<a class="tnv" href="#GramMatrix">GramMatrix</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnvc">loopmom</span>, <span class="tnvc">extmom</span>]] /. <span class="tnv">basis</span>[<span class="ts">"sprules"</span>]] /.
    <span class="tnv">basis</span>[<span class="ts">"nummap"</span>] /.
    <span class="tnv">basis</span>[<span class="ts">"sprules"</span>] /.
    <span class="tnv">DEN</span>[<span class="tnt">n_</span>] :&gt; <span class="tl">1</span>/<span class="tnvc">OP</span>[<span class="tnvc">n</span>] //
    <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_B</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Together.html" rel="nofollow">Together</a>]&amp;;
  <span class="tnvc">bid</span> = <span class="tnv">basis</span>[<span class="ts">"id"</span>];
  <span class="tnvc">result</span> = <span class="tnvc">op</span> * <span class="tnv">ex</span> // <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_B</span>|<span class="tnt">_OP</span>, <span class="tnv">#</span>&amp;, <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceRepeated.html" rel="nofollow">ReplaceRepeated</a>[<span class="tnv">#</span>,
    <span class="tnvc">OP</span>[<span class="tnt">n_</span>]^<span class="tnt">k_</span>. <span class="tnv">B</span>[<span class="tnvc">bid</span>, <span class="tnt">idx__</span>] :&gt; (<span class="tnvc">ii</span> = {<span class="tnvc">idx</span>}; <span class="tnvc">ii</span>[[<span class="tnvc">n</span>]] -= <span class="tnvc">k</span>; <span class="tnv">B</span>[<span class="tnvc">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>@@<span class="tnvc">ii</span>])
  ]&amp;]&amp;;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<span class="tnvc">result</span>, <span class="tnt">_OP</span>], <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Failed to replace all As"</span>]];
  (
    (-<span class="tl">2</span>)^<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">loopmom</span>]
    <span class="tl">1</span>/<a class="tnb" href="https://reference.wolfram.com/language/ref/Det.html" rel="nofollow">Det</a>[<a class="tnv" href="#GramMatrix">GramMatrix</a>[<span class="tnvc">extmom</span>] /. <span class="tnv">basis</span>[<span class="ts">"sprules"</span>]]
    <span class="tl">1</span>/<a class="tnb" href="https://reference.wolfram.com/language/ref/Pochhammer.html" rel="nofollow">Pochhammer</a>[<span class="tnv">d</span>-<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">extmom</span>]-<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">loopmom</span>]+<span class="tl">1</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">loopmom</span>]]
    <span class="tnvc">result</span>
  )
]</pre>
<h2 id="IntegralDifferentiation">Integral differentiation</h2>
<h3 id="BasisExternalInvariantSymbols"><code>BasisExternalInvariantSymbols[]</code></h3>
<p>All symbols on the right-hand side of scalar product rules.
Presumably names of Mandelstam variables and the like.</p>
<pre><a class="tnv" href="#BasisExternalInvariantSymbols">BasisExternalInvariantSymbols</a>[<span class="tnt">basis_Association</span>] := <span class="tnv">basis</span>[[<span class="ts">"sprules"</span>,;;,<span class="tl">2</span>]] // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_Symbol</span>]</pre>
<h3 id="BasisExternalScalarProducts"><code>BasisExternalScalarProducts[]</code></h3>
<p>All distinct <code>sp[p1, p2]</code>, for <code>p1</code> and <code>p2</code> being external
momenta of a basis.</p>
<pre><a class="tnv" href="#BasisExternalScalarProducts">BasisExternalScalarProducts</a>[<span class="tnt">basis_Association</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">p1</span>, <span class="tnvc">p2</span>},
  <span class="tnv">splist</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnvc">p1</span>,<span class="tnvc">p2</span>]],
    {<span class="tnvc">p1</span>, <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>]},
    {<span class="tnvc">p2</span>, <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>]}
  ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>
]</pre>
<h3 id="GramMatrix"><code>GramMatrix[]</code></h3>
<p>Gram matrix, <code>|pi * pj|</code>, for a given list of <code>pi</code>.</p>
<pre><a class="tnv" href="#GramMatrix">GramMatrix</a>[<span class="tnt">vectors_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">p</span>,<span class="tnvc">q</span>}, <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnvc">p</span>,<span class="tnvc">q</span>]], {<span class="tnvc">p</span>, <span class="tnv">vectors</span>}, {<span class="tnvc">q</span>, <span class="tnv">vectors</span>}]]</pre>
<h3 id="BasisGramMatrix"><code>BasisGramMatrix[]</code></h3>
<p>Gram matrix, <code>|pi * pj|</code>, for a given basis.</p>
<pre><a class="tnv" href="#BasisGramMatrix">BasisGramMatrix</a>[<span class="tnt">basis_Association</span>] := <a class="tnv" href="#GramMatrix">GramMatrix</a>[<span class="tnv">basis</span>[<span class="ts">"externalmom"</span>]] /. <span class="tnv">basis</span>[<span class="ts">"sprules"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Together.html" rel="nofollow">Together</a></pre>
<h3 id="BasisInvGramMatrix"><code>BasisInvGramMatrix[]</code></h3>
<p>The inverse of Gram matrix for a given basis.</p>
<pre><a class="tnv" href="#BasisInvGramMatrix">BasisInvGramMatrix</a>[<span class="tnt">basis_Association</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Inverse.html" rel="nofollow">Inverse</a>[<a class="tnv" href="#BasisGramMatrix">BasisGramMatrix</a>[<span class="tnv">basis</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Together.html" rel="nofollow">Together</a></pre>
<h3 id="BasisInvGramMatrixMap"><code>BasisInvGramMatrixMap[]</code></h3>
<p>The inverse of Gram matrix for a given basis, represented
as a nested Association. This is so it could be indexed by
momenta as <code>BasisInvGramMatrixMap[basis][p1,p2]</code>.</p>
<pre><a class="tnv" href="#BasisInvGramMatrixMap">BasisInvGramMatrixMap</a>[<span class="tnt">basis_Association</span>] := <a class="tnv" href="#BasisInvGramMatrixMap">BasisInvGramMatrixMap</a>[<span class="tnv">basis</span>] = <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">igm</span>, <span class="tnvc">emom</span>, <span class="tnvc">i</span>, <span class="tnvc">j</span>},
  <span class="tnvc">igm</span> = <a class="tnv" href="#BasisInvGramMatrix">BasisInvGramMatrix</a>[<span class="tnv">basis</span>];
  <span class="tnvc">emom</span> = <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <span class="tnvc">emom</span>[[<span class="tnvc">i</span>]] -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>[
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="tnvc">emom</span>[[<span class="tnvc">j</span>]] -&gt; <span class="tnvc">igm</span>[[<span class="tnvc">i</span>,<span class="tnvc">j</span>]], {<span class="tnvc">j</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">emom</span>]}]
    ]
    ,
    {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">emom</span>]}
  ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>
]

<a class="tnb" href="https://reference.wolfram.com/language/ref/ClearAll.html" rel="nofollow">ClearAll</a>[<span class="tnv">BDiffByMomentum</span>, <span class="tnv">BDiffByMass</span>, <span class="tnv">BDiffBySP</span>, <span class="tnv">BDiffByInv</span>, <a class="tnv" href="#BDiff">BDiff</a>];
<span class="tnv">BDiffByMomentum</span>[<span class="tnt">basis_Association</span>, <span class="tnt">indices_List</span>, <span class="tnt">p_Symbol</span>, <span class="tnt">pmul_Symbol</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">dens</span>, <span class="tnvc">ddens</span>},
  <span class="tnvc">dens</span> = {<span class="tnv">basis</span>[<span class="ts">"denominators"</span>], <span class="tnv">indices</span>} // <a class="tnb" href="https://reference.wolfram.com/language/ref/Transpose.html" rel="nofollow">Transpose</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[{_, <span class="tl">0</span>}];
  <span class="tnvc">ddens</span> = <span class="tnvc">dens</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
    {<span class="tnv">d</span>:<span class="tnv">den</span>[<span class="tnt">mom_</span>, ___], <span class="tnt">n_</span>} :&gt; -<span class="tnv">n</span> <span class="tnv">d</span>^(<span class="tnv">n</span>+<span class="tl">1</span>) <span class="tl">2</span> <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnv">mom</span>, <span class="tnv">pmul</span>]] <a class="tnb" href="https://reference.wolfram.com/language/ref/D.html" rel="nofollow">D</a>[<span class="tnv">mom</span>, <span class="tnv">p</span>]
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Sum.html" rel="nofollow">Sum</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Product.html" rel="nofollow">Product</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">i</span> === <span class="tnv">k</span>, <span class="tnvc">ddens</span>[[<span class="tnv">i</span>]], <span class="tnvc">dens</span>[[<span class="tnv">i</span>,<span class="tl">1</span>]]^<span class="tnvc">dens</span>[[<span class="tnv">i</span>,<span class="tl">2</span>]]], {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]}]
    ,
    {<span class="tnv">k</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]}]
]
<span class="tnv">BDiffByMass</span>[<span class="tnt">basis_Association</span>, <span class="tnt">indices_List</span>, <span class="tnt">mass_Symbol</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">dens</span>, <span class="tnvc">ddens</span>},
  <span class="tnvc">dens</span> = {<span class="tnv">basis</span>[<span class="ts">"denominators"</span>], <span class="tnv">indices</span>} // <a class="tnb" href="https://reference.wolfram.com/language/ref/Transpose.html" rel="nofollow">Transpose</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[{_, <span class="tl">0</span>}];
  <span class="tnvc">ddens</span> = <span class="tnvc">dens</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
    {<span class="tnv">d</span>:<span class="tnv">den</span>[<span class="tnt">mom_</span>], <span class="tnt">n_</span>} :&gt; -<span class="tnv">n</span> <span class="tnv">d</span>^(<span class="tnv">n</span>+<span class="tl">1</span>) <a class="tnb" href="https://reference.wolfram.com/language/ref/D.html" rel="nofollow">D</a>[<span class="tnv">ExpandSP</span>[<span class="tnv">sp</span>[<span class="tnv">mom</span>, <span class="tnv">mom</span>]], <span class="tnv">mass</span>]<span class="tl">0</span>,
    {<span class="tnv">d</span>:<span class="tnv">den</span>[<span class="tnt">mom_</span>, <span class="tnt">m_</span>, ___], <span class="tnt">n_</span>} :&gt; -<span class="tnv">n</span> <span class="tnv">d</span>^(<span class="tnv">n</span>+<span class="tl">1</span>) <a class="tnb" href="https://reference.wolfram.com/language/ref/D.html" rel="nofollow">D</a>[<span class="tnv">ExpandSP</span>[<span class="tnv">sp</span>[<span class="tnv">mom</span>, <span class="tnv">mom</span>]]-<span class="tnv">m</span>, <span class="tnv">mass</span>]
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Sum.html" rel="nofollow">Sum</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Product.html" rel="nofollow">Product</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">i</span> === <span class="tnv">k</span>, <span class="tnvc">ddens</span>[[<span class="tnv">i</span>]], <span class="tnvc">dens</span>[[<span class="tnv">i</span>,<span class="tl">1</span>]]^<span class="tnvc">dens</span>[[<span class="tnv">i</span>,<span class="tl">2</span>]]], {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]}]
    ,
    {<span class="tnv">k</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]}]//<a class="tnv" href="#ToB">ToB</a>[<span class="tnv">basis</span>]
]
<span class="tnv">BDiffBySP</span>[<span class="tnt">basis_Association</span>, <span class="tnt">indices_List</span>, <span class="tnv">s</span>:<span class="tnv">sp</span>[<span class="tnt">p1_Symbol</span>, <span class="tnt">p1_Symbol</span>]] := <span class="tnv">BDiffBySP</span>[<span class="tnv">basis</span>, <span class="tnv">indices</span>, <span class="tnv">s</span>] =
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">igm</span>, <span class="tnvc">pi</span>},
  <span class="tnvc">igm</span> = <a class="tnv" href="#BasisInvGramMatrixMap">BasisInvGramMatrixMap</a>[<span class="tnv">basis</span>];
  <span class="tl">1</span>/<span class="tl">2</span> <a class="tnb" href="https://reference.wolfram.com/language/ref/Sum.html" rel="nofollow">Sum</a>[<span class="tnvc">igm</span>[<span class="tnvc">pi</span>,<span class="tnv">p1</span>] <span class="tnv">BDiffByMomentum</span>[<span class="tnv">basis</span>, <span class="tnv">indices</span>, <span class="tnv">p1</span>, <span class="tnvc">pi</span>], {<span class="tnvc">pi</span>, <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>]}]//<a class="tnv" href="#ToB">ToB</a>[<span class="tnv">basis</span>]
]
<span class="tnv">BDiffBySP</span>[<span class="tnt">basis_Association</span>, <span class="tnt">indices_List</span>, <span class="tnv">s</span>:<span class="tnv">sp</span>[<span class="tnt">p1_Symbol</span>, <span class="tnt">p2_Symbol</span>]] := <span class="tnv">BDiffBySP</span>[<span class="tnv">basis</span>, <span class="tnv">indices</span>, <span class="tnv">s</span>] =
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">igm</span>, <span class="tnvc">pi</span>},
  <span class="tnvc">igm</span> = <a class="tnv" href="#BasisInvGramMatrixMap">BasisInvGramMatrixMap</a>[<span class="tnv">basis</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Sum.html" rel="nofollow">Sum</a>[<span class="tnvc">igm</span>[<span class="tnvc">pi</span>,<span class="tnv">p2</span>] <span class="tnv">BDiffByMomentum</span>[<span class="tnv">basis</span>, <span class="tnv">indices</span>, <span class="tnv">p1</span>, <span class="tnvc">pi</span>], {<span class="tnvc">pi</span>, <span class="tnv">basis</span>[<span class="ts">"externalmom"</span>]}]//<a class="tnv" href="#ToB">ToB</a>[<span class="tnv">basis</span>]
]
<span class="tnv">BDiffByInv</span>[<span class="tnt">basis_Association</span>, <span class="tnt">indices_List</span>, <span class="tnt">inv_Symbol</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">invlist</span>, <span class="tnvc">splist</span>, <span class="tnvc">ds</span>, <span class="tnvc">s</span>},
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>[<span class="ts">"denominators"</span>]] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">indices</span>]];
  <span class="tnvc">invlist</span> = <a class="tnv" href="#BasisExternalInvariantSymbols">BasisExternalInvariantSymbols</a>[<span class="tnv">basis</span>];
  <span class="tnvc">splist</span> = <a class="tnv" href="#BasisExternalScalarProducts">BasisExternalScalarProducts</a>[<span class="tnv">basis</span>];
  (<span class="tnv">BDiffByMass</span>[<span class="tnv">basis</span>, <span class="tnv">indices</span>, <span class="tnv">inv</span>]) + <a class="tnb" href="https://reference.wolfram.com/language/ref/Sum.html" rel="nofollow">Sum</a>[
    <span class="tnvc">ds</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/D.html" rel="nofollow">D</a>[<span class="tnvc">s</span>/.<span class="tnv">basis</span>[<span class="ts">"sprules"</span>], <span class="tnv">inv</span>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">ds</span> === <span class="tl">0</span>, <span class="tl">0</span>, <span class="tnvc">ds</span>*<span class="tnv">BDiffBySP</span>[<span class="tnv">basis</span>, <span class="tnv">indices</span>, <span class="tnvc">s</span>]],
    {<span class="tnvc">s</span>, <span class="tnvc">splist</span>}]
]</pre>
<h3 id="BDiff"><code>BDiff[]</code></h3>
<p>Diffferentiate an integral in the <code>B</code> notation by a scalar
product of external momenta, or an invariant of the basis.</p>
<pre><a class="tnv" href="#BDiff">BDiff</a>[<span class="tnt">ex_</span>, <span class="tnt">basis_Association</span>, <span class="tnt">s_sp</span>] := <span class="tnv">ex</span> /. <span class="tnv">B</span>[<span class="tnv">basis</span>[<span class="ts">"id"</span>], <span class="tnt">idx__</span>] :&gt; <span class="tnv">BDiffBySP</span>[<span class="tnv">basis</span>, {<span class="tnv">idx</span>}, <span class="tnv">s</span>]
<a class="tnv" href="#BDiff">BDiff</a>[<span class="tnt">ex_</span>, <span class="tnt">basis_Association</span>, <span class="tnt">inv_Symbol</span>] := <span class="tnv">ex</span> /. <span class="tnv">B</span>[<span class="tnv">basis</span>[<span class="ts">"id"</span>], <span class="tnt">idx__</span>] :&gt; <span class="tnv">BDiffByInv</span>[<span class="tnv">basis</span>, {<span class="tnv">idx</span>}, <span class="tnv">inv</span>]
<a class="tnv" href="#BDiff">BDiff</a>[<span class="tnt">basis_Association</span>, <span class="tnt">inv_Symbol</span>] := <a class="tnv" href="#BDiff">BDiff</a>[<span class="tnv">#</span>, <span class="tnv">basis</span>, <span class="tnv">inv</span>]&amp;</pre>
<h2 id="Amplitudes">Amplitudes</h2>
<pre><a class="tnb" href="https://reference.wolfram.com/language/ref/ClearAll.html" rel="nofollow">ClearAll</a>[<a class="tnv" href="#Amplitude">Amplitude</a>];</pre>
<h3 id="Amplitude"><code>Amplitude[]</code></h3>
<p>Convert a diagram into an amplitude.</p>
<p>Only the default cases are here; all actual Feynman rules are
supplied by the model files.</p>
<pre><a class="tnv" href="#Amplitude">Amplitude</a>[
  <span class="tnv">dia</span>:<span class="tnv">Diagram</span>[<span class="tnt">id_</span>, <span class="tnt">factor_</span>, <span class="tnt">ifields_List</span>, <span class="tnt">ofields_List</span>, <span class="tnt">propagators_List</span>, <span class="tnt">vertices_List</span>]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a>[{
    <span class="tnv">factor</span>,
    <span class="tnv">propagators</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#Amplitude">Amplitude</a>],
    <span class="tnv">vertices</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#Amplitude">Amplitude</a>]
  }] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>]
<a class="tnv" href="#Amplitude">Amplitude</a>[<span class="tnv">P</span>[<span class="tnt">field_</span>, <span class="tnt">fi1_</span>, <span class="tnt">fi2_</span>, _, _, <span class="tnt">p_</span>]] :=
  <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"No Feynman rules for the propagator of "</span>, <span class="tnv">field</span>]
<a class="tnv" href="#Amplitude">Amplitude</a>[<span class="tnv">V</span>[_, <span class="tnt">fields_</span>, ___]] :=
  <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"No Feynman rules for the vertex "</span>, <span class="tnv">fields</span>]
<a class="tnv" href="#Amplitude">Amplitude</a>[<span class="tnt">x__</span>] := <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Don't know an amplitude for: "</span>, <span class="tnv">x</span>]

<a class="tnb" href="https://reference.wolfram.com/language/ref/ClearAll.html" rel="nofollow">ClearAll</a>[<a class="tnv" href="#CutAmplitudeGlue">CutAmplitudeGlue</a>];</pre>
<h3 id="CutAmplitudeGlue"><code>CutAmplitudeGlue[]</code></h3>
<p>Take two diagrams with the same final states and return an
amplitude factor (i.e. delta functions) that join the outgoing
fields.
Only the default cases are here; all actual Feynman rules are
supplied by the model files.</p>
<pre><a class="tnv" href="#CutAmplitudeGlue">CutAmplitudeGlue</a>[<span class="tnt">f1_</span>, <span class="tnt">f2_</span>] := <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Can't connect these cut lines: "</span>, <span class="tnv">f1</span>, <span class="ts">" and "</span>, <span class="tnv">f2</span>]
<a class="tnv" href="#CutAmplitudeGlue">CutAmplitudeGlue</a>[
  <span class="tnv">dia1</span>:<span class="tnv">Diagram</span>[<span class="tnt">id1_</span>, <span class="tnt">factor1_</span>, <span class="tnt">ifields1_List</span>, <span class="tnt">ofields1_List</span>, <span class="tnt">propagators1_List</span>, <span class="tnt">vertices1_List</span>],
  <span class="tnv">dia2</span>:<span class="tnv">Diagram</span>[<span class="tnt">id2_</span>, <span class="tnt">factor2_</span>, <span class="tnt">ifields2_List</span>, <span class="tnt">ofields2_List</span>, <span class="tnt">propagators2_List</span>, <span class="tnt">vertices2_List</span>]
] := (
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<span class="tnv">ofields1</span>[[;;,<span class="tl">1</span>]] === <span class="tnv">ofields2</span>[[;;,<span class="tl">1</span>]]];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnv" href="#CutAmplitudeGlue">CutAmplitudeGlue</a>, {<span class="tnv">ofields1</span>, <span class="tnv">ofields2</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>]
)</pre>
<h3 id="DiagramFinalStateSum"><code>DiagramFinalStateSum[]</code></h3>
<p>Compute the sum over the final state particle states (i.e.
the spin sum and the polarization sum) of a product of two
diagrams, the second being complex-conjugated.</p>
<pre><a class="tnv" href="#DiagramFinalStateSum">DiagramFinalStateSum</a>[
  <span class="tnv">dia1</span>:<span class="tnv">Diagram</span>[<span class="tnt">id1_</span>, <span class="tnt">factor1_</span>, <span class="tnt">ifields1_List</span>, <span class="tnt">ofields1_List</span>, <span class="tnt">propagators1_List</span>, <span class="tnt">vertices1_List</span>],
  <span class="tnv">dia2</span>:<span class="tnv">Diagram</span>[<span class="tnt">id2_</span>, <span class="tnt">factor2_</span>, <span class="tnt">ifields2_List</span>, <span class="tnt">ofields2_List</span>, <span class="tnt">propagators2_List</span>, <span class="tnt">vertices2_List</span>]
] := (
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<span class="tnv">ofields1</span>[[;;,<span class="tl">1</span>]] === <span class="tnv">ofields2</span>[[;;,<span class="tl">1</span>]]];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnv" href="#CutAmplitudeGlue">CutAmplitudeGlue</a>, {<span class="tnv">ofields1</span>, <span class="tnv">ofields2</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>]
)
</pre>
  </body>
</html>
