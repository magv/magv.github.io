<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <title>Amplitude library (library.m)</title>
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
 </head>
 <body>
</pre>
<h1 id="AmplitudeLibraryLibraryM">Amplitude library (<code>library.m</code>)</h1>
<p>Misc utils</p>
<h3 id="SeriesDropTerms"><code>SeriesDropTerms[]</code></h3>
<p>Remove terms from a series that are not free of a given pattern.</p>
<pre><a class="tnv" href="#SeriesDropTerms">SeriesDropTerms</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/HoldPattern.html" rel="nofollow">HoldPattern</a>[<span class="tnv">s</span> : <a class="tnb" href="https://reference.wolfram.com/language/ref/SeriesData.html" rel="nofollow">SeriesData</a>[<span class="tnt">x_</span>, <span class="tnt">x0_</span>, <span class="tnt">items_List</span>, <span class="tnt">n1_</span>, <span class="tnt">n2_</span>, <span class="tnt">d_</span>]], <span class="tnt">pattern_</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">idx</span>, <span class="tnvc">nterms</span>},
  <span class="tnvc">idx</span> = <span class="tnv">items</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/FreeQ.html" rel="nofollow">FreeQ</a>[<span class="tnv">#1</span>, <span class="tnv">pattern</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>, <span class="tnv">#2</span>[[<span class="tl">1</span>]]] &amp;];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">idx</span> === {},
    <span class="tnv">s</span>,
    <span class="tnvc">nterms</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Min.html" rel="nofollow">Min</a>[<span class="tnvc">idx</span>] - <span class="tl">1</span>;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/SeriesData.html" rel="nofollow">SeriesData</a>[<span class="tnv">x</span>, <span class="tnv">x0</span>, <span class="tnv">items</span>[[;; <span class="tnvc">nterms</span>]], <span class="tnv">n1</span>, <span class="tnv">n1</span> + <span class="tnvc">nterms</span>, <span class="tnv">d</span>]
  ]
]
<a class="tnv" href="#SeriesDropTerms">SeriesDropTerms</a>[<span class="tnt">l_List</span>, <span class="tnt">pattern_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#SeriesDropTerms">SeriesDropTerms</a>[<span class="tnv">#</span>, <span class="tnv">pattern</span>] &amp;, <span class="tnv">l</span>]
<a class="tnv" href="#SeriesDropTerms">SeriesDropTerms</a>[<span class="tnt">pattern_</span>] := <a class="tnv" href="#SeriesDropTerms">SeriesDropTerms</a>[<span class="tnv">#</span>, <span class="tnv">pattern</span>] &amp;</pre>
<h3 id="Runx"><code>Runx[]</code></h3>
<p>Run a (shell) command, print its output into the GUI.</p>
<pre><a class="tnv" href="#Runx">Runx</a>[<span class="tnt">command__</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">file</span>, <span class="tnvc">s</span>},
  <span class="tnvc">file</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/OpenRead.html" rel="nofollow">OpenRead</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"!"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[{<span class="tnv">command</span>}, <span class="ts">" "</span>]]];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/While.html" rel="nofollow">While</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>,
    <span class="tnvc">s</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/ReadString.html" rel="nofollow">ReadString</a>[<span class="tnvc">file</span>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">s</span> === <a class="tnb" href="https://reference.wolfram.com/language/ref/EndOfFile.html" rel="nofollow">EndOfFile</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Break.html" rel="nofollow">Break</a>[]];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="tnvc">s</span>];
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Close.html" rel="nofollow">Close</a>[<span class="tnvc">file</span>];
]</pre>
<h3 id="FasterFactor"><code>FasterFactor[]</code></h3>
<p>Factor out an overall prefactor; faster than the full Factor.</p>
<pre><a class="tnv" href="#FasterFactor">FasterFactor</a>[<span class="tnt">ex_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#FasterFactor">FasterFactor</a>, <span class="tnv">ex</span>]
<a class="tnv" href="#FasterFactor">FasterFactor</a>[<span class="tnt">ex_Times</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="#FasterFactor">FasterFactor</a>, <span class="tnv">ex</span>]
<a class="tnv" href="#FasterFactor">FasterFactor</a>[<span class="tnt">ex_</span>^<span class="tnt">n_</span>] := <a class="tnv" href="#FasterFactor">FasterFactor</a>[<span class="tnv">ex</span>]^<span class="tnv">n</span>
<a class="tnv" href="#FasterFactor">FasterFactor</a>[<span class="tnt">ex_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">gcd</span>, <span class="tnvc">terms</span>},
  <span class="tnvc">terms</span> = <span class="tnv">ex</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a> // <a class="tnv" href="utils.html#Terms">Terms</a>;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">terms</span>] === <span class="tl">0</span>,
   <span class="tl">0</span>
   ,
   <span class="tnvc">gcd</span> = <span class="tnvc">terms</span>[[<span class="tl">1</span>]];
   <span class="tnvc">terms</span>[[<span class="tl">2</span> ;;]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[(<span class="tnvc">gcd</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/PolynomialGCD.html" rel="nofollow">PolynomialGCD</a>[<span class="tnv">#</span>, <span class="tnvc">gcd</span>];) &amp;];
   <span class="tnvc">terms</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span>/<span class="tnvc">gcd</span> &amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>] // <span class="tnv">#</span>*<span class="tnvc">gcd</span> &amp;
   ]
  ]</pre>
<h3 id="FastMatrixRank"><code>FastMatrixRank[]</code></h3>
<p>Determine the rank of a matrix using modular arithmetics, fast.</p>
<pre><a class="tnv" href="#FastMatrixRank">FastMatrixRank</a>[<span class="tnt">mx_</span>] := <a class="tnv" href="#FastMatrixRank">FastMatrixRank</a>[<span class="tnv">mx</span>, <span class="tnv">mx</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_Symbol</span>]]
<a class="tnv" href="#FastMatrixRank">FastMatrixRank</a>[<span class="tnt">mx_</span>, <span class="tnt">vars_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">mnx</span>},
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <span class="tnv">mxn</span> = <span class="tnv">mx</span> /. <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>, {<span class="tnv">vars</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/RandomInteger.html" rel="nofollow">RandomInteger</a>[{<span class="tl">2</span>^<span class="tl">20</span>, <span class="tl">2</span>^<span class="tl">30</span>}, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">vars</span>]]}]];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/MatrixRank.html" rel="nofollow">MatrixRank</a>[<span class="tnv">mxn</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Modulus.html" rel="nofollow">Modulus</a>-&gt;<a class="tnb" href="https://reference.wolfram.com/language/ref/RandomPrime.html" rel="nofollow">RandomPrime</a>[{<span class="tl">2</span>^<span class="tl">30</span>, <span class="tl">2</span>^<span class="tl">31</span>-<span class="tl">1</span>}]]
    ,
    <span class="tl">5</span>
  ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>
];</pre>
<h3 id="SelectAnyBasis"><code>SelectAnyBasis[]</code></h3>
<p>Given a list of vectors, select a linearly independent subset,
return the indices of the vectors in it.</p>
<pre><a class="tnv" href="#SelectAnyBasis">SelectAnyBasis</a>[<span class="tnt">vectors_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">vars</span>, <span class="tnvc">dim</span>, <span class="tnvc">basisidx</span>, <span class="tnvc">basis</span>, <span class="tnvc">i</span>, <span class="tnvc">newbasis</span>, <span class="tnvc">rank</span>},
  <span class="tnvc">vars</span> = <span class="tnvc">basis</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_Symbol</span>];
  <span class="tnvc">dim</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">vectors</span>[[<span class="tl">1</span>]]];
  <span class="tnvc">basis</span> = {};
  <span class="tnvc">basisidx</span> = {};
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="tnvc">i</span>];
    <span class="tnvc">newbasis</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnvc">basis</span>, <span class="tnv">vectors</span>[[<span class="tnvc">i</span>]]];
    <span class="tnvc">rank</span> = <a class="tnv" href="#FastMatrixRank">FastMatrixRank</a>[<span class="tnvc">newbasis</span>, <span class="tnvc">vars</span>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">rank</span> =!= <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">newbasis</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Continue.html" rel="nofollow">Continue</a>[]];
    <span class="tnvc">basis</span> = <span class="tnvc">newbasis</span>;
    <span class="tnvc">basisidx</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnvc">basisidx</span>, <span class="tnvc">i</span>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">rank</span> === <span class="tnvc">dim</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Break.html" rel="nofollow">Break</a>[]];
    ,
    {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">vectors</span>]}];
  <span class="tnvc">basisidx</span>
]</pre>
<p>XGraphs</p>
<pre><a class="tnb" href="https://reference.wolfram.com/language/ref/Needs.html" rel="nofollow">Needs</a>[<span class="ts">"GraphUtilities`"</span>];
<span class="tnv">XGraph</span>[<span class="tnt">edgelist_List</span>] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">Edge</span>, <span class="tnvc">edges</span> = {}, <span class="tnvc">styles</span> = {}, <span class="tnvc">e</span>, <span class="tnvc">x</span>, <span class="tnvc">edge</span>, <span class="tnvc">label</span>, <span class="tnvc">opt</span>},
  <span class="tnvc">Edge</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<span class="tnt">a_</span>, <span class="tnt">b_</span>]] := <span class="tnv">a</span> <span class="tnv">\[DirectedEdge]</span> <span class="tnv">b</span>;
  <span class="tnvc">Edge</span>[<span class="tnvc">e</span> : <a class="tnb" href="https://reference.wolfram.com/language/ref/DirectedEdge.html" rel="nofollow">DirectedEdge</a>[<span class="tnt">a_</span>, <span class="tnt">b_</span>]] := <span class="tnvc">e</span>;
  <span class="tnvc">Edge</span>[<span class="tnvc">e</span> : <a class="tnb" href="https://reference.wolfram.com/language/ref/UndirectedEdge.html" rel="nofollow">UndirectedEdge</a>[<span class="tnt">a_</span>, <span class="tnt">b_</span>]] := <span class="tnvc">e</span>;
  <span class="tnvc">Edge</span>[<span class="tnt">e_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Throw.html" rel="nofollow">Throw</a>[{<span class="ts">"Not an edge:"</span>, <span class="tnvc">e</span>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">e</span>, {{<span class="tnt">x_</span>, <span class="tnt">style___</span>} :&gt; (<span class="tnvc">edge</span> = <span class="tnvc">Edge</span>[<span class="tnvc">x</span>];
        <a class="tnb" href="https://reference.wolfram.com/language/ref/AppendTo.html" rel="nofollow">AppendTo</a>[<span class="tnvc">edges</span>, <span class="tnvc">edge</span>];
        <a class="tnb" href="https://reference.wolfram.com/language/ref/AppendTo.html" rel="nofollow">AppendTo</a>[<span class="tnvc">styles</span>, <span class="tnvc">edge</span> -&gt; {<span class="tnv">style</span>}];), <span class="tnt">x_</span> :&gt; (<span class="tnvc">edge</span> = <span class="tnvc">Edge</span>[<span class="tnvc">x</span>];
        <a class="tnb" href="https://reference.wolfram.com/language/ref/AppendTo.html" rel="nofollow">AppendTo</a>[<span class="tnvc">edges</span>, <span class="tnvc">edge</span>];
        <a class="tnb" href="https://reference.wolfram.com/language/ref/AppendTo.html" rel="nofollow">AppendTo</a>[<span class="tnvc">styles</span>, <span class="tnvc">edge</span> -&gt; {}];)}];, {<span class="tnvc">e</span>, <span class="tnv">edgelist</span>}];
  <span class="tnv">XGraph</span>[<span class="tnvc">edges</span>,
   <a class="tnb" href="https://reference.wolfram.com/language/ref/GatherBy.html" rel="nofollow">GatherBy</a>[<span class="tnvc">styles</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span>[[<span class="tl">1</span>, <span class="tl">1</span>]] -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span>[[<span class="tl">2</span>]] &amp;, <span class="tnv">#</span>] &amp;]]]
<a class="tnb" href="https://reference.wolfram.com/language/ref/MakeBoxes.html" rel="nofollow">MakeBoxes</a>[<span class="tnv">expr</span> : <span class="tnv">XGraph</span>[<span class="tnt">edges_List</span>, <span class="tnt">opt_List</span>],
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StandardForm.html" rel="nofollow">StandardForm</a> | <a class="tnb" href="https://reference.wolfram.com/language/ref/TraditionalForm.html" rel="nofollow">TraditionalForm</a>] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/Block.html" rel="nofollow">Block</a>[{<span class="tnvc">counter</span>, <span class="tnvc">e</span>}, <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[<span class="tnvc">counter</span>[<span class="tnvc">e</span>] = <span class="tl">1</span>, {<span class="tnvc">e</span>, <span class="tnv">edges</span>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/ToBoxes.html" rel="nofollow">ToBoxes</a>[
   <a class="tnb" href="https://reference.wolfram.com/language/ref/Interpretation.html" rel="nofollow">Interpretation</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Graph.html" rel="nofollow">Graph</a>[<span class="tnv">edges</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/ImageSize.html" rel="nofollow">ImageSize</a> -&gt; <span class="tl">300</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/GraphLayout.html" rel="nofollow">GraphLayout</a> -&gt; <span class="ts">"SpringEmbedding"</span>,
     <a class="tnb" href="https://reference.wolfram.com/language/ref/EdgeShapeFunction.html" rel="nofollow">EdgeShapeFunction</a> -&gt;(<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">style</span>, <span class="tnvc">c</span>, <span class="tnvc">s</span>, <span class="tnvc">x</span>, <span class="tnvc">i</span>},
         <span class="tnvc">c</span> = ++<span class="tnv">counter</span>[<span class="tnv">#2</span>];
         <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">c</span> &gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">#2</span> /. <span class="tnv">opt</span>], <span class="tnv">counter</span>[<span class="tnv">#2</span>] = <span class="tnvc">c</span> = <span class="tl">1</span>];
         <span class="tnvc">style</span> = (<span class="tnv">#2</span> /. <span class="tnv">opt</span>)[[<span class="tnvc">c</span>]];
         <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">s</span>, {
             <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<span class="tnt">x_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<span class="tnvc">x</span>, <span class="tnv">LineScaledCoordinate</span>[<span class="tnv">#1</span>, <span class="tl">0.5</span>]],
             <span class="tnv">Dots</span>[<span class="tnt">x_</span>] :&gt;
              <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<a class="tnb" href="https://reference.wolfram.com/language/ref/Black.html" rel="nofollow">Black</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Opacity.html" rel="nofollow">Opacity</a>[<span class="tl">1.0</span>],
                <a class="tnb" href="https://reference.wolfram.com/language/ref/Disk.html" rel="nofollow">Disk</a>[<span class="tnv">LineScaledCoordinate</span>[<span class="tnv">#1</span>, <span class="tnvc">i</span>/(<span class="tnvc">x</span> + <span class="tl">1</span>) // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a>],
                 <span class="tl">0.05</span>]}, {<span class="tnvc">i</span>, <span class="tnvc">x</span>}]
             }], {<span class="tnvc">s</span>, <span class="tnvc">style</span>}], <a class="tnb" href="https://reference.wolfram.com/language/ref/Arrow.html" rel="nofollow">Arrow</a>@<span class="tnv">#1</span>]] &amp;)], <span class="tnv">expr</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/StandardForm.html" rel="nofollow">StandardForm</a>]]</pre>
<p>Amplitudes &amp; Feynman Rules</p>
<pre><span class="tnv">AmpConjugateMomenta</span>[<span class="tnt">ex_</span>] := <span class="tnv">ex</span> \
  /. <span class="tnv">l1</span> -&gt; <span class="tnv">r1</span> /. <span class="tnv">l2</span> -&gt; <span class="tnv">r2</span> /. <span class="tnv">l3</span> -&gt; <span class="tnv">r3</span> /. <span class="tnv">l4</span> -&gt; <span class="tnv">r4</span> /. <span class="tnv">l5</span> -&gt; <span class="tnv">r5</span> \
  /. <span class="tnv">l6</span> -&gt; <span class="tnv">r6</span> /. <span class="tnv">l7</span> -&gt; <span class="tnv">r7</span> /. <span class="tnv">l8</span> -&gt; <span class="tnv">r8</span> /. <span class="tnv">l9</span> -&gt; <span class="tnv">r9</span> /. <span class="tnv">l10</span> -&gt; <span class="tnv">r10</span>
<span class="tnv">AmpConjugate</span>[<span class="tnt">ex_</span>] := (<span class="tnv">ex</span>
  <span class="tc">(*
  (* Spin indices *must* all be internal, because there is a
   * gammachain[spinor, spn[-1], X[-1]] at each external line of
   * fermions: here spn[-1] must be renamed, and X[-1] mustn’t.
   *)
  /. (idx : spn)[i_] :&gt; idx[2000 + i]
  (* The rest of the indices are external if negative, and
   * internal otherwise.
   *)
  /. (idx : flv | lor | fun | adj)[i_] :&gt; idx[If[TrueQ[i &gt;= 0], 5000 + i, i]]
  *)</span>
  /. (<span class="tnv">idx</span> : <span class="tnv">flv</span> | <span class="tnv">lor</span> | <span class="tnv">fun</span> | <span class="tnv">adj</span> | <span class="tnv">spn</span>)[<span class="tnt">i_</span>] :&gt; <span class="tnv">idx</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/TrueQ.html" rel="nofollow">TrueQ</a>[<span class="tnv">i</span> &lt; <span class="tl">0</span>], -<span class="tl">5000</span> + <span class="tnv">i</span>, <span class="tl">5000</span> + <span class="tnv">i</span>]]
  /. <a class="tnb" href="https://reference.wolfram.com/language/ref/Complex.html" rel="nofollow">Complex</a>[<span class="tnt">re_</span>, <span class="tnt">im_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Complex.html" rel="nofollow">Complex</a>[<span class="tnv">re</span>, -<span class="tnv">im</span>]
  /. (<span class="tnv">chain</span> : <span class="tnv">gammachain</span> | <span class="tnv">colorT</span>)[<span class="tnt">m___</span>, <span class="tnt">i_</span>, <span class="tnt">j_</span>] :&gt; <span class="tnv">chain</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a> @@ <a class="tnb" href="https://reference.wolfram.com/language/ref/Reverse.html" rel="nofollow">Reverse</a>[{<span class="tnv">m</span>}], <span class="tnv">j</span>, <span class="tnv">i</span>]
  // <span class="tnv">AmpConjugateMomenta</span>)
<span class="tnv">FormatAmp</span>[<span class="tnt">ex_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceRepeated.html" rel="nofollow">ReplaceRepeated</a>[<span class="tnv">ex</span>, {
   <span class="tnv">delta</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"\[Delta]"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<span class="tnv">a</span>, <span class="tnv">b</span>}]],
   <span class="tnv">deltaf</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"\[Delta]"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<span class="tnv">a</span>, <span class="tnv">b</span>}]],
   <span class="tnv">lor</span>[<span class="tnt">n__</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"\[Mu]"</span>, <span class="tnv">n</span>],
   <span class="tnv">adj</span>[<span class="tnt">n__</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"a"</span>, <span class="tnv">n</span>],
   <span class="tnv">fun</span>[<span class="tnt">n__</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"i"</span>, <span class="tnv">n</span>],
   <span class="tnv">flv</span>[<span class="tnt">n__</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"f"</span>, <span class="tnv">n</span>],
   <span class="tnv">spn</span>[<span class="tnt">n__</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"s"</span>, <span class="tnv">n</span>],
   <span class="tnv">momentum</span>[<span class="tnt">p_</span>, <span class="tnt">idx_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Superscript.html" rel="nofollow">Superscript</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/OverVector.html" rel="nofollow">OverVector</a>[<span class="tnv">p</span>], <span class="tnv">idx</span>],
   <span class="tnv">dot</span>[<span class="tnt">p1_</span>, <span class="tnt">p2_</span>] :&gt;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<span class="ts">"("</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OverVector.html" rel="nofollow">OverVector</a>[<span class="tnv">p1</span>], <span class="ts">"\[CenterDot]"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/OverVector.html" rel="nofollow">OverVector</a>[<span class="tnv">p2</span>], <span class="ts">")"</span>}],
   <span class="tnv">gammachain</span>[<span class="tnt">g___</span>, <span class="tnt">a_</span>, <span class="tnt">b_</span>] :&gt;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<span class="ts">"("</span>, <span class="tnv">g</span>, <span class="ts">")"</span>}], <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<span class="tnv">a</span>, <span class="tnv">b</span>}]],
   <span class="tnv">gammatrace</span>[<span class="tnt">g___</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<span class="ts">"Tr("</span>, <span class="tnv">g</span>, <span class="ts">")"</span>}],
   <span class="tnv">gamma</span>[<span class="tnt">mu_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Superscript.html" rel="nofollow">Superscript</a>[<span class="ts">"\[Gamma]"</span>, <span class="tnv">mu</span>],
   <span class="tnv">slash</span>[<span class="tnt">mom_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/OverVector.html" rel="nofollow">OverVector</a>[<span class="tnv">mom</span>],
   <span class="tnv">polarization</span>[<span class="tnt">p_</span>, <span class="tnt">idx_</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/I.html" rel="nofollow">I</a>] :&gt;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<a class="tnb" href="https://reference.wolfram.com/language/ref/Superscript.html" rel="nofollow">Superscript</a>[<span class="ts">"\[Epsilon]"</span>, <span class="tnv">idx</span>], <span class="ts">"("</span>, <span class="tnv">p</span>, <span class="ts">")"</span>}],
   <span class="tnv">polarization</span>[<span class="tnt">p_</span>, <span class="tnt">idx_</span>, -<a class="tnb" href="https://reference.wolfram.com/language/ref/I.html" rel="nofollow">I</a>] :&gt;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<a class="tnb" href="https://reference.wolfram.com/language/ref/Superscript.html" rel="nofollow">Superscript</a>[<span class="ts">"\[Epsilon]"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<span class="ts">"*"</span>, <span class="tnv">idx</span>}]], <span class="ts">"("</span>, <span class="tnv">p</span>, <span class="ts">")"</span>}],
   <span class="tnv">colorf</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>, <span class="tnt">c_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Superscript.html" rel="nofollow">Superscript</a>[<span class="ts">"f"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<span class="tnv">a</span>, <span class="tnv">b</span>, <span class="tnv">c</span>}]],
   <span class="tnv">colorT</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>, <span class="tnt">c_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subsuperscript.html" rel="nofollow">Subsuperscript</a>[<span class="ts">"T"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Row.html" rel="nofollow">Row</a>[{<span class="tnv">b</span>, <span class="tnv">c</span>}], <span class="tnv">a</span>],
   <span class="tnv">spinor</span>[<span class="tnt">p_</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/I.html" rel="nofollow">I</a>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Style.html" rel="nofollow">Style</a>[<span class="tnv">u</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Italic.html" rel="nofollow">Italic</a>][<span class="tnv">p</span>],
   <span class="tnv">spinor</span>[<span class="tnt">p_</span>, -<a class="tnb" href="https://reference.wolfram.com/language/ref/I.html" rel="nofollow">I</a>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/OverBar.html" rel="nofollow">OverBar</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Style.html" rel="nofollow">Style</a>[<span class="tnv">u</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Italic.html" rel="nofollow">Italic</a>]][<span class="tnv">p</span>],
   <span class="tnv">gs</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"g"</span>, <span class="ts">"s"</span>],
   <span class="tnv">p1</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"p"</span>, <span class="ts">"1"</span>], <span class="tnv">p2</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"p"</span>, <span class="ts">"2"</span>],
   <span class="tnv">p3</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"p"</span>, <span class="ts">"3"</span>], <span class="tnv">p4</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"p"</span>, <span class="ts">"4"</span>],
   <span class="tnv">q1</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"q"</span>, <span class="ts">"1"</span>], <span class="tnv">q2</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"q"</span>, <span class="ts">"2"</span>],
   <span class="tnv">q3</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"q"</span>, <span class="ts">"3"</span>], <span class="tnv">q4</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Subscript.html" rel="nofollow">Subscript</a>[<span class="ts">"q"</span>, <span class="ts">"4"</span>]
}]
<span class="tnv">PRAmp</span>[<span class="tnt">ex_</span>] := (<a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="tnv">ex</span> // <span class="tnv">FormatAmp</span>]; <span class="tnv">ex</span>)
<span class="tnv">deltaflv</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] := <span class="tnv">deltaf</span>[<span class="tnv">flv</span>[<span class="tnv">a</span>], <span class="tnv">flv</span>[<span class="tnv">b</span>]]
<span class="tnv">deltaflvt</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] := <span class="tnv">deltaft</span>[<span class="tnv">flv</span>[<span class="tnv">a</span>], <span class="tnv">flv</span>[<span class="tnv">b</span>]]
<span class="tnv">deltafun</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] := <span class="tnv">delta</span>[<span class="tnv">fun</span>[<span class="tnv">a</span>], <span class="tnv">fun</span>[<span class="tnv">b</span>]]
<span class="tnv">deltaadj</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] := <span class="tnv">delta</span>[<span class="tnv">adj</span>[<span class="tnv">a</span>], <span class="tnv">adj</span>[<span class="tnv">b</span>]]
<span class="tnv">deltalor</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] := <span class="tnv">delta</span>[<span class="tnv">lor</span>[<span class="tnv">a</span>], <span class="tnv">lor</span>[<span class="tnv">b</span>]]

<span class="tnv">AmpToForm</span>[<span class="tnt">expression_</span>] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnv">expression</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>] //
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringReplace.html" rel="nofollow">StringReplace</a>[{<span class="ts">"\""</span> -&gt; <span class="ts">""</span>, <span class="ts">" "</span> -&gt; <span class="ts">""</span>, <span class="ts">"["</span> -&gt; <span class="ts">"("</span>, <span class="ts">"]"</span> -&gt; <span class="ts">")"</span>}]
<span class="tnv">AmpFromForm</span>[<span class="tnt">expression_</span>] := <span class="tnv">expression</span>

<span class="tnv">AmpFormIndexMaps</span>[<span class="tnt">ex_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">original</span>, <span class="tnvc">renamed</span>, <span class="tnvc">i</span>, <span class="tnvc">mu</span>},
  <span class="tnvc">original</span> = <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">ex</span>, <span class="tnt">_lor</span> | <span class="tnt">_adj</span> | <span class="tnt">_fun</span> | <span class="tnt">_spn</span> | <span class="tnt">_X</span> | <span class="tnt">_flv</span>];
  <span class="tnvc">renamed</span> = <span class="tnvc">original</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[{
       <span class="tnvc">i</span> : (<span class="tnt">idx_</span>)[<span class="tnt">mu_</span>?<a class="tnb" href="https://reference.wolfram.com/language/ref/Negative.html" rel="nofollow">Negative</a>] :&gt;
        <a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnv">idx</span>] &lt;&gt; <span class="ts">"e"</span> &lt;&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[-<span class="tnvc">mu</span>]],
       <span class="tnvc">i</span> : (<span class="tnt">idx_</span>)[<span class="tnt">mu_</span>] :&gt;
        <a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnv">idx</span>] &lt;&gt; <span class="ts">"i"</span> &lt;&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/ToString.html" rel="nofollow">ToString</a>[<span class="tnvc">mu</span>]]
       }]];
  {<a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>, {<span class="tnvc">original</span>, <span class="tnvc">renamed</span>}]],
   <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>, {<span class="tnvc">renamed</span>, <span class="tnvc">original</span>}]]}
  ]

<span class="tnv">AmpSanityCheck</span>[<span class="tnt">ex_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">AmpSanityCheck</span>, <span class="tnv">ex</span>]
<span class="tnv">AmpSanityCheck</span>[<span class="tnt">ex_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">idx</span>, <span class="tnvc">termidx</span>},
  <span class="tnvc">idx</span> = <span class="tnv">ex</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_flv</span>|<span class="tnt">_lor</span>|<span class="tnt">_fun</span>|<span class="tnt">_adj</span>|<span class="tnt">_spn</span>];
  <span class="tnv">ex</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[(
    <span class="tnvc">termidx</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnv">#</span>, <span class="tnt">_flv</span>|<span class="tnt">_lor</span>|<span class="tnt">_fun</span>|<span class="tnt">_adj</span>|<span class="tnt">_spn</span>, -<span class="tl">1</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">#</span>&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">idx</span> =!= <a class="tnb" href="https://reference.wolfram.com/language/ref/Keys.html" rel="nofollow">Keys</a>[<span class="tnvc">termidx</span>],
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"Expected this set of indices: "</span>, <span class="tnvc">idx</span>];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"Got this set: "</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Keys.html" rel="nofollow">Keys</a>[<span class="tnvc">termidx</span>]];
      <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Mismatch in index set"</span>];
    ];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Values.html" rel="nofollow">Values</a>[<span class="tnvc">termidx</span>]] =!= {<span class="tl">2</span>},
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"* Summation notation fail:"</span>];
      <span class="tnvc">termidx</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[_-&gt;<span class="tl">2</span>] // <a class="tnv" href="utils.html#PrintIndexed">PrintIndexed</a>;
      <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Summation notation fail"</span>];
    ];
  )&amp;];
]</pre>
<h3 id="AmpHideFactorsFromMap"><code>AmpHideFactorsFromMap[]</code></h3>
<p>Remove factors that don’t have indices inside from each
expression in a list, apply f to the resulting list, put the
factors back in.</p>
<pre><a class="tnv" href="#AmpHideFactorsFromMap">AmpHideFactorsFromMap</a>[<span class="tnt">ex_List</span>, <span class="tnt">f_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">wheat</span>, <span class="tnvc">chaff</span>},
  {<span class="tnvc">wheat</span>, <span class="tnvc">chaff</span>} =
    <span class="tnv">ex</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[(<span class="tnv">#</span> // <a class="tnv" href="utils.html#Factors">Factors</a> //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/FreeQ.html" rel="nofollow">FreeQ</a>[<span class="tnv">#</span>, <span class="tnv">Xi</span> | <span class="tnt">_den</span> | <span class="tnt">_dot</span> | <span class="tnt">_sp</span> | <span class="tnt">_lor</span> | <span class="tnt">_adj</span> | <span class="tnt">_fun</span> | <span class="tnt">_spn</span> | <span class="tnt">_X</span> | <span class="tnt">_flv</span>] &amp;] //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Lookup.html" rel="nofollow">Lookup</a>[<span class="tnv">#</span>, {<a class="tnb" href="https://reference.wolfram.com/language/ref/False.html" rel="nofollow">False</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>}, {}] &amp; //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>]]) &amp;
      ] // {<span class="tnv">#</span>[[;;,<span class="tl">1</span>]], <span class="tnv">#</span>[[;;,<span class="tl">2</span>]]}&amp;;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"AmpHideFactorsFromMap: wheat/chaff is "</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/ByteCount.html" rel="nofollow">ByteCount</a>[<span class="tnvc">wheat</span>], <span class="ts">"/"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/ByteCount.html" rel="nofollow">ByteCount</a>[<span class="tnvc">chaff</span>]];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>, {<span class="tnv">f</span>[<span class="tnvc">wheat</span>], <span class="tnvc">chaff</span>}]
]
<a class="tnv" href="#AmpHideFactorsFromMap">AmpHideFactorsFromMap</a>[<span class="tnt">f_</span>] := <a class="tnv" href="#AmpHideFactorsFromMap">AmpHideFactorsFromMap</a>[<span class="tnv">#</span>, <span class="tnv">f</span>] &amp;
<span class="tnv">CutDiagramFlavorFactor</span>[<span class="tnv">CutDiagram</span>[<span class="tnt">d1_Diagram</span>, <span class="tnt">d2_Diagram</span>]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">a1</span>, <span class="tnvc">a2</span>},
  <span class="tnvc">a1</span> = <span class="tnv">d1</span> // <a class="tnv" href="alibrary.html#Amplitude">Amplitude</a>;
  <span class="tnvc">a2</span> = <span class="tnv">d2</span> // <a class="tnv" href="alibrary.html#Amplitude">Amplitude</a> // <span class="tnv">AmpConjugate</span>;
  <span class="tnvc">a1</span> <span class="tnvc">a2</span> /. <span class="tnv">flv</span>[-<span class="tl">2</span>] -&gt; <span class="tl">0</span> // <a class="tnv" href="#FasterFactor">FasterFactor</a> // <a class="tnv" href="utils.html#Factors">Factors</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<span class="tnt">_deltaf</span> | <span class="tnt">_chargeQ</span> | <span class="tnt">_chargeV</span> | <span class="tnt">_chargeA</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a> // <a class="tnv" href="alibrary.html#RunThroughForm">RunThroughForm</a>[<span class="tnv">FormCall</span>[<span class="ts">"flavorsum"</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>
]</pre>
<p>Graph canonization</p>
<pre><span class="tnv">StartDreadnaut</span>[] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[(<a class="tnb" href="https://reference.wolfram.com/language/ref/Head.html" rel="nofollow">Head</a>[<span class="tnv">$DREADNAUT</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Symbol.html" rel="nofollow">Symbol</a> || <a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ProcessStatus.html" rel="nofollow">ProcessStatus</a>[<span class="tnv">$DREADNAUT</span>, <span class="ts">"Running"</span>]]),
    <span class="tnv">$DREADNAUT</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/StartProcess.html" rel="nofollow">StartProcess</a>[<span class="ts">"dreadnaut"</span>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/WriteLine.html" rel="nofollow">WriteLine</a>[<span class="tnv">$DREADNAUT</span>, <span class="ts">"As l=0 $=1 c"</span>];
  ]
<span class="tnv">KillDreadnaut</span>[] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Head.html" rel="nofollow">Head</a>[<span class="tnv">$DREADNAUT</span>] =!= <a class="tnb" href="https://reference.wolfram.com/language/ref/Symbol.html" rel="nofollow">Symbol</a>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/KillProcess.html" rel="nofollow">KillProcess</a>[<span class="tnv">$DREADNAUT</span>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ClearAll.html" rel="nofollow">ClearAll</a>[<span class="tnv">$DREADNAUT</span>];
  ]</pre>
<h3 id="ColoredSimpleGraphToDreadnaut"><code>ColoredSimpleGraphToDreadnaut[]</code></h3>
<p>&quot;
No self-loops.
No double lines.
Vertex colors are integers that start at 0.
Edge colors are integers that start at 1.
&quot;</p>
<pre><a class="tnv" href="#ColoredSimpleGraphToDreadnaut">ColoredSimpleGraphToDreadnaut</a>[<span class="tnv">vertices</span> : {{_, _} ...}, <span class="tnv">edges</span> : {{_, _, _} ...}] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">nlayers</span>, <span class="tnvc">nvertices</span>, <span class="tnvc">vertex2idx</span>, <span class="tnvc">i</span>, <span class="tnvc">l</span>},
  <span class="tnvc">nvertices</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">vertices</span>];
  <span class="tnvc">nlayers</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/BitLength.html" rel="nofollow">BitLength</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Max.html" rel="nofollow">Max</a>[<span class="tnv">edges</span>[[;; , <span class="tl">3</span>]], <span class="tnv">vertices</span>[[;; , <span class="tl">2</span>]], <span class="tl">1</span>]];
  <span class="tnvc">vertex2idx</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>[<span class="tnv">#1</span>] -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>[<span class="tnv">#2</span>] &amp;, <span class="tnv">vertices</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>;
  <a class="tnv" href="utils.html#MkString">MkString</a>[
   <span class="ts">"As c n="</span>, <span class="tnvc">nlayers</span>*<span class="tnvc">nvertices</span> + <span class="tl">1</span>, <span class="ts">" $=0 g"</span>,
   <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="tc">(*inter-layer threads*)</span>
    {<span class="ts">" "</span>, <span class="tnvc">l</span> + <span class="tnvc">i</span>, <span class="ts">":"</span>, <span class="tnvc">l</span> + <span class="tnvc">i</span> + <span class="tnvc">nvertices</span>},
    {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">vertices</span>]}, {<span class="tnvc">l</span>, <span class="tl">0</span>, (<span class="tnvc">nlayers</span> - <span class="tl">2</span>) <span class="tnvc">nvertices</span>, <span class="tnvc">nvertices</span>}],
   <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="tc">(*vertex colors*)</span>
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/BitGet.html" rel="nofollow">BitGet</a>[<span class="tnv">vertices</span>[[<span class="tnvc">i</span>, <span class="tl">2</span>]], <span class="tnvc">l</span>] =!= <span class="tl">1</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>, {<span class="ts">" 0:"</span>, <span class="tnvc">i</span> + <span class="tnvc">l</span> <span class="tnvc">nvertices</span>}],
    {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">vertices</span>]}, {<span class="tnvc">l</span>, <span class="tl">0</span>, <span class="tnvc">nlayers</span> - <span class="tl">1</span>}],
   <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="tc">(*edge colors*)</span>
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/BitGet.html" rel="nofollow">BitGet</a>[<span class="tnv">edges</span>[[<span class="tnvc">i</span>, <span class="tl">3</span>]], <span class="tnvc">l</span>] =!= <span class="tl">1</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>,
     {<span class="ts">" "</span>, <span class="tnvc">vertex2idx</span>[<span class="tnv">edges</span>[[<span class="tnvc">i</span>, <span class="tl">1</span>]]] + <span class="tnvc">l</span> <span class="tnvc">nvertices</span>, <span class="ts">":"</span>,
      <span class="tnvc">vertex2idx</span>[<span class="tnv">edges</span>[[<span class="tnvc">i</span>, <span class="tl">2</span>]]] + <span class="tnvc">l</span> <span class="tnvc">nvertices</span>}],
    {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">edges</span>]}, {<span class="tnvc">l</span>, <span class="tl">0</span>, <span class="tnvc">nlayers</span> - <span class="tl">1</span>}],
   <span class="ts">" .\nf=[0"</span>,
   <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<span class="ts">"|"</span>, <span class="tnvc">l</span> + <span class="tl">1</span>, <span class="ts">":"</span>, <span class="tnvc">l</span> + <span class="tnvc">nvertices</span>}, {<span class="tnvc">l</span>,
     <span class="tl">0</span>, (<span class="tnvc">nlayers</span> - <span class="tl">1</span>) <span class="tnvc">nvertices</span>, <span class="tnvc">nvertices</span>}],
   <span class="ts">"]\nx \"--{\\n\" b \"}--\\n--cut--\\n\" -&gt;&gt;"</span>
   ]
  ]
<span class="tnv">ColoredSimpleGraphCanonicalLabel</span>[<span class="tnv">vertices</span> : {{_, _} ...}, <span class="tnv">edges</span> : {{_, _, _} ...}] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">nvertices</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">vertices</span>]},
    <span class="tnv">StartDreadnaut</span>[];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/WriteLine.html" rel="nofollow">WriteLine</a>[<span class="tnv">$DREADNAUT</span>, <a class="tnv" href="#ColoredSimpleGraphToDreadnaut">ColoredSimpleGraphToDreadnaut</a>[<span class="tnv">vertices</span>, <span class="tnv">edges</span>]];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/ReadString.html" rel="nofollow">ReadString</a>[<span class="tnv">$DREADNAUT</span>, <span class="ts">"--cut--\n"</span>] //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/StringCases.html" rel="nofollow">StringCases</a>[<span class="tnv">#</span>, <span class="ts">"--{\n"</span> ~~ <a class="tnb" href="https://reference.wolfram.com/language/ref/Shortest.html" rel="nofollow">Shortest</a>[<span class="tnt">x__</span>] ~~ <span class="ts">"\n"</span> ~~ <a class="tnb" href="https://reference.wolfram.com/language/ref/Shortest.html" rel="nofollow">Shortest</a>[__] ~~ <span class="ts">"}--"</span> :&gt; <span class="tnv">x</span> ] &amp; //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Last.html" rel="nofollow">Last</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/StringSplit.html" rel="nofollow">StringSplit</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>] //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<span class="tl">0</span> &lt; <span class="tnv">#</span> &lt;= <span class="tnvc">nvertices</span> &amp;] //
      <span class="tc">(*(Print["CAN ORD: ", #, " -&gt; ",vertices[[#]]];#)&amp;//*)</span>
      <span class="tc">(*PositionIndex // Map[First] // Normal // Map[Apply[vertices[[#2,1]] -&gt; vertices[[#1,1]]&amp;]] // PR*)</span>
      <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[<span class="tnv">vertices</span>[[<span class="tnv">#1</span>, <span class="tl">1</span>]] -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>[<span class="tnv">#2</span>] &amp;, <span class="tnv">#</span>] &amp;
  ]</pre>
<h3 id="GraphCanonicalLabel"><code>GraphCanonicalLabel[]</code></h3>
<p>&quot;
Canonical vertex relabeling (a list of rules) for an undirected graph.
Self-edges and doubled lines are allowed.
Example:
GraphCanonicalLabel[{{a,b},{b,c},{c,b},{c,d},{d,d}}]
=&gt; {b -&gt; 1, c -&gt; 2, a -&gt; 3, d -&gt; 4}
&quot;</p>
<pre><a class="tnv" href="#GraphCanonicalLabel">GraphCanonicalLabel</a>[<span class="tnv">g</span> : {{_, _} ...}] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">edges</span>, <span class="tnvc">vertices</span>, <span class="tnvc">v</span>},
    <span class="tnvc">edges</span> = <span class="tnv">g</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>];
    <span class="tnvc">vertices</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>[<span class="tnvc">edges</span>[[;; , <span class="tl">1</span>]], <span class="tnvc">edges</span>[[;; , <span class="tl">2</span>]]];
    <span class="tnv">ColoredSimpleGraphCanonicalLabel</span>[
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<span class="tnvc">v</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnvc">edges</span>, {<span class="tnvc">v</span>, <span class="tnvc">v</span>}]}, {<span class="tnvc">v</span>, <span class="tnvc">vertices</span>}],
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Counts.html" rel="nofollow">Counts</a>[<span class="tnvc">edges</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[{<span class="tnt">v_</span>, <span class="tnt">v_</span>} -&gt; _] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>]]
    ]
  ]</pre>
<h3 id="GraphCanonicalForm"><code>GraphCanonicalForm[]</code></h3>
<p>Example:
GraphCanonicalForm[{{a,b},{b,c},{c,b},{c,d},{d,d}}]
=&gt; {{1, 2}, {1, 2}, {1, 3}, {2, 4}, {4, 4}}</p>
<pre><a class="tnv" href="#GraphCanonicalForm">GraphCanonicalForm</a>[<span class="tnt">g_</span>] :=
  <span class="tnv">g</span> /. <a class="tnv" href="#GraphCanonicalLabel">GraphCanonicalLabel</a>[<span class="tnv">g</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>
<span class="tnv">GraphCanonicalString</span>[<span class="tnt">g_</span>] :=
  <span class="tnv">g</span> // <a class="tnv" href="#GraphCanonicalForm">GraphCanonicalForm</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"-"</span>] &amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">";"</span>] &amp; // <a class="tnv" href="utils.html#MkString">MkString</a></pre>
<h3 id="ColoredGraphCanonicalLabel"><code>ColoredGraphCanonicalLabel[]</code></h3>
<p>&quot;
Canonical vertex relabeling (a list of rules) for an undirected graph <br />
with colored edges.
Self-edges and doubled lines are allowed.
Colors can be any objects.
&quot;</p>
<pre><a class="tnv" href="#ColoredGraphCanonicalLabel">ColoredGraphCanonicalLabel</a>[<span class="tnv">g</span> : {{_, _, _} ...}] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">edgecolors</span>, <span class="tnvc">color2idx</span>, <span class="tnvc">vertices</span>, <span class="tnvc">v</span>},
  <span class="tnvc">edgecolors</span> = <span class="tnv">g</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[(<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">#</span>[[;; <span class="tl">2</span>]]] &amp;) -&gt; (<span class="tnv">#</span>[[<span class="tl">3</span>]] &amp;)];
  <span class="tc">(*//Normal//Apply[List]//Transpose;*)</span>
  <span class="tnvc">color2idx</span> = <span class="tnvc">edgecolors</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Values.html" rel="nofollow">Values</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/PositionIndex.html" rel="nofollow">PositionIndex</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>];
  <span class="tnvc">edgecolors</span> = <span class="tnvc">edgecolors</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnvc">color2idx</span>];
  <span class="tnvc">vertices</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>[<span class="tnv">g</span>[[;; , <span class="tl">1</span>]], <span class="tnv">g</span>[[;; , <span class="tl">2</span>]]];
  <span class="tnv">ColoredSimpleGraphCanonicalLabel</span>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<span class="tnvc">v</span>, <span class="tnvc">edgecolors</span>[{<span class="tnvc">v</span>, <span class="tnvc">v</span>}] /. <span class="tnt">_Missing</span> -&gt; <span class="tl">0</span>}, {<span class="tnvc">v</span>, <span class="tnvc">vertices</span>}],
    <span class="tnvc">edgecolors</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[{<span class="tnt">v_</span>, <span class="tnt">v_</span>} -&gt; _] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>]]
  ]
]
<span class="tnv">ColoredGraphCanonicalForm</span>[<span class="tnt">g_</span>] :=
  <span class="tnv">g</span> /. <a class="tnv" href="#ColoredGraphCanonicalLabel">ColoredGraphCanonicalLabel</a>[<span class="tnv">g</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[{<span class="tnv">#</span>[[<span class="tl">1</span>]], <span class="tnv">#</span>[[<span class="tl">2</span>]]}], <span class="tnv">#</span>[[<span class="tl">3</span>]]] &amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>
<span class="tnv">ColoredGraphCanonicalString</span>[<span class="tnt">g_</span>] :=
  <span class="tnv">g</span> // <span class="tnv">ColoredGraphCanonicalForm</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">"-"</span>] &amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">";"</span>] &amp; // <a class="tnv" href="utils.html#MkString">MkString</a></pre>
<p>IBP Topologies</p>
<p>Get the list of momenta in the denominators of a Diagram or
a CutDiagram.</p>
<pre><a class="tnb" href="https://reference.wolfram.com/language/ref/ClearAll.html" rel="nofollow">ClearAll</a>[<span class="tnv">Denominators</span>];
<span class="tnv">Denominators</span>[<span class="tnt">p_P</span>] := <a class="tnv" href="alibrary.html#Amplitude">Amplitude</a>[<span class="tnv">p</span>] // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_den</span>]
<span class="tnv">Denominators</span>[<span class="tnt">d_Diagram</span>] := <span class="tnv">d</span> // <span class="tnv">DiagramPropagators</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">Denominators</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>] // <a class="tnv" href="alibrary.html#NormalizeDens">NormalizeDens</a>
<span class="tnv">Denominators</span>[<span class="tnv">CutDiagram</span>[
    <span class="tnv">Diagram</span>[_, _, _, <span class="tnt">o1_List</span>, <span class="tnt">p1_List</span>, <span class="tnt">_List</span>],
    <span class="tnv">Diagram</span>[_, _, _, <span class="tnt">o2_List</span>, <span class="tnt">p2_List</span>, <span class="tnt">_List</span>]
  ]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">p1</span>, <span class="tnv">p2</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">Denominators</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>],
    <span class="tnv">o1</span> /. <span class="tnv">F</span>[__, <span class="tnt">mom_</span>] :&gt; <span class="tnv">den</span>[<a class="tnv" href="utils.html#DropLeadingSign">DropLeadingSign</a>[<span class="tnv">mom</span>], <span class="tl">0</span>, <span class="tnv">cut</span>]
  ]
<span class="tnv">Denominators</span>[<span class="tnt">x_</span>] := <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Don't know the denominators of "</span>, <span class="tnv">x</span>]

<span class="tnv">CutDiagramGraph</span>[<span class="tnv">CutDiagram</span>[<span class="tnt">d1_Diagram</span>, <span class="tnt">d2_Diagram</span>]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">e1</span>, <span class="tnvc">e2</span>},
  <span class="tnvc">e1</span> = <a class="tnv" href="alibrary.html#DiagramGraphEdges">DiagramGraphEdges</a>[<span class="tnv">d1</span>];
  <span class="tnvc">e2</span> = <a class="tnv" href="alibrary.html#DiagramGraphEdges">DiagramGraphEdges</a>[<span class="tnv">d2</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnvc">e1</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[_ &lt;-&gt; <span class="tnt">_EE</span>],
   <span class="tnvc">e2</span> /. <span class="tnv">SS</span> -&gt; <span class="tnv">SS2</span> /. <span class="tnv">II</span> -&gt; <span class="tnv">II2</span> /. <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnvc">e1</span>, (<span class="tnt">i_</span> &lt;-&gt; <span class="tnt">e_EE</span>) :&gt; ((<span class="tnt">x_</span> &lt;-&gt; <span class="tnv">e</span>) :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Style.html" rel="nofollow">Style</a>[<span class="tnv">x</span> &lt;-&gt; <span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Dashed.html" rel="nofollow">Dashed</a>])]]
]
<span class="tnv">CanonicalSector</span>[<span class="tnt">edges_</span>: {{_, _, _, _} ...}] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">canonicmap</span>, <span class="tnvc">tag</span>, <span class="tnvc">canonicedges</span>},
    <span class="tnvc">canonicmap</span> = <a class="tnv" href="#ColoredGraphCanonicalLabel">ColoredGraphCanonicalLabel</a>[<span class="tnv">edges</span>[[;; , ;; <span class="tl">3</span>]]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>;
    <span class="tnvc">canonicedges</span> =
      <a class="tnb" href="https://reference.wolfram.com/language/ref/MapAt.html" rel="nofollow">MapAt</a>[<span class="tnvc">canonicmap</span>, <span class="tnv">edges</span>, {;; , ;; <span class="tl">2</span>}] //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/OrderedQ.html" rel="nofollow">OrderedQ</a>[<span class="tnv">#</span>[[;; <span class="tl">2</span>]]], <span class="tnv">#</span>, <span class="tnv">#</span>[[{<span class="tl">2</span>, <span class="tl">1</span>, <span class="tl">3</span>, <span class="tl">4</span>}]]*{<span class="tl">1</span>, <span class="tl">1</span>, <span class="tl">1</span>, -<span class="tl">1</span>}] &amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>;
    <span class="tnvc">tag</span> = <span class="tnvc">canonicedges</span>[[;; , ;; <span class="tl">3</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">" "</span>] &amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">";"</span>] &amp; // <a class="tnv" href="utils.html#MkString">MkString</a>;
    {<span class="tnvc">tag</span>, <span class="tnvc">canonicedges</span>}
  ]
<a class="tnb" href="https://reference.wolfram.com/language/ref/ClearAll.html" rel="nofollow">ClearAll</a>[<span class="tnv">SectorsAdd</span>];
<span class="tnv">SectorsAdd</span>[<span class="tnt">sectors_</span>,
    <span class="tnv">CutDiagram</span>[<span class="tnv">Diagram</span>[_, _, <span class="tnt">i1_List</span>, <span class="tnt">o1_List</span>, <span class="tnt">p1_List</span>, _],
    <span class="tnv">Diagram</span>[_, _, <span class="tnt">i2_List</span>, <span class="tnt">o2_List</span>, <span class="tnt">p2_List</span>, _]]] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">outfi2vi</span>, <span class="tnvc">edges</span>, <span class="tnvc">tag</span>},
  <span class="tc">(*
  Construct an edge-colored graph with distinct colors for each
  input and each output, one color for propagators, one color for
  the cut lines, and a separate color for the first cut line.
  *)</span>
  <span class="tnvc">outfi2vi</span> =
   <span class="tnv">o1</span> /. <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<span class="tnv">fi</span>, <span class="tnv">vi</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>;
  <span class="tnvc">edges</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
    <span class="tnv">i1</span> /. <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">SS</span>[<span class="tnv">fi</span>], <span class="tnv">I1</span>[<span class="tnv">vi</span>], <span class="tnv">fi</span>, <span class="tnv">mom</span>},
    <span class="tnv">i2</span> /. <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">I2</span>[<span class="tnv">vi</span>], <span class="tnv">EE</span>[<span class="tnv">fi</span>], <span class="tnv">fi</span>, <span class="tnv">mom</span>},
    <span class="tnv">o2</span> /.
     <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">I1</span>[<span class="tnvc">outfi2vi</span>[<span class="tnv">fi</span>]], <span class="tnv">I2</span>[<span class="tnv">vi</span>],
       <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">fi</span> === -<span class="tl">2</span>, <span class="tl">0</span>, <span class="tl">0</span>], <span class="tnv">mom</span>},
    <span class="tnv">p1</span> /. <span class="tnv">P</span>[_, _, _, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">I1</span>[<span class="tnv">vi1</span>], <span class="tnv">I1</span>[<span class="tnv">vi2</span>], <span class="tl">0</span>, <span class="tnv">mom</span>},
    <span class="tnv">p2</span> /.
     <span class="tnv">P</span>[_, _, _, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">I2</span>[<span class="tnv">vi2</span>], <span class="tnv">I2</span>[<span class="tnv">vi1</span>], <span class="tl">0</span>,
       <span class="tnv">mom</span> /. <span class="tnv">l1</span> -&gt; <span class="tnv">r1</span> /. <span class="tnv">l2</span> -&gt; <span class="tnv">r2</span> /. <span class="tnv">l3</span> -&gt; <span class="tnv">r3</span> /. <span class="tnv">l4</span> -&gt; <span class="tnv">r4</span>}
    ];
  <span class="tnv">SectorsAdd</span>[<span class="tnv">sectors</span>, <span class="tnvc">edges</span>]
  ]
<span class="tnv">SectorsAdd</span>[<span class="tnt">sectors_</span>, <span class="tnt">sector_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">tag</span>, <span class="tnvc">edges</span>},
  {<span class="tnvc">tag</span>, <span class="tnvc">edges</span>} = <span class="tnv">CanonicalSector</span>[<span class="tnv">sector</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/KeyExistsQ.html" rel="nofollow">KeyExistsQ</a>[<span class="tnv">sectors</span>, <span class="tnvc">tag</span>],
   <span class="tnv">sectors</span>
   ,
   <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnv">sectors</span>, <span class="tnvc">tag</span> -&gt; <span class="tnvc">edges</span>]
   ]
  ]
<span class="tnv">SectorUniquePropagators</span>[<span class="tnt">sector_</span>] :=
 <span class="tnv">sector</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[{_, _, _?(<a class="tnb" href="https://reference.wolfram.com/language/ref/Negative.html" rel="nofollow">Negative</a> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>), _}] // <span class="tnv">#</span>[[;; , <span class="tl">4</span>]] &amp; //
   <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#DropLeadingSign">DropLeadingSign</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>
<span class="tnv">SubSectors</span>[<span class="tnt">subsectors_</span>, {}] := <span class="tnv">subsectors</span>
<span class="tnv">SubSectors</span>[<span class="tnt">subsectors_</span>, <span class="tnt">sector_List</span>] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">ss</span> = <span class="tnv">subsectors</span>, <span class="tnvc">line</span>, <span class="tnvc">i</span>, <span class="tnvc">tag</span>, <span class="tnvc">edges</span>},
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
   <span class="tnvc">line</span> = <span class="tnv">sector</span>[[<span class="tnvc">i</span>]];
   <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">line</span>, {<span class="tnt">a_</span>, <span class="tnt">a_</span>, _, _} | {_, _, <a class="tnb" href="https://reference.wolfram.com/language/ref/Except.html" rel="nofollow">Except</a>[<span class="tl">0</span>], _}]],
    <span class="tnvc">edges</span> =
     <a class="tnb" href="https://reference.wolfram.com/language/ref/Drop.html" rel="nofollow">Drop</a>[<span class="tnv">sector</span>, {<span class="tnvc">i</span>}] //
      <a class="tnb" href="https://reference.wolfram.com/language/ref/MapAt.html" rel="nofollow">MapAt</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">line</span>[[<span class="tl">1</span>]] -&gt; <span class="tnvc">line</span>[[<span class="tl">2</span>]]], <span class="tnv">#</span>, {;; , ;; <span class="tl">2</span>}] &amp;;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">edges</span>, {___, {<span class="tnt">a_</span>, <span class="tnt">a_</span>, ___}, ___}]],
     {<span class="tnvc">tag</span>, <span class="tnvc">edges</span>} = <span class="tnv">CanonicalSector</span>[<span class="tnvc">edges</span>];
     <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/KeyExistsQ.html" rel="nofollow">KeyExistsQ</a>[<span class="tnvc">ss</span>, <span class="tnvc">tag</span>]],
      <span class="tc">(*Print["ADD ",1+Length[ss]," (",tag,"):",edges//Map[
      Apply[{DirectedEdge[#1,#2](*,Text[#4]*)}&amp;]]//XGraph];*)</span>
      <span class="tnvc">ss</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnvc">ss</span>, <span class="tnvc">tag</span> -&gt; <span class="tnvc">edges</span>] // <span class="tnv">SubSectors</span>[<span class="tnv">#</span>, <span class="tnvc">edges</span>] &amp;;
      ]
     ]
    ],
   {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">sector</span>]}];
  <span class="tnvc">ss</span>
  ]</pre>
<h3 id="EqualSectorSet"><code>EqualSectorSet[]</code></h3>
<p>Return this sector, and all its subsectors with the same set of propagators.</p>
<pre><a class="tnv" href="#EqualSectorSet">EqualSectorSet</a>[<span class="tnt">sector_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">tag</span>, <span class="tnvc">edges</span>},
  {<span class="tnvc">tag</span>, <span class="tnvc">edges</span>} = <span class="tnv">CanonicalSector</span>[<span class="tnv">sector</span>];
  <a class="tnv" href="#EqualSectorSet">EqualSectorSet</a>[&lt;|<span class="tnvc">tag</span> -&gt; <span class="tnvc">edges</span>|&gt;, <span class="tnvc">edges</span>, <span class="tnv">SectorUniquePropagators</span>[<span class="tnvc">edges</span>]]
]
<a class="tnv" href="#EqualSectorSet">EqualSectorSet</a>[<span class="tnt">subsectors_</span>, <span class="tnt">sector_</span>, <span class="tnt">uniqprops_List</span>] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">ss</span> = <span class="tnv">subsectors</span>, <span class="tnvc">line</span>, <span class="tnvc">i</span>, <span class="tnvc">tag</span>, <span class="tnvc">edges</span>},
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
      <span class="tnvc">line</span> = <span class="tnv">sector</span>[[<span class="tnvc">i</span>]];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">line</span>, {<span class="tnt">a_</span>, <span class="tnt">a_</span>, _, _} | {_, _, <a class="tnb" href="https://reference.wolfram.com/language/ref/Except.html" rel="nofollow">Except</a>[<span class="tl">0</span>], _}]],
        {<span class="tnvc">tag</span>, <span class="tnvc">edges</span>} = <span class="tnv">CanonicalSector</span>[
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Drop.html" rel="nofollow">Drop</a>[<span class="tnv">sector</span>, {<span class="tnvc">i</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/MapAt.html" rel="nofollow">MapAt</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">line</span>[[<span class="tl">1</span>]] -&gt; <span class="tnvc">line</span>[[<span class="tl">2</span>]]], <span class="tnv">#</span>, {;; , ;; <span class="tl">2</span>}] &amp;];
        <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/KeyExistsQ.html" rel="nofollow">KeyExistsQ</a>[<span class="tnvc">ss</span>, <span class="tnvc">tag</span>]] &amp;&amp; (<span class="tnv">SectorUniquePropagators</span>[<span class="tnvc">edges</span>] === <span class="tnv">uniqprops</span>),
          <span class="tnvc">ss</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnvc">ss</span>, <span class="tnvc">tag</span> -&gt; <span class="tnvc">edges</span>] // <a class="tnv" href="#EqualSectorSet">EqualSectorSet</a>[<span class="tnv">#</span>, <span class="tnvc">edges</span>, <span class="tnv">uniqprops</span>] &amp;;
        ]
      ],
    {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">sector</span>]}];
    <span class="tnvc">ss</span>
  ]
<span class="tnv">SuperSectors</span>[<span class="tnt">sectors_</span>] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">supersectors</span>, <span class="tnvc">subsectors</span>, <span class="tnvc">tag</span>, <span class="tnvc">sector</span>, <span class="tnvc">eqsubsectors</span>, <span class="tnvc">sector2subsectors</span>},
    <span class="tnvc">subsectors</span> = &lt;||&gt;;
    <span class="tnvc">supersectors</span> = &lt;||&gt;;
    <span class="tnvc">sector2subsectors</span> = &lt;||&gt;;
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
     <span class="tnvc">eqsubsectors</span> = <a class="tnv" href="#EqualSectorSet">EqualSectorSet</a>[<span class="tnv">sectors</span>[<span class="tnvc">tag</span>]]<span class="tc">(*//PR*)</span>;
     <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/AllTrue.html" rel="nofollow">AllTrue</a>[<span class="tnvc">eqsubsectors</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Keys.html" rel="nofollow">Keys</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/KeyExistsQ.html" rel="nofollow">KeyExistsQ</a>[<span class="tnvc">subsectors</span>, <span class="tnv">#</span>]] &amp;],
      <span class="tc">(*{tag,sector}=eqsubsectors//Normal//SortBy[Length[#[[2]]]&amp;];
      If[Length[eqsubsectors]&gt;
      0,*)</span>
      {<span class="tnvc">tag</span>, <span class="tnvc">sector</span>} = <span class="tnvc">eqsubsectors</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a> // <span class="tnv">#</span>[[-<span class="tl">1</span>]] &amp; // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>]<span class="tc">(*//PR*)(*]*)</span>;
      <span class="tnvc">subsectors</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnvc">subsectors</span>, <span class="tnvc">tag</span> -&gt; <span class="tnvc">sector</span>] // <span class="tnv">SubSectors</span>[<span class="tnv">#</span>, <span class="tnvc">sector</span>] &amp;;
      <span class="tnvc">supersectors</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnvc">supersectors</span>, <span class="tnvc">tag</span> -&gt; <span class="tnvc">sector</span>];
      ];
     ,
     {<span class="tnvc">tag</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Keys.html" rel="nofollow">Keys</a>[<span class="tnv">sectors</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/SortBy.html" rel="nofollow">SortBy</a>[<span class="tnv">sectors</span> /* <span class="tnv">SectorUniquePropagators</span> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Minus.html" rel="nofollow">Minus</a>]}];
    <span class="tnvc">supersectors</span>
  ]
<span class="tnv">SectorXGraph</span>[<span class="tnt">sector_</span>] := <span class="tnv">sector</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[{<a class="tnb" href="https://reference.wolfram.com/language/ref/DirectedEdge.html" rel="nofollow">DirectedEdge</a>[<span class="tnv">#1</span>, <span class="tnv">#2</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<span class="tnv">#4</span>]} &amp;]] // <span class="tnv">XGraph</span>
<span class="tnv">SectorXGraph</span>[<span class="tnt">sector_</span>] := <span class="tnv">sector</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[{
      {<span class="tnt">v1_</span>, <span class="tnt">v2_</span>, <span class="tl">2</span>, <span class="tnt">mom_</span>} :&gt; {<a class="tnb" href="https://reference.wolfram.com/language/ref/DirectedEdge.html" rel="nofollow">DirectedEdge</a>[<span class="tnv">v1</span>, <span class="tnv">v2</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<span class="tnv">mom</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Thick.html" rel="nofollow">Thick</a>,
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Dashed.html" rel="nofollow">Dashed</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Red.html" rel="nofollow">Red</a>},
      {<span class="tnt">v1_</span>, <span class="tnt">v2_</span>, <span class="tl">1</span>, <span class="tnt">mom_</span>} :&gt; {<a class="tnb" href="https://reference.wolfram.com/language/ref/DirectedEdge.html" rel="nofollow">DirectedEdge</a>[<span class="tnv">v1</span>, <span class="tnv">v2</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<span class="tnv">mom</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Thick.html" rel="nofollow">Thick</a>,
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Dashed.html" rel="nofollow">Dashed</a>},
      {<span class="tnt">v1_</span>, <span class="tnt">v2_</span>, _?<a class="tnb" href="https://reference.wolfram.com/language/ref/Negative.html" rel="nofollow">Negative</a>, <span class="tnt">mom_</span>} :&gt; {<a class="tnb" href="https://reference.wolfram.com/language/ref/DirectedEdge.html" rel="nofollow">DirectedEdge</a>[<span class="tnv">v1</span>, <span class="tnv">v2</span>],
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<span class="tnv">mom</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Lighter.html" rel="nofollow">Lighter</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Gray.html" rel="nofollow">Gray</a>]},
      {<span class="tnt">v1_</span>, <span class="tnt">v2_</span>, _, <span class="tnt">mom_</span>} :&gt; {<a class="tnb" href="https://reference.wolfram.com/language/ref/DirectedEdge.html" rel="nofollow">DirectedEdge</a>[<span class="tnv">v1</span>, <span class="tnv">v2</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Text.html" rel="nofollow">Text</a>[<span class="tnv">mom</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Thick.html" rel="nofollow">Thick</a>}
      }]] // <span class="tnv">XGraph</span>
<span class="tnv">SectorGraph</span>[<span class="tnt">sector_</span>] :=
 <span class="tnv">sector</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/UndirectedEdge.html" rel="nofollow">UndirectedEdge</a>[<span class="tnv">#1</span>, <span class="tnv">#2</span>] &amp;]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Graph.html" rel="nofollow">Graph</a></pre>
<h3 id="DenominatorsLinearlyDependentQ"><code>DenominatorsLinearlyDependentQ[]</code></h3>
<p>Check if a list of denominators are linearly dependent, in
the sense that there is a non-trivial linear combination of
them that is a constant.</p>
<p>The denominators can be: den[p] for 1/p^2, and den[p,m2]
for 1/(p^2-m2). Monomials of the form l*k are considered
independent variables for this test, with l being any of the
loop momenta, and k any of the loop or external momenta.</p>
<p>It is OK to supply a superset of the loop momenta in loopmom,
and a superset of external momenta in extmom.</p>
<pre><a class="tnv" href="#DenominatorsLinearlyDependentQ">DenominatorsLinearlyDependentQ</a>[<span class="tnv">dens</span> : {<span class="tnt">_den</span> ...}, <span class="tnt">loopmom_List</span>, <span class="tnt">extmom_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">L</span>, <span class="tnvc">K</span>, <span class="tnvc">ex</span>, <span class="tnvc">c</span>},
  <span class="tnvc">L</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnv">loopmom</span>;
  <span class="tnvc">K</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">loopmom</span>, <span class="tnv">extmom</span>];
  <span class="tnvc">ex</span> = <span class="tnv">dens</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>^<span class="tl">2</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m2_</span>, ___] :&gt; <span class="tnv">p</span>^<span class="tl">2</span> - <span class="tnv">m2</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>;
  <span class="tnvc">ex</span> = <span class="tnvc">ex</span> /. (<span class="tnv">l</span> : <span class="tnvc">L</span>)^<span class="tl">2</span> :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a>[<span class="tnv">l</span>, <span class="tnv">l</span>] /. (<span class="tnv">l</span> : <span class="tnvc">L</span>)*(<span class="tnv">k</span> : <span class="tnvc">K</span>) :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a>[<span class="tnv">l</span>, <span class="tnv">k</span>]];
  <a class="tnv" href="utils.html#PolynomialsLinearlyDependentQ">PolynomialsLinearlyDependentQ</a>[<span class="tnvc">ex</span> - (<span class="tnvc">ex</span> /. <span class="tnt">_Dot</span> -&gt; <span class="tl">0</span>), <span class="tnvc">ex</span> // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_Dot</span>]]
]

<span class="tnv">PartialFractionFactor</span>[<span class="tnt">dens_List</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">extmom_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">L</span>, <span class="tnvc">E</span>, <span class="tnvc">p</span>, <span class="tnvc">q</span>, <span class="tnvc">m</span>, <span class="tnvc">nums</span>, <span class="tnvc">vars</span>, <span class="tnvc">c</span>, <span class="tnvc">mx</span>, <span class="tnvc">nullspace</span>, <span class="tnvc">ns0</span>, <span class="tnvc">cutk</span>, <span class="tnvc">num</span>, <span class="tnvc">i</span>, <span class="tnvc">ex</span>},
  <span class="tnvc">L</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnv">loopmom</span>;
  <span class="tnvc">E</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnv">extmom</span>;
  <span class="tc">(* nums = 1/dens *)</span>
  <span class="tnvc">nums</span> = <span class="tnv">dens</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tnvc">p</span>^<span class="tl">2</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, ___] :&gt; <span class="tnvc">p</span>^<span class="tl">2</span> - <span class="tnvc">m</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>;
  <span class="tnvc">nums</span> = <span class="tnvc">nums</span> /.
    (<span class="tnvc">p</span>:<span class="tnvc">L</span>)^<span class="tl">2</span> :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a>[<span class="tnvc">p</span>, <span class="tnvc">p</span>] /.
    (<span class="tnvc">p</span>:<span class="tnvc">L</span>) (<span class="tnvc">q</span>:<span class="tnvc">L</span>|<span class="tnvc">E</span>) :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a>[<span class="tnvc">p</span>, <span class="tnvc">q</span>]] /.
    (<span class="tnvc">p</span>:<span class="tnvc">E</span>) (<span class="tnvc">q</span>:<span class="tnvc">E</span>) :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[<span class="tnv">sp</span>[<span class="tnvc">p</span>, <span class="tnvc">q</span>]] /.
    (<span class="tnvc">p</span>:<span class="tnvc">E</span>)^<span class="tl">2</span> :&gt; <span class="tnv">sp</span>[<span class="tnvc">p</span>];
  <span class="tnvc">vars</span> = <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnvc">nums</span>, <span class="tnt">_Dot</span>];
  {<span class="tnvc">c</span>, <span class="tnvc">mx</span>} = <a class="tnb" href="https://reference.wolfram.com/language/ref/CoefficientArrays.html" rel="nofollow">CoefficientArrays</a>[<span class="tnvc">nums</span>, <span class="tnvc">vars</span>];
  <span class="tc">(* nums == c + mx.vars *)</span>
  <span class="tnvc">nullspace</span> = <span class="tnvc">mx</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Transpose.html" rel="nofollow">Transpose</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/NullSpace.html" rel="nofollow">NullSpace</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>;
  <span class="tc">(* nullspace[[i]].mx == {0, ...} =&gt; ns[[i]].nums == c *)</span>
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">nullspace</span>] &lt; <span class="tl">1</span>,
    <span class="tl">1</span>
    ,
    <span class="tnvc">nullspace</span> = <span class="tnvc">nullspace</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/RowReduce.html" rel="nofollow">RowReduce</a>;
    <span class="tnvc">ns0</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<span class="tnvc">nullspace</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>[<span class="tnv">#</span>.<span class="tnvc">c</span>] =!= <span class="tl">0</span> &amp;];
    <span class="tc">(* Assume that all cut demoninators have index 1, and drop
     * indices lower than that. *)</span>
    <span class="tnvc">cutk</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">#</span>, <span class="tnv">den</span>[_, _, <span class="tnv">cut</span>]], <span class="tl">0</span>, <span class="tl">1</span>]&amp;, <span class="tnv">dens</span>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">ns0</span> =!= {},
      <span class="tnvc">ns0</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/MaximalBy.html" rel="nofollow">MaximalBy</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">#</span>*<span class="tnvc">cutk</span>, <span class="tl">0</span>] &amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a> // (<span class="tnv">#</span>*<span class="tnvc">cutk</span>).(<span class="tl">1</span>/<span class="tnv">dens</span>)/<a class="tnb" href="https://reference.wolfram.com/language/ref/Factor.html" rel="nofollow">Factor</a>[<span class="tnv">#</span>.<span class="tnvc">c</span>] &amp;
      ,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"WARNING: PartialFractionFactor -- second case"</span>];
      <span class="tnvc">nullspace</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/MaximalBy.html" rel="nofollow">MaximalBy</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">#</span>*<span class="tnvc">cutk</span>, <span class="tl">0</span>] &amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a> //
        <span class="tnv">#</span>.<a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[<span class="tnvc">num</span>[<span class="tnv">#2</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>]&amp;, <span class="tnv">dens</span>]&amp; //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Solve.html" rel="nofollow">Solve</a>[<span class="tnv">#</span>==<span class="tl">0</span>, <span class="tnv">#</span>//<a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_num</span>]//<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>]&amp; // <a class="tnv" href="utils.html#Only">Only</a> // <a class="tnv" href="utils.html#Only">Only</a> //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[(<span class="tnvc">num</span>[<span class="tnt">i_</span>] -&gt; <span class="tnt">ex_</span>) :&gt; (<span class="tnv">dens</span>[[<span class="tnvc">i</span>]] * <span class="tnvc">ex</span>)] //
        <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnvc">num</span>[<span class="tnt">i_</span>] :&gt; <span class="tnvc">cutk</span>[[<span class="tnvc">i</span>]]/<span class="tnv">dens</span>[[<span class="tnvc">i</span>]]]
    ]
  ]
]</pre>
<p>FailUnless[
PartialFractionFactor[{den[p1], den[p1+p2], den[p2], den[p1-p2]}, {p1,p2}, {q}] /.
den[p_]:&gt;1/p^2 /. den[p_,m_]:&gt;1/(p^2-m) // Together // #===1&amp;
];
FailUnless[
PartialFractionFactor[{den[p1], den[p1,m]}, {p1,p2}, {q}] /.
den[p_]:&gt;1/p^2 /. den[p_,m_]:&gt;1/(p^2-m) // Together // #===1&amp;
];</p>
<h3 id="PartialFraction"><code>PartialFraction[]</code></h3>
<p>Perform partial fraction decomposition on terms consisting of
den[p] and den[p,m2,___] objects via the Leinartas' algorithm.
Example:</p>
<blockquote>
<p>PartialFraction[den[p]*den[p,m2],{p},{}]
den[p,m2]/m2 - den[p]/m2</p>
</blockquote>
<p>Cut denominators are assumed to all have power 1, and zero
terms are dropped automatically:</p>
<blockquote>
<p>PartialFraction[den[p]*den[p,m2,cut],{p},{}]
den[p,m2]/m2</p>
</blockquote>
<pre><a class="tnv" href="#PartialFraction">PartialFraction</a>[<span class="tnt">ex_</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">extmom_List</span>] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/FixedPoint.html" rel="nofollow">FixedPoint</a>[
  <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_den</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Together.html" rel="nofollow">Together</a>, <span class="tnv">#</span> * <span class="tnv">PartialFractionFactor</span>[
      <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnv">#</span>, <span class="tnt">_den</span>]//<a class="tnb" href="https://reference.wolfram.com/language/ref/SortBy.html" rel="nofollow">SortBy</a>[{<span class="tnv">#</span>,<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">#</span>,<span class="tnv">den</span>[_,_,<span class="tnv">cut</span>]]}&amp;], <span class="tnv">loopmom</span>, <span class="tnv">extmom</span>
    ]&amp;
  ]&amp;,
  <span class="tnv">ex</span>]

<span class="tnv">IBPBasisSanityCheck</span>[<span class="tnt">ibpbasis_List</span>] := (<a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">IBPBasisSanityCheck</span>, <span class="tnv">ibpbasis</span>];)
<span class="tnv">IBPBasisSanityCheck</span>[<span class="tnv">IBPBasis</span>[<span class="tnt">bid_</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">extmom_List</span>, <span class="tnt">dens_List</span>, <span class="tnt">denmap_</span>, <span class="tnt">dotmap_</span>]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">normaldens</span>, <span class="tnvc">i</span>, <span class="tnvc">dots</span>, <span class="tnvc">p1</span>, <span class="tnvc">p2</span>, <span class="tnvc">p</span>, <span class="tnvc">m</span>},
  <span class="tnvc">normaldens</span> = <span class="tnv">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tnv">den</span>[_, _, <span class="tnv">irr</span>]];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[(<span class="tnvc">normaldens</span> /. <span class="tnv">denmap</span>) === <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="tnv">DEN</span>[<span class="tnvc">i</span>], {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">normaldens</span>]}]];
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[(<a class="tnb" href="https://reference.wolfram.com/language/ref/MapAt.html" rel="nofollow">MapAt</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Minus.html" rel="nofollow">Minus</a>, <span class="tnvc">normaldens</span>, {;;,<span class="tl">1</span>}] /. <span class="tnv">denmap</span>) === <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="tnv">DEN</span>[<span class="tnvc">i</span>], {<span class="tnvc">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">normaldens</span>]}]];
  <span class="tnvc">dots</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[{<span class="tnvc">p1</span>.<span class="tnvc">p2</span>, <span class="tnvc">p2</span>.<span class="tnvc">p1</span>}, {<span class="tnvc">p1</span>, <span class="tnv">loopmom</span>}, {<span class="tnvc">p2</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[<span class="tnv">loopmom</span>, <span class="tnv">extmom</span>]}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>;
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>, <span class="tnvc">dots</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Together.html" rel="nofollow">Together</a>[<span class="tnvc">dots</span> /.
    <span class="tnv">dotmap</span> /. <span class="tnv">DEN</span>[<span class="tnt">i_</span>] :&gt; <span class="tnv">dens</span>[[<span class="tnvc">i</span>]] /.
    <span class="tnv">den</span>[<span class="tnt">p_</span>] :&gt; <span class="tl">1</span>/<span class="tnvc">p</span>.<span class="tnvc">p</span> /. <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, ___] :&gt; <span class="tl">1</span>/(<span class="tnvc">p</span>.<span class="tnvc">p</span>-<span class="tnvc">m</span>) /.
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a>-&gt;<span class="tnv">ExpandDot</span> /. <span class="tnv">sp</span>[<span class="tnt">p1_</span>] :&gt; <span class="tnvc">p1</span>.<span class="tnvc">p1</span> /. <span class="tnv">sp</span>[<span class="tnt">p1_</span>, <span class="tnt">p2_</span>] :&gt; <span class="tnvc">p1</span>.<span class="tnvc">p2</span>
  ]];
]
<span class="tnv">IBPBasisSanityCheck</span>[<span class="tnt">ex_</span>] := <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Not an IBPBasis: "</span>, <span class="tnv">ex</span>]

<span class="tnv">DiagramToSector</span>[<span class="tnv">Diagram</span>[_, _, <span class="tnt">i_List</span>, <span class="tnt">o_List</span>, <span class="tnt">p_List</span>, _]] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">outfi2vi</span>, <span class="tnvc">edges</span>, <span class="tnvc">tag</span>},
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
   <span class="tnv">i</span> /. <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">fi</span>, <span class="tnv">vi</span>, <span class="tnv">fi</span>, <span class="tnv">mom</span>},
   <span class="tnv">o</span> /. <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">vi</span>, <span class="tnv">fi</span>, <span class="tnv">fi</span>, <span class="tnv">mom</span>},
   <span class="tnv">p</span> /. <span class="tnv">P</span>[_, _, _, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">vi1</span>, <span class="tnv">vi2</span>, <span class="tl">0</span>, <span class="tnv">mom</span>}
   ]
  ]
<span class="tnv">DiagramToSector</span>[<span class="tnv">CutDiagram</span>[
  <span class="tnv">Diagram</span>[_, _, <span class="tnt">i1_List</span>, <span class="tnt">o1_List</span>, <span class="tnt">p1_List</span>, _],
  <span class="tnv">Diagram</span>[_, _, <span class="tnt">i2_List</span>, <span class="tnt">o2_List</span>, <span class="tnt">p2_List</span>, _]
 ]] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">outfi2vi</span>, <span class="tnvc">edges</span>, <span class="tnvc">tag</span>},
  <span class="tnvc">outfi2vi</span> = <span class="tnv">o1</span> /. <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<span class="tnv">fi</span>, <span class="tnv">vi</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Association.html" rel="nofollow">Association</a>;
  <span class="tnvc">edges</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
    <span class="tnv">i1</span> /. <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">SS</span>[<span class="tnv">fi</span>], <span class="tnv">I1</span>[<span class="tnv">vi</span>], <span class="tnv">fi</span>, <span class="tnv">mom</span>},
    <span class="tnv">i2</span> /. <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">I2</span>[<span class="tnv">vi</span>], <span class="tnv">EE</span>[<span class="tnv">fi</span>], <span class="tnv">fi</span>, <span class="tnv">mom</span>},
    <span class="tnv">o2</span> /.
     <span class="tnv">F</span>[_, <span class="tnt">fi_</span>, <span class="tnt">vi_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">I1</span>[<span class="tnvc">outfi2vi</span>[<span class="tnv">fi</span>]], <span class="tnv">I2</span>[<span class="tnv">vi</span>],
       <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">fi</span> === -<span class="tl">2</span>, <span class="tl">2</span>, <span class="tl">1</span>], <span class="tnv">mom</span>},
    <span class="tnv">p1</span> /. <span class="tnv">P</span>[_, _, _, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">I1</span>[<span class="tnv">vi1</span>], <span class="tnv">I1</span>[<span class="tnv">vi2</span>], <span class="tl">0</span>, <span class="tnv">mom</span>},
    <span class="tnv">p2</span> /.
     <span class="tnv">P</span>[_, _, _, <span class="tnt">vi1_</span>, <span class="tnt">vi2_</span>, <span class="tnt">mom_</span>] :&gt; {<span class="tnv">I2</span>[<span class="tnv">vi2</span>], <span class="tnv">I2</span>[<span class="tnv">vi1</span>], <span class="tl">0</span>,
       <span class="tnv">mom</span> // <span class="tnv">AmpConjugateMomenta</span>}
    ]
  ]
<span class="tnv">SectorDeletePropagators</span>[<span class="tnt">sector_List</span>, {<span class="tnt">momentum_</span>}] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">rules</span>},
  <span class="tnvc">rules</span> = <span class="tnv">sector</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[{<span class="tnt">v1_</span>, <span class="tnt">v2_</span>, <span class="tl">0</span>, <span class="tnv">momentum</span> | -<span class="tnv">momentum</span>} :&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<span class="tnv">v1</span>, <span class="tnv">v2</span>]];
  <span class="tnv">sector</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[{_, _, <span class="tl">0</span>, <span class="tnv">momentum</span> | -<span class="tnv">momentum</span>}] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/MapAt.html" rel="nofollow">MapAt</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[<span class="tnvc">rules</span>], <span class="tnv">#</span>, {;; , ;; <span class="tl">2</span>}] &amp;
]
<span class="tnv">SectorDeletePropagators</span>[<span class="tnt">sector_List</span>, <span class="tnt">momenta_List</span>] :=
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Fold.html" rel="nofollow">Fold</a>[<span class="tnv">SectorDeletePropagators</span>[<span class="tnv">#1</span>, {<span class="tnv">#2</span>}] &amp;, <span class="tnv">sector</span>, <span class="tnv">momenta</span>]
<span class="tnv">SectorDeletePropagators</span>[<span class="tnt">momenta_List</span>] :=
  <span class="tnv">SectorDeletePropagators</span>[<span class="tnv">#</span>, <span class="tnv">momenta</span>] &amp;

<span class="tnv">IBPBasisToInclusive</span>[<span class="tnv">IBPBasis</span>[<span class="tnt">bid_</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">extmom_List</span>, <span class="tnt">dens_List</span>, <span class="tnt">denmap_</span>, <span class="tnt">dotmap_</span>]] :=
  <a class="tnv" href="alibrary.html#CompleteIBPBasis">CompleteIBPBasis</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[
      <span class="tnv">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tnv">den</span>[_, (<span class="tl">1</span>-<span class="tnv">x</span>)<span class="tnv">sp</span>[<span class="tnv">q</span>], <span class="tnv">cut</span>]],
      <span class="tnv">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[<span class="tnv">den</span>[<span class="tnt">p_</span>, (<span class="tl">1</span>-<span class="tnv">x</span>)<span class="tnv">sp</span>[<span class="tnv">q</span>], <span class="tnv">cut</span>] :&gt; <span class="tnv">den</span>[<span class="tnv">p</span>, <span class="tl">0</span>, <span class="tnv">irr</span>]]
    ],
    <span class="tnv">loopmom</span>, <span class="tnv">extmom</span>, <span class="tnv">bid</span>]

<span class="tnv">SectorToSubTopologies</span>[<span class="tnt">sector_</span>, <span class="tnt">mastersubsectors_</span>] :=
 <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">eqsectors</span>, <span class="tnvc">tag</span>, <span class="tnvc">edges</span>, <span class="tnvc">idx</span>, <span class="tnvc">eqs</span>, <span class="tnvc">result</span>},
  <span class="tnvc">result</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>;
  <span class="tnvc">eqsectors</span> = <a class="tnv" href="#EqualSectorSet">EqualSectorSet</a>[<span class="tnv">sector</span>];
  <span class="tc">(*{tag,edges}=CanonicalSector[sector];*)</span>
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
   <span class="tnvc">edges</span> = <span class="tnvc">eqsectors</span>[<span class="tnvc">tag</span>];
   <span class="tc">(*Print["EQ SECTOR:",edges//SectorXGraph];*)</span>
   <span class="tnvc">idx</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/FirstPosition.html" rel="nofollow">FirstPosition</a>[
      <span class="tnv">mastersubsectors</span>, _?(<a class="tnb" href="https://reference.wolfram.com/language/ref/KeyExistsQ.html" rel="nofollow">KeyExistsQ</a>[<span class="tnv">#</span>, <span class="tnvc">tag</span>] &amp;), {-<span class="tl">1</span>}, {<span class="tl">1</span>},
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Heads.html" rel="nofollow">Heads</a> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/False.html" rel="nofollow">False</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>;
   <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">idx</span> &gt;= <span class="tl">0</span>,
    <span class="tnvc">eqs</span> = (<span class="tnvc">edges</span>[[;; , <span class="tl">4</span>]] /.
        <span class="tnv">p</span> : <a class="tnb" href="https://reference.wolfram.com/language/ref/Except.html" rel="nofollow">Except</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a> | <a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a> | <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a> | <a class="tnb" href="https://reference.wolfram.com/language/ref/Power.html" rel="nofollow">Power</a>, <span class="tnt">_Symbol</span>] :&gt;
         <span class="tnv">OLD</span>[<span class="tnv">p</span>]) - (<span class="tnv">mastersubsectors</span>[[<span class="tnvc">idx</span>]][<span class="tnvc">tag</span>][[;; , <span class="tl">4</span>]] /.
        <span class="tnv">p</span> : <a class="tnb" href="https://reference.wolfram.com/language/ref/Except.html" rel="nofollow">Except</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a> | <a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a> | <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a> | <a class="tnb" href="https://reference.wolfram.com/language/ref/Power.html" rel="nofollow">Power</a>, <span class="tnt">_Symbol</span>] :&gt; <span class="tnv">NEW</span>[<span class="tnv">p</span>]);
    <span class="tc">(*Print["EQ:",eqs];*)</span>
    <span class="tc">(*Print[mastersubsectors[[idx,1]]//
    SectorXGraph];*)</span>
    <span class="tnvc">result</span> = {<span class="tnvc">idx</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Solve.html" rel="nofollow">Solve</a>[<span class="tnvc">eqs</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">#</span> == <span class="tl">0</span> &amp;], <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnvc">eqs</span>, <span class="tnt">_OLD</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a> //
       <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[(<span class="tnv">OLD</span> | <span class="tnv">NEW</span>)[<span class="tnt">p_</span>] :&gt; <span class="tnv">p</span>]};
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Break.html" rel="nofollow">Break</a>[];
    ]
   ,
   {<span class="tnvc">tag</span>, <span class="tnvc">eqsectors</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Keys.html" rel="nofollow">Keys</a>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">result</span> === <a class="tnb" href="https://reference.wolfram.com/language/ref/None.html" rel="nofollow">None</a>, <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Failed to match a sector to topologies"</span>]];
  <span class="tnvc">result</span>
  ]

<a class="tnb" href="https://reference.wolfram.com/language/ref/ClearAll.html" rel="nofollow">ClearAll</a>[<span class="tnv">ExpandDot</span>, <span class="tnv">LinearizeDot</span>]
<span class="tnv">ExpandDot</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Distribute.html" rel="nofollow">Distribute</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>[<span class="tnv">a</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Expand.html" rel="nofollow">Expand</a>[<span class="tnv">b</span>]]] /. <a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a> -&gt; <span class="tnv">LinearizeDot</span>
<span class="tnv">LinearizeDot</span>[<span class="tnt">k1_</span>.*<span class="tnt">a_Symbol</span>, <span class="tnt">k2_</span>. <span class="tnt">b_Symbol</span>] := <span class="tnv">k1</span> <span class="tnv">k2</span> <a class="tnb" href="https://reference.wolfram.com/language/ref/Dot.html" rel="nofollow">Dot</a> @@ <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>[{<span class="tnv">a</span>, <span class="tnv">b</span>}]
<span class="tnv">LinearizeDot</span>[<span class="tnt">a_</span>, <span class="tnt">b_</span>] := <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"ExpandDot: don't know how to expand "</span>, <span class="tnv">a</span>.<span class="tnv">b</span>]

<span class="tnv">SemiInclusiveCuts</span>[<span class="tnt">in_String</span>, <span class="tnt">out1_String</span>, <span class="tnt">order_Integer</span>, <span class="tnt">projector_String</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">particles</span>, <span class="tnvc">priority</span>, <span class="tnvc">n1</span>, <span class="tnvc">n2</span>, <span class="tnvc">proj</span>},
  <span class="tnvc">particles</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[{<span class="tnv">out1</span>}, <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[{<span class="ts">"g"</span>, <span class="ts">"q"</span>, <span class="ts">"Q"</span>, <span class="ts">"c"</span>, <span class="ts">"C"</span>, <span class="ts">"-"</span>}, <span class="tnv">out1</span>]];
  <span class="tnvc">priority</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/PositionIndex.html" rel="nofollow">PositionIndex</a>[<span class="tnvc">particles</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Tuples.html" rel="nofollow">Tuples</a>[<span class="tnvc">particles</span>, <span class="tnv">order</span> + <span class="tl">1</span>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="ts">"-"</span>] /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnvc">priority</span>] /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Sort.html" rel="nofollow">Sort</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnvc">particles</span>[[<span class="tnv">#</span>]]&amp;]] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/FreeQ.html" rel="nofollow">FreeQ</a>[<span class="tnv">out1</span>] /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Not.html" rel="nofollow">Not</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[(<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">#</span>] &gt;= <span class="tl">2</span>)&amp;] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[(<a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">#</span>, <span class="ts">"c"</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">#</span>, <span class="ts">"C"</span>])&amp;] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[(<a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">#</span>, <span class="ts">"q"</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">#</span>, <span class="ts">"Q"</span>])&amp;] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      <span class="tnvc">n1</span> = <span class="tnv">order</span> - (<span class="tnvc">n2</span> + <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">#</span>] - <span class="tl">1</span>);
      <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">n1</span> &gt;= <span class="tnvc">n2</span>, <span class="tnv">Cut</span>[<span class="tnv">in</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/StringJoin.html" rel="nofollow">StringJoin</a>@@<span class="tnv">#</span>, <span class="tnvc">n1</span>, <span class="tnvc">n2</span>, <span class="tnv">projector</span>], <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>]
      ,
      {<span class="tnvc">n2</span>, <span class="tl">0</span>, <span class="tnv">order</span>}]&amp;
    ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a>
]

<span class="tnv">ListAllCuts</span>[<span class="tnt">in_String</span>, <span class="tnt">out_</span>, <span class="tnt">order_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">n1</span>, <span class="tnvc">n2</span>},
  (<span class="tnv">out</span> /. <span class="tnt">proc_String</span> :&gt; (<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>@@<a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a>@<a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <span class="tnvc">n1</span> = <span class="tnv">order</span> - (<span class="tnvc">n2</span> + <a class="tnb" href="https://reference.wolfram.com/language/ref/StringLength.html" rel="nofollow">StringLength</a>[<span class="tnv">proc</span>] - <span class="tl">1</span>);
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">n1</span> &lt; <span class="tl">0</span>, <span class="tl">0</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">n1</span> &gt;= <span class="tnvc">n2</span>,
        <span class="tnv">Cut</span>[<span class="tnv">in</span>, <span class="tnv">proc</span>, <span class="tnvc">n1</span>, <span class="tnvc">n2</span>, <span class="ts">"I"</span>],
        <span class="tnv">Cut</span>[<span class="tnv">in</span>, <span class="tnv">proc</span>, <span class="tnvc">n2</span>, <span class="tnvc">n1</span>, <span class="ts">"I"</span>] (<span class="tnv">REAL</span>-<span class="tl">1</span>)
      ]
    ]
    ,
    {<span class="tnvc">n2</span>, <span class="tl">0</span>, <span class="tnv">order</span>}])) // <a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">#</span>, <span class="tnt">_Cut</span>]&amp;
]

<span class="tnv">ProcessCutList</span>[{<span class="tnt">in_String</span>, <span class="tnt">out_</span>, <span class="tnt">order_Integer</span>}] := <span class="tnv">ListAllCuts</span>[<span class="tnv">in</span>, <span class="tnv">out</span>, <span class="tnv">order</span>] // <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_Cut</span>]
<span class="tnv">ProcessCutList</span>[{<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>[<span class="tnt">in_String</span>, <span class="tnt">out1_String</span>], <span class="tnt">order_Integer</span>, <span class="tnt">projector_String</span>}] := <span class="tnv">SemiInclusiveCuts</span>[<span class="tnv">in</span>, <span class="tnv">out1</span>, <span class="tnv">order</span>, <span class="tnv">projector</span>]
<span class="tnv">ProcessCutList</span>[<span class="tnt">l_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">ProcessCutList</span>, <span class="tnv">l</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>]
<span class="tnv">ProcessCutList</span>[<span class="tnt">ex_</span>] := <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"ProcessCutList: bad process format "</span>, <span class="tnv">ex</span>]</pre>
<p>Mass dimension</p>
<pre><a class="tnb" href="https://reference.wolfram.com/language/ref/ClearAll.html" rel="nofollow">ClearAll</a>[<span class="tnv">MassDim</span>];
<span class="tnv">MassDim</span>[<span class="tnt">ex_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">MassDim</span>, <span class="tnv">ex</span>]
<span class="tnv">MassDim</span>[<span class="tnt">ex_Series</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/MapAt.html" rel="nofollow">MapAt</a>[<span class="tnv">MassDim</span>, <span class="tnv">ex</span>, {<span class="tl">3</span>}]
<span class="tnv">MassDim</span>[<span class="tnt">x_</span> /; <a class="tnb" href="https://reference.wolfram.com/language/ref/FreeQ.html" rel="nofollow">FreeQ</a>[<span class="tnv">x</span>, <span class="tnt">_sp</span>|<span class="tnt">_dot</span>|<span class="tnt">_B</span>|<span class="tnt">_den</span>]] := <span class="tl">0</span>
<span class="tnv">MassDim</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/HoldPattern.html" rel="nofollow">HoldPattern</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>[<span class="tnt">a__</span>]]] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a> @@ <span class="tnv">MassDim</span> /@ {<span class="tnv">a</span>}
<span class="tnv">MassDim</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/HoldPattern.html" rel="nofollow">HoldPattern</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>[<span class="tnt">a__</span>]]] := <span class="tnv">SameMassDim</span> @@ <span class="tnv">MassDim</span> /@ {<span class="tnv">a</span>}
<span class="tnv">MassDim</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/HoldPattern.html" rel="nofollow">HoldPattern</a>[<span class="tnt">a_</span>^<span class="tnt">b_</span>]] := <span class="tnv">MassDim</span>[<span class="tnv">a</span>]*<span class="tnv">b</span>
<span class="tnv">MassDim</span>[<span class="tnv">B</span>[_, <span class="tnt">idx__</span>]] := -<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>[<span class="tnv">idx</span>]
<span class="tnv">MassDim</span>[<span class="tnv">sp</span>[__]] := <span class="tl">1</span>
<span class="tnv">MassDim</span>[<span class="tnv">dot</span>[__]] := <span class="tl">1</span>
<span class="tnv">MassDim</span>[<span class="tnv">den</span>[__]] := -<span class="tl">1</span>
<span class="tnv">MassDim</span>[<span class="tnt">ex_</span>] := <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Don't know the mass dimension of a "</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Head.html" rel="nofollow">Head</a>[<span class="tnv">ex</span>]]
<a class="tnb" href="https://reference.wolfram.com/language/ref/ClearAll.html" rel="nofollow">ClearAll</a>[<span class="tnv">SameMassDim</span>];
<span class="tnv">SameMassDim</span>[<span class="tnt">a_</span> ..] := <span class="tnv">a</span></pre>
<h3 id="RedistributeDots"><code>RedistributeDots[]</code></h3>
<p>Master integral fixing</p>
<pre><a class="tnv" href="#RedistributeDots">RedistributeDots</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>], <span class="tnt">ibpbasis_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">iscut</span>, <span class="tnvc">badd</span>, <span class="tnvc">freeslots</span>},
  <span class="tnvc">iscut</span> = <span class="tnv">ibpbasis</span>[[<span class="tnv">bid</span>, <span class="tl">4</span>]] // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">den</span>[_, _, <span class="tnv">cut</span>] -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>, <span class="tnt">_den</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/False.html" rel="nofollow">False</a>];
  <span class="tnv">newidx</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#1</span>, <span class="tl">1</span>, <span class="tnv">#2</span>]&amp;, {<span class="tnvc">iscut</span>, {<span class="tnv">idx</span>}}];
  <span class="tnvc">badd</span> = <span class="tnv">IndicesToR</span>[{<span class="tnv">idx</span>}] - <span class="tnv">IndicesToR</span>[<span class="tnv">newidx</span>];
  <span class="tnvc">freeslots</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#1</span> || <span class="tnv">#2</span> &lt;= <span class="tl">0</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>, <span class="tnv">#3</span>]&amp;, {<span class="tnvc">iscut</span>, {<span class="tnv">idx</span>}, <a class="tnb" href="https://reference.wolfram.com/language/ref/Range.html" rel="nofollow">Range</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[{<span class="tnv">idx</span>}]]}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/IntegerPartitions.html" rel="nofollow">IntegerPartitions</a>[<span class="tnvc">badd</span> + <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">freeslots</span>], {<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">freeslots</span>]}] - <span class="tl">1</span> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Permutations.html" rel="nofollow">Permutations</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>, {<span class="tnvc">freeslots</span>, <span class="tnv">#</span>}]&amp; /* (<a class="tnb" href="https://reference.wolfram.com/language/ref/SparseArray.html" rel="nofollow">SparseArray</a>[<span class="tnv">#</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">iscut</span>]]&amp;) /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Reverse.html" rel="nofollow">Reverse</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">B</span>[<span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a> @@ (<span class="tnv">newidx</span> + <span class="tnv">#</span>)]&amp;]
]
<span class="tnv">AddNumerators</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>], <span class="tnt">ibpbasis_List</span>, <span class="tnt">nadd_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">isok</span>, <span class="tnvc">freeslots</span>},
  <span class="tnvc">isok</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/And.html" rel="nofollow">And</a>, {
    <span class="tnv">ibpbasis</span>[[<span class="tnv">bid</span>, <span class="tl">4</span>]] // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">den</span>[_, _, <span class="tnv">irr</span>|<span class="tnv">cut</span>] -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/False.html" rel="nofollow">False</a>, <span class="tnt">_den</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>],
    {<span class="tnv">idx</span>} // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[_?<a class="tnb" href="https://reference.wolfram.com/language/ref/NonPositive.html" rel="nofollow">NonPositive</a> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>, _ -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/False.html" rel="nofollow">False</a>]
  }];
  <span class="tnvc">freeslots</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#1</span>, <span class="tnv">#2</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>]&amp;, <span class="tnvc">isok</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/IntegerPartitions.html" rel="nofollow">IntegerPartitions</a>[<span class="tnv">nadd</span> + <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">freeslots</span>], {<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">freeslots</span>]}] - <span class="tl">1</span> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Permutations.html" rel="nofollow">Permutations</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>, {<span class="tnvc">freeslots</span>, <span class="tnv">#</span>}]&amp; /* (<a class="tnb" href="https://reference.wolfram.com/language/ref/SparseArray.html" rel="nofollow">SparseArray</a>[<span class="tnv">#</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">isok</span>]]&amp;) /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Reverse.html" rel="nofollow">Reverse</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">B</span>[<span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a> @@ ({<span class="tnv">idx</span>} - <span class="tnv">#</span>)]&amp;]
]
<span class="tnv">AddDenominators</span>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>], <span class="tnt">ibpbasis_List</span>, <span class="tnt">nadd_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">isok</span>, <span class="tnvc">freeslots</span>},
  <span class="tnvc">isok</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/And.html" rel="nofollow">And</a>, {
    <span class="tnv">ibpbasis</span>[[<span class="tnv">bid</span>, <span class="tl">4</span>]] // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">den</span>[_, _, <span class="tnv">irr</span>|<span class="tnv">cut</span>] -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/False.html" rel="nofollow">False</a>, <span class="tnt">_den</span> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>],
    {<span class="tnv">idx</span>} // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[_?<a class="tnb" href="https://reference.wolfram.com/language/ref/Positive.html" rel="nofollow">Positive</a> -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>, _ -&gt; <a class="tnb" href="https://reference.wolfram.com/language/ref/False.html" rel="nofollow">False</a>]
  }];
  <span class="tnvc">freeslots</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/MapIndexed.html" rel="nofollow">MapIndexed</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">#1</span>, <span class="tnv">#2</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>]&amp;, <span class="tnvc">isok</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/IntegerPartitions.html" rel="nofollow">IntegerPartitions</a>[<span class="tnv">nadd</span> + <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">freeslots</span>], {<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">freeslots</span>]}] - <span class="tl">1</span> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Permutations.html" rel="nofollow">Permutations</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>, {<span class="tnvc">freeslots</span>, <span class="tnv">#</span>}]&amp; /* (<a class="tnb" href="https://reference.wolfram.com/language/ref/SparseArray.html" rel="nofollow">SparseArray</a>[<span class="tnv">#</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">isok</span>]]&amp;) /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Reverse.html" rel="nofollow">Reverse</a> //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">B</span>[<span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a> @@ ({<span class="tnv">idx</span>} + <span class="tnv">#</span>)]&amp;]
]</pre>
<h2 id="EpsilonFormSolutions">Epsilon form solutions</h2>
<h3 id="EpsilonFormFundamentalSolutionSeries"><code>EpsilonFormFundamentalSolutionSeries[]</code></h3>
<p>Return a list of expressions, each representing an order of
expansion in epsilon of the solution to D[J,x]=epsilon*S.J.
Each order is a list of {Hlog[...], matrix} entries.</p>
<pre><a class="tnv" href="#EpsilonFormFundamentalSolutionSeries">EpsilonFormFundamentalSolutionSeries</a>[<span class="tnt">S_</span>, <span class="tnt">x_</span>, <span class="tnt">orders_Integer</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">Sa</span>, <span class="tnvc">result</span>},
  <span class="tnvc">Sa</span> = <a class="tnv" href="utils.html#MxApart">MxApart</a>[<span class="tnv">S</span>, <span class="tnv">x</span>] // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[{<span class="tl">1</span>/(<span class="tnt">k_</span>.*<span class="tnv">x</span>+<span class="tnt">c_</span>.), <span class="tnt">mx_</span>} :&gt; {-<span class="tnv">c</span>/<span class="tnv">k</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/SparseArray.html" rel="nofollow">SparseArray</a>[<span class="tnv">mx</span>/<span class="tnv">k</span>]}];
  <span class="tnvc">result</span> = {
    <span class="tc">(* Order 0 result is just the identity matrix: *)</span>
    {<a class="tnb" href="https://reference.wolfram.com/language/ref/List.html" rel="nofollow">List</a>[{}, <a class="tnb" href="https://reference.wolfram.com/language/ref/SparseArray.html" rel="nofollow">SparseArray</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/IdentityMatrix.html" rel="nofollow">IdentityMatrix</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">S</span>]]]]}
  };
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Do.html" rel="nofollow">Do</a>[
    <span class="tnvc">result</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/AppendTo.html" rel="nofollow">AppendTo</a>[<span class="tnvc">result</span>,
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
        <span class="tnvc">result</span>[[-<span class="tl">1</span>]] //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[{<a class="tnb" href="https://reference.wolfram.com/language/ref/Prepend.html" rel="nofollow">Prepend</a>[<span class="tnv">#</span>[[<span class="tl">1</span>]], <span class="tnv">i</span>], <span class="tnvc">Sa</span>[[<span class="tnv">i</span>, <span class="tl">2</span>]].<span class="tnv">#</span>[[<span class="tl">2</span>]]//<a class="tnb" href="https://reference.wolfram.com/language/ref/Normal.html" rel="nofollow">Normal</a>//<a class="tnb" href="https://reference.wolfram.com/language/ref/SparseArray.html" rel="nofollow">SparseArray</a>}&amp;] //
          <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[{_, <span class="tnt">mx_</span>?<a class="tnv" href="utils.html#ZeroMatrixQ">ZeroMatrixQ</a>}]
        ,
        {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">Sa</span>]}
      ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>]
    ];
    ,
    <span class="tnv">orders</span>-<span class="tl">1</span>];
  <span class="tnvc">result</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#MapReplace">MapReplace</a>[
    {{}, <span class="tnt">mx_</span>} :&gt; {<span class="tl">1</span>, <span class="tnv">mx</span>},
    {<span class="tnt">idx_List</span>, <span class="tnt">mx_</span>} :&gt; {<span class="tnv">G</span>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>@@<span class="tnvc">Sa</span>[[<span class="tnv">idx</span>,<span class="tl">1</span>]],<span class="tnv">x</span>], <span class="tnv">mx</span>}
  ]]
]

<span class="tnv">SeriesOfMatrices</span>[<span class="tnt">mxlist_List</span>, <span class="tnt">var_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
  <a class="tnb" href="https://reference.wolfram.com/language/ref/SeriesData.html" rel="nofollow">SeriesData</a>[
    <span class="tnv">var</span>,
    <span class="tl">0</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">mxk</span> === <span class="tl">0</span>, <span class="tl">0</span>, <span class="tnv">mxk</span>[[<span class="tnv">i</span>,<span class="tnv">j</span>]]], {<span class="tnv">mxk</span>, <span class="tnv">mxlist</span>}],
    <span class="tl">0</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">mxlist</span>],
    <span class="tl">1</span>]
  ,
  {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">mxlist</span>[[<span class="tl">1</span>]]]},
  {<span class="tnv">j</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">mxlist</span>[[<span class="tl">1</span>, <span class="tl">1</span>]]]}
]

<span class="tnv">SeriesOfVectors</span>[<span class="tnt">mxlist_List</span>, <span class="tnt">var_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
  <a class="tnb" href="https://reference.wolfram.com/language/ref/SeriesData.html" rel="nofollow">SeriesData</a>[
    <span class="tnv">var</span>,
    <span class="tl">0</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnv">mxk</span> === <span class="tl">0</span>, <span class="tl">0</span>, <span class="tnv">mxk</span>[[<span class="tnv">i</span>]]], {<span class="tnv">mxk</span>, <span class="tnv">mxlist</span>}],
    <span class="tl">0</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">mxlist</span>],
    <span class="tl">1</span>]
  ,
  {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">mxlist</span>[[<span class="tl">1</span>]]]}
]

<span class="tnv">KnownBasisMap</span>[<span class="tnv">knownibp</span>:{{<span class="tc">(*file*)</span><span class="tnt">_String</span>, <span class="tc">(*idx*)</span><span class="tnt">_Integer</span>, <span class="tc">(*exb*)</span>_} ...}, <span class="tnt">masters_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">kmx</span>},
  <span class="tnvc">kmx</span> = <span class="tnv">knownibp</span>[[;;,<span class="tl">3</span>]] // <a class="tnv" href="utils.html#CoefficientMatrix">CoefficientMatrix</a>[<span class="tnv">masters</span>];
  <span class="tnv">idx</span> = <span class="tnvc">kmx</span> // <a class="tnv" href="#SelectAnyBasis">SelectAnyBasis</a>;
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">idx</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">masters</span>]];
  <span class="tc">(* k = kmx . masters =&gt; masters = kmx^-1 . k *)</span>
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Inverse.html" rel="nofollow">Inverse</a>[<span class="tnvc">kmx</span>[[<span class="tnv">idx</span>, ;;]]].<a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">Known</span>[<span class="tnv">#</span>[[<span class="tl">1</span>]], <span class="tnv">#</span>[[<span class="tl">2</span>]]]&amp;, <span class="tnv">knownibp</span>[[<span class="tnv">idx</span>]]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Rule.html" rel="nofollow">Rule</a>, {<span class="tnv">masters</span>, <span class="tnv">#</span>}]&amp;
]</pre>
<p>** LIB IBP **</p>
<pre><span class="tnv">LoadKiraSectorMappings</span>[<span class="tnt">nmomenta_Integer</span>, <span class="tnt">filename_String</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">text</span>, <span class="tnvc">sector1</span>, <span class="tnvc">mommap</span>, <span class="tnvc">jacobian</span>, <span class="tnvc">sector2</span>, <span class="tnvc">bid2</span>},
  <span class="tc">(* Example:
   *   14 l1 l1 l2 l2+l1 1 14 3 0 {place==holder} {place==holder} -1 1 2 3 -1 0 0
   * Decoding:
   * - 14: i=0..2^jule ???
   * - l1 l1 l2 l2+l1: change of variables {l1 = l1, l2 = l2+l1};
   * - 1: the jacobian
   * - 14: sector
   * - 3: n of props
   * - 0: ext symm???
   * - {place==holder} ext sym???
   * - {place==holder} ext sym???
   * - -1 1 2 3 -1: ing[g], g = 0..jule-1
   * - 0: symDOTS
   * - 0: topology
   *)</span>
  <span class="tnvc">text</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Import.html" rel="nofollow">Import</a>[<span class="tnv">filename</span>, <span class="ts">"Text"</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">text</span> === <a class="tnb" href="https://reference.wolfram.com/language/ref/$Failed.html" rel="nofollow">$Failed</a>, <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Failed to read the sectorRelations file"</span>]];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/StringSplit.html" rel="nofollow">StringSplit</a>[<span class="tnvc">text</span>, <span class="ts">"\n"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/StringSplit.html" rel="nofollow">StringSplit</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[(
    <span class="tnvc">sector1</span> = <span class="tnv">#</span>[[<span class="tl">1</span>]]//<a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>;
    <span class="tnvc">mommap</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<span class="tnv">#</span>[[<span class="tl">2</span>+<span class="tl">2</span>*<span class="tnv">i</span>]]-&gt;<span class="tnv">#</span>[[<span class="tl">2</span>+<span class="tl">2</span>*<span class="tnv">i</span>+<span class="tl">1</span>]], {<span class="tnv">i</span>, <span class="tl">0</span>, <span class="tnv">nmomenta</span>-<span class="tl">1</span>}] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>, <span class="tnv">#</span>, {<span class="tl">2</span>}]&amp;;
    <span class="tnvc">jacobian</span> = <span class="tnv">#</span>[[<span class="tl">2</span> + <span class="tnv">nmomenta</span>*<span class="tl">2</span>]]//<a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>;
    <span class="tnvc">sector2</span> = <span class="tnv">#</span>[[<span class="tl">3</span> + <span class="tnv">nmomenta</span>*<span class="tl">2</span>]]//<a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>;
    <span class="tnvc">bid2</span> = (<span class="tnv">#</span>[[-<span class="tl">1</span>]]//<a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>) + <span class="tl">1</span>;
    {<span class="tnvc">sector1</span>, <span class="tnvc">bid2</span>, <span class="tnvc">sector2</span>, <span class="tnvc">jacobian</span>, <span class="tnvc">mommap</span>}
  )&amp;] \
    // <a class="tnb" href="https://reference.wolfram.com/language/ref/SortBy.html" rel="nofollow">SortBy</a>[{-<span class="tnv">#</span>[[<span class="tl">1</span>]], -<span class="tnv">#</span>[[<span class="tl">4</span>]], <span class="tnv">#</span>[[<span class="tl">5</span>, ;;, <span class="tl">2</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#TermCount">TermCount</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>]}&amp;]
]</pre>
<h3 id="KiraSymmetryMaps"><code>KiraSymmetryMaps[]</code></h3>
<p>Return a list of momenta maps for each amplitude that removes
symmetric duplicates among the denominator sets.</p>
<p>Amplitudes are defined by the sets of den[__] objects inside,
otherwise their structure does not matter.</p>
<p>This is slow; use SymmetryMaps[] in stead.</p>
<pre><a class="tnv" href="#KiraSymmetryMaps">KiraSymmetryMaps</a>[<span class="tnt">amplitudes_List</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">extmom_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">densets</span>, <span class="tnvc">uniqdensets</span>, <span class="tnvc">densetindices</span>, <span class="tnvc">ibpbasis</span>, <span class="tnvc">confdir</span>, <span class="tnvc">dens</span>, <span class="tnvc">topsector</span>, <span class="tnvc">text</span>, <span class="tnvc">sector1</span>, <span class="tnvc">bid2</span>, <span class="tnvc">sector2</span>, <span class="tnvc">jacobian</span>, <span class="tnvc">mommap</span>},
  <span class="tnvc">densets</span> = <span class="tnv">amplitudes</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[
    <a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_den</span>] /* <a class="tnv" href="alibrary.html#NormalizeDens">NormalizeDens</a> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a>@@<span class="tnv">loopmom</span>]]
  ];
  {<span class="tnvc">uniqdensets</span>, <span class="tnvc">densetindices</span>} = <a class="tnv" href="#UniqueSupertopologyMapping">UniqueSupertopologyMapping</a>[<span class="tnvc">densets</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"Got a total of "</span>, <span class="tnvc">uniqdensets</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>, <span class="ts">" denominator sets"</span>];
  <span class="tnvc">ibpbasis</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnv" href="alibrary.html#CompleteIBPBasis">CompleteIBPBasis</a>[<span class="tnvc">uniqdensets</span>[[<span class="tnv">i</span>]], <span class="tnv">loopmom</span>, <span class="tnv">extmom</span>, <span class="tnv">i</span>], {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">uniqdensets</span>]}];
  <span class="tnvc">confdir</span> = <span class="ts">"kira-sym"</span>;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Quiet.html" rel="nofollow">Quiet</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteDirectory.html" rel="nofollow">DeleteDirectory</a>[<span class="tnvc">confdir</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteContents.html" rel="nofollow">DeleteContents</a>-&gt;<a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>], {<a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteDirectory.html" rel="nofollow">DeleteDirectory</a>::<span class="tne">nodir</span>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Quiet.html" rel="nofollow">Quiet</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/CreateDirectory.html" rel="nofollow">CreateDirectory</a>[<span class="tnvc">confdir</span>], {<a class="tnb" href="https://reference.wolfram.com/language/ref/CreateDirectory.html" rel="nofollow">CreateDirectory</a>::<span class="tne">filex</span>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Quiet.html" rel="nofollow">Quiet</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/CreateDirectory.html" rel="nofollow">CreateDirectory</a>[<span class="tnvc">confdir</span> &lt;&gt; <span class="ts">"/config"</span>], {<a class="tnb" href="https://reference.wolfram.com/language/ref/CreateDirectory.html" rel="nofollow">CreateDirectory</a>::<span class="tne">filex</span>}];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">confdir</span> &lt;&gt; <span class="ts">"/jobs.yaml"</span>,
    <span class="ts">"jobs:\n"</span>,
    <span class="ts">" - reduce_sectors:\n"</span>,
    <span class="ts">"    integral_ordering: 6\n"</span>,
    <span class="ts">"    run_symmetries: true\n"</span>,
    <span class="ts">"    run_initiate: false\n"</span>,
    <span class="ts">"    run_pyred: false\n"</span>,
    <span class="ts">"    run_triangular: false\n"</span>,
    <span class="ts">"    run_back_substitution: false\n"</span>
  ];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">confdir</span> &lt;&gt; <span class="ts">"/config/kinematics.yaml"</span>,
    <span class="ts">"kinematics:\n"</span>,
    <span class="ts">" incoming_momenta: ["</span>, <span class="tnv">extmom</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">#</span>, <span class="ts">", "</span>]&amp;, <span class="ts">"]\n"</span>,
    <span class="ts">" kinematic_invariants:\n"</span>,
    <span class="ts">"  - [qq,  2]\n"</span>,
    <span class="ts">"  - [mt2,  2]\n"</span>,
    <span class="ts">"  - [x, 0]\n"</span>,
    <span class="ts">" scalarproduct_rules:\n"</span>,
    <span class="ts">"  - [[q,q], qq]\n"</span>,
    <span class="ts">" symbol_to_replace_by_one: qq"</span>
  ];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">confdir</span> &lt;&gt; <span class="ts">"/config/integralfamilies.yaml"</span>,
    <span class="ts">"integralfamilies:\n"</span>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
      <span class="tnvc">dens</span> = <span class="tnvc">ibpbasis</span>[[<span class="tnv">bid</span>, <span class="tl">4</span>]];
      <span class="tnvc">topsector</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">dens</span>[[<span class="tnv">i</span>]], <span class="tnv">den</span>[_, _, <span class="tnv">irr</span>]], <span class="tl">0</span>, <span class="tl">2</span>^(<span class="tnv">i</span>-<span class="tl">1</span>)], {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]}]
        // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>];
      {
        <span class="ts">"  - name: \""</span>, <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"\"\n"</span>,
        <span class="ts">"    loop_momenta: ["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">loopmom</span>, <span class="ts">", "</span>], <span class="ts">"]\n"</span>,
        <span class="ts">"    top_level_sectors: ["</span>, <span class="tnvc">topsector</span>, <span class="ts">"]\n"</span>,
        <span class="ts">"    propagators:\n"</span>,
        <span class="tnvc">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[{
          <span class="tnv">den</span>[<span class="tnt">p_</span>] | <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tl">0</span>, ___] :&gt; {<span class="ts">"      - [\""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>[<span class="tnv">p</span>], <span class="ts">"\", 0]\n"</span>},
          <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, ___] :&gt; {<span class="ts">"      - [\""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>[<span class="tnv">p</span>], <span class="ts">"\", \""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>[<span class="tnv">m</span> /. <span class="tnv">sp</span>[<span class="tnv">q</span>] -&gt; <span class="tnv">qq</span>], <span class="ts">"\"]\n"</span>},
          <span class="tnt">d_</span> :&gt; <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"MkKiraConfig: bad denominator form: "</span>, <span class="tnv">d</span>]
        }]],
        <span class="ts">"    cut_propagators: ["</span>,
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Range.html" rel="nofollow">Range</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">dens</span>[[<span class="tnv">#</span>]], <span class="tnv">den</span>[_, _, <span class="tnv">cut</span>]]&amp;], <span class="ts">", "</span>],
        <span class="ts">"]\n"</span>
      }
      ,
      {<span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">ibpbasis</span>]}]
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Run.html" rel="nofollow">Run</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"./kira.sh "</span>, <span class="tnvc">confdir</span>, <span class="ts">"/jobs.yaml"</span>]]//<a class="tnv" href="utils.html#TM">TM</a>//<span class="tnv">#</span> =!= <span class="tl">0</span>&amp;,
    <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Failed to run kira"</span>];
  ];
  <span class="tnv">uniqdensetmaps</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <span class="tnvc">dens</span> = <span class="tnvc">ibpbasis</span>[[<span class="tnv">bid</span>, <span class="tl">4</span>]];
    <span class="tnvc">topsector</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnvc">dens</span>[[<span class="tnv">i</span>]], <span class="tnv">den</span>[_, _, <span class="tnv">irr</span>]], <span class="tl">0</span>, <span class="tl">2</span>^(<span class="tnv">i</span>-<span class="tl">1</span>)], {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">dens</span>]}]
      // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>];
    <span class="tc">(* {{sector1, bid2, sector2, jacobian, mommap}} *)</span>
    <span class="tnv">topsymmetries</span> = <span class="tnv">LoadKiraSectorMappings</span>[
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">loopmom</span>],
      <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnvc">confdir</span>, <span class="ts">"/sectormappings/"</span>, <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"/sectorRelations"</span>]
    ] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[{<span class="tnvc">topsector</span>, _, _, _, _}];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">topsymmetries</span>] &gt; <span class="tl">0</span>,
      {<span class="tnvc">sector1</span>, <span class="tnvc">bid2</span>, <span class="tnvc">sector2</span>, <span class="tnvc">jacobian</span>, <span class="tnvc">mommap</span>} = <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>[<span class="tnv">topsymmetries</span>];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"Map: "</span>, <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"["</span>, <span class="tnvc">sector1</span>, <span class="ts">"] = "</span>, <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnvc">bid2</span>], <span class="ts">"["</span>, <span class="tnvc">sector2</span>, <span class="ts">"]: "</span>, <span class="tnvc">mommap</span>];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">jacobian</span> =!= <span class="tl">1</span>,
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"WARNING: Jacobian for that map is "</span>, <span class="tnvc">jacobian</span>, <span class="ts">"; does this matter?"</span>];
      ];
      <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/AllTrue.html" rel="nofollow">AllTrue</a>[<span class="tnvc">mommap</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnt">a_</span> -&gt; <span class="tnt">a_</span>]],
        {}
        ,
        <span class="tnvc">mommap</span>
      ]
      ,
      {}
    ]
    ,
    {<span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnvc">ibpbasis</span>]}];
  (<span class="tnv">uniqdensetmaps</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tnt">a_</span>-&gt;<span class="tnt">a_</span>]])[[<span class="tnvc">densetindices</span>]]
]</pre>
<h3 id="MapToBasis"><code>MapToBasis[]</code></h3>
<p>Out of a list of expressions choose the ones that can be
mappend into a given IBP basis by a symmetry transformation,
and return them transformed.</p>
<p>The expressions are recognized by the set of den[...] inside.</p>
<pre><a class="tnv" href="#MapToBasis">MapToBasis</a>[<span class="tnv">IBPBasis</span>[<span class="tnt">bid_</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">extmom_List</span>, <span class="tnt">dens_List</span>, <span class="tnt">denmap_</span>, <span class="tnt">dotmap_</span>], <span class="tnt">exprs_List</span>] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">densets</span>, <span class="tnvc">symmaps</span>},
  <span class="tnvc">densets</span> = <span class="tnv">exprs</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#CaseUnion">CaseUnion</a>[<span class="tnt">_den</span>] /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnv" href="utils.html#NotFreeQ">NotFreeQ</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Alternatives.html" rel="nofollow">Alternatives</a> @@ <span class="tnv">loopmom</span>]]];
  <span class="tnvc">symmaps</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Join.html" rel="nofollow">Join</a>[{<span class="tnv">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteCases.html" rel="nofollow">DeleteCases</a>[<span class="tnv">den</span>[_,_,<span class="tnv">irr</span>]]}, <span class="tnvc">densets</span>] // <a class="tnv" href="alibrary.html#SymmetryMaps">SymmetryMaps</a>[<span class="tnv">#</span>, <span class="tnv">loopmom</span>, <span class="tnv">extmom</span>]&amp;;
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<span class="tnvc">symmaps</span>[[<span class="tl">1</span>]] === {}];
  <span class="tnvc">symmaps</span> = <span class="tnvc">symmaps</span>[[<span class="tl">2</span>;;]];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/MapThread.html" rel="nofollow">MapThread</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnv" href="#SubtopologyQ">SubtopologyQ</a>[<span class="tnv">dens</span>, <span class="tnv">#1</span>/.<span class="tnv">#2</span>//<a class="tnv" href="alibrary.html#NormalizeDens">NormalizeDens</a>], <span class="tnv">#3</span>/.<span class="tnv">#2</span>//<a class="tnv" href="alibrary.html#NormalizeDens">NormalizeDens</a>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Nothing.html" rel="nofollow">Nothing</a>]&amp;, {<span class="tnvc">densets</span>, <span class="tnvc">symmaps</span>, <span class="tnv">exprs</span>}]
]</pre>
<h3 id="KiraZeroSectors"><code>KiraZeroSectors[]</code></h3>
<p>Slow; use this only for double-checking.</p>
<pre><a class="tnv" href="#KiraZeroSectors">KiraZeroSectors</a>[<span class="tnv">IBPBasis</span>[<span class="tnt">bid_</span>, <span class="tnt">loopmom_List</span>, <span class="tnt">extmom_List</span>, <span class="tnt">dens_List</span>, <span class="tnt">denmap_</span>, <span class="tnt">dotmap_</span>]] :=
<a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">confdir</span>, <span class="tnvc">topsector</span>, <span class="tnvc">zerosectors</span>},
  <span class="tnvc">confdir</span> = <span class="ts">"kira-intra-symmetries"</span>;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Quiet.html" rel="nofollow">Quiet</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteDirectory.html" rel="nofollow">DeleteDirectory</a>[<span class="tnvc">confdir</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteContents.html" rel="nofollow">DeleteContents</a>-&gt;<a class="tnb" href="https://reference.wolfram.com/language/ref/True.html" rel="nofollow">True</a>], {<a class="tnb" href="https://reference.wolfram.com/language/ref/DeleteDirectory.html" rel="nofollow">DeleteDirectory</a>::<span class="tne">nodir</span>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Quiet.html" rel="nofollow">Quiet</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/CreateDirectory.html" rel="nofollow">CreateDirectory</a>[<span class="tnvc">confdir</span>], {<a class="tnb" href="https://reference.wolfram.com/language/ref/CreateDirectory.html" rel="nofollow">CreateDirectory</a>::<span class="tne">filex</span>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Quiet.html" rel="nofollow">Quiet</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/CreateDirectory.html" rel="nofollow">CreateDirectory</a>[<span class="tnvc">confdir</span> &lt;&gt; <span class="ts">"/config"</span>], {<a class="tnb" href="https://reference.wolfram.com/language/ref/CreateDirectory.html" rel="nofollow">CreateDirectory</a>::<span class="tne">filex</span>}];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">confdir</span> &lt;&gt; <span class="ts">"/jobs.yaml"</span>,
    <span class="ts">"jobs:\n"</span>,
    <span class="ts">" - reduce_sectors:\n"</span>,
    <span class="ts">"    integral_ordering: 6\n"</span>,
    <span class="ts">"    run_symmetries: true\n"</span>,
    <span class="ts">"    run_initiate: false\n"</span>,
    <span class="ts">"    run_pyred: false\n"</span>,
    <span class="ts">"    run_triangular: false\n"</span>,
    <span class="ts">"    run_back_substitution: false\n"</span>
  ];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">confdir</span> &lt;&gt; <span class="ts">"/config/kinematics.yaml"</span>,
    <span class="ts">"kinematics:\n"</span>,
    <span class="ts">" incoming_momenta: ["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">extmom</span>, <span class="ts">", "</span>], <span class="ts">"]\n"</span>,
    <span class="ts">" kinematic_invariants: []\n"</span>,
    <span class="ts">" scalarproduct_rules:\n"</span>,
    <span class="ts">"  - [[q,q], 1]\n"</span>
  ];
  <span class="tnvc">topsector</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">dens</span>[[<span class="tnv">i</span>]], <span class="tnv">den</span>[_, _, <span class="tnv">irr</span>]], <span class="tl">0</span>, <span class="tl">2</span>^(<span class="tnv">i</span>-<span class="tl">1</span>)], {<span class="tnv">i</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">dens</span>]}]
    // <a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Plus.html" rel="nofollow">Plus</a>];
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnvc">confdir</span> &lt;&gt; <span class="ts">"/config/integralfamilies.yaml"</span>,
    <span class="ts">"integralfamilies:\n"</span>,
      {
        <span class="ts">"  - name: \""</span>, <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"\"\n"</span>,
        <span class="ts">"    loop_momenta: ["</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<span class="tnv">loopmom</span>, <span class="ts">", "</span>], <span class="ts">"]\n"</span>,
        <span class="ts">"    top_level_sectors: ["</span>, <span class="tnvc">topsector</span>, <span class="ts">"]\n"</span>,
        <span class="ts">"    propagators:\n"</span>,
        <span class="tnv">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Replace.html" rel="nofollow">Replace</a>[{
          <span class="tnv">den</span>[<span class="tnt">p_</span>] | <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tl">0</span>, ___] :&gt; {<span class="ts">"      - [\""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>[<span class="tnv">p</span>], <span class="ts">"\", 0]\n"</span>},
          <span class="tnv">den</span>[<span class="tnt">p_</span>, <span class="tnt">m_</span>, ___] :&gt; {<span class="ts">"      - [\""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>[<span class="tnv">p</span>], <span class="ts">"\", \""</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/CForm.html" rel="nofollow">CForm</a>[<span class="tnv">m</span>], <span class="ts">"\"]\n"</span>},
          <span class="tnt">d_</span> :&gt; <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"MkKiraConfig: bad denominator form: "</span>, <span class="tnv">d</span>]
        }]],
        <span class="ts">"    cut_propagators: ["</span>,
        <a class="tnb" href="https://reference.wolfram.com/language/ref/Riffle.html" rel="nofollow">Riffle</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Range.html" rel="nofollow">Range</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">dens</span>]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Select.html" rel="nofollow">Select</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/MatchQ.html" rel="nofollow">MatchQ</a>[<span class="tnv">dens</span>[[<span class="tnv">#</span>]], <span class="tnv">den</span>[_, _, <span class="tnv">cut</span>]]&amp;], <span class="ts">", "</span>],
        <span class="ts">"]\n"</span>
      }
  ];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Run.html" rel="nofollow">Run</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"./kira.sh "</span>, <span class="tnvc">confdir</span>, <span class="ts">"/jobs.yaml"</span>]]//<a class="tnv" href="utils.html#TM">TM</a>//<span class="tnv">#</span> =!= <span class="tl">0</span>&amp;,
    <a class="tnv" href="utils.html#Error">Error</a>[<span class="ts">"Failed to run kira"</span>];
  ];
  <span class="tnvc">zerosectors</span> = \
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Import.html" rel="nofollow">Import</a>[<a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnvc">confdir</span>, <span class="ts">"/sectormappings/"</span>, <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"/trivialsector"</span>], <span class="ts">"Text"</span>]
      // <a class="tnv" href="utils.html#MkExpression">MkExpression</a>[<span class="ts">"{"</span>, <span class="tnv">#</span>, <span class="ts">"}"</span>]&amp;
      // <a class="tnb" href="https://reference.wolfram.com/language/ref/SortBy.html" rel="nofollow">SortBy</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/DigitCount.html" rel="nofollow">DigitCount</a>[<span class="tnv">#</span>, <span class="tl">2</span>]&amp; /* <a class="tnb" href="https://reference.wolfram.com/language/ref/Minus.html" rel="nofollow">Minus</a>]
      // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">SectorIdToIndices</span>[<span class="tnv">#</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">dens</span>]]&amp;]
      // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">B</span>[<span class="tnv">bid</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Sequence.html" rel="nofollow">Sequence</a>@@<span class="tnv">#</span>]&amp;];
  <span class="tnvc">zerosectors</span>
]

<span class="tnv">GetKiraIBPMap</span>[<span class="tnt">basedir_String</span>, <span class="tnt">ibpbasis_List</span>, <span class="tnt">bid_Integer</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bvarmap</span>, <span class="tnvc">filename</span>, <span class="tnvc">b</span>},
  <span class="tnvc">bvarmap</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <span class="tnv">bvar</span> = <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnvc">b</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>;
    (<span class="tnv">bvar</span>[<span class="tnt">idx__</span>] :&gt; <span class="tnv">B</span>[<span class="tnv">$BID</span>, <span class="tnv">idx</span>]) /. <span class="tnv">$BID</span> -&gt; <span class="tnvc">b</span>
    ,
    {<span class="tnvc">b</span>, <span class="tnv">ibpbasis</span>[[;;,<span class="tl">1</span>]]}
  ];
  <span class="tnvc">filename</span> = <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnv">basedir</span>, <span class="ts">"/*/results/"</span>,
    <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">"/kira_"</span>, <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnv">bid</span>], <span class="ts">".integrals.m"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/FileNames.html" rel="nofollow">FileNames</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/First.html" rel="nofollow">First</a>;
  <span class="tc">(*Print["* Loading Kira IBP tables for basis ", bid, " from ", filename];*)</span>
  <span class="tnvc">filename</span> // <a class="tnv" href="utils.html#SafeGet">SafeGet</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnvc">bvarmap</span>]
]

<span class="tnv">LoadFullKiraBMap</span>[<span class="tnt">bmap_Symbol</span>, <span class="tnt">basedir_String</span>, <span class="tnt">ibpbasis_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">bvarmap</span>, <span class="tnvc">filename</span>, <span class="tnvc">b</span>},
  <span class="tnvc">bvarmap</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Table.html" rel="nofollow">Table</a>[
    <span class="tnv">bvar</span> = <a class="tnv" href="alibrary.html#KiraBasisName">KiraBasisName</a>[<span class="tnvc">b</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/ToExpression.html" rel="nofollow">ToExpression</a>;
    (<span class="tnv">bvar</span>[<span class="tnt">idx__</span>] :&gt; <span class="tnv">B</span>[<span class="tnv">$BID</span>, <span class="tnv">idx</span>]) /. <span class="tnv">$BID</span> -&gt; <span class="tnvc">b</span>
    ,
    {<span class="tnvc">b</span>, <span class="tnv">ibpbasis</span>[[;;,<span class="tl">1</span>]]}
  ];
  <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="tnv">basedir</span>, <span class="ts">"/*/results/*/kira_*.m"</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/FileNames.html" rel="nofollow">FileNames</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnv" href="utils.html#SafeGet">SafeGet</a> /* <a class="tnb" href="https://reference.wolfram.com/language/ref/ReplaceAll.html" rel="nofollow">ReplaceAll</a>[<span class="tnvc">bvarmap</span>] /* (<a class="tnv" href="utils.html#BMapLoad">BMapLoad</a>[<span class="tnv">bmap</span>, <span class="tnv">#</span>]&amp;)];
]</pre>
<h3 id="SubtopologyQ"><code>SubtopologyQ[]</code></h3>
<p>Is a set of denominators a subtopology of a different set?
Subtopology differs from just a subset by the threatment of
cut denominators: a denominator set is only a subtopology if
the set of cuts is the same.</p>
<pre><a class="tnv" href="#SubtopologyQ">SubtopologyQ</a>[<span class="tnt">superdenset_List</span>, <span class="tnt">denset_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/And.html" rel="nofollow">And</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">superdenset</span>, <span class="tnv">den</span>[_, _, <span class="tnv">cut</span>]] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">denset</span>, <span class="tnv">den</span>[_, _, <span class="tnv">cut</span>]],
    <a class="tnb" href="https://reference.wolfram.com/language/ref/SubsetQ.html" rel="nofollow">SubsetQ</a>[<span class="tnv">superdenset</span>, <span class="tnv">denset</span>]
  ]</pre>
<h3 id="UniqueSupertopologyMapping"><code>UniqueSupertopologyMapping[]</code></h3>
<p>Same as <a href="utils.html#UniqueSupersetMapping">UniqueSupersetMapping</a>, but using <a href="#SubtopologyQ">SubtopologyQ</a>
instead of <code>SubsetQ</code>.</p>
<pre><a class="tnv" href="#UniqueSupertopologyMapping">UniqueSupertopologyMapping</a>[<span class="tnt">densets_List</span>] := <a class="tnv" href="utils.html#UniqueSupersetMapping">UniqueSupersetMapping</a>[<span class="tnv">densets</span>, <a class="tnv" href="#SubtopologyQ">SubtopologyQ</a>]

<span class="tnv">IBPBasisStructureId</span>[<span class="tnv">IBPBasis</span>[_, _, _, <span class="tnt">dens_</span>, _, _]] := <span class="tnv">dens</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Count.html" rel="nofollow">Count</a>[<span class="tnv">den</span>[_, <span class="tl">0</span>, <span class="tnv">cut</span>]] // <a class="tnv" href="utils.html#MkString">MkString</a>[<span class="ts">"cut-"</span>, <span class="tnv">#</span>]&amp;</pre>
<p>FIRE I/O</p>
<pre><span class="tnv">MkFireRulesFile</span>[<span class="tnt">filename_String</span>, <span class="tnt">rules_List</span>] :=
  <a class="tnv" href="utils.html#MkFile">MkFile</a>[<span class="tnv">filename</span>,
    <span class="tnv">rules</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[(<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>] -&gt; <span class="tnt">ex_</span>) :&gt;
      {
        <span class="tnv">G</span>[<span class="tnv">bid</span>, {<span class="tnv">idx</span>}] -&gt; (<a class="tnv" href="utils.html#Bracket">Bracket</a>[<span class="tnv">ex</span>, <span class="tnt">_B</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Factor.html" rel="nofollow">Factor</a> /* <span class="tnv">COEF</span>, <span class="tnv">STEM</span>] //
          <a class="tnv" href="utils.html#Terms">Terms</a> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">COEF</span>[<span class="tnt">c_</span>]*<span class="tnv">STEM</span>[<span class="tnv">B</span>[<span class="tnt">bid2_</span>, <span class="tnt">idx2__</span>]] :&gt; {<span class="tnv">c</span>, <span class="tnv">G</span>[<span class="tnv">bid2</span>, {<span class="tnv">idx2</span>}]}]) // <a class="tnb" href="https://reference.wolfram.com/language/ref/InputForm.html" rel="nofollow">InputForm</a>,
        <span class="ts">";\n\n"</span>
      }
    ]
  ]

<span class="tnv">MkFireIntegralsFile</span>[<span class="tnt">filename_String</span>, <span class="tnt">ints_List</span>] :=
  <a class="tnv" href="utils.html#SafePut">SafePut</a>[<span class="tnv">ints</span> // <a class="tnv" href="utils.html#MapReplace">MapReplace</a>[<span class="tnv">B</span>[<span class="tnt">bid_</span>, <span class="tnt">idx__</span>] :&gt; {<span class="tnv">bid</span>, {<span class="tnv">idx</span>}}], <span class="tnv">filename</span>]</pre>
<p>PSLQ</p>
<pre><span class="tnv">MzvLinearBasis</span>[<span class="tnt">mzvs_List</span>, {<span class="tl">0</span>}] := <span class="tl">1</span>
<span class="tnv">MzvLinearBasis</span>[<span class="tnt">mzvs_List</span>, {<span class="tnt">weight_</span>}] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">wtomzv</span>},
  <span class="tnvc">wtomzv</span> = <span class="tnv">mzvs</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/GroupBy.html" rel="nofollow">GroupBy</a>[<span class="tnv">MaxZetaWeight</span>];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/IntegerPartitions.html" rel="nofollow">IntegerPartitions</a>[<span class="tnv">weight</span>] /. <span class="tnvc">wtomzv</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Cases.html" rel="nofollow">Cases</a>[{{(<span class="tnt">_Mzv</span>|<span class="tnt">_Log</span>) ..} ..}] //
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Apply.html" rel="nofollow">Apply</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Outer.html" rel="nofollow">Outer</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Times.html" rel="nofollow">Times</a>, <span class="tnv">##</span>]&amp;]] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Union.html" rel="nofollow">Union</a>
]
<span class="tnv">MzvLinearBasis</span>[<span class="tnt">mzvs_List</span>, <span class="tnt">weight_</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Range.html" rel="nofollow">Range</a>[<span class="tl">0</span>, <span class="tnv">weight</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<span class="tnv">MzvLinearBasis</span>[<span class="tnv">mzvs</span>, {<span class="tnv">#</span>}]&amp;] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Flatten.html" rel="nofollow">Flatten</a>

<span class="tnv">PSLQ</span>[<span class="tnt">x_</span>, <span class="tnt">basis_List</span>, <span class="tnt">basisvalues_List</span>] := <a class="tnb" href="https://reference.wolfram.com/language/ref/Module.html" rel="nofollow">Module</a>[{<span class="tnvc">ndigits</span>, <span class="tnvc">cbound</span>, <span class="tnvc">nv</span>},
  <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>] === <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basisvalues</span>]];
  <span class="tnvc">ndigits</span> = <span class="tnv">basisvalues</span> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Map.html" rel="nofollow">Map</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Precision.html" rel="nofollow">Precision</a>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Min.html" rel="nofollow">Min</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Floor.html" rel="nofollow">Floor</a>;
  <span class="tnvc">cbound</span> = <span class="tnvc">ndigits</span>/(<a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>] + <span class="tl">1</span>)*<span class="tl">0.9</span>//<a class="tnb" href="https://reference.wolfram.com/language/ref/Floor.html" rel="nofollow">Floor</a>;
  <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"PSLQ: basis size "</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Length.html" rel="nofollow">Length</a>[<span class="tnv">basis</span>], <span class="ts">", "</span>, <span class="tnvc">ndigits</span>, <span class="ts">" digits; max coeff: 10^"</span>, <span class="tnvc">cbound</span>];
  <span class="tnvc">nv</span> = <a class="tnb" href="https://reference.wolfram.com/language/ref/Quiet.html" rel="nofollow">Quiet</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Check.html" rel="nofollow">Check</a>[
    <a class="tnb" href="https://reference.wolfram.com/language/ref/FindIntegerNullVector.html" rel="nofollow">FindIntegerNullVector</a>[<a class="tnb" href="https://reference.wolfram.com/language/ref/Append.html" rel="nofollow">Append</a>[<span class="tnv">basisvalues</span>, <span class="tnv">x</span>], <span class="tl">10</span>^<span class="tnvc">cbound</span>],
    <a class="tnb" href="https://reference.wolfram.com/language/ref/$Failed.html" rel="nofollow">$Failed</a>,
    {<a class="tnb" href="https://reference.wolfram.com/language/ref/FindIntegerNullVector.html" rel="nofollow">FindIntegerNullVector</a>::<span class="tne">norel</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/FindIntegerNullVector.html" rel="nofollow">FindIntegerNullVector</a>::<span class="tne">rnf</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/FindIntegerNullVector.html" rel="nofollow">FindIntegerNullVector</a>::<span class="tne">rnfb</span>}
  ],
  {<a class="tnb" href="https://reference.wolfram.com/language/ref/FindIntegerNullVector.html" rel="nofollow">FindIntegerNullVector</a>::<span class="tne">norel</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/FindIntegerNullVector.html" rel="nofollow">FindIntegerNullVector</a>::<span class="tne">rnf</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/FindIntegerNullVector.html" rel="nofollow">FindIntegerNullVector</a>::<span class="tne">rnfb</span>}];
  <a class="tnb" href="https://reference.wolfram.com/language/ref/If.html" rel="nofollow">If</a>[<span class="tnvc">nv</span> === <a class="tnb" href="https://reference.wolfram.com/language/ref/$Failed.html" rel="nofollow">$Failed</a>,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"PSLQ: *FAILED* to find a relation"</span>];
    <a class="tnb" href="https://reference.wolfram.com/language/ref/$Failed.html" rel="nofollow">$Failed</a>
    ,
    <a class="tnb" href="https://reference.wolfram.com/language/ref/Print.html" rel="nofollow">Print</a>[<span class="ts">"PSLQ: resulting relation norm: 10^"</span>, <a class="tnb" href="https://reference.wolfram.com/language/ref/Norm.html" rel="nofollow">Norm</a>[<span class="tnvc">nv</span>] // <a class="tnb" href="https://reference.wolfram.com/language/ref/Log10.html" rel="nofollow">Log10</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/Ceiling.html" rel="nofollow">Ceiling</a> // <a class="tnb" href="https://reference.wolfram.com/language/ref/N.html" rel="nofollow">N</a>];
    <a class="tnv" href="utils.html#FailUnless">FailUnless</a>[<span class="tnvc">nv</span>[[-<span class="tl">1</span>]] =!= <span class="tl">0</span>];
    -<span class="tnv">basis</span>.<span class="tnvc">nv</span>[[;;-<span class="tl">2</span>]]/<span class="tnvc">nv</span>[[-<span class="tl">1</span>]]
  ]
]
</pre>
  </body>
</html>
